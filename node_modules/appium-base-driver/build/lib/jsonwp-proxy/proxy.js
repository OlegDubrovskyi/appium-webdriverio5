"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.JWProxy = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _appiumSupport = require("appium-support");

var _requestPromise = _interopRequireDefault(require("request-promise"));

var _status = require("../jsonwp-status/status");

var _errors = require("../protocol/errors");

var _driver = _interopRequireDefault(require("../basedriver/driver"));

var _routes = require("../protocol/routes");

var _protocolConverter = _interopRequireDefault(require("./protocol-converter"));

const log = _appiumSupport.logger.getLogger('WD Proxy');

const LOG_OBJ_LENGTH = 1024;
const DEFAULT_REQUEST_TIMEOUT = 240000;
const {
  MJSONWP,
  W3C
} = _driver.default.DRIVER_PROTOCOL;

class JWProxy {
  constructor(opts = {}) {
    Object.assign(this, {
      scheme: 'http',
      server: 'localhost',
      port: 4444,
      base: '/wd/hub',
      sessionId: null,
      timeout: DEFAULT_REQUEST_TIMEOUT,
      keepAlive: false
    }, opts);
    this.scheme = this.scheme.toLowerCase();
    this._activeRequests = [];
    this._downstreamProtocol = null;
    this.protocolConverter = new _protocolConverter.default(this.proxy.bind(this));
  }

  async request(...args) {
    const currentRequest = (0, _requestPromise.default)(...args);

    this._activeRequests.push(currentRequest);

    return await currentRequest.finally(() => _lodash.default.pull(this._activeRequests, currentRequest));
  }

  getActiveRequestsCount() {
    return this._activeRequests.length;
  }

  cancelActiveRequests() {
    try {
      for (let r of this._activeRequests) {
        r.cancel();
      }
    } finally {
      this._activeRequests = [];
    }
  }

  endpointRequiresSessionId(endpoint) {
    return !_lodash.default.includes(['/session', '/sessions', '/status'], endpoint);
  }

  set downstreamProtocol(value) {
    this._downstreamProtocol = value;
    this.protocolConverter.downstreamProtocol = value;
  }

  get downstreamProtocol() {
    return this._downstreamProtocol;
  }

  getUrlForProxy(url) {
    if (url === '') {
      url = '/';
    }

    const proxyBase = `${this.scheme}://${this.server}:${this.port}${this.base}`;
    const endpointRe = '(/(session|status))';
    let remainingUrl = '';

    if (/^http/.test(url)) {
      const first = new RegExp(`(https?://.+)${endpointRe}`).exec(url);

      if (!first) {
        throw new Error('Got a complete url but could not extract JWP endpoint');
      }

      remainingUrl = url.replace(first[1], '');
    } else if (new RegExp('^/').test(url)) {
      remainingUrl = url;
    } else {
      throw new Error(`Did not know what to do with url '${url}'`);
    }

    const stripPrefixRe = new RegExp('^.*?(/(session|status).*)$');

    if (stripPrefixRe.test(remainingUrl)) {
      remainingUrl = stripPrefixRe.exec(remainingUrl)[1];
    }

    if (!new RegExp(endpointRe).test(remainingUrl)) {
      remainingUrl = `/session/${this.sessionId}${remainingUrl}`;
    }

    const requiresSessionId = this.endpointRequiresSessionId(remainingUrl);

    if (requiresSessionId && this.sessionId === null) {
      throw new Error('Trying to proxy a session command without session id');
    }

    const sessionBaseRe = new RegExp('^/session/([^/]+)');

    if (sessionBaseRe.test(remainingUrl)) {
      const match = sessionBaseRe.exec(remainingUrl);
      remainingUrl = remainingUrl.replace(match[1], this.sessionId);
    } else if (requiresSessionId) {
      throw new Error(`Could not find :session section for url: ${remainingUrl}`);
    }

    remainingUrl = remainingUrl.replace(/\/$/, '');
    return proxyBase + remainingUrl;
  }

  async proxy(url, method, body = null) {
    method = method.toUpperCase();
    const newUrl = this.getUrlForProxy(url);
    const reqOpts = {
      agent: false,
      url: newUrl,
      method,
      headers: {
        'content-type': 'application/json; charset=utf-8',
        'user-agent': 'appium',
        accept: 'application/json, */*'
      },
      resolveWithFullResponse: true,
      timeout: this.timeout,
      forever: this.keepAlive
    };

    if (_appiumSupport.util.hasValue(body)) {
      if (typeof body !== 'object') {
        try {
          reqOpts.json = JSON.parse(body);
        } catch (e) {
          throw new Error('Cannot interpret the request body as valid JSON: ' + _lodash.default.truncate(_lodash.default.isString(body) ? body : JSON.stringify(body), {
            length: LOG_OBJ_LENGTH
          }));
        }
      } else {
        reqOpts.json = body;
      }
    }

    if (method === 'GET') {
      reqOpts.json = null;
    }

    log.debug(`Proxying [${method} ${url || '/'}] to [${method} ${newUrl}] ` + (body ? `with body: ${_lodash.default.truncate(_lodash.default.isString(body) ? body : JSON.stringify(body), {
      length: LOG_OBJ_LENGTH
    })}` : 'with no body'));

    const throwProxyError = error => {
      const message = `The request to ${url} has failed`;
      const err = new Error(message);
      err.message = message;
      err.error = error;
      err.statusCode = 500;
      throw err;
    };

    try {
      const res = await this.request(reqOpts);

      const resObj = _appiumSupport.util.safeJsonParse(res.body);

      if (!_lodash.default.isPlainObject(resObj)) {
        throwProxyError(res.body);
      }

      log.debug(`Got response with status ${res.statusCode}: ` + _lodash.default.truncate(_lodash.default.isString(res.body) ? res.body : JSON.stringify(res.body), {
        length: LOG_OBJ_LENGTH
      }));
      const isSessionCreationRequest = /\/session$/.test(url) && method === 'POST';

      if (isSessionCreationRequest && res.statusCode === 200) {
        this.sessionId = resObj.sessionId;
      }

      if (!this.downstreamProtocol) {
        this.downstreamProtocol = this.getProtocolFromResBody(resObj);
        log.debug(`Determined the downstream protocol as '${this.downstreamProtocol}'`);
      } else if (isSessionCreationRequest) {
        const previousValue = this.downstreamProtocol;
        this.downstreamProtocol = this.getProtocolFromResBody(resObj);

        if (previousValue && previousValue !== this.downstreamProtocol) {
          log.debug(`Updated the downstream protocol to '${this.downstreamProtocol}' ` + `as per session creation request`);
        } else {
          log.debug(`Determined the downstream protocol as '${this.downstreamProtocol}' ` + `per session creation request`);
        }
      }

      if (res.statusCode < 400 && this.downstreamProtocol === MJSONWP && _lodash.default.has(resObj, 'status') && parseInt(resObj.status, 10) !== 0) {
        throwProxyError(resObj);
      }

      return [res, resObj];
    } catch (e) {
      if (_appiumSupport.util.hasValue(e.error)) {
        log.warn(`Got an unexpected response: ` + _lodash.default.truncate(_lodash.default.isString(e.error) ? e.error : JSON.stringify(e.error), {
          length: LOG_OBJ_LENGTH
        }));
      } else {
        log.debug(e.stack);
      }

      throw new _errors.errors.ProxyRequestError(`Could not proxy command to remote server. ` + `Original error: ${e.message}`, e.error, e.statusCode);
    }
  }

  getProtocolFromResBody(resObj) {
    if (_appiumSupport.util.hasValue(resObj.status)) {
      return MJSONWP;
    }

    if (_appiumSupport.util.hasValue(resObj.value)) {
      return W3C;
    }
  }

  requestToCommandName(url, method) {
    const extractCommandName = pattern => {
      const pathMatch = pattern.exec(url);
      return pathMatch ? (0, _routes.routeToCommandName)(pathMatch[1], method) : null;
    };

    let commandName = (0, _routes.routeToCommandName)(url, method);

    if (!commandName && _lodash.default.includes(url, '/wd/hub/session/')) {
      commandName = extractCommandName(/\/wd\/hub\/session\/[^/]+(.+)/);
    }

    if (!commandName && _lodash.default.includes(url, '/wd/hub/')) {
      commandName = extractCommandName(/\/wd\/hub(\/.+)/);
    }

    return commandName;
  }

  async proxyCommand(url, method, body = null) {
    const commandName = this.requestToCommandName(url, method);

    if (!commandName) {
      return await this.proxy(url, method, body);
    }

    log.debug(`Matched '${url}' to command name '${commandName}'`);
    return await this.protocolConverter.convertAndProxy(commandName, url, method, body);
  }

  async command(url, method, body = null) {
    let response;
    let resObj;

    try {
      [response, resObj] = await this.proxyCommand(url, method, body);
    } catch (err) {
      if ((0, _errors.isErrorType)(err, _errors.errors.ProxyRequestError)) {
        throw err.getActualError();
      }

      throw new _errors.errors.UnknownError(err.message);
    }

    const protocol = this.getProtocolFromResBody(resObj);

    if (protocol === MJSONWP) {
      if (response.statusCode === 200 && resObj.status === 0) {
        return resObj.value;
      }

      const status = parseInt(resObj.status, 10);

      if (!isNaN(status) && status !== 0) {
        let message = resObj.value;

        if (_lodash.default.has(message, 'message')) {
          message = message.message;
        }

        throw (0, _errors.errorFromMJSONWPStatusCode)(status, _lodash.default.isEmpty(message) ? (0, _status.getSummaryByCode)(status) : message);
      }
    } else if (protocol === W3C) {
      if (response.statusCode < 300) {
        return resObj.value;
      }

      if (_lodash.default.isPlainObject(resObj.value) && resObj.value.error) {
        throw (0, _errors.errorFromW3CJsonCode)(resObj.value.error, resObj.value.message, resObj.value.stacktrace);
      }
    } else if (response.statusCode === 200) {
      return resObj;
    }

    throw new _errors.errors.UnknownError(`Did not know what to do with response code '${response.statusCode}' ` + `and response body '${_lodash.default.truncate(JSON.stringify(resObj), {
      length: 300
    })}'`);
  }

  getSessionIdFromUrl(url) {
    const match = url.match(/\/session\/([^/]+)/);
    return match ? match[1] : null;
  }

  async proxyReqRes(req, res) {
    let [response, body] = await this.proxyCommand(req.originalUrl, req.method, req.body);
    res.headers = response.headers;
    res.set('content-type', response.headers['content-type']);
    body = _appiumSupport.util.safeJsonParse(body);

    if (body && body.sessionId) {
      const reqSessionId = this.getSessionIdFromUrl(req.originalUrl);

      if (reqSessionId) {
        log.info(`Replacing sessionId ${body.sessionId} with ${reqSessionId}`);
        body.sessionId = reqSessionId;
      } else if (this.sessionId) {
        log.info(`Replacing sessionId ${body.sessionId} with ${this.sessionId}`);
        body.sessionId = this.sessionId;
      }
    }

    res.status(response.statusCode).send(JSON.stringify(body));
  }

}

exports.JWProxy = JWProxy;
var _default = JWProxy;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9qc29ud3AtcHJveHkvcHJveHkuanMiXSwibmFtZXMiOlsibG9nIiwibG9nZ2VyIiwiZ2V0TG9nZ2VyIiwiTE9HX09CSl9MRU5HVEgiLCJERUZBVUxUX1JFUVVFU1RfVElNRU9VVCIsIk1KU09OV1AiLCJXM0MiLCJCYXNlRHJpdmVyIiwiRFJJVkVSX1BST1RPQ09MIiwiSldQcm94eSIsImNvbnN0cnVjdG9yIiwib3B0cyIsIk9iamVjdCIsImFzc2lnbiIsInNjaGVtZSIsInNlcnZlciIsInBvcnQiLCJiYXNlIiwic2Vzc2lvbklkIiwidGltZW91dCIsImtlZXBBbGl2ZSIsInRvTG93ZXJDYXNlIiwiX2FjdGl2ZVJlcXVlc3RzIiwiX2Rvd25zdHJlYW1Qcm90b2NvbCIsInByb3RvY29sQ29udmVydGVyIiwiUHJvdG9jb2xDb252ZXJ0ZXIiLCJwcm94eSIsImJpbmQiLCJyZXF1ZXN0IiwiYXJncyIsImN1cnJlbnRSZXF1ZXN0IiwicHVzaCIsImZpbmFsbHkiLCJfIiwicHVsbCIsImdldEFjdGl2ZVJlcXVlc3RzQ291bnQiLCJsZW5ndGgiLCJjYW5jZWxBY3RpdmVSZXF1ZXN0cyIsInIiLCJjYW5jZWwiLCJlbmRwb2ludFJlcXVpcmVzU2Vzc2lvbklkIiwiZW5kcG9pbnQiLCJpbmNsdWRlcyIsImRvd25zdHJlYW1Qcm90b2NvbCIsInZhbHVlIiwiZ2V0VXJsRm9yUHJveHkiLCJ1cmwiLCJwcm94eUJhc2UiLCJlbmRwb2ludFJlIiwicmVtYWluaW5nVXJsIiwidGVzdCIsImZpcnN0IiwiUmVnRXhwIiwiZXhlYyIsIkVycm9yIiwicmVwbGFjZSIsInN0cmlwUHJlZml4UmUiLCJyZXF1aXJlc1Nlc3Npb25JZCIsInNlc3Npb25CYXNlUmUiLCJtYXRjaCIsIm1ldGhvZCIsImJvZHkiLCJ0b1VwcGVyQ2FzZSIsIm5ld1VybCIsInJlcU9wdHMiLCJhZ2VudCIsImhlYWRlcnMiLCJhY2NlcHQiLCJyZXNvbHZlV2l0aEZ1bGxSZXNwb25zZSIsImZvcmV2ZXIiLCJ1dGlsIiwiaGFzVmFsdWUiLCJqc29uIiwiSlNPTiIsInBhcnNlIiwiZSIsInRydW5jYXRlIiwiaXNTdHJpbmciLCJzdHJpbmdpZnkiLCJkZWJ1ZyIsInRocm93UHJveHlFcnJvciIsImVycm9yIiwibWVzc2FnZSIsImVyciIsInN0YXR1c0NvZGUiLCJyZXMiLCJyZXNPYmoiLCJzYWZlSnNvblBhcnNlIiwiaXNQbGFpbk9iamVjdCIsImlzU2Vzc2lvbkNyZWF0aW9uUmVxdWVzdCIsImdldFByb3RvY29sRnJvbVJlc0JvZHkiLCJwcmV2aW91c1ZhbHVlIiwiaGFzIiwicGFyc2VJbnQiLCJzdGF0dXMiLCJ3YXJuIiwic3RhY2siLCJlcnJvcnMiLCJQcm94eVJlcXVlc3RFcnJvciIsInJlcXVlc3RUb0NvbW1hbmROYW1lIiwiZXh0cmFjdENvbW1hbmROYW1lIiwicGF0dGVybiIsInBhdGhNYXRjaCIsImNvbW1hbmROYW1lIiwicHJveHlDb21tYW5kIiwiY29udmVydEFuZFByb3h5IiwiY29tbWFuZCIsInJlc3BvbnNlIiwiZ2V0QWN0dWFsRXJyb3IiLCJVbmtub3duRXJyb3IiLCJwcm90b2NvbCIsImlzTmFOIiwiaXNFbXB0eSIsInN0YWNrdHJhY2UiLCJnZXRTZXNzaW9uSWRGcm9tVXJsIiwicHJveHlSZXFSZXMiLCJyZXEiLCJvcmlnaW5hbFVybCIsInNldCIsInJlcVNlc3Npb25JZCIsImluZm8iLCJzZW5kIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUdBLE1BQU1BLEdBQUcsR0FBR0Msc0JBQU9DLFNBQVAsQ0FBaUIsVUFBakIsQ0FBWjs7QUFFQSxNQUFNQyxjQUFjLEdBQUcsSUFBdkI7QUFDQSxNQUFNQyx1QkFBdUIsR0FBRyxNQUFoQztBQUVBLE1BQU07QUFBQ0MsRUFBQUEsT0FBRDtBQUFVQyxFQUFBQTtBQUFWLElBQWlCQyxnQkFBV0MsZUFBbEM7O0FBRUEsTUFBTUMsT0FBTixDQUFjO0FBQ1pDLEVBQUFB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RSxZQUFKLEVBQWtCO0FBQ2hCdkgsUUFBQUEsR0FBRyxDQUFDd0gsSUFBSixDQUFVLHVCQUFzQjNELElBQUksQ0FBQzNDLFNBQVUsU0FBUXFHLFlBQWEsRUFBcEU7QUFDQTFELFFBQUFBLElBQUksQ0FBQzNDLFNBQUwsR0FBaUJxRyxZQUFqQjtBQUNELE9BSEQsTUFHTyxJQUFJLEtBQUtyRyxTQUFULEVBQW9CO0FBQ3pCbEIsUUFBQUEsR0FBRyxDQUFDd0gsSUFBSixDQUFVLHVCQUFzQjNELElBQUksQ0FBQzNDLFNBQVUsU0FBUSxLQUFLQSxTQUFVLEVBQXRFO0FBQ0EyQyxRQUFBQSxJQUFJLENBQUMzQyxTQUFMLEdBQWlCLEtBQUtBLFNBQXRCO0FBQ0Q7QUFDRjs7QUFDRG1FLElBQUFBLEdBQUcsQ0FBQ1MsTUFBSixDQUFXYSxRQUFRLENBQUN2QixVQUFwQixFQUFnQ3FDLElBQWhDLENBQXFDaEQsSUFBSSxDQUFDSyxTQUFMLENBQWVqQixJQUFmLENBQXJDO0FBQ0Q7O0FBL1NXOzs7ZUFtVENwRCxPIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IGxvZ2dlciwgdXRpbCB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCByZXF1ZXN0IGZyb20gJ3JlcXVlc3QtcHJvbWlzZSc7XG5pbXBvcnQgeyBnZXRTdW1tYXJ5QnlDb2RlIH0gZnJvbSAnLi4vanNvbndwLXN0YXR1cy9zdGF0dXMnO1xuaW1wb3J0IHsgZXJyb3JzLCBpc0Vycm9yVHlwZSwgZXJyb3JGcm9tTUpTT05XUFN0YXR1c0NvZGUsIGVycm9yRnJvbVczQ0pzb25Db2RlIH0gZnJvbSAnLi4vcHJvdG9jb2wvZXJyb3JzJztcbmltcG9ydCBCYXNlRHJpdmVyIGZyb20gJy4uL2Jhc2Vkcml2ZXIvZHJpdmVyJztcbmltcG9ydCB7IHJvdXRlVG9Db21tYW5kTmFtZSB9IGZyb20gJy4uL3Byb3RvY29sL3JvdXRlcyc7XG5pbXBvcnQgUHJvdG9jb2xDb252ZXJ0ZXIgZnJvbSAnLi9wcm90b2NvbC1jb252ZXJ0ZXInO1xuXG5cbmNvbnN0IGxvZyA9IGxvZ2dlci5nZXRMb2dnZXIoJ1dEIFByb3h5Jyk7XG4vLyBUT0RPOiBNYWtlIHRoaXMgdmFsdWUgY29uZmlndXJhYmxlIGFzIGEgc2VydmVyIHNpZGUgY2FwYWJpbGl0eVxuY29uc3QgTE9HX09CSl9MRU5HVEggPSAxMDI0OyAvLyBNQVggTEVOR1RIIExvZ2dlZCB0byBmaWxlIC8gY29uc29sZVxuY29uc3QgREVGQVVMVF9SRVFVRVNUX1RJTUVPVVQgPSAyNDAwMDA7XG5cbmNvbnN0IHtNSlNPTldQLCBXM0N9ID0gQmFzZURyaXZlci5EUklWRVJfUFJPVE9DT0w7XG5cbmNsYXNzIEpXUHJveHkge1xuICBjb25zdHJ1Y3RvciAob3B0cyA9IHt9KSB7XG4gICAgT2JqZWN0LmFzc2lnbih0aGlzLCB7XG4gICAgICBzY2hlbWU6ICdodHRwJyxcbiAgICAgIHNlcnZlcjogJ2xvY2FsaG9zdCcsXG4gICAgICBwb3J0OiA0NDQ0LFxuICAgICAgYmFzZTogJy93ZC9odWInLFxuICAgICAgc2Vzc2lvbklkOiBudWxsLFxuICAgICAgdGltZW91dDogREVGQVVMVF9SRVFVRVNUX1RJTUVPVVQsXG4gICAgICBrZWVwQWxpdmU6IGZhbHNlLFxuICAgIH0sIG9wdHMpO1xuICAgIHRoaXMuc2NoZW1lID0gdGhpcy5zY2hlbWUudG9Mb3dlckNhc2UoKTtcbiAgICB0aGlzLl9hY3RpdmVSZXF1ZXN0cyA9IFtdO1xuICAgIHRoaXMuX2Rvd25zdHJlYW1Qcm90b2NvbCA9IG51bGw7XG4gICAgdGhpcy5wcm90b2NvbENvbnZlcnRlciA9IG5ldyBQcm90b2NvbENvbnZlcnRlcih0aGlzLnByb3h5LmJpbmQodGhpcykpO1xuICB9XG5cbiAgLy8gYWJzdHJhY3QgdGhlIGNhbGwgYmVoaW5kIGEgbWVtYmVyIGZ1bmN0aW9uXG4gIC8vIHNvIHRoYXQgd2UgY2FuIG1vY2sgaXQgaW4gdGVzdHNcbiAgYXN5bmMgcmVxdWVzdCAoLi4uYXJncykge1xuICAgIGNvbnN0IGN1cnJlbnRSZXF1ZXN0ID0gcmVxdWVzdCguLi5hcmdzKTtcbiAgICB0aGlzLl9hY3RpdmVSZXF1ZXN0cy5wdXNoKGN1cnJlbnRSZXF1ZXN0KTtcbiAgICByZXR1cm4gYXdhaXQgY3VycmVudFJlcXVlc3QuZmluYWxseSgoKSA9PiBfLnB1bGwodGhpcy5fYWN0aXZlUmVxdWVzdHMsIGN1cnJlbnRSZXF1ZXN0KSk7XG4gIH1cblxuICBnZXRBY3RpdmVSZXF1ZXN0c0NvdW50ICgpIHtcbiAgICByZXR1cm4gdGhpcy5fYWN0aXZlUmVxdWVzdHMubGVuZ3RoO1xuICB9XG5cbiAgY2FuY2VsQWN0aXZlUmVxdWVzdHMgKCkge1xuICAgIHRyeSB7XG4gICAgICBmb3IgKGxldCByIG9mIHRoaXMuX2FjdGl2ZVJlcXVlc3RzKSB7XG4gICAgICAgIHIuY2FuY2VsKCk7XG4gICAgICB9XG4gICAgfSBmaW5hbGx5IHtcbiAgICAgIHRoaXMuX2FjdGl2ZVJlcXVlc3RzID0gW107XG4gICAgfVxuICB9XG5cbiAgZW5kcG9pbnRSZXF1aXJlc1Nlc3Npb25JZCAoZW5kcG9pbnQpIHtcbiAgICByZXR1cm4gIV8uaW5jbHVkZXMoWycvc2Vzc2lvbicsICcvc2Vzc2lvbnMnLCAnL3N0YXR1cyddLCBlbmRwb2ludCk7XG4gIH1cblxuICBzZXQgZG93bnN0cmVhbVByb3RvY29sICh2YWx1ZSkge1xuICAgIHRoaXMuX2Rvd25zdHJlYW1Qcm90b2NvbCA9IHZhbHVlO1xuICAgIHRoaXMucHJvdG9jb2xDb252ZXJ0ZXIuZG93bnN0cmVhbVByb3RvY29sID0gdmFsdWU7XG4gIH1cblxuICBnZXQgZG93bnN0cmVhbVByb3RvY29sICgpIHtcbiAgICByZXR1cm4gdGhpcy5fZG93bnN0cmVhbVByb3RvY29sO1xuICB9XG5cbiAgZ2V0VXJsRm9yUHJveHkgKHVybCkge1xuICAgIGlmICh1cmwgPT09ICcnKSB7XG4gICAgICB1cmwgPSAnLyc7XG4gICAgfVxuICAgIGNvbnN0IHByb3h5QmFzZSA9IGAke3RoaXMuc2NoZW1lfTovLyR7dGhpcy5zZXJ2ZXJ9OiR7dGhpcy5wb3J0fSR7dGhpcy5iYXNlfWA7XG4gICAgY29uc3QgZW5kcG9pbnRSZSA9ICcoLyhzZXNzaW9ufHN0YXR1cykpJztcbiAgICBsZXQgcmVtYWluaW5nVXJsID0gJyc7XG4gICAgaWYgKC9eaHR0cC8udGVzdCh1cmwpKSB7XG4gICAgICBjb25zdCBmaXJzdCA9IChuZXcgUmVnRXhwKGAoaHR0cHM/Oi8vLispJHtlbmRwb2ludFJlfWApKS5leGVjKHVybCk7XG4gICAgICBpZiAoIWZpcnN0KSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignR290IGEgY29tcGxldGUgdXJsIGJ1dCBjb3VsZCBub3QgZXh0cmFjdCBKV1AgZW5kcG9pbnQnKTtcbiAgICAgIH1cbiAgICAgIHJlbWFpbmluZ1VybCA9IHVybC5yZXBsYWNlKGZpcnN0WzFdLCAnJyk7XG4gICAgfSBlbHNlIGlmICgobmV3IFJlZ0V4cCgnXi8nKSkudGVzdCh1cmwpKSB7XG4gICAgICByZW1haW5pbmdVcmwgPSB1cmw7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgRGlkIG5vdCBrbm93IHdoYXQgdG8gZG8gd2l0aCB1cmwgJyR7dXJsfSdgKTtcbiAgICB9XG5cbiAgICBjb25zdCBzdHJpcFByZWZpeFJlID0gbmV3IFJlZ0V4cCgnXi4qPygvKHNlc3Npb258c3RhdHVzKS4qKSQnKTtcbiAgICBpZiAoc3RyaXBQcmVmaXhSZS50ZXN0KHJlbWFpbmluZ1VybCkpIHtcbiAgICAgIHJlbWFpbmluZ1VybCA9IHN0cmlwUHJlZml4UmUuZXhlYyhyZW1haW5pbmdVcmwpWzFdO1xuICAgIH1cblxuICAgIGlmICghKG5ldyBSZWdFeHAoZW5kcG9pbnRSZSkpLnRlc3QocmVtYWluaW5nVXJsKSkge1xuICAgICAgcmVtYWluaW5nVXJsID0gYC9zZXNzaW9uLyR7dGhpcy5zZXNzaW9uSWR9JHtyZW1haW5pbmdVcmx9YDtcbiAgICB9XG5cbiAgICBjb25zdCByZXF1aXJlc1Nlc3Npb25JZCA9IHRoaXMuZW5kcG9pbnRSZXF1aXJlc1Nlc3Npb25JZChyZW1haW5pbmdVcmwpO1xuXG4gICAgaWYgKHJlcXVpcmVzU2Vzc2lvbklkICYmIHRoaXMuc2Vzc2lvbklkID09PSBudWxsKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1RyeWluZyB0byBwcm94eSBhIHNlc3Npb24gY29tbWFuZCB3aXRob3V0IHNlc3Npb24gaWQnKTtcbiAgICB9XG5cbiAgICBjb25zdCBzZXNzaW9uQmFzZVJlID0gbmV3IFJlZ0V4cCgnXi9zZXNzaW9uLyhbXi9dKyknKTtcbiAgICBpZiAoc2Vzc2lvbkJhc2VSZS50ZXN0KHJlbWFpbmluZ1VybCkpIHtcbiAgICAgIC8vIHdlIGhhdmUgc29tZXRoaW5nIGxpa2UgL3Nlc3Npb24vOmlkL2Zvb2Jhciwgc28gd2UgbmVlZCB0byByZXBsYWNlXG4gICAgICAvLyB0aGUgc2Vzc2lvbiBpZFxuICAgICAgY29uc3QgbWF0Y2ggPSBzZXNzaW9uQmFzZVJlLmV4ZWMocmVtYWluaW5nVXJsKTtcbiAgICAgIHJlbWFpbmluZ1VybCA9IHJlbWFpbmluZ1VybC5yZXBsYWNlKG1hdGNoWzFdLCB0aGlzLnNlc3Npb25JZCk7XG4gICAgfSBlbHNlIGlmIChyZXF1aXJlc1Nlc3Npb25JZCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBDb3VsZCBub3QgZmluZCA6c2Vzc2lvbiBzZWN0aW9uIGZvciB1cmw6ICR7cmVtYWluaW5nVXJsfWApO1xuICAgIH1cbiAgICByZW1haW5pbmdVcmwgPSByZW1haW5pbmdVcmwucmVwbGFjZSgvXFwvJC8sICcnKTsgLy8gY2FuJ3QgaGF2ZSB0cmFpbGluZyBzbGFzaGVzXG5cbiAgICByZXR1cm4gcHJveHlCYXNlICsgcmVtYWluaW5nVXJsO1xuICB9XG5cbiAgYXN5bmMgcHJveHkgKHVybCwgbWV0aG9kLCBib2R5ID0gbnVsbCkge1xuICAgIG1ldGhvZCA9IG1ldGhvZC50b1VwcGVyQ2FzZSgpO1xuICAgIGNvbnN0IG5ld1VybCA9IHRoaXMuZ2V0VXJsRm9yUHJveHkodXJsKTtcbiAgICBjb25zdCByZXFPcHRzID0ge1xuICAgICAgYWdlbnQ6IGZhbHNlLFxuICAgICAgdXJsOiBuZXdVcmwsXG4gICAgICBtZXRob2QsXG4gICAgICBoZWFkZXJzOiB7XG4gICAgICAgICdjb250ZW50LXR5cGUnOiAnYXBwbGljYXRpb24vanNvbjsgY2hhcnNldD11dGYtOCcsXG4gICAgICAgICd1c2VyLWFnZW50JzogJ2FwcGl1bScsXG4gICAgICAgIGFjY2VwdDogJ2FwcGxpY2F0aW9uL2pzb24sICovKicsXG4gICAgICB9LFxuICAgICAgcmVzb2x2ZVdpdGhGdWxsUmVzcG9uc2U6IHRydWUsXG4gICAgICB0aW1lb3V0OiB0aGlzLnRpbWVvdXQsXG4gICAgICBmb3JldmVyOiB0aGlzLmtlZXBBbGl2ZSxcbiAgICB9O1xuICAgIGlmICh1dGlsLmhhc1ZhbHVlKGJvZHkpKSB7XG4gICAgICBpZiAodHlwZW9mIGJvZHkgIT09ICdvYmplY3QnKSB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgcmVxT3B0cy5qc29uID0gSlNPTi5wYXJzZShib2R5KTtcbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcignQ2Fubm90IGludGVycHJldCB0aGUgcmVxdWVzdCBib2R5IGFzIHZhbGlkIEpTT046ICcgK1xuICAgICAgICAgICAgXy50cnVuY2F0ZShfLmlzU3RyaW5nKGJvZHkpID8gYm9keSA6IEpTT04uc3RyaW5naWZ5KGJvZHkpLFxuICAgICAgICAgICAge2xlbmd0aDogTE9HX09CSl9MRU5HVEh9KSk7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJlcU9wdHMuanNvbiA9IGJvZHk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gR0VUIG1ldGhvZHMgc2hvdWxkbid0IGhhdmUgYW55IGJvZHkuIE1vc3Qgc2VydmVycyBhcmUgT0sgd2l0aCB0aGlzLCBidXQgV2ViRHJpdmVyQWdlbnQgdGhyb3dzIDQwMCBlcnJvcnNcbiAgICBpZiAobWV0aG9kID09PSAnR0VUJykge1xuICAgICAgcmVxT3B0cy5qc29uID0gbnVsbDtcbiAgICB9XG5cbiAgICBsb2cuZGVidWcoYFByb3h5aW5nIFske21ldGhvZH0gJHt1cmwgfHwgJy8nfV0gdG8gWyR7bWV0aG9kfSAke25ld1VybH1dIGAgK1xuICAgICAgKGJvZHkgPyBgd2l0aCBib2R5OiAke18udHJ1bmNhdGUoXy5pc1N0cmluZyhib2R5KSA/IGJvZHkgOiBKU09OLnN0cmluZ2lmeShib2R5KSxcbiAgICAgIHtsZW5ndGg6IExPR19PQkpfTEVOR1RIfSl9YCA6ICd3aXRoIG5vIGJvZHknKSk7XG5cbiAgICBjb25zdCB0aHJvd1Byb3h5RXJyb3IgPSAoZXJyb3IpID0+IHtcbiAgICAgIGNvbnN0IG1lc3NhZ2UgPSBgVGhlIHJlcXVlc3QgdG8gJHt1cmx9IGhhcyBmYWlsZWRgO1xuICAgICAgY29uc3QgZXJyID0gbmV3IEVycm9yKG1lc3NhZ2UpO1xuICAgICAgZXJyLm1lc3NhZ2UgPSBtZXNzYWdlO1xuICAgICAgZXJyLmVycm9yID0gZXJyb3I7XG4gICAgICBlcnIuc3RhdHVzQ29kZSA9IDUwMDtcbiAgICAgIHRocm93IGVycjtcbiAgICB9O1xuICAgIHRyeSB7XG4gICAgICBjb25zdCByZXMgPSBhd2FpdCB0aGlzLnJlcXVlc3QocmVxT3B0cyk7XG4gICAgICAvLyBgcmVzLmJvZHlgIG1pZ2h0IGJlIHJlYWxseSBiaWdcbiAgICAgIC8vIEJlIGNhcmVmdWwgd2hpbGUgaGFuZGxpbmcgaXQgdG8gYXZvaWQgbWVtb3J5IGxlYWtzXG4gICAgICBjb25zdCByZXNPYmogPSB1dGlsLnNhZmVKc29uUGFyc2UocmVzLmJvZHkpO1xuICAgICAgaWYgKCFfLmlzUGxhaW5PYmplY3QocmVzT2JqKSkge1xuICAgICAgICAvLyBUaGUgcmVzcG9uc2Ugc2hvdWxkIGJlIGEgdmFsaWQgSlNPTiBvYmplY3RcbiAgICAgICAgLy8gSWYgaXQgY2Fubm90IGJlIGNvZXJjZWQgdG8gYW4gb2JqZWN0IHRoZW4gdGhlIHJlc3BvbnNlIGlzIHdyb25nXG4gICAgICAgIHRocm93UHJveHlFcnJvcihyZXMuYm9keSk7XG4gICAgICB9XG4gICAgICBsb2cuZGVidWcoYEdvdCByZXNwb25zZSB3aXRoIHN0YXR1cyAke3Jlcy5zdGF0dXNDb2RlfTogYCArXG4gICAgICAgIF8udHJ1bmNhdGUoXy5pc1N0cmluZyhyZXMuYm9keSkgPyByZXMuYm9keSA6IEpTT04uc3RyaW5naWZ5KHJlcy5ib2R5KSwge1xuICAgICAgICAgIGxlbmd0aDogTE9HX09CSl9MRU5HVEgsXG4gICAgICAgIH0pXG4gICAgICApO1xuICAgICAgY29uc3QgaXNTZXNzaW9uQ3JlYXRpb25SZXF1ZXN0ID0gL1xcL3Nlc3Npb24kLy50ZXN0KHVybCkgJiYgbWV0aG9kID09PSAnUE9TVCc7XG4gICAgICBpZiAoaXNTZXNzaW9uQ3JlYXRpb25SZXF1ZXN0ICYmIHJlcy5zdGF0dXNDb2RlID09PSAyMDApIHtcbiAgICAgICAgdGhpcy5zZXNzaW9uSWQgPSByZXNPYmouc2Vzc2lvbklkO1xuICAgICAgfVxuICAgICAgaWYgKCF0aGlzLmRvd25zdHJlYW1Qcm90b2NvbCkge1xuICAgICAgICB0aGlzLmRvd25zdHJlYW1Qcm90b2NvbCA9IHRoaXMuZ2V0UHJvdG9jb2xGcm9tUmVzQm9keShyZXNPYmopO1xuICAgICAgICBsb2cuZGVidWcoYERldGVybWluZWQgdGhlIGRvd25zdHJlYW0gcHJvdG9jb2wgYXMgJyR7dGhpcy5kb3duc3RyZWFtUHJvdG9jb2x9J2ApO1xuICAgICAgfSBlbHNlIGlmIChpc1Nlc3Npb25DcmVhdGlvblJlcXVlc3QpIHtcbiAgICAgICAgLy8gSXQgbWlnaHQgYmUgdGhhdCB3ZSBwcm94eSBBUEkgY2FsbHMgdG8gdGhlIGRvd25zdHJlYW0gZHJpdmVyXG4gICAgICAgIC8vIHdpdGhvdXQgY3JlYXRpbmcgYSBzZXNzaW9uIGZpcnN0XG4gICAgICAgIC8vIGFuZCBpdCByZXNwb25kcyB1c2luZyB0aGUgZGVmYXVsdCBwcm90byxcbiAgICAgICAgLy8gYnV0IHRoZW4gYWZ0ZXIgY3JlYXRlU2Vzc2lvbiByZXF1ZXN0IGlzIHNlbnQgdGhlIGludGVybmFsIHByb3RvIGlzIGNoYW5nZWRcbiAgICAgICAgLy8gdG8gdGhlIG90aGVyIG9uZSBiYXNlZCBvbiB0aGUgYWN0dWFsbHkgcHJvdmlkZWQgY2Fwc1xuICAgICAgICBjb25zdCBwcmV2aW91c1ZhbHVlID0gdGhpcy5kb3duc3RyZWFtUHJvdG9jb2w7XG4gICAgICAgIHRoaXMuZG93bnN0cmVhbVByb3RvY29sID0gdGhpcy5nZXRQcm90b2NvbEZyb21SZXNCb2R5KHJlc09iaik7XG4gICAgICAgIGlmIChwcmV2aW91c1ZhbHVlICYmIHByZXZpb3VzVmFsdWUgIT09IHRoaXMuZG93bnN0cmVhbVByb3RvY29sKSB7XG4gICAgICAgICAgbG9nLmRlYnVnKGBVcGRhdGVkIHRoZSBkb3duc3RyZWFtIHByb3RvY29sIHRvICcke3RoaXMuZG93bnN0cmVhbVByb3RvY29sfScgYCArXG4gICAgICAgICAgICBgYXMgcGVyIHNlc3Npb24gY3JlYXRpb24gcmVxdWVzdGApO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGxvZy5kZWJ1ZyhgRGV0ZXJtaW5lZCB0aGUgZG93bnN0cmVhbSBwcm90b2NvbCBhcyAnJHt0aGlzLmRvd25zdHJlYW1Qcm90b2NvbH0nIGAgK1xuICAgICAgICAgICAgYHBlciBzZXNzaW9uIGNyZWF0aW9uIHJlcXVlc3RgKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgaWYgKHJlcy5zdGF0dXNDb2RlIDwgNDAwICYmIHRoaXMuZG93bnN0cmVhbVByb3RvY29sID09PSBNSlNPTldQICYmXG4gICAgICAgIF8uaGFzKHJlc09iaiwgJ3N0YXR1cycpICYmIHBhcnNlSW50KHJlc09iai5zdGF0dXMsIDEwKSAhPT0gMCkge1xuICAgICAgICAvLyBTb21lIHNlcnZlcnMsIGxpa2UgY2hyb21lZHJpdmVyIG1heSByZXR1cm4gcmVzcG9uc2UgY29kZSAyMDAgZm9yIG5vbi16ZXJvIEpTT05XUCBzdGF0dXNlc1xuICAgICAgICB0aHJvd1Byb3h5RXJyb3IocmVzT2JqKTtcbiAgICAgIH1cbiAgICAgIHJldHVybiBbcmVzLCByZXNPYmpdO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGlmICh1dGlsLmhhc1ZhbHVlKGUuZXJyb3IpKSB7XG4gICAgICAgIGxvZy53YXJuKGBHb3QgYW4gdW5leHBlY3RlZCByZXNwb25zZTogYCArXG4gICAgICAgICAgXy50cnVuY2F0ZShfLmlzU3RyaW5nKGUuZXJyb3IpID8gZS5lcnJvciA6IEpTT04uc3RyaW5naWZ5KGUuZXJyb3IpLCB7bGVuZ3RoOiBMT0dfT0JKX0xFTkdUSH0pKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGxvZy5kZWJ1ZyhlLnN0YWNrKTtcbiAgICAgIH1cbiAgICAgIHRocm93IG5ldyBlcnJvcnMuUHJveHlSZXF1ZXN0RXJyb3IoYENvdWxkIG5vdCBwcm94eSBjb21tYW5kIHRvIHJlbW90ZSBzZXJ2ZXIuIGAgK1xuICAgICAgICBgT3JpZ2luYWwgZXJyb3I6ICR7ZS5tZXNzYWdlfWAsIGUuZXJyb3IsIGUuc3RhdHVzQ29kZSk7XG4gICAgfVxuICB9XG5cbiAgZ2V0UHJvdG9jb2xGcm9tUmVzQm9keSAocmVzT2JqKSB7XG4gICAgaWYgKHV0aWwuaGFzVmFsdWUocmVzT2JqLnN0YXR1cykpIHtcbiAgICAgIHJldHVybiBNSlNPTldQO1xuICAgIH1cbiAgICBpZiAodXRpbC5oYXNWYWx1ZShyZXNPYmoudmFsdWUpKSB7XG4gICAgICByZXR1cm4gVzNDO1xuICAgIH1cbiAgfVxuXG4gIHJlcXVlc3RUb0NvbW1hbmROYW1lICh1cmwsIG1ldGhvZCkge1xuICAgIGNvbnN0IGV4dHJhY3RDb21tYW5kTmFtZSA9IChwYXR0ZXJuKSA9PiB7XG4gICAgICBjb25zdCBwYXRoTWF0Y2ggPSBwYXR0ZXJuLmV4ZWModXJsKTtcbiAgICAgIHJldHVybiBwYXRoTWF0Y2ggPyByb3V0ZVRvQ29tbWFuZE5hbWUocGF0aE1hdGNoWzFdLCBtZXRob2QpIDogbnVsbDtcbiAgICB9O1xuICAgIGxldCBjb21tYW5kTmFtZSA9IHJvdXRlVG9Db21tYW5kTmFtZSh1cmwsIG1ldGhvZCk7XG4gICAgaWYgKCFjb21tYW5kTmFtZSAmJiBfLmluY2x1ZGVzKHVybCwgJy93ZC9odWIvc2Vzc2lvbi8nKSkge1xuICAgICAgY29tbWFuZE5hbWUgPSBleHRyYWN0Q29tbWFuZE5hbWUoL1xcL3dkXFwvaHViXFwvc2Vzc2lvblxcL1teL10rKC4rKS8pO1xuICAgIH1cbiAgICBpZiAoIWNvbW1hbmROYW1lICYmIF8uaW5jbHVkZXModXJsLCAnL3dkL2h1Yi8nKSkge1xuICAgICAgY29tbWFuZE5hbWUgPSBleHRyYWN0Q29tbWFuZE5hbWUoL1xcL3dkXFwvaHViKFxcLy4rKS8pO1xuICAgIH1cbiAgICByZXR1cm4gY29tbWFuZE5hbWU7XG4gIH1cblxuICBhc3luYyBwcm94eUNvbW1hbmQgKHVybCwgbWV0aG9kLCBib2R5ID0gbnVsbCkge1xuICAgIGNvbnN0IGNvbW1hbmROYW1lID0gdGhpcy5yZXF1ZXN0VG9Db21tYW5kTmFtZSh1cmwsIG1ldGhvZCk7XG4gICAgaWYgKCFjb21tYW5kTmFtZSkge1xuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMucHJveHkodXJsLCBtZXRob2QsIGJvZHkpO1xuICAgIH1cbiAgICBsb2cuZGVidWcoYE1hdGNoZWQgJyR7dXJsfScgdG8gY29tbWFuZCBuYW1lICcke2NvbW1hbmROYW1lfSdgKTtcblxuICAgIHJldHVybiBhd2FpdCB0aGlzLnByb3RvY29sQ29udmVydGVyLmNvbnZlcnRBbmRQcm94eShjb21tYW5kTmFtZSwgdXJsLCBtZXRob2QsIGJvZHkpO1xuICB9XG5cbiAgYXN5bmMgY29tbWFuZCAodXJsLCBtZXRob2QsIGJvZHkgPSBudWxsKSB7XG4gICAgbGV0IHJlc3BvbnNlO1xuICAgIGxldCByZXNPYmo7XG4gICAgdHJ5IHtcbiAgICAgIFtyZXNwb25zZSwgcmVzT2JqXSA9IGF3YWl0IHRoaXMucHJveHlDb21tYW5kKHVybCwgbWV0aG9kLCBib2R5KTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGlmIChpc0Vycm9yVHlwZShlcnIsIGVycm9ycy5Qcm94eVJlcXVlc3RFcnJvcikpIHtcbiAgICAgICAgdGhyb3cgZXJyLmdldEFjdHVhbEVycm9yKCk7XG4gICAgICB9XG4gICAgICB0aHJvdyBuZXcgZXJyb3JzLlVua25vd25FcnJvcihlcnIubWVzc2FnZSk7XG4gICAgfVxuICAgIGNvbnN0IHByb3RvY29sID0gdGhpcy5nZXRQcm90b2NvbEZyb21SZXNCb2R5KHJlc09iaik7XG4gICAgaWYgKHByb3RvY29sID09PSBNSlNPTldQKSB7XG4gICAgICAvLyBHb3QgcmVzcG9uc2UgaW4gTUpTT05XUCBmb3JtYXRcbiAgICAgIGlmIChyZXNwb25zZS5zdGF0dXNDb2RlID09PSAyMDAgJiYgcmVzT2JqLnN0YXR1cyA9PT0gMCkge1xuICAgICAgICByZXR1cm4gcmVzT2JqLnZhbHVlO1xuICAgICAgfVxuICAgICAgY29uc3Qgc3RhdHVzID0gcGFyc2VJbnQocmVzT2JqLnN0YXR1cywgMTApO1xuICAgICAgaWYgKCFpc05hTihzdGF0dXMpICYmIHN0YXR1cyAhPT0gMCkge1xuICAgICAgICBsZXQgbWVzc2FnZSA9IHJlc09iai52YWx1ZTtcbiAgICAgICAgaWYgKF8uaGFzKG1lc3NhZ2UsICdtZXNzYWdlJykpIHtcbiAgICAgICAgICBtZXNzYWdlID0gbWVzc2FnZS5tZXNzYWdlO1xuICAgICAgICB9XG4gICAgICAgIHRocm93IGVycm9yRnJvbU1KU09OV1BTdGF0dXNDb2RlKHN0YXR1cywgXy5pc0VtcHR5KG1lc3NhZ2UpID8gZ2V0U3VtbWFyeUJ5Q29kZShzdGF0dXMpIDogbWVzc2FnZSk7XG4gICAgICB9XG4gICAgfSBlbHNlIGlmIChwcm90b2NvbCA9PT0gVzNDKSB7XG4gICAgICAvLyBHb3QgcmVzcG9uc2UgaW4gVzNDIGZvcm1hdFxuICAgICAgaWYgKHJlc3BvbnNlLnN0YXR1c0NvZGUgPCAzMDApIHtcbiAgICAgICAgcmV0dXJuIHJlc09iai52YWx1ZTtcbiAgICAgIH1cbiAgICAgIGlmIChfLmlzUGxhaW5PYmplY3QocmVzT2JqLnZhbHVlKSAmJiByZXNPYmoudmFsdWUuZXJyb3IpIHtcbiAgICAgICAgdGhyb3cgZXJyb3JGcm9tVzNDSnNvbkNvZGUocmVzT2JqLnZhbHVlLmVycm9yLCByZXNPYmoudmFsdWUubWVzc2FnZSwgcmVzT2JqLnZhbHVlLnN0YWNrdHJhY2UpO1xuICAgICAgfVxuICAgIH0gZWxzZSBpZiAocmVzcG9uc2Uuc3RhdHVzQ29kZSA9PT0gMjAwKSB7XG4gICAgICAvLyBVbmtub3duIHByb3RvY29sLiBLZWVwaW5nIGl0IGJlY2F1c2Ugb2YgdGhlIGJhY2t3YXJkIGNvbXBhdGliaWxpdHlcbiAgICAgIHJldHVybiByZXNPYmo7XG4gICAgfVxuICAgIHRocm93IG5ldyBlcnJvcnMuVW5rbm93bkVycm9yKGBEaWQgbm90IGtub3cgd2hhdCB0byBkbyB3aXRoIHJlc3BvbnNlIGNvZGUgJyR7cmVzcG9uc2Uuc3RhdHVzQ29kZX0nIGAgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGBhbmQgcmVzcG9uc2UgYm9keSAnJHtfLnRydW5jYXRlKEpTT04uc3RyaW5naWZ5KHJlc09iaiksIHtsZW5ndGg6IDMwMH0pfSdgKTtcbiAgfVxuXG4gIGdldFNlc3Npb25JZEZyb21VcmwgKHVybCkge1xuICAgIGNvbnN0IG1hdGNoID0gdXJsLm1hdGNoKC9cXC9zZXNzaW9uXFwvKFteL10rKS8pO1xuICAgIHJldHVybiBtYXRjaCA/IG1hdGNoWzFdIDogbnVsbDtcbiAgfVxuXG4gIGFzeW5jIHByb3h5UmVxUmVzIChyZXEsIHJlcykge1xuICAgIGxldCBbcmVzcG9uc2UsIGJvZHldID0gYXdhaXQgdGhpcy5wcm94eUNvbW1hbmQocmVxLm9yaWdpbmFsVXJsLCByZXEubWV0aG9kLCByZXEuYm9keSk7XG5cbiAgICByZXMuaGVhZGVycyA9IHJlc3BvbnNlLmhlYWRlcnM7XG4gICAgcmVzLnNldCgnY29udGVudC10eXBlJywgcmVzcG9uc2UuaGVhZGVyc1snY29udGVudC10eXBlJ10pO1xuICAgIC8vIGlmIHRoZSBwcm94aWVkIHJlc3BvbnNlIGNvbnRhaW5zIGEgc2Vzc2lvbklkIHRoYXQgdGhlIGRvd25zdHJlYW1cbiAgICAvLyBkcml2ZXIgaGFzIGdlbmVyYXRlZCwgd2UgZG9uJ3Qgd2FudCB0byByZXR1cm4gdGhhdCB0byB0aGUgY2xpZW50LlxuICAgIC8vIEluc3RlYWQsIHJldHVybiB0aGUgaWQgZnJvbSB0aGUgcmVxdWVzdCBvciBmcm9tIGN1cnJlbnQgc2Vzc2lvblxuICAgIGJvZHkgPSB1dGlsLnNhZmVKc29uUGFyc2UoYm9keSk7XG4gICAgaWYgKGJvZHkgJiYgYm9keS5zZXNzaW9uSWQpIHtcbiAgICAgIGNvbnN0IHJlcVNlc3Npb25JZCA9IHRoaXMuZ2V0U2Vzc2lvbklkRnJvbVVybChyZXEub3JpZ2luYWxVcmwpO1xuICAgICAgaWYgKHJlcVNlc3Npb25JZCkge1xuICAgICAgICBsb2cuaW5mbyhgUmVwbGFjaW5nIHNlc3Npb25JZCAke2JvZHkuc2Vzc2lvbklkfSB3aXRoICR7cmVxU2Vzc2lvbklkfWApO1xuICAgICAgICBib2R5LnNlc3Npb25JZCA9IHJlcVNlc3Npb25JZDtcbiAgICAgIH0gZWxzZSBpZiAodGhpcy5zZXNzaW9uSWQpIHtcbiAgICAgICAgbG9nLmluZm8oYFJlcGxhY2luZyBzZXNzaW9uSWQgJHtib2R5LnNlc3Npb25JZH0gd2l0aCAke3RoaXMuc2Vzc2lvbklkfWApO1xuICAgICAgICBib2R5LnNlc3Npb25JZCA9IHRoaXMuc2Vzc2lvbklkO1xuICAgICAgfVxuICAgIH1cbiAgICByZXMuc3RhdHVzKHJlc3BvbnNlLnN0YXR1c0NvZGUpLnNlbmQoSlNPTi5zdHJpbmdpZnkoYm9keSkpO1xuICB9XG59XG5cbmV4cG9ydCB7IEpXUHJveHkgfTtcbmV4cG9ydCBkZWZhdWx0IEpXUHJveHk7XG4iXSwiZmlsZSI6ImxpYi9qc29ud3AtcHJveHkvcHJveHkuanMiLCJzb3VyY2VSb290IjoiLi4vLi4vLi4ifQ==
