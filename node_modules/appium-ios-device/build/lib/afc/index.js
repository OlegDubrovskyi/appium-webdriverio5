"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.AFC_SERVICE_NAME = exports.AfcService = exports.default = void 0;

require("source-map-support/register");

var _lengthBasedSplitter = _interopRequireDefault(require("../util/transformer/length-based-splitter"));

var _protocol = require("./protocol");

var _streams = require("./streams");

var _afcencoder = _interopRequireDefault(require("./transformer/afcencoder"));

var _afcdecoder = _interopRequireDefault(require("./transformer/afcdecoder"));

var _constants = require("../constants");

var _bluebird = _interopRequireDefault(require("bluebird"));

var _lodash = _interopRequireDefault(require("lodash"));

const AFC_SERVICE_NAME = 'com.apple.afc';
exports.AFC_SERVICE_NAME = AFC_SERVICE_NAME;
const NULL_DELIMETER_CODE = 0x00;

class AfcService {
  constructor(socketClient) {
    this._socketClient = socketClient;
    this._splitter = new _lengthBasedSplitter.default(true, _constants.MB, 8, 8, -8);
    this._decoder = new _afcdecoder.default();

    this._socketClient.pipe(this._splitter).pipe(this._decoder);

    this._encoder = new _afcencoder.default();

    this._encoder.pipe(this._socketClient);

    this._responseCallbacks = {};
    this._packetNumber = 0;

    this._decoder.on('data', this._handleData.bind(this));
  }

  _handleData(data) {
    const cb = this._responseCallbacks[data.packetNumber];

    if (!_lodash.default.isFunction(cb)) {
      return;
    }

    cb(data);
  }

  async createDirectory(path) {
    const {
      packetNumber,
      response
    } = this.createPacketPromise();
    const data = {
      opCode: _protocol.Operations.MAKE_DIR,
      packetNumber,
      headerPayload: Buffer.from(path)
    };

    this._encoder.write(data);

    const res = await response;
    this.checkStatus(res);
  }

  async deleteDirectory(path) {
    const {
      packetNumber,
      response
    } = this.createPacketPromise();
    const data = {
      opCode: _protocol.Operations.REMOVE_PATH_AND_CONTENTS,
      packetNumber,
      headerPayload: Buffer.from(path)
    };

    this._encoder.write(data);

    const res = await response;
    this.checkStatus(res);
  }

  async listDirectory(path) {
    const {
      packetNumber,
      response
    } = this.createPacketPromise();
    const data = {
      opCode: _protocol.Operations.READ_DIR,
      packetNumber,
      headerPayload: Buffer.from(path)
    };

    this._encoder.write(data);

    const res = await response;

    if (res.opCode !== _protocol.Operations.DATA) {
      this.checkStatus(res);
    }

    return this.parseArray(res.content);
  }

  async openFile(path, mode) {
    const {
      packetNumber,
      response
    } = this.createPacketPromise();
    const pathPayload = Buffer.from(path);
    const fileModePayload = Buffer.alloc(8);
    fileModePayload.writeUInt32LE(mode, 0);
    const data = {
      opCode: _protocol.Operations.FILE_OPEN,
      packetNumber,
      headerPayload: Buffer.concat([fileModePayload, pathPayload])
    };

    this._encoder.write(data);

    const res = await response;

    if (res.opCode !== _protocol.Operations.FILE_OPEN_RES) {
      this.checkStatus(res);
    }

    return res.headerPayload.readUInt32LE(0);
  }

  async createWriteStream(filePath, options) {
    const fileHandle = await this.openFile(filePath, _protocol.FileModes.w);
    return new _streams.AfcWritableFileStream(fileHandle, this, options);
  }

  async createReadStream(filePath, options) {
    const fileHandle = await this.openFile(filePath, _protocol.FileModes.r);
    return new _streams.AfcReadableFileStream(fileHandle, this, options);
  }

  async closeFileHandle(fileHande) {
    const {
      packetNumber,
      response
    } = this.createPacketPromise();
    const fileModePayload = Buffer.alloc(8);
    fileModePayload.writeUInt32LE(fileHande, 0);
    const data = {
      opCode: _protocol.Operations.FILE_CLOSE,
      packetNumber,
      headerPayload: fileModePayload
    };

    this._encoder.write(data);

    const res = await response;
    this.checkStatus(res);
  }

  async writeFile(fileHande, buffer) {
    const {
      packetNumber,
      response
    } = this.createPacketPromise();
    const headerPayload = Buffer.alloc(8);
    headerPayload.writeUInt32LE(fileHande, 0);
    const data = {
      opCode: _protocol.Operations.FILE_WRITE,
      packetNumber,
      headerPayload,
      content: buffer
    };

    this._encoder.write(data);

    const res = await response;
    this.checkStatus(res);
  }

  async readFile(fileHande, length) {
    const {
      packetNumber,
      response
    } = this.createPacketPromise();
    const headerPayload = Buffer.alloc(16);
    headerPayload.writeUInt32LE(fileHande, 0);
    headerPayload.writeUInt32LE(length, 8);
    const data = {
      opCode: _protocol.Operations.FILE_READ,
      packetNumber,
      headerPayload
    };

    this._encoder.write(data);

    const res = await response;

    if (res.opCode !== _protocol.Operations.DATA) {
      this.checkStatus(res);
    }

    return res.content;
  }

  async getFileInfo(path) {
    const {
      packetNumber,
      response
    } = this.createPacketPromise();
    const data = {
      opCode: _protocol.Operations.GET_FILE_INFO,
      packetNumber,
      headerPayload: Buffer.from(path)
    };

    this._encoder.write(data);

    const res = await response;

    if (res.opCode !== _protocol.Operations.DATA) {
      this.checkStatus(res);
    }

    return this.parseObject(res.content);
  }

  checkStatus(res) {
    if (res.opCode !== _protocol.Operations.STATUS) {
      throw new Error(`Unexpected response ${(0, _protocol.operationCode)(res.opCode)}`);
    }

    if (_lodash.default.isEmpty(res.headerPayload)) {
      throw new Error('Header payload cant be empty for a status response');
    }

    if (res.headerPayload[0] !== _protocol.Errors.SUCCESS) {
      throw new Error(`Unexpected response ${(0, _protocol.errorCode)(res.headerPayload[0])}`);
    }
  }

  parseArray(buffer) {
    const items = [];
    let start = 0;

    for (let end = 0; end < buffer.length; end++) {
      if (buffer[end] !== NULL_DELIMETER_CODE) {
        continue;
      }

      const item = buffer.toString('utf8', start, end);
      items.push(item);
      start = end + 1;
    }

    return items;
  }

  parseObject(buffer) {
    const items = {};
    let start = 0;
    let currentKey;

    for (let end = 0; end < buffer.length; end++) {
      if (buffer[end] !== NULL_DELIMETER_CODE) {
        continue;
      }

      const item = buffer.toString('utf8', start, end);

      if (_lodash.default.isNil(currentKey)) {
        currentKey = item;
      } else {
        items[currentKey] = item;
        currentKey = null;
      }

      start = end + 1;
    }

    if (currentKey) {
      throw new Error(`Failed to parse correctly ${buffer}. Please investigate`);
    }

    return items;
  }

  createPacketPromise(timeout = 10000) {
    const packetNumber = this._packetNumber++;
    const response = new _bluebird.default((resolve, reject) => {
      this._responseCallbacks[packetNumber] = data => resolve(data);

      setTimeout(() => reject(new Error(`Failed to receive any data within the timeout: ${timeout}`)), timeout);
    });
    return {
      packetNumber,
      response
    };
  }

  close() {
    this._socketClient.destroy();
  }

}

exports.AfcService = AfcService;
var _default = AfcService;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9hZmMvaW5kZXguanMiXSwibmFtZXMiOlsiQUZDX1NFUlZJQ0VfTkFNRSIsIk5VTExfREVMSU1FVEVSX0NPREUiLCJBZmNTZXJ2aWNlIiwiY29uc3RydWN0b3IiLCJzb2NrZXRDbGllbnQiLCJfc29ja2V0Q2xpZW50IiwiX3NwbGl0dGVyIiwiTGVuZ3RoQmFzZWRTcGxpdHRlciIsIk1CIiwiX2RlY29kZXIiLCJBZmNEZWNvZGVyIiwicGlwZSIsIl9lbmNvZGVyIiwiQWZjRW5jb2RlciIsIl9yZXNwb25zZUNhbGxiYWNrcyIsIl9wYWNrZXROdW1iZXIiLCJvbiIsIl9oYW5kbGVEYXRhIiwiYmluZCIsImRhdGEiLCJjYiIsInBhY2tldE51bWJlciIsIl8iLCJpc0Z1bmN0aW9uIiwiY3JlYXRlRGlyZWN0b3J5IiwicGF0aCIsInJlc3BvbnNlIiwiY3JlYXRlUGFja2V0UHJvbWlzZSIsIm9wQ29kZSIsIk9wZXJhdGlvbnMiLCJNQUtFX0RJUiIsImhlYWRlclBheWxvYWQiLCJCdWZmZXIiLCJmcm9tIiwid3JpdGUiLCJyZXMiLCJjaGVja1N0YXR1cyIsImRlbGV0ZURpcmVjdG9yeSIsIlJFTU9WRV9QQVRIX0FORF9DT05URU5UUyIsImxpc3REaXJlY3RvcnkiLCJSRUFEX0RJUiIsIkRBVEEiLCJwYXJzZUFycmF5IiwiY29udGVudCIsIm9wZW5GaWxlIiwibW9kZSIsInBhdGhQYXlsb2FkIiwiZmlsZU1vZGVQYXlsb2FkIiwiYWxsb2MiLCJ3cml0ZVVJbnQzMkxFIiwiRklMRV9PUEVOIiwiY29uY2F0IiwiRklMRV9PUEVOX1JFUyIsInJlYWRVSW50MzJMRSIsImNyZWF0ZVdyaXRlU3RyZWFtIiwiZmlsZVBhdGgiLCJvcHRpb25zIiwiZmlsZUhhbmRsZSIsIkZpbGVNb2RlcyIsInciLCJBZmNXcml0YWJsZUZpbGVTdHJlYW0iLCJjcmVhdGVSZWFkU3RyZWFtIiwiciIsIkFmY1JlYWRhYmxlRmlsZVN0cmVhbSIsImNsb3NlRmlsZUhhbmRsZSIsImZpbGVIYW5kZSIsIkZJTEVfQ0xPU0UiLCJ3cml0ZUZpbGUiLCJidWZmZXIiLCJGSUxFX1dSSVRFIiwicmVhZEZpbGUiLCJsZW5ndGgiLCJGSUxFX1JFQUQiLCJnZXRGaWxlSW5mbyIsIkdFVF9GSUxFX0lORk8iLCJwYXJzZU9iamVjdCIsIlNUQVRVUyIsIkVycm9yIiwiaXNFbXB0eSIsIkVycm9ycyIsIlNVQ0NFU1MiLCJpdGVtcyIsInN0YXJ0IiwiZW5kIiwiaXRlbSIsInRvU3RyaW5nIiwicHVzaCIsImN1cnJlbnRLZXkiLCJpc05pbCIsInRpbWVvdXQiLCJCIiwicmVzb2x2ZSIsInJlamVjdCIsInNldFRpbWVvdXQiLCJjbG9zZSIsImRlc3Ryb3kiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUEsTUFBTUEsZ0JBQWdCLEdBQUcsZUFBekI7O0FBRUEsTUFBTUMsbUJBQW1CLEdBQUcsSUFBNUI7O0FBRUEsTUFBTUMsVUFBTixDQUFpQjtBQUVmQyxFQUFBQSxXQUFXLENBQUVDLFlBQUYsRUFBZ0I7QUFDekIsU0FBS0MsYUFBTCxHQUFxQkQsWUFBckI7QUFDQSxTQUFLRSxTQUFMLEdBQWlCLElBQUlDLDRCQUFKLENBQXdCLElBQXhCLEVBQThCQyxhQUE5QixFQUFrQyxDQUFsQyxFQUFxQyxDQUFyQyxFQUF3QyxDQUFDLENBQXpDLENBQWpCO0FBQ0EsU0FBS0MsUUFBTCxHQUFnQixJQUFJQyxtQkFBSixFQUFoQjs7QUFDQSxTQUFLTCxhQUFMLENBQW1CTSxJQUFuQixDQUF3QixLQUFLTCxTQUE3QixFQUF3Q0ssSUFBeEMsQ0FBNkMsS0FBS0YsUUFBbEQ7O0FBRUEsU0FBS0csUUFBTCxHQUFnQixJQUFJQyxtQkFBSixFQUFoQjs7QUFDQSxTQUFLRCxRQUFMLENBQWNELElBQWQsQ0FBbUIsS0FBS04sYUFBeEI7O0FBRUEsU0FBS1Msa0JBQUwsR0FBMEIsRUFBMUI7QUFFQSxTQUFLQyxhQUFMLEdBQXFCLENBQXJCOztBQUNBLFNB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QVEsRUFBcEUsQ0FBRCxDQUFiLEVBQXVGQSxPQUF2RixDQUFWO0FBQ0QsS0FIZ0IsQ0FBakI7QUFJQSxXQUFPO0FBQUVwRSxNQUFBQSxZQUFGO0FBQWdCSyxNQUFBQTtBQUFoQixLQUFQO0FBQ0Q7O0FBRURvRSxFQUFBQSxLQUFLLEdBQUk7QUFDUCxTQUFLekYsYUFBTCxDQUFtQjBGLE9BQW5CO0FBQ0Q7O0FBdE9jOzs7ZUF5T0Y3RixVIiwic291cmNlc0NvbnRlbnQiOlsiLyogZXNsaW50LWRpc2FibGUgcHJvbWlzZS9wcmVmZXItYXdhaXQtdG8tY2FsbGJhY2tzICovXG5pbXBvcnQgTGVuZ3RoQmFzZWRTcGxpdHRlciBmcm9tICcuLi91dGlsL3RyYW5zZm9ybWVyL2xlbmd0aC1iYXNlZC1zcGxpdHRlcic7XG5pbXBvcnQgeyBPcGVyYXRpb25zLCBvcGVyYXRpb25Db2RlLCBFcnJvcnMsIGVycm9yQ29kZSwgRmlsZU1vZGVzIH0gZnJvbSAnLi9wcm90b2NvbCc7XG5pbXBvcnQgeyBBZmNXcml0YWJsZUZpbGVTdHJlYW0sIEFmY1JlYWRhYmxlRmlsZVN0cmVhbSB9IGZyb20gJy4vc3RyZWFtcyc7XG5pbXBvcnQgQWZjRW5jb2RlciBmcm9tICcuL3RyYW5zZm9ybWVyL2FmY2VuY29kZXInO1xuaW1wb3J0IEFmY0RlY29kZXIgZnJvbSAnLi90cmFuc2Zvcm1lci9hZmNkZWNvZGVyJztcbmltcG9ydCB7IE1CIH0gZnJvbSAnLi4vY29uc3RhbnRzJztcbmltcG9ydCBCIGZyb20gJ2JsdWViaXJkJztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5cbmNvbnN0IEFGQ19TRVJWSUNFX05BTUUgPSAnY29tLmFwcGxlLmFmYyc7XG5cbmNvbnN0IE5VTExfREVMSU1FVEVSX0NPREUgPSAweDAwO1xuXG5jbGFzcyBBZmNTZXJ2aWNlIHtcblxuICBjb25zdHJ1Y3RvciAoc29ja2V0Q2xpZW50KSB7XG4gICAgdGhpcy5fc29ja2V0Q2xpZW50ID0gc29ja2V0Q2xpZW50O1xuICAgIHRoaXMuX3NwbGl0dGVyID0gbmV3IExlbmd0aEJhc2VkU3BsaXR0ZXIodHJ1ZSwgTUIsIDgsIDgsIC04KTtcbiAgICB0aGlzLl9kZWNvZGVyID0gbmV3IEFmY0RlY29kZXIoKTtcbiAgICB0aGlzLl9zb2NrZXRDbGllbnQucGlwZSh0aGlzLl9zcGxpdHRlcikucGlwZSh0aGlzLl9kZWNvZGVyKTtcblxuICAgIHRoaXMuX2VuY29kZXIgPSBuZXcgQWZjRW5jb2RlcigpO1xuICAgIHRoaXMuX2VuY29kZXIucGlwZSh0aGlzLl9zb2NrZXRDbGllbnQpO1xuXG4gICAgdGhpcy5fcmVzcG9uc2VDYWxsYmFja3MgPSB7fTtcblxuICAgIHRoaXMuX3BhY2tldE51bWJlciA9IDA7XG4gICAgdGhpcy5fZGVjb2Rlci5vbignZGF0YScsIHRoaXMuX2hhbmRsZURhdGEuYmluZCh0aGlzKSk7XG4gIH1cblxuICBfaGFuZGxlRGF0YSAoZGF0YSkge1xuICAgIGNvbnN0IGNiID0gdGhpcy5fcmVzcG9uc2VDYWxsYmFja3NbZGF0YS5wYWNrZXROdW1iZXJdO1xuICAgIGlmICghXy5pc0Z1bmN0aW9uKGNiKSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBjYihkYXRhKTtcbiAgfVxuXG4gIGFzeW5jIGNyZWF0ZURpcmVjdG9yeSAocGF0aCkge1xuICAgIGNvbnN0IHtwYWNrZXROdW1iZXIsIHJlc3BvbnNlfSA9IHRoaXMuY3JlYXRlUGFja2V0UHJvbWlzZSgpO1xuXG4gICAgY29uc3QgZGF0YSA9IHtcbiAgICAgIG9wQ29kZTogT3BlcmF0aW9ucy5NQUtFX0RJUixcbiAgICAgIHBhY2tldE51bWJlcixcbiAgICAgIGhlYWRlclBheWxvYWQ6IEJ1ZmZlci5mcm9tKHBhdGgpXG4gICAgfTtcbiAgICB0aGlzLl9lbmNvZGVyLndyaXRlKGRhdGEpO1xuICAgIGNvbnN0IHJlcyA9IGF3YWl0IHJlc3BvbnNlO1xuICAgIHRoaXMuY2hlY2tTdGF0dXMocmVzKTtcbiAgfVxuXG4gIGFzeW5jIGRlbGV0ZURpcmVjdG9yeSAocGF0aCkge1xuICAgIGNvbnN0IHtwYWNrZXROdW1iZXIsIHJlc3BvbnNlfSA9IHRoaXMuY3JlYXRlUGFja2V0UHJvbWlzZSgpO1xuXG4gICAgY29uc3QgZGF0YSA9IHtcbiAgICAgIG9wQ29kZTogT3BlcmF0aW9ucy5SRU1PVkVfUEFUSF9BTkRfQ09OVEVOVFMsXG4gICAgICBwYWNrZXROdW1iZXIsXG4gICAgICBoZWFkZXJQYXlsb2FkOiBCdWZmZXIuZnJvbShwYXRoKVxuICAgIH07XG4gICAgdGhpcy5fZW5jb2Rlci53cml0ZShkYXRhKTtcbiAgICBjb25zdCByZXMgPSBhd2FpdCByZXNwb25zZTtcbiAgICB0aGlzLmNoZWNrU3RhdHVzKHJlcyk7XG4gIH1cblxuICBhc3luYyBsaXN0RGlyZWN0b3J5IChwYXRoKSB7XG4gICAgY29uc3Qge3BhY2tldE51bWJlciwgcmVzcG9uc2V9ID0gdGhpcy5jcmVhdGVQYWNrZXRQcm9taXNlKCk7XG5cbiAgICBjb25zdCBkYXRhID0ge1xuICAgICAgb3BDb2RlOiBPcGVyYXRpb25zLlJFQURfRElSLFxuICAgICAgcGFja2V0TnVtYmVyLFxuICAgICAgaGVhZGVyUGF5bG9hZDogQnVmZmVyLmZyb20ocGF0aClcbiAgICB9O1xuICAgIHRoaXMuX2VuY29kZXIud3JpdGUoZGF0YSk7XG4gICAgY29uc3QgcmVzID0gYXdhaXQgcmVzcG9uc2U7XG4gICAgaWYgKHJlcy5vcENvZGUgIT09IE9wZXJhdGlvbnMuREFUQSkge1xuICAgICAgdGhpcy5jaGVja1N0YXR1cyhyZXMpO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzLnBhcnNlQXJyYXkocmVzLmNvbnRlbnQpO1xuICB9XG5cbiAgYXN5bmMgb3BlbkZpbGUgKHBhdGgsIG1vZGUpIHtcbiAgICBjb25zdCB7cGFja2V0TnVtYmVyLCByZXNwb25zZX0gPSB0aGlzLmNyZWF0ZVBhY2tldFByb21pc2UoKTtcblxuICAgIGNvbnN0IHBhdGhQYXlsb2FkID0gQnVmZmVyLmZyb20ocGF0aCk7XG4gICAgY29uc3QgZmlsZU1vZGVQYXlsb2FkID0gQnVmZmVyLmFsbG9jKDgpO1xuICAgIGZpbGVNb2RlUGF5bG9hZC53cml0ZVVJbnQzMkxFKG1vZGUsIDApO1xuXG4gICAgY29uc3QgZGF0YSA9IHtcbiAgICAgIG9wQ29kZTogT3BlcmF0aW9ucy5GSUxFX09QRU4sXG4gICAgICBwYWNrZXROdW1iZXIsXG4gICAgICBoZWFkZXJQYXlsb2FkOiBCdWZmZXIuY29uY2F0KFtmaWxlTW9kZVBheWxvYWQsIHBhdGhQYXlsb2FkXSlcbiAgICB9O1xuICAgIHRoaXMuX2VuY29kZXIud3JpdGUoZGF0YSk7XG4gICAgY29uc3QgcmVzID0gYXdhaXQgcmVzcG9uc2U7XG4gICAgaWYgKHJlcy5vcENvZGUgIT09IE9wZXJhdGlvbnMuRklMRV9PUEVOX1JFUykge1xuICAgICAgdGhpcy5jaGVja1N0YXR1cyhyZXMpO1xuICAgIH1cblxuICAgIHJldHVybiByZXMuaGVhZGVyUGF5bG9hZC5yZWFkVUludDMyTEUoMCk7XG4gIH1cblxuICBhc3luYyBjcmVhdGVXcml0ZVN0cmVhbSAoZmlsZVBhdGgsIG9wdGlvbnMpIHtcbiAgICBjb25zdCBmaWxlSGFuZGxlID0gYXdhaXQgdGhpcy5vcGVuRmlsZShmaWxlUGF0aCwgRmlsZU1vZGVzLncpO1xuICAgIHJldHVybiBuZXcgQWZjV3JpdGFibGVGaWxlU3RyZWFtKGZpbGVIYW5kbGUsIHRoaXMsIG9wdGlvbnMpO1xuICB9XG5cbiAgYXN5bmMgY3JlYXRlUmVhZFN0cmVhbSAoZmlsZVBhdGgsIG9wdGlvbnMpIHtcbiAgICBjb25zdCBmaWxlSGFuZGxlID0gYXdhaXQgdGhpcy5vcGVuRmlsZShmaWxlUGF0aCwgRmlsZU1vZGVzLnIpO1xuICAgIHJldHVybiBuZXcgQWZjUmVhZGFibGVGaWxlU3RyZWFtKGZpbGVIYW5kbGUsIHRoaXMsIG9wdGlvbnMpO1xuICB9XG5cbiAgYXN5bmMgY2xvc2VGaWxlSGFuZGxlIChmaWxlSGFuZGUpIHtcbiAgICBjb25zdCB7cGFja2V0TnVtYmVyLCByZXNwb25zZX0gPSB0aGlzLmNyZWF0ZVBhY2tldFByb21pc2UoKTtcblxuICAgIGNvbnN0IGZpbGVNb2RlUGF5bG9hZCA9IEJ1ZmZlci5hbGxvYyg4KTtcbiAgICBmaWxlTW9kZVBheWxvYWQud3JpdGVVSW50MzJMRShmaWxlSGFuZGUsIDApO1xuXG4gICAgY29uc3QgZGF0YSA9IHtcbiAgICAgIG9wQ29kZTogT3BlcmF0aW9ucy5GSUxFX0NMT1NFLFxuICAgICAgcGFja2V0TnVtYmVyLFxuICAgICAgaGVhZGVyUGF5bG9hZDogZmlsZU1vZGVQYXlsb2FkXG4gICAgfTtcbiAgICB0aGlzLl9lbmNvZGVyLndyaXRlKGRhdGEpO1xuICAgIGNvbnN0IHJlcyA9IGF3YWl0IHJlc3BvbnNlO1xuICAgIHRoaXMuY2hlY2tTdGF0dXMocmVzKTtcbiAgfVxuXG4gIGFzeW5jIHdyaXRlRmlsZSAoZmlsZUhhbmRlLCBidWZmZXIpIHtcbiAgICBjb25zdCB7cGFja2V0TnVtYmVyLCByZXNwb25zZX0gPSB0aGlzLmNyZWF0ZVBhY2tldFByb21pc2UoKTtcblxuICAgIGNvbnN0IGhlYWRlclBheWxvYWQgPSBCdWZmZXIuYWxsb2MoOCk7XG4gICAgaGVhZGVyUGF5bG9hZC53cml0ZVVJbnQzMkxFKGZpbGVIYW5kZSwgMCk7XG5cbiAgICBjb25zdCBkYXRhID0ge1xuICAgICAgb3BDb2RlOiBPcGVyYXRpb25zLkZJTEVfV1JJVEUsXG4gICAgICBwYWNrZXROdW1iZXIsXG4gICAgICBoZWFkZXJQYXlsb2FkLFxuICAgICAgY29udGVudDogYnVmZmVyXG4gICAgfTtcbiAgICB0aGlzLl9lbmNvZGVyLndyaXRlKGRhdGEpO1xuICAgIGNvbnN0IHJlcyA9IGF3YWl0IHJlc3BvbnNlO1xuICAgIHRoaXMuY2hlY2tTdGF0dXMocmVzKTtcbiAgfVxuXG4gIGFzeW5jIHJlYWRGaWxlIChmaWxlSGFuZGUsIGxlbmd0aCkge1xuICAgIGNvbnN0IHtwYWNrZXROdW1iZXIsIHJlc3BvbnNlfSA9IHRoaXMuY3JlYXRlUGFja2V0UHJvbWlzZSgpO1xuXG4gICAgY29uc3QgaGVhZGVyUGF5bG9hZCA9IEJ1ZmZlci5hbGxvYygxNik7XG4gICAgaGVhZGVyUGF5bG9hZC53cml0ZVVJbnQzMkxFKGZpbGVIYW5kZSwgMCk7XG4gICAgaGVhZGVyUGF5bG9hZC53cml0ZVVJbnQzMkxFKGxlbmd0aCwgOCk7XG5cbiAgICBjb25zdCBkYXRhID0ge1xuICAgICAgb3BDb2RlOiBPcGVyYXRpb25zLkZJTEVfUkVBRCxcbiAgICAgIHBhY2tldE51bWJlcixcbiAgICAgIGhlYWRlclBheWxvYWRcbiAgICB9O1xuICAgIHRoaXMuX2VuY29kZXIud3JpdGUoZGF0YSk7XG4gICAgY29uc3QgcmVzID0gYXdhaXQgcmVzcG9uc2U7XG4gICAgaWYgKHJlcy5vcENvZGUgIT09IE9wZXJhdGlvbnMuREFUQSkge1xuICAgICAgdGhpcy5jaGVja1N0YXR1cyhyZXMpO1xuICAgIH1cbiAgICByZXR1cm4gcmVzLmNvbnRlbnQ7XG4gIH1cblxuICBhc3luYyBnZXRGaWxlSW5mbyAocGF0aCkge1xuICAgIGNvbnN0IHtwYWNrZXROdW1iZXIsIHJlc3BvbnNlfSA9IHRoaXMuY3JlYXRlUGFja2V0UHJvbWlzZSgpO1xuXG4gICAgY29uc3QgZGF0YSA9IHtcbiAgICAgIG9wQ29kZTogT3BlcmF0aW9ucy5HRVRfRklMRV9JTkZPLFxuICAgICAgcGFja2V0TnVtYmVyLFxuICAgICAgaGVhZGVyUGF5bG9hZDogQnVmZmVyLmZyb20ocGF0aClcbiAgICB9O1xuICAgIHRoaXMuX2VuY29kZXIud3JpdGUoZGF0YSk7XG4gICAgY29uc3QgcmVzID0gYXdhaXQgcmVzcG9uc2U7XG4gICAgaWYgKHJlcy5vcENvZGUgIT09IE9wZXJhdGlvbnMuREFUQSkge1xuICAgICAgdGhpcy5jaGVja1N0YXR1cyhyZXMpO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5wYXJzZU9iamVjdChyZXMuY29udGVudCk7XG4gIH1cblxuICBjaGVja1N0YXR1cyAocmVzKSB7XG4gICAgaWYgKHJlcy5vcENvZGUgIT09IE9wZXJhdGlvbnMuU1RBVFVTKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFVuZXhwZWN0ZWQgcmVzcG9uc2UgJHtvcGVyYXRpb25Db2RlKHJlcy5vcENvZGUpfWApO1xuICAgIH1cbiAgICBpZiAoXy5pc0VtcHR5KHJlcy5oZWFkZXJQYXlsb2FkKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdIZWFkZXIgcGF5bG9hZCBjYW50IGJlIGVtcHR5IGZvciBhIHN0YXR1cyByZXNwb25zZScpO1xuICAgIH1cbiAgICBpZiAocmVzLmhlYWRlclBheWxvYWRbMF0gIT09IEVycm9ycy5TVUNDRVNTKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFVuZXhwZWN0ZWQgcmVzcG9uc2UgJHtlcnJvckNvZGUocmVzLmhlYWRlclBheWxvYWRbMF0pfWApO1xuICAgIH1cbiAgfVxuXG4gIHBhcnNlQXJyYXkgKGJ1ZmZlcikge1xuICAgIGNvbnN0IGl0ZW1zID0gW107XG4gICAgbGV0IHN0YXJ0ID0gMDtcbiAgICBmb3IgKGxldCBlbmQgPSAwOyBlbmQgPCBidWZmZXIubGVuZ3RoOyBlbmQrKykge1xuICAgICAgaWYgKGJ1ZmZlcltlbmRdICE9PSBOVUxMX0RFTElNRVRFUl9DT0RFKSB7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuICAgICAgY29uc3QgaXRlbSA9IGJ1ZmZlci50b1N0cmluZygndXRmOCcsIHN0YXJ0LCBlbmQpO1xuICAgICAgaXRlbXMucHVzaChpdGVtKTtcbiAgICAgIC8vIFdlIHNraXAgdGhlIG51bGwgZGVsaW1ldGVyXG4gICAgICBzdGFydCA9IGVuZCArIDE7XG4gICAgfVxuICAgIHJldHVybiBpdGVtcztcbiAgfVxuXG4gIHBhcnNlT2JqZWN0IChidWZmZXIpIHtcbiAgICBjb25zdCBpdGVtcyA9IHt9O1xuICAgIGxldCBzdGFydCA9IDA7XG4gICAgbGV0IGN1cnJlbnRLZXk7XG4gICAgZm9yIChsZXQgZW5kID0gMDsgZW5kIDwgYnVmZmVyLmxlbmd0aDsgZW5kKyspIHtcbiAgICAgIGlmIChidWZmZXJbZW5kXSAhPT0gTlVMTF9ERUxJTUVURVJfQ09ERSkge1xuICAgICAgICBjb250aW51ZTtcbiAgICAgIH1cbiAgICAgIGNvbnN0IGl0ZW0gPSBidWZmZXIudG9TdHJpbmcoJ3V0ZjgnLCBzdGFydCwgZW5kKTtcbiAgICAgIGlmIChfLmlzTmlsKGN1cnJlbnRLZXkpKSB7XG4gICAgICAgIGN1cnJlbnRLZXkgPSBpdGVtO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgaXRlbXNbY3VycmVudEtleV0gPSBpdGVtO1xuICAgICAgICBjdXJyZW50S2V5ID0gbnVsbDtcbiAgICAgIH1cbiAgICAgIC8vIFdlIHNraXAgdGhlIG51bGwgZGVsaW1ldGVyXG4gICAgICBzdGFydCA9IGVuZCArIDE7XG4gICAgfVxuICAgIGlmIChjdXJyZW50S2V5KSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYEZhaWxlZCB0byBwYXJzZSBjb3JyZWN0bHkgJHtidWZmZXJ9LiBQbGVhc2UgaW52ZXN0aWdhdGVgKTtcbiAgICB9XG4gICAgcmV0dXJuIGl0ZW1zO1xuICB9XG5cbiAgY3JlYXRlUGFja2V0UHJvbWlzZSAodGltZW91dCA9IDEwMDAwKSB7XG4gICAgY29uc3QgcGFja2V0TnVtYmVyID0gdGhpcy5fcGFja2V0TnVtYmVyKys7XG4gICAgY29uc3QgcmVzcG9uc2UgPSBuZXcgQigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICB0aGlzLl9yZXNwb25zZUNhbGxiYWNrc1twYWNrZXROdW1iZXJdID0gKGRhdGEpID0+IHJlc29sdmUoZGF0YSk7XG4gICAgICBzZXRUaW1lb3V0KCgpID0+IHJlamVjdChuZXcgRXJyb3IoYEZhaWxlZCB0byByZWNlaXZlIGFueSBkYXRhIHdpdGhpbiB0aGUgdGltZW91dDogJHt0aW1lb3V0fWApKSwgdGltZW91dCk7XG4gICAgfSk7XG4gICAgcmV0dXJuIHsgcGFja2V0TnVtYmVyLCByZXNwb25zZSB9O1xuICB9XG5cbiAgY2xvc2UgKCkge1xuICAgIHRoaXMuX3NvY2tldENsaWVudC5kZXN0cm95KCk7XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgQWZjU2VydmljZTtcbmV4cG9ydCB7IEFmY1NlcnZpY2UsIEFGQ19TRVJWSUNFX05BTUUgfTtcbiJdLCJmaWxlIjoibGliL2FmYy9pbmRleC5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9
