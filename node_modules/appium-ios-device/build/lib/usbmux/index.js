"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.Usbmux = void 0;

require("source-map-support/register");

var _net = _interopRequireDefault(require("net"));

var _lodash = _interopRequireDefault(require("lodash"));

var _bluebird = _interopRequireDefault(require("bluebird"));

var _appiumSupport = require("appium-support");

var _lengthBasedSplitter = _interopRequireDefault(require("../util/transformer/length-based-splitter"));

var _usbmuxDecoder = _interopRequireDefault(require("./transformer/usbmux-decoder.js"));

var _usbmuxEncoder = _interopRequireDefault(require("./transformer/usbmux-encoder.js"));

var _path = _interopRequireDefault(require("path"));

var _plistService = _interopRequireDefault(require("../plist-service"));

var _lockdown = require("../lockdown");

const USBMUX_RESULT = {
  OK: 0,
  BADCOMMAND: 1,
  BADDEV: 2,
  CONNREFUSED: 3
};
let name, version;

try {
  ({
    name,
    version
  } = require(_path.default.resolve(__dirname, '..', '..', '..', 'package.json')));
} catch (err) {
  ({
    name,
    version
  } = require(_path.default.resolve(__dirname, '..', '..', 'package.json')));
}

const DEFAULT_USBMUXD_SOCKET = '/var/run/usbmuxd';
const PROG_NAME = name;
const CLIENT_VERSION_STRING = `${name}-${version}`;

function swap16(val) {
  return (val & 0xFF) << 8 | val >> 8 & 0xFF;
}

class Usbmux {
  constructor(socketClient = _net.default.createConnection(DEFAULT_USBMUXD_SOCKET)) {
    this._socketClient = socketClient;
    this._decoder = new _usbmuxDecoder.default();
    this._splitter = new _lengthBasedSplitter.default(true, 1000000, 0, 4, 0);

    this._socketClient.pipe(this._splitter).pipe(this._decoder);

    this._encoder = new _usbmuxEncoder.default();

    this._encoder.pipe(this._socketClient);
  }

  async readBUID(timeout = 5000) {
    const receivePromise = this.receivePlistPromise(timeout);
    this.sendPlist({
      MessageType: 'ReadBUID',
      ProgName: PROG_NAME,
      ClientVersionString: CLIENT_VERSION_STRING
    });
    const data = await receivePromise;

    if (data.payload.BUID) {
      return data.payload.BUID;
    } else {
      throw new Error(`Unexpected data: ${JSON.stringify(data)}`);
    }
  }

  async readPairRecord(udid, timeout = 5000) {
    const receivePromise = this.receivePlistPromise(timeout);
    this.sendPlist({
      MessageType: 'ReadPairRecord',
      PairRecordID: udid,
      ProgName: PROG_NAME,
      ClientVersionString: CLIENT_VERSION_STRING
    });
    const data = await receivePromise;

    if (data.payload.PairRecordData) {
      try {
        return _appiumSupport.plist.parsePlist(data.payload.PairRecordData);
      } catch (err) {
        throw new Error(`Unexpected data: ${JSON.stringify(data)}`);
      }
    } else {
      return null;
    }
  }

  sendPlist(json) {
    this._encoder.write(json);
  }

  receivePlistPromise(timeout = 5000) {
    return new _bluebird.default((resolve, reject) => {
      this._decoder.once('data', resolve);

      setTimeout(() => reject(new Error(`Failed to receive any data within the timeout: ${timeout}`)), timeout);
    });
  }

  async listDevices(timeout = 5000) {
    const receivePromise = this.receivePlistPromise(timeout);
    this.sendPlist({
      MessageType: 'ListDevices',
      ProgName: PROG_NAME,
      ClientVersionString: CLIENT_VERSION_STRING
    });
    const data = await receivePromise;

    if (data.payload.DeviceList) {
      return data.payload.DeviceList;
    } else {
      throw new Error(`Unexpected data: ${JSON.stringify(data)}`);
    }
  }

  async findDevice(udid) {
    let devices = await this.listDevices();
    return _lodash.default.find(devices, device => device.Properties.SerialNumber === udid);
  }

  async connectLockdown(udid) {
    let device = await this.findDevice(udid);

    if (!device) {
      throw new Error(`Could not find the expected device '${udid}'`);
    }

    let plistService = new _plistService.default((await this.connect(device.Properties.DeviceID, _lockdown.LOCKDOWN_PORT)));
    return new _lockdown.Lockdown(plistService);
  }

  async connect(deviceID, port, timeout = 5000) {
    const receivePromise = this.receivePlistPromise(timeout);
    this.sendPlist({
      MessageType: 'Connect',
      ProgName: PROG_NAME,
      ClientVersionString: CLIENT_VERSION_STRING,
      DeviceID: deviceID,
      PortNumber: swap16(port)
    });
    const data = await receivePromise;

    if (data.payload.MessageType !== 'Result') {
      throw new Error(`Unexpected data: ${JSON.stringify(data)}`);
    }

    if (data.payload.Number === USBMUX_RESULT.OK) {
      this._socketClient.unpipe(this._splitter);

      this._splitter.unpipe(this._decoder);

      return this._socketClient;
    } else if (data.payload.Number === USBMUX_RESULT.CONNREFUSED) {
      throw new Error(`Connection was refused to port ${port}`);
    } else {
      throw new Error(`Unexpected data: ${JSON.stringify(data)}`);
    }
  }

  close() {
    this._socketClient.destroy();
  }

}

exports.Usbmux = Usbmux;
var _default = Usbmux;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi91c2JtdXgvaW5kZXguanMiXSwibmFtZXMiOlsiVVNCTVVYX1JFU1VMVCIsIk9LIiwiQkFEQ09NTUFORCIsIkJBRERFViIsIkNPTk5SRUZVU0VEIiwibmFtZSIsInZlcnNpb24iLCJyZXF1aXJlIiwicGF0aCIsInJlc29sdmUiLCJfX2Rpcm5hbWUiLCJlcnIiLCJERUZBVUxUX1VTQk1VWERfU09DS0VUIiwiUFJPR19OQU1FIiwiQ0xJRU5UX1ZFUlNJT05fU1RSSU5HIiwic3dhcDE2IiwidmFsIiwiVXNibXV4IiwiY29uc3RydWN0b3IiLCJzb2NrZXRDbGllbnQiLCJuZXQiLCJjcmVhdGVDb25uZWN0aW9uIiwiX3NvY2tldENsaWVudCIsIl9kZWNvZGVyIiwiVXNibXV4RGVjb2RlciIsIl9zcGxpdHRlciIsIkxlbmd0aEJhc2VkU3BsaXR0ZXIiLCJwaXBlIiwiX2VuY29kZXIiLCJVc2JtdXhFbmNvZGVyIiwicmVhZEJVSUQiLCJ0aW1lb3V0IiwicmVjZWl2ZVByb21pc2UiLCJyZWNlaXZlUGxpc3RQcm9taXNlIiwic2VuZFBsaXN0IiwiTWVzc2FnZVR5cGUiLCJQcm9nTmFtZSIsIkNsaWVudFZlcnNpb25TdHJpbmciLCJkYXRhIiwicGF5bG9hZCIsIkJVSUQiLCJFcnJvciIsIkpTT04iLCJzdHJpbmdpZnkiLCJyZWFkUGFpclJlY29yZCIsInVkaWQiLCJQYWlyUmVjb3JkSUQiLCJQYWlyUmVjb3JkRGF0YSIsInBsaXN0IiwicGFyc2VQbGlzdCIsImpzb24iLCJ3cml0ZSIsIkIiLCJyZWplY3QiLCJvbmNlIiwic2V0VGltZW91dCIsImxpc3REZXZpY2VzIiwiRGV2aWNlTGlzdCIsImZpbmREZXZpY2UiLCJkZXZpY2VzIiwiXyIsImZpbmQiLCJkZXZpY2UiLCJQcm9wZXJ0aWVzIiwiU2VyaWFsTnVtYmVyIiwiY29ubmVjdExvY2tkb3duIiwicGxpc3RTZXJ2aWNlIiwiUGxpc3RTZXJ2aWNlIiwiY29ubmVjdCIsIkRldmljZUlEIiwiTE9DS0RPV05fUE9SVCIsIkxvY2tkb3duIiwiZGV2aWNlSUQiLCJwb3J0IiwiUG9ydE51bWJlciIsIk51bWJlciIsInVucGlwZSIsImNsb3NlIiwiZGVzdHJveSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFFQSxNQUFNQSxhQUFhLEdBQUc7QUFDcEJDLEVBQUFBLEVBQUUsRUFBRSxDQURnQjtBQUVwQkMsRUFBQUEsVUFBVSxFQUFFLENBRlE7QUFHcEJDLEVBQUFBLE1BQU0sRUFBRSxDQUhZO0FBSXBCQyxFQUFBQSxXQUFXLEVBQUU7QUFKTyxDQUF0QjtBQU9BLElBQUlDLElBQUosRUFBVUMsT0FBVjs7QUFDQSxJQUFJO0FBRUYsR0FBQztBQUFFRCxJQUFBQSxJQUFGO0FBQVFDLElBQUFBO0FBQVIsTUFBb0JDLE9BQU8sQ0FBQ0MsY0FBS0MsT0FBTCxDQUFhQyxTQUFiLEVBQXdCLElBQXhCLEVBQThCLElBQTlCLEVBQW9DLElBQXBDLEVBQTBDLGNBQTFDLENBQUQsQ0FBNUI7QUFDRCxDQUhELENBR0UsT0FBT0MsR0FBUCxFQUFZO0FBRVosR0FBQztBQUFFTixJQUFBQSxJQUFGO0FBQVFDLElBQUFBO0FBQVIsTUFBb0JDLE9BQU8sQ0FBQ0MsY0FBS0MsT0FBTCxDQUFhQyxTQUFiLEVBQXdCLElBQXhCLEVBQThCLElBQTlCLEVBQW9DLGNBQXBDLENBQUQsQ0FBNUI7QUFDRDs7QUFFRCxNQUFNRSxzQkFBc0IsR0FBRyxrQkFBL0I7QUFDQSxNQUFNQyxTQUFTLEdBQUdSLElBQWxCO0FBQ0EsTUFBTVMscUJBQXFCLEdBQUksR0FBRVQsSUFBSyxJQUFHQyxPQUFRLEVBQWpEOztBQUVBLFNBQVNTLE1BQVQsQ0FBaUJDLEdBQWpCLEVBQXNCO0FBQ3BCLFNBQVEsQ0FBQ0EsR0FBRyxHQUFHLElBQVAsS0FBZ0IsQ0FBakIsR0FBd0JBLEdBQUcsSUFBSSxDQUFSLEdBQWEsSUFBM0M7QUFDRDs7QUFFRCxNQUFNQyxNQUFOLENB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LEtBQUosQ0FBVyxvQkFBbUJDLElBQUksQ0FBQ0MsU0FBTCxDQUFlTCxJQUFmLENBQXFCLEVBQW5ELENBQU47QUFDRDtBQUNGOztBQUVEdUMsRUFBQUEsS0FBSyxHQUFJO0FBQ1AsU0FBS3ZELGFBQUwsQ0FBbUJ3RCxPQUFuQjtBQUNEOztBQXpIVTs7O2VBNkhFN0QsTSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBuZXQgZnJvbSAnbmV0JztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgQiBmcm9tICdibHVlYmlyZCc7XG5pbXBvcnQgeyBwbGlzdCB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCBMZW5ndGhCYXNlZFNwbGl0dGVyIGZyb20gJy4uL3V0aWwvdHJhbnNmb3JtZXIvbGVuZ3RoLWJhc2VkLXNwbGl0dGVyJztcbmltcG9ydCBVc2JtdXhEZWNvZGVyIGZyb20gJy4vdHJhbnNmb3JtZXIvdXNibXV4LWRlY29kZXIuanMnO1xuaW1wb3J0IFVzYm11eEVuY29kZXIgZnJvbSAnLi90cmFuc2Zvcm1lci91c2JtdXgtZW5jb2Rlci5qcyc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCBQbGlzdFNlcnZpY2UgZnJvbSAnLi4vcGxpc3Qtc2VydmljZSc7XG5pbXBvcnQgeyBMb2NrZG93biwgTE9DS0RPV05fUE9SVCB9IGZyb20gJy4uL2xvY2tkb3duJztcblxuY29uc3QgVVNCTVVYX1JFU1VMVCA9IHtcbiAgT0s6IDAsXG4gIEJBRENPTU1BTkQ6IDEsXG4gIEJBRERFVjogMixcbiAgQ09OTlJFRlVTRUQ6IDMsXG59O1xuXG5sZXQgbmFtZSwgdmVyc2lvbjtcbnRyeSB7XG4gIC8vIGZpcnN0IHRyeSBhc3N1bWluZyB0aGlzIGlzIGluIHRoZSBgYnVpbGRgIGZvbGRlclxuICAoeyBuYW1lLCB2ZXJzaW9uIH0gPSByZXF1aXJlKHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsICcuLicsICcuLicsICcuLicsICdwYWNrYWdlLmpzb24nKSkpO1xufSBjYXRjaCAoZXJyKSB7XG4gIC8vIHRoZW4gdHJ5IGFzc3VtaW5nIGl0IGlzIG5vdFxuICAoeyBuYW1lLCB2ZXJzaW9uIH0gPSByZXF1aXJlKHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsICcuLicsICcuLicsICdwYWNrYWdlLmpzb24nKSkpO1xufVxuXG5jb25zdCBERUZBVUxUX1VTQk1VWERfU09DS0VUID0gJy92YXIvcnVuL3VzYm11eGQnO1xuY29uc3QgUFJPR19OQU1FID0gbmFtZTtcbmNvbnN0IENMSUVOVF9WRVJTSU9OX1NUUklORyA9IGAke25hbWV9LSR7dmVyc2lvbn1gO1xuXG5mdW5jdGlvbiBzd2FwMTYgKHZhbCkge1xuICByZXR1cm4gKCh2YWwgJiAweEZGKSA8PCA4KSB8ICgodmFsID4+IDgpICYgMHhGRik7XG59XG5cbmNsYXNzIFVzYm11eCB7XG5cbiAgY29uc3RydWN0b3IgKHNvY2tldENsaWVudCA9IG5ldC5jcmVhdGVDb25uZWN0aW9uKERFRkFVTFRfVVNCTVVYRF9TT0NLRVQpKSB7XG4gICAgdGhpcy5fc29ja2V0Q2xpZW50ID0gc29ja2V0Q2xpZW50O1xuXG4gICAgdGhpcy5fZGVjb2RlciA9IG5ldyBVc2JtdXhEZWNvZGVyKCk7XG4gICAgdGhpcy5fc3BsaXR0ZXIgPSBuZXcgTGVuZ3RoQmFzZWRTcGxpdHRlcih0cnVlLCAxMDAwMDAwLCAwLCA0LCAwKTtcbiAgICB0aGlzLl9zb2NrZXRDbGllbnQucGlwZSh0aGlzLl9zcGxpdHRlcikucGlwZSh0aGlzLl9kZWNvZGVyKTtcblxuICAgIHRoaXMuX2VuY29kZXIgPSBuZXcgVXNibXV4RW5jb2RlcigpO1xuICAgIHRoaXMuX2VuY29kZXIucGlwZSh0aGlzLl9zb2NrZXRDbGllbnQpO1xuICB9XG5cbiAgYXN5bmMgcmVhZEJVSUQgKHRpbWVvdXQgPSA1MDAwKSB7XG4gICAgY29uc3QgcmVjZWl2ZVByb21pc2UgPSB0aGlzLnJlY2VpdmVQbGlzdFByb21pc2UodGltZW91dCk7XG5cbiAgICB0aGlzLnNlbmRQbGlzdCh7XG4gICAgICBNZXNzYWdlVHlwZTogJ1JlYWRCVUlEJyxcbiAgICAgIFByb2dOYW1lOiBQUk9HX05BTUUsXG4gICAgICBDbGllbnRWZXJzaW9uU3RyaW5nOiBDTElFTlRfVkVSU0lPTl9TVFJJTkdcbiAgICB9KTtcblxuICAgIGNvbnN0IGRhdGEgPSBhd2FpdCByZWNlaXZlUHJvbWlzZTtcbiAgICBpZiAoZGF0YS5wYXlsb2FkLkJVSUQpIHtcbiAgICAgIHJldHVybiBkYXRhLnBheWxvYWQuQlVJRDtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbmV4cGVjdGVkIGRhdGE6ICR7SlNPTi5zdHJpbmdpZnkoZGF0YSl9YCk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgcmVhZFBhaXJSZWNvcmQgKHVkaWQsIHRpbWVvdXQgPSA1MDAwKSB7XG4gICAgY29uc3QgcmVjZWl2ZVByb21pc2UgPSB0aGlzLnJlY2VpdmVQbGlzdFByb21pc2UodGltZW91dCk7XG5cbiAgICB0aGlzLnNlbmRQbGlzdCh7XG4gICAgICBNZXNzYWdlVHlwZTogJ1JlYWRQYWlyUmVjb3JkJyxcbiAgICAgIFBhaXJSZWNvcmRJRDogdWRpZCxcbiAgICAgIFByb2dOYW1lOiBQUk9HX05BTUUsXG4gICAgICBDbGllbnRWZXJzaW9uU3RyaW5nOiBDTElFTlRfVkVSU0lPTl9TVFJJTkdcbiAgICB9KTtcbiAgICBjb25zdCBkYXRhID0gYXdhaXQgcmVjZWl2ZVByb21pc2U7XG4gICAgaWYgKGRhdGEucGF5bG9hZC5QYWlyUmVjb3JkRGF0YSkge1xuICAgICAgdHJ5IHtcbiAgICAgICAgcmV0dXJuIHBsaXN0LnBhcnNlUGxpc3QoZGF0YS5wYXlsb2FkLlBhaXJSZWNvcmREYXRhKTtcbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFVuZXhwZWN0ZWQgZGF0YTogJHtKU09OLnN0cmluZ2lmeShkYXRhKX1gKTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuICB9XG5cbiAgc2VuZFBsaXN0IChqc29uKSB7XG4gICAgdGhpcy5fZW5jb2Rlci53cml0ZShqc29uKTtcbiAgfVxuXG4gIHJlY2VpdmVQbGlzdFByb21pc2UgKHRpbWVvdXQgPSA1MDAwKSB7XG4gICAgcmV0dXJuIG5ldyBCKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIHRoaXMuX2RlY29kZXIub25jZSgnZGF0YScsIHJlc29sdmUpO1xuICAgICAgc2V0VGltZW91dCgoKSA9PiByZWplY3QobmV3IEVycm9yKGBGYWlsZWQgdG8gcmVjZWl2ZSBhbnkgZGF0YSB3aXRoaW4gdGhlIHRpbWVvdXQ6ICR7dGltZW91dH1gKSksIHRpbWVvdXQpO1xuICAgIH0pO1xuICB9XG5cbiAgYXN5bmMgbGlzdERldmljZXMgKHRpbWVvdXQgPSA1MDAwKSB7XG4gICAgY29uc3QgcmVjZWl2ZVByb21pc2UgPSB0aGlzLnJlY2VpdmVQbGlzdFByb21pc2UodGltZW91dCk7XG5cbiAgICB0aGlzLnNlbmRQbGlzdCh7XG4gICAgICBNZXNzYWdlVHlwZTogJ0xpc3REZXZpY2VzJyxcbiAgICAgIFByb2dOYW1lOiBQUk9HX05BTUUsXG4gICAgICBDbGllbnRWZXJzaW9uU3RyaW5nOiBDTElFTlRfVkVSU0lPTl9TVFJJTkdcbiAgICB9KTtcblxuICAgIGNvbnN0IGRhdGEgPSBhd2FpdCByZWNlaXZlUHJvbWlzZTtcbiAgICBpZiAoZGF0YS5wYXlsb2FkLkRldmljZUxpc3QpIHtcbiAgICAgIHJldHVybiBkYXRhLnBheWxvYWQuRGV2aWNlTGlzdDtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbmV4cGVjdGVkIGRhdGE6ICR7SlNPTi5zdHJpbmdpZnkoZGF0YSl9YCk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgZmluZERldmljZSAodWRpZCkge1xuICAgIGxldCBkZXZpY2VzID0gYXdhaXQgdGhpcy5saXN0RGV2aWNlcygpO1xuICAgIHJldHVybiBfLmZpbmQoZGV2aWNlcywgKGRldmljZSkgPT4gZGV2aWNlLlByb3BlcnRpZXMuU2VyaWFsTnVtYmVyID09PSB1ZGlkKTtcbiAgfVxuXG4gIGFzeW5jIGNvbm5lY3RMb2NrZG93biAodWRpZCkge1xuICAgIGxldCBkZXZpY2UgPSBhd2FpdCB0aGlzLmZpbmREZXZpY2UodWRpZCk7XG4gICAgaWYgKCFkZXZpY2UpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgQ291bGQgbm90IGZpbmQgdGhlIGV4cGVjdGVkIGRldmljZSAnJHt1ZGlkfSdgKTtcbiAgICB9XG4gICAgbGV0IHBsaXN0U2VydmljZSA9IG5ldyBQbGlzdFNlcnZpY2UoYXdhaXQgdGhpcy5jb25uZWN0KGRldmljZS5Qcm9wZXJ0aWVzLkRldmljZUlELCBMT0NLRE9XTl9QT1JUKSk7XG4gICAgcmV0dXJuIG5ldyBMb2NrZG93bihwbGlzdFNlcnZpY2UpO1xuICB9XG5cbiAgYXN5bmMgY29ubmVjdCAoZGV2aWNlSUQsIHBvcnQsIHRpbWVvdXQgPSA1MDAwKSB7XG4gICAgY29uc3QgcmVjZWl2ZVByb21pc2UgPSB0aGlzLnJlY2VpdmVQbGlzdFByb21pc2UodGltZW91dCk7XG5cbiAgICB0aGlzLnNlbmRQbGlzdCh7XG4gICAgICBNZXNzYWdlVHlwZTogJ0Nvbm5lY3QnLFxuICAgICAgUHJvZ05hbWU6IFBST0dfTkFNRSxcbiAgICAgIENsaWVudFZlcnNpb25TdHJpbmc6IENMSUVOVF9WRVJTSU9OX1NUUklORyxcbiAgICAgIERldmljZUlEOiBkZXZpY2VJRCxcbiAgICAgIFBvcnROdW1iZXI6IHN3YXAxNihwb3J0KVxuICAgIH0pO1xuXG4gICAgY29uc3QgZGF0YSA9IGF3YWl0IHJlY2VpdmVQcm9taXNlO1xuICAgIGlmIChkYXRhLnBheWxvYWQuTWVzc2FnZVR5cGUgIT09ICdSZXN1bHQnKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFVuZXhwZWN0ZWQgZGF0YTogJHtKU09OLnN0cmluZ2lmeShkYXRhKX1gKTtcbiAgICB9XG4gICAgaWYgKGRhdGEucGF5bG9hZC5OdW1iZXIgPT09IFVTQk1VWF9SRVNVTFQuT0spIHtcbiAgICAgIHRoaXMuX3NvY2tldENsaWVudC51bnBpcGUodGhpcy5fc3BsaXR0ZXIpO1xuICAgICAgdGhpcy5fc3BsaXR0ZXIudW5waXBlKHRoaXMuX2RlY29kZXIpO1xuICAgICAgcmV0dXJuIHRoaXMuX3NvY2tldENsaWVudDtcbiAgICB9IGVsc2UgaWYgKGRhdGEucGF5bG9hZC5OdW1iZXIgPT09IFVTQk1VWF9SRVNVTFQuQ09OTlJFRlVTRUQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgQ29ubmVjdGlvbiB3YXMgcmVmdXNlZCB0byBwb3J0ICR7cG9ydH1gKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbmV4cGVjdGVkIGRhdGE6ICR7SlNPTi5zdHJpbmdpZnkoZGF0YSl9YCk7XG4gICAgfVxuICB9XG5cbiAgY2xvc2UgKCkge1xuICAgIHRoaXMuX3NvY2tldENsaWVudC5kZXN0cm95KCk7XG4gIH1cbn1cblxuZXhwb3J0IHsgVXNibXV4IH07XG5leHBvcnQgZGVmYXVsdCBVc2JtdXg7XG4iXSwiZmlsZSI6ImxpYi91c2JtdXgvaW5kZXguanMiLCJzb3VyY2VSb290IjoiLi4vLi4vLi4ifQ==
