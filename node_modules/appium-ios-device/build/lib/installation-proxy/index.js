"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.INSTALLATION_PROXY_SERVICE_NAME = exports.InstallationProxyService = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

const INSTALLATION_PROXY_SERVICE_NAME = 'com.apple.mobile.installation_proxy';
exports.INSTALLATION_PROXY_SERVICE_NAME = INSTALLATION_PROXY_SERVICE_NAME;

class InstallationProxyService {
  constructor(plistService) {
    this.plistService = plistService;
  }

  async installApplication(path, clientOptions = {}, timeout = 60000) {
    const request = {
      Command: 'Install',
      PackagePath: path,
      ClientOptions: clientOptions
    };
    this.plistService.sendPlist(request);
    return await this.waitMessageCompletion(timeout);
  }

  async listApplications(opts = {}) {
    const request = {
      Command: 'Browse',
      ClientOptions: {}
    };

    if (opts.applicationType) {
      request.ClientOptions.ApplicationType = opts.applicationType;
    }

    if (opts.returnAttributes) {
      request.ClientOptions.ReturnAttributes = opts.returnAttributes;
    }

    this.plistService.sendPlist(request);
    const messages = await this.waitMessageCompletion();
    return messages.reduce((acc, message) => {
      if (!message.CurrentList) {
        return acc;
      }

      message.CurrentList.forEach(app => {
        acc[app.CFBundleIdentifier] = app;
      });
      return acc;
    }, {});
  }

  async lookupApplications(opts = {}) {
    const request = {
      Command: 'Lookup',
      ClientOptions: {}
    };

    if (opts.bundleIds) {
      request.ClientOptions.BundleIDs = _lodash.default.isString(opts.bundleIds) ? [opts.bundleIds] : opts.bundleIds;
    }

    if (opts.applicationType) {
      request.ClientOptions.ApplicationType = opts.applicationType;
    }

    if (opts.returnAttributes) {
      request.ClientOptions.ReturnAttributes = opts.returnAttributes;
    }

    this.plistService.sendPlist(request);
    const messages = await this.waitMessageCompletion();

    for (const message of messages) {
      if (message.LookupResult) {
        return message.LookupResult;
      }
    }

    throw new Error(`Couldn't find LookupResult in the response: Response: ${JSON.stringify(messages)}`);
  }

  async uninstallApplication(bundleId, timeout = 20000) {
    const request = {
      Command: 'Uninstall',
      ApplicationIdentifier: bundleId
    };
    this.plistService.sendPlist(request);
    return await this.waitMessageCompletion(timeout);
  }

  async waitMessageCompletion(timeout) {
    let messages = [];

    for (let i = 0; i < Number.MAX_SAFE_INTEGER; i++) {
      const data = await this.plistService.receivePlist(timeout);
      messages.push(data);

      if (this.isFinished(data)) {
        return messages;
      }
    }
  }

  isFinished(response) {
    if (response.Error) {
      throw new Error(`Unexpected data: ${JSON.stringify(response)}`);
    }

    if (!response.Status) {
      return false;
    }

    return response.Status === 'Complete';
  }

  close() {
    this.plistService.close();
  }

}

exports.InstallationProxyService = InstallationProxyService;
var _default = InstallationProxyService;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9pbnN0YWxsYXRpb24tcHJveHkvaW5kZXguanMiXSwibmFtZXMiOlsiSU5TVEFMTEFUSU9OX1BST1hZX1NFUlZJQ0VfTkFNRSIsIkluc3RhbGxhdGlvblByb3h5U2VydmljZSIsImNvbnN0cnVjdG9yIiwicGxpc3RTZXJ2aWNlIiwiaW5zdGFsbEFwcGxpY2F0aW9uIiwicGF0aCIsImNsaWVudE9wdGlvbnMiLCJ0aW1lb3V0IiwicmVxdWVzdCIsIkNvbW1hbmQiLCJQYWNrYWdlUGF0aCIsIkNsaWVudE9wdGlvbnMiLCJzZW5kUGxpc3QiLCJ3YWl0TWVzc2FnZUNvbXBsZXRpb24iLCJsaXN0QXBwbGljYXRpb25zIiwib3B0cyIsImFwcGxpY2F0aW9uVHlwZSIsIkFwcGxpY2F0aW9uVHlwZSIsInJldHVybkF0dHJpYnV0ZXMiLCJSZXR1cm5BdHRyaWJ1dGVzIiwibWVzc2FnZXMiLCJyZWR1Y2UiLCJhY2MiLCJtZXNzYWdlIiwiQ3VycmVudExpc3QiLCJmb3JFYWNoIiwiYXBwIiwiQ0ZCdW5kbGVJZGVudGlmaWVyIiwibG9va3VwQXBwbGljYXRpb25zIiwiYnVuZGxlSWRzIiwiQnVuZGxlSURzIiwiXyIsImlzU3RyaW5nIiwiTG9va3VwUmVzdWx0IiwiRXJyb3IiLCJKU09OIiwic3RyaW5naWZ5IiwidW5pbnN0YWxsQXBwbGljYXRpb24iLCJidW5kbGVJZCIsIkFwcGxpY2F0aW9uSWRlbnRpZmllciIsImkiLCJOdW1iZXIiLCJNQVhfU0FGRV9JTlRFR0VSIiwiZGF0YSIsInJlY2VpdmVQbGlzdCIsInB1c2giLCJpc0ZpbmlzaGVkIiwicmVzcG9uc2UiLCJTdGF0dXMiLCJjbG9zZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQTs7QUFFQSxNQUFNQSwrQkFBK0IsR0FBRyxxQ0FBeEM7OztBQUVBLE1BQU1DLHdCQUFOLENBQStCO0FBQzdCQyxFQUFBQSxXQUFXLENBQUVDLFlBQUYsRUFBZ0I7QUFDekIsU0FBS0EsWUFBTCxHQUFvQkEsWUFBcEI7QUFD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U0FBSzlDLFlBQUwsQ0FBa0I4QyxLQUFsQjtBQUNEOztBQTFJNEI7OztlQThJaEJoRCx3QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5cbmNvbnN0IElOU1RBTExBVElPTl9QUk9YWV9TRVJWSUNFX05BTUUgPSAnY29tLmFwcGxlLm1vYmlsZS5pbnN0YWxsYXRpb25fcHJveHknO1xuXG5jbGFzcyBJbnN0YWxsYXRpb25Qcm94eVNlcnZpY2Uge1xuICBjb25zdHJ1Y3RvciAocGxpc3RTZXJ2aWNlKSB7XG4gICAgdGhpcy5wbGlzdFNlcnZpY2UgPSBwbGlzdFNlcnZpY2U7XG4gIH1cblxuICAvKipcbiAgICogSW5zdGFsbCB0aGUgYXBwbGljYXRpb24gb24gdGhlIHJlbGF0aXZlIHBhdGggb24gdGhlIHBob25lXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBwYXRoIFRoZSBwYXRoIHdoZXJlIHRoZSAuYXBwIGFuZCAuaXBhIGlzIGxvY2F0ZWQgYXQgb24gdGhlIHBob25lXG4gICAqIEBwYXJhbSB7T2JqZWN0fSBjbGllbnRPcHRpb25zIFRoZSBleHRyYSBvcHRpb25zIHRoYXQgd2FudHMgdG8gYmUgcGFzc2VkIHRvIHRoZSBpbnN0YWxsZFxuICAgKiBAcGFyYW0ge251bWJlcn0gdGltZW91dCBbNjAwMDBdIFRoZSB0aW1lb3V0IGJldHdlZW4gbWVzc2FnZXMgcmVjZWl2ZWQgZnJvbSB0aGUgcGhvbmUgYXMgc3RhdHVzIHVwZGF0ZXNcbiAgICovXG4gIGFzeW5jIGluc3RhbGxBcHBsaWNhdGlvbiAocGF0aCwgY2xpZW50T3B0aW9ucyA9IHt9LCB0aW1lb3V0ID0gNjAwMDApIHtcbiAgICBjb25zdCByZXF1ZXN0ID0ge1xuICAgICAgQ29tbWFuZDogJ0luc3RhbGwnLFxuICAgICAgUGFja2FnZVBhdGg6IHBhdGgsXG4gICAgICBDbGllbnRPcHRpb25zOiBjbGllbnRPcHRpb25zXG4gICAgfTtcblxuICAgIHRoaXMucGxpc3RTZXJ2aWNlLnNlbmRQbGlzdChyZXF1ZXN0KTtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy53YWl0TWVzc2FnZUNvbXBsZXRpb24odGltZW91dCk7XG4gIH1cblxuICAvKipcbiAqIEB0eXBlZGVmIHtPYmplY3R9IExpc3RBcHBsaWNhdGlvbk9wdGlvbnNcbiAqXG4gKiBAcHJvcGVydHkge3N0cmluZ30gYXBwbGljYXRpb25UeXBlIG9mIHRoZSB3aGljaCBncm91cCB5b3Ugd2FudCB0byBsaXN0LiBUaGVzZSBjYW4gYmUgVXNlciwgU3lzdGVtIG9yIGxlYXZlIGl0IGVtcHR5IGZvciBib3RoXG4gKiBAcHJvcGVydHkge0FycmF5fSByZXR1cm5BdHRyaWJ1dGVzIHRoZSBmaWVsZHMgd2hpY2ggc2hvdWxkIGJlIGZpbHRlcmVkIGFuZCByZXR1cm5lZCB0byB0aGUgY2xpZW50LiBMZWF2ZSB0aGlzIHBhcmFtZXRlciBlbXB0eSBpZiB5b3UgZG9uJ3Qgd2FudCB0byBmaWx0ZXJcbiAqL1xuXG4gIC8qKlxuICAgKiBMaXN0cyBhcHBsaWNhdGlvbnMgYWNjb3JkaW5nIHRvIHRoZSBvcHRzIGFuZCByZXR1cm5zIHRoZW0gYXMgYSBtYXBcbiAgICogQHBhcmFtIHtMaXN0QXBwbGljYXRpb25PcHRpb25zfSBvcHRzIHRoZSBsaXN0aW5nIG9wdGlvbnMgdGhhdCB3YW50cyB0byBiZSBwYXNzZWRcbiAgICogQHJldHVybnMgQSBtYXAgb2YgdGhlIGFwcGxpY2F0aW9ucyB3aGljaCB0aGUga2V5IGlzIHRoZSBidW5kbGVJZFxuICAgKi9cbiAgYXN5bmMgbGlzdEFwcGxpY2F0aW9ucyAob3B0cyA9IHt9KSB7XG4gICAgY29uc3QgcmVxdWVzdCA9IHtcbiAgICAgIENvbW1hbmQ6ICdCcm93c2UnLFxuICAgICAgQ2xpZW50T3B0aW9uczoge31cbiAgICB9O1xuXG4gICAgaWYgKG9wdHMuYXBwbGljYXRpb25UeXBlKSB7XG4gICAgICByZXF1ZXN0LkNsaWVudE9wdGlvbnMuQXBwbGljYXRpb25UeXBlID0gb3B0cy5hcHBsaWNhdGlvblR5cGU7XG4gICAgfVxuICAgIGlmIChvcHRzLnJldHVybkF0dHJpYnV0ZXMpIHtcbiAgICAgIHJlcXVlc3QuQ2xpZW50T3B0aW9ucy5SZXR1cm5BdHRyaWJ1dGVzID0gb3B0cy5yZXR1cm5BdHRyaWJ1dGVzO1xuICAgIH1cblxuICAgIHRoaXMucGxpc3RTZXJ2aWNlLnNlbmRQbGlzdChyZXF1ZXN0KTtcbiAgICBjb25zdCBtZXNzYWdlcyA9IGF3YWl0IHRoaXMud2FpdE1lc3NhZ2VDb21wbGV0aW9uKCk7XG4gICAgcmV0dXJuIG1lc3NhZ2VzLnJlZHVjZSgoYWNjLCBtZXNzYWdlKSA9PiB7XG4gICAgICBpZiAoIW1lc3NhZ2UuQ3VycmVudExpc3QpIHtcbiAgICAgICAgcmV0dXJuIGFjYztcbiAgICAgIH1cbiAgICAgIG1lc3NhZ2UuQ3VycmVudExpc3QuZm9yRWFjaChhcHAgPT4ge1xuICAgICAgICBhY2NbYXBwLkNGQnVuZGxlSWRlbnRpZmllcl0gPSBhcHA7XG4gICAgICB9KTtcbiAgICAgIHJldHVybiBhY2M7XG4gICAgfSwge30pO1xuICB9XG5cbiAgLyoqXG4gKiBAdHlwZWRlZiB7T2JqZWN0fSBMb29rdXBBcHBsaWNhdGlvbk9wdGlvbnNcbiAqXG4gKiBAcHJvcGVydHkge3N0cmluZ30gYXBwbGljYXRpb25UeXBlIG9mIHRoZSB3aGljaCBncm91cCB5b3Ugd2FudCB0byBsaXN0LiBUaGVzZSBjYW4gYmUgVXNlciwgU3lzdGVtIG9yIGxlYXZlIGl0IGVtcHR5IGZvciBib3RoXG4gKiBAcHJvcGVydHkge0FycmF5fSByZXR1cm5BdHRyaWJ1dGVzIHRoZSBmaWVsZHMgd2hpY2ggc2hvdWxkIGJlIGZpbHRlcmVkIGFuZCByZXR1cm5lZCB0byB0aGUgY2xpZW50LiBMZWF2ZSB0aGlzIHBhcmFtZXRlciBlbXB0eSBpZiB5b3UgZG9uJ3Qgd2FudCB0byBmaWx0ZXJcbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfEFycmF5fSBidW5kbGVJZHMgQnVuZGxlIElkcyBvZiB0aGUgYXBwcyB0aGF0IHNob3VsZCBiZSBzZWFyY2hlZFxuICovXG5cbiAgLyoqXG4gICAqIExpc3RzIGFwcGxpY2F0aW9ucyBhY2NvcmRpbmcgdG8gdGhlIG9wdHMgYW5kIHJldHVybnMgdGhlbSBhcyBhIG1hcFxuICAgKiBAcGFyYW0ge0xvb2t1cEFwcGxpY2F0aW9uT3B0aW9uc30gb3B0cyB0aGUgbG9va3VwIG9wdGlvbnMgdGhhdCB3YW50cyB0byBiZSBwYXNzZWRcbiAgICogQHJldHVybnMgQSBtYXAgb2YgdGhlIGFwcGxpY2F0aW9ucyB3aGljaCB0aGUga2V5IGlzIHRoZSBidW5kbGVJZFxuICAgKi9cbiAgYXN5bmMgbG9va3VwQXBwbGljYXRpb25zIChvcHRzID0ge30pIHtcbiAgICBjb25zdCByZXF1ZXN0ID0ge1xuICAgICAgQ29tbWFuZDogJ0xvb2t1cCcsXG4gICAgICBDbGllbnRPcHRpb25zOiB7fVxuICAgIH07XG4gICAgaWYgKG9wdHMuYnVuZGxlSWRzKSB7XG4gICAgICByZXF1ZXN0LkNsaWVudE9wdGlvbnMuQnVuZGxlSURzID0gXy5pc1N0cmluZyhvcHRzLmJ1bmRsZUlkcykgPyBbb3B0cy5idW5kbGVJZHNdIDogb3B0cy5idW5kbGVJZHM7XG4gICAgfVxuICAgIGlmIChvcHRzLmFwcGxpY2F0aW9uVHlwZSkge1xuICAgICAgcmVxdWVzdC5DbGllbnRPcHRpb25zLkFwcGxpY2F0aW9uVHlwZSA9IG9wdHMuYXBwbGljYXRpb25UeXBlO1xuICAgIH1cbiAgICBpZiAob3B0cy5yZXR1cm5BdHRyaWJ1dGVzKSB7XG4gICAgICByZXF1ZXN0LkNsaWVudE9wdGlvbnMuUmV0dXJuQXR0cmlidXRlcyA9IG9wdHMucmV0dXJuQXR0cmlidXRlcztcbiAgICB9XG5cbiAgICB0aGlzLnBsaXN0U2VydmljZS5zZW5kUGxpc3QocmVxdWVzdCk7XG4gICAgY29uc3QgbWVzc2FnZXMgPSBhd2FpdCB0aGlzLndhaXRNZXNzYWdlQ29tcGxldGlvbigpO1xuICAgIGZvciAoY29uc3QgbWVzc2FnZSBvZiBtZXNzYWdlcykge1xuICAgICAgaWYgKG1lc3NhZ2UuTG9va3VwUmVzdWx0KSB7XG4gICAgICAgIHJldHVybiBtZXNzYWdlLkxvb2t1cFJlc3VsdDtcbiAgICAgIH1cbiAgICB9XG4gICAgdGhyb3cgbmV3IEVycm9yKGBDb3VsZG4ndCBmaW5kIExvb2t1cFJlc3VsdCBpbiB0aGUgcmVzcG9uc2U6IFJlc3BvbnNlOiAke0pTT04uc3RyaW5naWZ5KG1lc3NhZ2VzKX1gKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBVbmluc3RhbGxzIGFuIGFwcGxpY2F0aW9uIGFjY29yZGluZyB0byB0aGUgZ2l2ZW4gYnVuZGxlSWRcbiAgICogQHBhcmFtIHtzdHJpbmd9IGJ1bmRsZUlkIG9mIHRoZSBhcHAgdGhhdCBuZWVkcyB0byBiZSBwYXNzZWQgZm9yIHVuaW5zdGFsbGF0aW9uXG4gICAqIEBwYXJhbSB7bnVtYmVyfSB0aW1lb3V0IFRoZSB0aW1lb3V0IGJldHdlZW4gbWVzc2FnZXMgcmVjZWl2ZWQgZnJvbSB0aGUgcGhvbmUgYXMgc3RhdHVzIHVwZGF0ZXNcbiAgICovXG4gIGFzeW5jIHVuaW5zdGFsbEFwcGxpY2F0aW9uIChidW5kbGVJZCwgdGltZW91dCA9IDIwMDAwKSB7XG4gICAgY29uc3QgcmVxdWVzdCA9IHtcbiAgICAgIENvbW1hbmQ6ICdVbmluc3RhbGwnLFxuICAgICAgQXBwbGljYXRpb25JZGVudGlmaWVyOiBidW5kbGVJZFxuICAgIH07XG5cbiAgICB0aGlzLnBsaXN0U2VydmljZS5zZW5kUGxpc3QocmVxdWVzdCk7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMud2FpdE1lc3NhZ2VDb21wbGV0aW9uKHRpbWVvdXQpO1xuICB9XG5cbiAgYXN5bmMgd2FpdE1lc3NhZ2VDb21wbGV0aW9uICh0aW1lb3V0KSB7XG4gICAgbGV0IG1lc3NhZ2VzID0gW107XG4gICAgLy8gSnVzdCBhZGRlZCBmb3Igc2FmZXR5LiBUaGlzIHNob3VsZG4ndCBoYXBwZW5cbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IE51bWJlci5NQVhfU0FGRV9JTlRFR0VSOyBpKyspIHtcbiAgICAgIGNvbnN0IGRhdGEgPSBhd2FpdCB0aGlzLnBsaXN0U2VydmljZS5yZWNlaXZlUGxpc3QodGltZW91dCk7XG4gICAgICBtZXNzYWdlcy5wdXNoKGRhdGEpO1xuICAgICAgaWYgKHRoaXMuaXNGaW5pc2hlZChkYXRhKSkge1xuICAgICAgICByZXR1cm4gbWVzc2FnZXM7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgaXNGaW5pc2hlZCAocmVzcG9uc2UpIHtcbiAgICBpZiAocmVzcG9uc2UuRXJyb3IpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgVW5leHBlY3RlZCBkYXRhOiAke0pTT04uc3RyaW5naWZ5KHJlc3BvbnNlKX1gKTtcbiAgICB9XG5cbiAgICBpZiAoIXJlc3BvbnNlLlN0YXR1cykge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICByZXR1cm4gcmVzcG9uc2UuU3RhdHVzID09PSAnQ29tcGxldGUnO1xuICB9XG5cbiAgY2xvc2UgKCkge1xuICAgIHRoaXMucGxpc3RTZXJ2aWNlLmNsb3NlKCk7XG4gIH1cbn1cblxuZXhwb3J0IHsgSW5zdGFsbGF0aW9uUHJveHlTZXJ2aWNlLCBJTlNUQUxMQVRJT05fUFJPWFlfU0VSVklDRV9OQU1FIH07XG5leHBvcnQgZGVmYXVsdCBJbnN0YWxsYXRpb25Qcm94eVNlcnZpY2U7XG5cbiJdLCJmaWxlIjoibGliL2luc3RhbGxhdGlvbi1wcm94eS9pbmRleC5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9
