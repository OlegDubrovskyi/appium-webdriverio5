"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.helpers = exports.commands = void 0;

require("source-map-support/register");

var _logger = _interopRequireDefault(require("../logger"));

var _os = _interopRequireDefault(require("os"));

var _lodash = _interopRequireDefault(require("lodash"));

var _ws = _interopRequireDefault(require("ws"));

var _appiumBaseDriver = require("appium-base-driver");

const GET_SERVER_LOGS_FEATURE = 'get_server_logs';
let commands = {},
    helpers = {},
    extensions = {};
exports.helpers = helpers;
exports.commands = commands;

const WEBSOCKET_ENDPOINT = sessionId => `${_appiumBaseDriver.DEFAULT_WS_PATHNAME_PREFIX}/session/${sessionId}/appium/device/logcat`;

function toLogRecord(timestamp, level, message) {
  return {
    timestamp,
    level,
    message
  };
}

extensions.supportedLogTypes = {
  logcat: {
    description: 'Logs for Android applications on real device and emulators via ADB',
    getter: async self => await self.adb.getLogcatLogs()
  },
  bugreport: {
    description: `'adb bugreport' output for advanced issues diagnostic`,
    getter: async self => {
      const output = await self.adb.bugreport();
      const timestamp = Date.now();
      return output.split(_os.default.EOL).map(x => toLogRecord(timestamp, 'ALL', x));
    }
  },
  server: {
    description: 'Appium server logs',
    getter: self => {
      self.ensureFeatureEnabled(GET_SERVER_LOGS_FEATURE);
      const timestamp = Date.now();
      return _logger.default.unwrap().record.map(x => toLogRecord(timestamp, 'ALL', _lodash.default.isEmpty(x.prefix) ? x.message : `[${x.prefix}] ${x.message}`));
    }
  }
};

commands.mobileStartLogsBroadcast = async function mobileStartLogsBroadcast() {
  const pathname = WEBSOCKET_ENDPOINT(this.sessionId);

  if (!_lodash.default.isEmpty((await this.server.getWebSocketHandlers(pathname)))) {
    _logger.default.debug(`The logcat broadcasting web socket server is already listening at ${pathname}`);

    return;
  }

  _logger.default.info(`Assigning logcat broadcasting web socket server to ${pathname}`);

  const wss = new _ws.default.Server({
    noServer: true
  });
  wss.on('connection', (ws, req) => {
    if (req) {
      const remoteIp = _lodash.default.isEmpty(req.headers['x-forwarded-for']) ? req.connection.remoteAddress : req.headers['x-forwarded-for'];

      _logger.default.debug(`Established a new logcat listener web socket connection from ${remoteIp}`);
    } else {
      _logger.default.debug('Established a new logcat listener web socket connection');
    }

    if (_lodash.default.isEmpty(this._logcatWebsocketListener)) {
      this._logcatWebsocketListener = logRecord => {
        if (ws && ws.readyState === _ws.default.OPEN) {
          ws.send(logRecord.message);
        }
      };
    }

    this.adb.setLogcatListener(this._logcatWebsocketListener);
    ws.on('close', (code, reason) => {
      if (!_lodash.default.isEmpty(this._logcatWebsocketListener)) {
        try {
          this.adb.removeLogcatListener(this._logcatWebsocketListener);
        } catch (ign) {}

        this._logcatWebsocketListener = null;
      }

      let closeMsg = 'Logcat listener web socket is closed.';

      if (!_lodash.default.isEmpty(code)) {
        closeMsg += ` Code: ${code}.`;
      }

      if (!_lodash.default.isEmpty(reason)) {
        closeMsg += ` Reason: ${reason}.`;
      }

      _logger.default.debug(closeMsg);
    });
  });
  await this.server.addWebSocketHandler(pathname, wss);
};

commands.mobileStopLogsBroadcast = async function mobileStopLogsBroadcast() {
  const pathname = WEBSOCKET_ENDPOINT(this.sessionId);

  if (_lodash.default.isEmpty((await this.server.getWebSocketHandlers(pathname)))) {
    return;
  }

  _logger.default.debug('Stopping the logcat broadcasting web socket server');

  await this.server.removeWebSocketHandler(pathname);
};

Object.assign(extensions, commands, helpers);
var _default = extensions;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9sb2cuanMiXSwibmFtZXMiOlsiR0VUX1NFUlZFUl9MT0dTX0ZFQVRVUkUiLCJjb21tYW5kcyIsImhlbHBlcnMiLCJleHRlbnNpb25zIiwiV0VCU09DS0VUX0VORFBPSU5UIiwic2Vzc2lvbklkIiwiREVGQVVMVF9XU19QQVRITkFNRV9QUkVGSVgiLCJ0b0xvZ1JlY29yZCIsInRpbWVzdGFtcCIsImxldmVsIiwibWVzc2FnZSIsInN1cHBvcnRlZExvZ1R5cGVzIiwibG9nY2F0IiwiZGVzY3JpcHRpb24iLCJnZXR0ZXIiLCJzZWxmIiwiYWRiIiwiZ2V0TG9nY2F0TG9ncyIsImJ1Z3JlcG9ydCIsIm91dHB1dCIsIkRhdGUiLCJub3ciLCJzcGxpdCIsIm9zIiwiRU9MIiwibWFwIiwieCIsInNlcnZlciIsImVuc3VyZUZlYXR1cmVFbmFibGVkIiwibG9nIiwidW53cmFwIiwicmVjb3JkIiwiXyIsImlzRW1wdHkiLCJwcmVmaXgiLCJtb2JpbGVTdGFydExvZ3NCcm9hZGNhc3QiLCJwYXRobmFtZSIsImdldFdlYlNvY2tldEhhbmRsZXJzIiwiZGVidWciLCJpbmZvIiwid3NzIiwiV2ViU29ja2V0IiwiU2VydmVyIiwibm9TZXJ2ZXIiLCJvbiIsIndzIiwicmVxIiwicmVtb3RlSXAiLCJoZWFkZXJzIiwiY29ubmVjdGlvbiIsInJlbW90ZUFkZHJlc3MiLCJfbG9nY2F0V2Vic29ja2V0TGlzdGVuZXIiLCJsb2dSZWNvcmQiLCJyZWFkeVN0YXRlIiwiT1BFTiIsInNlbmQiLCJzZXRMb2djYXRMaXN0ZW5lciIsImNvZGUiLCJyZWFzb24iLCJyZW1vdmVMb2djYXRMaXN0ZW5lciIsImlnbiIsImNsb3NlTXNnIiwiYWRkV2ViU29ja2V0SGFuZGxlciIsIm1vYmlsZVN0b3BMb2dzQnJvYWRjYXN0IiwicmVtb3ZlV2ViU29ja2V0SGFuZGxlciIsIk9iamVjdCIsImFzc2lnbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7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QUFPLEdBQS9CO0FBQ0Q7O0FBQ0Q3QixzQkFBSVMsS0FBSixDQUFVdUIsUUFBVjtBQUNELEtBaEJEO0FBaUJELEdBcENEO0FBcUNBLFFBQU0sS0FBS2xDLE1BQUwsQ0FBWW1DLG1CQUFaLENBQWdDMUIsUUFBaEMsRUFBMENJLEdBQTFDLENBQU47QUFDRCxDQWxERDs7QUF3REF2QyxRQUFRLENBQUM4RCx1QkFBVCxHQUFtQyxlQUFlQSx1QkFBZixHQUEwQztBQUMzRSxRQUFNM0IsUUFBUSxHQUFHaEMsa0JBQWtCLENBQUMsS0FBS0MsU0FBTixDQUFuQzs7QUFDQSxNQUFJMkIsZ0JBQUVDLE9BQUYsRUFBVSxNQUFNLEtBQUtOLE1BQUwsQ0FBWVUsb0JBQVosQ0FBaUNELFFBQWpDLENBQWhCLEVBQUosRUFBaUU7QUFDL0Q7QUFDRDs7QUFFRFAsa0JBQUlTLEtBQUosQ0FBVSxvREFBVjs7QUFDQSxRQUFNLEtBQUtYLE1BQUwsQ0FBWXFDLHNCQUFaLENBQW1DNUIsUUFBbkMsQ0FBTjtBQUNELENBUkQ7O0FBVUE2QixNQUFNLENBQUNDLE1BQVAsQ0FBYy9ELFVBQWQsRUFBMEJGLFFBQTFCLEVBQW9DQyxPQUFwQztlQUVlQyxVIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGxvZyBmcm9tICcuLi9sb2dnZXInO1xuaW1wb3J0IG9zIGZyb20gJ29zJztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgV2ViU29ja2V0IGZyb20gJ3dzJztcbmltcG9ydCB7IERFRkFVTFRfV1NfUEFUSE5BTUVfUFJFRklYIH0gZnJvbSAnYXBwaXVtLWJhc2UtZHJpdmVyJztcblxuY29uc3QgR0VUX1NFUlZFUl9MT0dTX0ZFQVRVUkUgPSAnZ2V0X3NlcnZlcl9sb2dzJztcblxubGV0IGNvbW1hbmRzID0ge30sIGhlbHBlcnMgPSB7fSwgZXh0ZW5zaW9ucyA9IHt9O1xuXG5jb25zdCBXRUJTT0NLRVRfRU5EUE9JTlQgPSAoc2Vzc2lvbklkKSA9PiBgJHtERUZBVUxUX1dTX1BBVEhOQU1FX1BSRUZJWH0vc2Vzc2lvbi8ke3Nlc3Npb25JZH0vYXBwaXVtL2RldmljZS9sb2djYXRgO1xuXG4vLyBodHRwczovL2dpdGh1Yi5jb20vU2VsZW5pdW1IUS9zZWxlbml1bS9ibG9iLzBkNDI1Njc2YjNjOWRmMjYxZGQ2NDE5MTdmODY3ZDRkNWNlNzc3NGQvamF2YS9jbGllbnQvc3JjL29yZy9vcGVucWEvc2VsZW5pdW0vbG9nZ2luZy9Mb2dFbnRyeS5qYXZhXG5mdW5jdGlvbiB0b0xvZ1JlY29yZCAodGltZXN0YW1wLCBsZXZlbCwgbWVzc2FnZSkge1xuICByZXR1cm4ge1xuICAgIHRpbWVzdGFtcCxcbiAgICBsZXZlbCxcbiAgICBtZXNzYWdlLFxuICB9O1xufVxuXG5leHRlbnNpb25zLnN1cHBvcnRlZExvZ1R5cGVzID0ge1xuICBsb2djYXQ6IHtcbiAgICBkZXNjcmlwdGlvbjogJ0xvZ3MgZm9yIEFuZHJvaWQgYXBwbGljYXRpb25zIG9uIHJlYWwgZGV2aWNlIGFuZCBlbXVsYXRvcnMgdmlhIEFEQicsXG4gICAgZ2V0dGVyOiBhc3luYyAoc2VsZikgPT4gYXdhaXQgc2VsZi5hZGIuZ2V0TG9nY2F0TG9ncygpLFxuICB9LFxuICBidWdyZXBvcnQ6IHtcbiAgICBkZXNjcmlwdGlvbjogYCdhZGIgYnVncmVwb3J0JyBvdXRwdXQgZm9yIGFkdmFuY2VkIGlzc3VlcyBkaWFnbm9zdGljYCxcbiAgICBnZXR0ZXI6IGFzeW5jIChzZWxmKSA9PiB7XG4gICAgICBjb25zdCBvdXRwdXQgPSBhd2FpdCBzZWxmLmFkYi5idWdyZXBvcnQoKTtcbiAgICAgIGNvbnN0IHRpbWVzdGFtcCA9IERhdGUubm93KCk7XG4gICAgICByZXR1cm4gb3V0cHV0LnNwbGl0KG9zLkVPTClcbiAgICAgICAgLm1hcCgoeCkgPT4gdG9Mb2dSZWNvcmQodGltZXN0YW1wLCAnQUxMJywgeCkpO1xuICAgIH0sXG4gIH0sXG4gIHNlcnZlcjoge1xuICAgIGRlc2NyaXB0aW9uOiAnQXBwaXVtIHNlcnZlciBsb2dzJyxcbiAgICBnZXR0ZXI6IChzZWxmKSA9PiB7XG4gICAgICBzZWxmLmVuc3VyZUZlYXR1cmVFbmFibGVkKEdFVF9TRVJWRVJfTE9HU19GRUFUVVJFKTtcbiAgICAgIGNvbnN0IHRpbWVzdGFtcCA9IERhdGUubm93KCk7XG4gICAgICByZXR1cm4gbG9nLnVud3JhcCgpLnJlY29yZFxuICAgICAgICAubWFwKCh4KSA9PiB0b0xvZ1JlY29yZCh0aW1lc3RhbXAsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdBTEwnLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfLmlzRW1wdHkoeC5wcmVmaXgpID8geC5tZXNzYWdlIDogYFske3gucHJlZml4fV0gJHt4Lm1lc3NhZ2V9YClcbiAgICAgICAgKTtcbiAgICB9LFxuICB9LFxufTtcblxuLyoqXG4gKiBTdGFydHMgQW5kcm9pZCBsb2djYXQgYnJvYWRjYXN0IHdlYnNvY2tldCBvbiB0aGUgc2FtZSBob3N0IGFuZCBwb3J0XG4gKiB3aGVyZSBBcHBpdW0gc2VydmVyIGlzIHJ1bm5pbmcgYXQgYC93cy9zZXNzaW9uLzpzZXNzaW9uSWQ6L2FwcGl1bS9sb2djYXRgIGVuZHBvaW50LiBUaGUgbWV0aG9kXG4gKiB3aWxsIHJldHVybiBpbW1lZGlhdGVseSBpZiB0aGUgd2ViIHNvY2tldCBpcyBhbHJlYWR5IGxpc3RlbmluZy5cbiAqXG4gKiBFYWNoIGNvbm5lY3RlZCB3ZWJjb2tldCBsaXN0ZW5lciB3aWxsIHJlY2VpdmUgbG9nY2F0IGxvZyBsaW5lc1xuICogYXMgc29vbiBhcyB0aGV5IGFyZSB2aXNpYmxlIHRvIEFwcGl1bS5cbiAqL1xuY29tbWFuZHMubW9iaWxlU3RhcnRMb2dzQnJvYWRjYXN0ID0gYXN5bmMgZnVuY3Rpb24gbW9iaWxlU3RhcnRMb2dzQnJvYWRjYXN0ICgpIHtcbiAgY29uc3QgcGF0aG5hbWUgPSBXRUJTT0NLRVRfRU5EUE9JTlQodGhpcy5zZXNzaW9uSWQpO1xuICBpZiAoIV8uaXNFbXB0eShhd2FpdCB0aGlzLnNlcnZlci5nZXRXZWJTb2NrZXRIYW5kbGVycyhwYXRobmFtZSkpKSB7XG4gICAgbG9nLmRlYnVnKGBUaGUgbG9nY2F0IGJyb2FkY2FzdGluZyB3ZWIgc29ja2V0IHNlcnZlciBpcyBhbHJlYWR5IGxpc3RlbmluZyBhdCAke3BhdGhuYW1lfWApO1xuICAgIHJldHVybjtcbiAgfVxuXG4gIGxvZy5pbmZvKGBBc3NpZ25pbmcgbG9nY2F0IGJyb2FkY2FzdGluZyB3ZWIgc29ja2V0IHNlcnZlciB0byAke3BhdGhuYW1lfWApO1xuICAvLyBodHRwczovL2dpdGh1Yi5jb20vd2Vic29ja2V0cy93cy9ibG9iL21hc3Rlci9kb2Mvd3MubWRcbiAgY29uc3Qgd3NzID0gbmV3IFdlYlNvY2tldC5TZXJ2ZXIoe1xuICAgIG5vU2VydmVyOiB0cnVlLFxuICB9KTtcbiAgd3NzLm9uKCdjb25uZWN0aW9uJywgKHdzLCByZXEpID0+IHtcbiAgICBpZiAocmVxKSB7XG4gICAgICBjb25zdCByZW1vdGVJcCA9IF8uaXNFbXB0eShyZXEuaGVhZGVyc1sneC1mb3J3YXJkZWQtZm9yJ10pXG4gICAgICAgID8gcmVxLmNvbm5lY3Rpb24ucmVtb3RlQWRkcmVzc1xuICAgICAgICA6IHJlcS5oZWFkZXJzWyd4LWZvcndhcmRlZC1mb3InXTtcbiAgICAgIGxvZy5kZWJ1ZyhgRXN0YWJsaXNoZWQgYSBuZXcgbG9nY2F0IGxpc3RlbmVyIHdlYiBzb2NrZXQgY29ubmVjdGlvbiBmcm9tICR7cmVtb3RlSXB9YCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGxvZy5kZWJ1ZygnRXN0YWJsaXNoZWQgYSBuZXcgbG9nY2F0IGxpc3RlbmVyIHdlYiBzb2NrZXQgY29ubmVjdGlvbicpO1xuICAgIH1cblxuICAgIGlmIChfLmlzRW1wdHkodGhpcy5fbG9nY2F0V2Vic29ja2V0TGlzdGVuZXIpKSB7XG4gICAgICB0aGlzLl9sb2djYXRXZWJzb2NrZXRMaXN0ZW5lciA9IChsb2dSZWNvcmQpID0+IHtcbiAgICAgICAgaWYgKHdzICYmIHdzLnJlYWR5U3RhdGUgPT09IFdlYlNvY2tldC5PUEVOKSB7XG4gICAgICAgICAgd3Muc2VuZChsb2dSZWNvcmQubWVzc2FnZSk7XG4gICAgICAgIH1cbiAgICAgIH07XG4gICAgfVxuICAgIHRoaXMuYWRiLnNldExvZ2NhdExpc3RlbmVyKHRoaXMuX2xvZ2NhdFdlYnNvY2tldExpc3RlbmVyKTtcblxuICAgIHdzLm9uKCdjbG9zZScsIChjb2RlLCByZWFzb24pID0+IHtcbiAgICAgIGlmICghXy5pc0VtcHR5KHRoaXMuX2xvZ2NhdFdlYnNvY2tldExpc3RlbmVyKSkge1xuICAgICAgICB0cnkge1xuICAgICAgICAgIHRoaXMuYWRiLnJlbW92ZUxvZ2NhdExpc3RlbmVyKHRoaXMuX2xvZ2NhdFdlYnNvY2tldExpc3RlbmVyKTtcbiAgICAgICAgfSBjYXRjaCAoaWduKSB7fVxuICAgICAgICB0aGlzLl9sb2djYXRXZWJzb2NrZXRMaXN0ZW5lciA9IG51bGw7XG4gICAgICB9XG5cbiAgICAgIGxldCBjbG9zZU1zZyA9ICdMb2djYXQgbGlzdGVuZXIgd2ViIHNvY2tldCBpcyBjbG9zZWQuJztcbiAgICAgIGlmICghXy5pc0VtcHR5KGNvZGUpKSB7XG4gICAgICAgIGNsb3NlTXNnICs9IGAgQ29kZTogJHtjb2RlfS5gO1xuICAgICAgfVxuICAgICAgaWYgKCFfLmlzRW1wdHkocmVhc29uKSkge1xuICAgICAgICBjbG9zZU1zZyArPSBgIFJlYXNvbjogJHtyZWFzb259LmA7XG4gICAgICB9XG4gICAgICBsb2cuZGVidWcoY2xvc2VNc2cpO1xuICAgIH0pO1xuICB9KTtcbiAgYXdhaXQgdGhpcy5zZXJ2ZXIuYWRkV2ViU29ja2V0SGFuZGxlcihwYXRobmFtZSwgd3NzKTtcbn07XG5cbi8qKlxuICogU3RvcHMgdGhlIHByZXZpb3VzbHkgc3RhcnRlZCBsb2djYXQgYnJvYWRjYXN0aW5nIHdlc29ja2V0IHNlcnZlci5cbiAqIFRoaXMgbWV0aG9kIHdpbGwgcmV0dXJuIGltbWVkaWF0ZWx5IGlmIG5vIHNlcnZlciBpcyBydW5uaW5nLlxuICovXG5jb21tYW5kcy5tb2JpbGVTdG9wTG9nc0Jyb2FkY2FzdCA9IGFzeW5jIGZ1bmN0aW9uIG1vYmlsZVN0b3BMb2dzQnJvYWRjYXN0ICgpIHtcbiAgY29uc3QgcGF0aG5hbWUgPSBXRUJTT0NLRVRfRU5EUE9JTlQodGhpcy5zZXNzaW9uSWQpO1xuICBpZiAoXy5pc0VtcHR5KGF3YWl0IHRoaXMuc2VydmVyLmdldFdlYlNvY2tldEhhbmRsZXJzKHBhdGhuYW1lKSkpIHtcbiAgICByZXR1cm47XG4gIH1cblxuICBsb2cuZGVidWcoJ1N0b3BwaW5nIHRoZSBsb2djYXQgYnJvYWRjYXN0aW5nIHdlYiBzb2NrZXQgc2VydmVyJyk7XG4gIGF3YWl0IHRoaXMuc2VydmVyLnJlbW92ZVdlYlNvY2tldEhhbmRsZXIocGF0aG5hbWUpO1xufTtcblxuT2JqZWN0LmFzc2lnbihleHRlbnNpb25zLCBjb21tYW5kcywgaGVscGVycyk7XG5leHBvcnQgeyBjb21tYW5kcywgaGVscGVycyB9O1xuZXhwb3J0IGRlZmF1bHQgZXh0ZW5zaW9ucztcbiJdLCJmaWxlIjoibGliL2NvbW1hbmRzL2xvZy5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9
