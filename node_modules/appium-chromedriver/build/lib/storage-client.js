"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _utils = require("./utils");

var _lodash = _interopRequireDefault(require("lodash"));

var _requestPromise = _interopRequireDefault(require("request-promise"));

var _request = _interopRequireDefault(require("request"));

var _xpath = _interopRequireDefault(require("xpath"));

var _xmldom = require("xmldom");

var _bluebird = _interopRequireDefault(require("bluebird"));

var _path = _interopRequireDefault(require("path"));

var _appiumSupport = require("appium-support");

const STORAGE_URL = 'https://chromedriver.storage.googleapis.com';
const TIMEOUT_MS = 15000;
const MAX_PARALLEL_DOWNLOADS = 5;

const log = _appiumSupport.logger.getLogger('ChromedriverStorageClient');

async function walkDir(dir) {
  const result = [];

  for (const name of await _appiumSupport.fs.readdir(dir)) {
    const currentPath = _path.default.join(dir, name);

    result.push(currentPath);

    if ((await _appiumSupport.fs.stat(currentPath)).isDirectory()) {
      result.push(...(await walkDir(currentPath)));
    }
  }

  return result;
}

async function getOsInfo() {
  let name = 'linux';

  if (_appiumSupport.system.isWindows()) {
    name = 'win';
  } else if (_appiumSupport.system.isMac()) {
    name = 'mac';
  }

  return {
    name,
    arch: await _appiumSupport.system.arch()
  };
}

async function isCrcOk(src, checksum) {
  const md5 = await _appiumSupport.fs.hash(src, 'md5');
  return _lodash.default.toLower(md5) === _lodash.default.toLower(checksum);
}

function findChildNode(parent, childName = null, text = null) {
  if (!childName && !text) {
    return null;
  }

  if (!parent.hasChildNodes()) {
    return null;
  }

  for (let childNodeIdx = 0; childNodeIdx < parent.childNodes.length; childNodeIdx++) {
    const childNode = parent.childNodes[childNodeIdx];

    if (childName && !text && childName === childNode.localName) {
      return childNode;
    }

    if (text) {
      const childText = extractNodeText(childNode);

      if (!childText) {
        continue;
      }

      if (childName && childName === childNode.localName && text === childText) {
        return childNode;
      }

      if (!childName && text === childText) {
        return childNode;
      }
    }
  }

  return null;
}

function extractNodeText(node) {
  return !node || !node.firstChild || !_appiumSupport.util.hasValue(node.firstChild.nodeValue) ? null : node.firstChild.nodeValue;
}

class ChromedriverStorageClient {
  constructor(args = {}) {
    const {
      chromedriverDir = (0, _utils.getChromedriverDir)(),
      timeout = TIMEOUT_MS
    } = args;
    this.chromedriverDir = chromedriverDir;
    this.timeout = timeout;
    this.mapping = {};
  }

  parseNotes(content) {
    const result = {};
    const versionMatch = /^\s*[-]+ChromeDriver[\D]+([\d.]+)/im.exec(content);

    if (versionMatch) {
      result.version = versionMatch[1];
    }

    const minBrowserVersionMatch = /^\s*Supports Chrome[\D]+(\d+)/im.exec(content);

    if (minBrowserVersionMatch) {
      result.minBrowserVersion = minBrowserVersionMatch[1];
    }

    return result;
  }

  async retrieveAdditionalDriverInfo(driverKey, notesUrl, infoDict) {
    const response = await (0, _requestPromise.default)({
      url: notesUrl,
      method: 'GET',
      headers: {
        'user-agent': 'appium',
        accept: '*/*'
      },
      resolveWithFullResponse: true,
      timeout: this.timeout
    });
    const {
      minBrowserVersion
    } = this.parseNotes(response.body);

    if (!minBrowserVersion) {
      log.debug(`The driver '${driverKey}' does not contain valid release notes at ${notesUrl}. ` + `Skipping it`);
      return;
    }

    infoDict.minBrowserVersion = minBrowserVersion;
  }

  async parseStorageXml(doc, shouldParseNotes = true) {
    const driverNodes = _xpath.default.select(`//*[local-name(.)='Contents']`, doc);

    log.debug(`Parsed ${driverNodes.length} entries from storage XML`);

    if (_lodash.default.isEmpty(driverNodes)) {
      return;
    }

    const promises = [];

    for (const driverNode of driverNodes) {
      const key = extractNodeText(findChildNode(driverNode, 'Key'));

      if (!_lodash.default.includes(key, '/chromedriver_')) {
        continue;
      }

      log.debug(`Processing chromedriver entry '${key}'`);
      const etag = extractNodeText(findChildNode(driverNode, 'ETag'));

      if (!etag) {
        log.debug(`The entry '${key}' does not contain the checksum. Skipping it`);
        continue;
      }

      const cdInfo = {
        url: `${STORAGE_URL}/${key}`,
        etag: _lodash.default.trim(etag, '"'),
        version: _lodash.default.first(key.split('/'))
      };
      this.mapping[key] = cdInfo;
      const notesPath = `${cdInfo.version}/notes.txt`;
      const isNotesPresent = !!driverNodes.reduce((acc, node) => acc || findChildNode(node, 'Key', notesPath), false);

      if (!isNotesPresent) {
        cdInfo.minBrowserVersion = null;

        if (shouldParseNotes) {
          log.info(`The entry '${key}' does not contain any notes. Skipping it`);
        }

        continue;
      } else if (!shouldParseNotes) {
        continue;
      }

      promises.push(this.retrieveAdditionalDriverInfo(key, `${STORAGE_URL}/${notesPath}`, cdInfo));

      if (promises.length % MAX_PARALLEL_DOWNLOADS === 0) {
        await _bluebird.default.all(promises);
      }
    }

    await _bluebird.default.all(promises);
    log.info(`The total count of entries in the mapping: ${_lodash.default.size(this.mapping)}`);
  }

  async retrieveMapping(shouldParseNotes = true) {
    const response = await (0, _requestPromise.default)({
      url: STORAGE_URL,
      method: 'GET',
      headers: {
        'user-agent': 'appium',
        accept: 'application/xml, */*'
      },
      resolveWithFullResponse: true,
      timeout: this.timeout
    });
    const doc = new _xmldom.DOMParser().parseFromString(response.body);
    await this.parseStorageXml(doc, shouldParseNotes);
    return _lodash.default.cloneDeep(this.mapping);
  }

  async unzipDriver(src, dst) {
    const tmpRoot = await _appiumSupport.tempDir.openDir();

    try {
      await _appiumSupport.zip.extractAllTo(src, tmpRoot);
      const allExtractedItems = await walkDir(tmpRoot);
      const chromedriverPath = allExtractedItems.find(p => _path.default.parse(p).name === 'chromedriver');

      if (!chromedriverPath) {
        throw new Error('The archive was unzipped properly, but we could not find any chromedriver executable');
      }

      log.debug(`Moving the extracted '${_path.default.basename(chromedriverPath)}' to '${dst}'`);
      await _appiumSupport.fs.mv(chromedriverPath, dst, {
        mkdirp: true
      });
    } finally {
      await _appiumSupport.fs.rimraf(tmpRoot);
    }
  }

  selectMatchingDrivers(osInfo, opts = {}) {
    const {
      minBrowserVersion,
      versions = []
    } = opts;

    let driversToSync = _lodash.default.keys(this.mapping);

    if (!_lodash.default.isEmpty(versions)) {
      log.debug(`Selecting chromedrivers whose versions match to ${versions}`);
      driversToSync = driversToSync.filter(x => versions.includes(`${this.mapping[x].version}`));
      log.debug(`Got ${driversToSync.length} item${driversToSync.length === 1 ? '' : 's'}`);
    }

    if (minBrowserVersion) {
      log.debug(`Selecting chromedrivers whose minimum supported browser version matches to ${minBrowserVersion}`);
      driversToSync = driversToSync.reduce((acc, x) => this.mapping[x].minBrowserVersion === `${minBrowserVersion}` ? [...acc, x] : acc, []);
      log.debug(`Got ${driversToSync.length} item${driversToSync.length === 1 ? '' : 's'}`);
    }

    let {
      name,
      arch
    } = osInfo;

    if (arch === '64' && !driversToSync.some(x => x.includes(`_${name}64`))) {
      arch = '32';
    }

    log.debug(`Selecting chromedrivers whose platform matches to ${name}${arch}`);
    driversToSync = driversToSync.filter(x => x.includes(`_${name}${arch}`));
    log.debug(`Got ${driversToSync.length} item${driversToSync.length === 1 ? '' : 's'}`);
    return driversToSync;
  }

  async retrieveDriver(index, driverKey, archivesRoot, isStrict = false) {
    const {
      url,
      etag,
      version
    } = this.mapping[driverKey];

    const archivePath = _path.default.resolve(archivesRoot, `${index}.zip`);

    log.debug(`Retrieving '${url}' to '${archivePath}'`);

    try {
      await new _bluebird.default((resolve, reject) => {
        (0, _request.default)(url).on('error', reject).on('response', res => {
          if (res.statusCode >= 400) {
            return reject(`Error downloading chromedriver at ${url}: ${res.statusCode}`);
          }
        }).pipe(_appiumSupport.fs.createWriteStream(archivePath)).on('close', resolve);
      });
    } catch (e) {
      const msg = `Cannot download chromedriver archive. Original error: ${e.message}`;

      if (isStrict) {
        throw new Error(msg);
      }

      log.error(msg);
      return false;
    }

    if (!(await isCrcOk(archivePath, etag))) {
      const msg = `The checksum for the downloaded chromedriver '${driverKey}' did not match`;

      if (isStrict) {
        throw new Error(msg);
      }

      log.error(msg);
      return false;
    }

    const fileName = `${_path.default.parse(url).name}_v${version}` + (_appiumSupport.system.isWindows() ? '.exe' : '');

    const targetPath = _path.default.resolve(this.chromedriverDir, fileName);

    try {
      await this.unzipDriver(archivePath, targetPath);
    } catch (e) {
      if (isStrict) {
        throw e;
      }

      log.error(e.message);
      return false;
    }

    return true;
  }

  async syncDrivers(opts = {}) {
    if (_lodash.default.isEmpty(this.mapping)) {
      await this.retrieveMapping(!!opts.minBrowserVersion);
    }

    if (_lodash.default.isEmpty(this.mapping)) {
      throw new Error('Cannot retrieve chromedrivers mapping from Google storage');
    }

    const driversToSync = this.selectMatchingDrivers((await getOsInfo()), opts);

    if (_lodash.default.isEmpty(driversToSync)) {
      log.debug(`There are no drivers to sync. Exiting`);
      return [];
    }

    log.debug(`Got ${driversToSync.length} driver(s) to sync: ${driversToSync}`);
    const synchronizedDrivers = [];
    const promises = [];
    const archivesRoot = await _appiumSupport.tempDir.openDir();

    try {
      for (const [idx, driverKey] of driversToSync.entries()) {
        promises.push((async () => {
          if (await this.retrieveDriver(idx, driverKey, archivesRoot, !_lodash.default.isEmpty(opts))) {
            synchronizedDrivers.push(driverKey);
          }
        })());

        if (promises.length % MAX_PARALLEL_DOWNLOADS === 0) {
          await _bluebird.default.all(promises);
        }
      }

      await _bluebird.default.all(promises);
    } finally {
      await _appiumSupport.fs.rimraf(archivesRoot);
    }

    if (!_lodash.default.isEmpty(synchronizedDrivers)) {
      log.info(`Successfully synchronized ${synchronizedDrivers.length} ` + `chromedriver${synchronizedDrivers.length === 1 ? '' : 's'}`);
    } else {
      log.info(`No chromedrivers were synchronized`);
    }

    return synchronizedDrivers;
  }

}

var _default = ChromedriverStorageClient;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9zdG9yYWdlLWNsaWVudC5qcyJdLCJuYW1lcyI6WyJTVE9SQUdFX1VSTCIsIlRJTUVPVVRfTVMiLCJNQVhfUEFSQUxMRUxfRE9XTkxPQURTIiwibG9nIiwibG9nZ2VyIiwiZ2V0TG9nZ2VyIiwid2Fsa0RpciIsImRpciIsInJlc3VsdCIsIm5hbWUiLCJmcyIsInJlYWRkaXIiLCJjdXJyZW50UGF0aCIsInBhdGgiLCJqb2luIiwicHVzaCIsInN0YXQiLCJpc0RpcmVjdG9yeSIsImdldE9zSW5mbyIsInN5c3RlbSIsImlzV2luZG93cyIsImlzTWFjIiwiYXJjaCIsImlzQ3JjT2siLCJzcmMiLCJjaGVja3N1bSIsIm1kNSIsImhhc2giLCJfIiwidG9Mb3dlciIsImZpbmRDaGlsZE5vZGUiLCJwYXJlbnQiLCJjaGlsZE5hbWUiLCJ0ZXh0IiwiaGFzQ2hpbGROb2RlcyIsImNoaWxkTm9kZUlkeCIsImNoaWxkTm9kZXMiLCJsZW5ndGgiLCJjaGlsZE5vZGUiLCJsb2NhbE5hbWUiLCJjaGlsZFRleHQiLCJleHRyYWN0Tm9kZVRleHQiLCJub2RlIiwiZmlyc3RDaGlsZCIsInV0aWwiLCJoYXNWYWx1ZSIsIm5vZGVWYWx1ZSIsIkNocm9tZWRyaXZlclN0b3JhZ2VDbGllbnQiLCJjb25zdHJ1Y3RvciIsImFyZ3MiLCJjaHJvbWVkcml2ZXJEaXIiLCJ0aW1lb3V0IiwibWFwcGluZyIsInBhcnNlTm90ZXMiLCJjb250ZW50IiwidmVyc2lvbk1hdGNoIiwiZXhlYyIsInZlcnNpb24iLCJtaW5Ccm93c2VyVmVyc2lvbk1hdGNoIiwibWluQnJvd3NlclZlcnNpb24iLCJyZXRyaWV2ZUFkZGl0aW9uYWxEcml2ZXJJbmZvIiwiZHJpdmVyS2V5Iiwibm90ZXNVcmwiLCJpbmZvRGljdCIsInJlc3BvbnNlIiwidXJsIiwibWV0aG9kIiwiaGVhZGVycyIsImFjY2VwdCIsInJlc29sdmVXaXRoRnVsbFJlc3BvbnNlIiwiYm9keSIsImRlYnVnIiwicGFyc2VTdG9yYWdlWG1sIiwiZG9jIiwic2hvdWxkUGFyc2VOb3RlcyIsImRyaXZlck5vZGVzIiwieHBhdGgiLCJzZWxlY3QiLCJpc0VtcHR5IiwicHJvbWlzZXMiLCJkcml2ZXJOb2RlIiwia2V5IiwiaW5jbHVkZXMiLCJldGFnIiwiY2RJbmZvIiwidHJpbSIsImZpcnN0Iiwic3BsaXQiLCJub3Rlc1BhdGgiLCJpc05vdGVzUHJlc2VudCIsInJlZHVjZSIsImFjYyIsImluZm8iLCJCIiwiYWxsIiwic2l6ZSIsInJldHJpZXZlTWFwcGluZyIsIkRPTVBhcnNlciIsInBhcnNlRnJvbVN0cmluZyIsImNsb25lRGVlcCIsInVuemlwRHJpdmVyIiwiZHN0IiwidG1wUm9vdCIsInRlbXBEaXIiLCJvcGVuRGlyIiwiemlwIiwiZXh0cmFjdEFsbFRvIiwiYWxsRXh0cmFjdGVkSXRlbXMiLCJjaHJvbWVkcml2ZXJQYXRoIiwiZmluZCIsInAiLCJwYXJzZSIsIkVycm9yIiwiYmFzZW5hbWUiLCJtdiIsIm1rZGlycCIsInJpbXJhZiIsInNlbGVjdE1hdGNoaW5nRHJpdmVycyIsIm9zSW5mbyIsIm9wdHMiLCJ2ZXJzaW9ucyIsImRyaXZlcnNUb1N5bmMiLCJrZXlzIiwiZmlsdGVyIiwieCIsInNvbWUiLCJyZXRyaWV2ZURyaXZlciIsImluZGV4IiwiYXJjaGl2ZXNSb290IiwiaXNTdHJpY3QiLCJhcmNoaXZlUGF0aCIsInJlc29sdmUiLCJyZWplY3QiLCJvbiIsInJlcyIsInN0YXR1c0NvZGUiLCJwaXBlIiwiY3JlYXRlV3JpdGVTdHJlYW0iLCJlIiwibXNnIiwibWVzc2FnZSIsImVycm9yIiwiZmlsZU5hbWUiLCJ0YXJnZXRQYXRoIiwic3luY0RyaXZlcnMiLCJzeW5jaHJvbml6ZWREcml2ZXJzIiwiaWR4IiwiZW50cmllcyJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFHQSxNQUFNQSxXQUFXLEdBQUcsNkNBQXBCO0FBQ0EsTUFBTUMsVUFBVSxHQUFHLEtBQW5CO0FBQ0EsTUFBTUMsc0JBQXNCLEdBQUcsQ0FBL0I7O0FBRUEsTUFBTUMsR0FBRyxHQUFHQyxzQkFBT0MsU0FBUCxDQUFpQiwyQkFBakIsQ0FBWjs7QUFFQSxlQUFlQyxPQUFmLENBQXdCQyxHQUF4QixFQUE2QjtBQUMzQixRQUFNQyxNQUFNLEdBQUcsRUFBZjs7QUFDQSxPQUFLLE1BQU1DLElBQVgsSUFBbUIsTUFBTUMsa0JBQUdDLE9BQUgsQ0FBV0osR0FBWCxDQUF6QixFQUEwQztBQUN4QyxVQUFNSyxXQUFXLEdBQUdDLGNBQUtDLElBQUwsQ0FBVVAsR0FBVixFQUFlRSxJQUFmLENBQXBCOztBQUNBRCxJQUFBQSxNQUFNLENBQUNPLElBQVAsQ0FBWUgsV0FBWjs7QUFDQSxRQUFJLENBQUMsTUFBTUYsa0JBQUdNLElBQUgsQ0FBUUosV0FBUixDQUFQLEVBQTZCSyxXQUE3QixFQUFKLEVBQWdEO0FBQzlDVCxNQUFBQSxNQUFNLENBQUNPLElBQVAsQ0FBWSxJQUFJLE1BQU1ULE9BQU8sQ0FBQ00sV0FBRCxDQUFqQixDQUFaO0FBQ0Q7QUFDRjs7QUFDRCxTQUFPSixNQUFQO0FBQ0Q7O0FBRUQsZUFBZVUsU0FBZixHQUE0QjtBQUMxQixNQUFJVCxJQUFJLEdBQUcsT0FBWDs7QUFDQSxNQUFJVSxzQkFBT0MsU0FBUCxFQUFKLEVBQXdCO0FBQ3RCWCxJQUFBQSxJQUFJLEdBQUcsS0FBUDtBQUNELEdBRkQsTUFFTyxJQUFJVSxzQkFBT0UsS0FBUCxFQUFKLEVBQW9CO0FBQ3pCWixJQUFBQSxJQUFJLEdBQUcsS0FBUDtBQUNEOztBQUNELFNBQU87QUFDTEEsSUFBQUEsSUFESztBQUVMYSxJQUFBQSxJQUFJLEVBQUUsTUFBTUgsc0JBQU9HLElBQVA7QUFGUCxHQUFQO0FBSUQ7O0FBRUQsZUFBZUMsT0FBZixDQUF3QkMsR0FBeEIsRUFBNkJDLFFBQTdCLEVBQXVDO0FBQ3JDLFFBQU1DLEdBQUcsR0FBRyxNQUFNaEIsa0JBQUdpQixJQUFILENBQVFILEdBQVIsRUFBYSxLQUFiLENBQWxCO0FBQ0EsU0FBT0ksZ0JBQUVDLE9BQUYsQ0FBVUgsR0FBVixNQUFtQkUsZ0JBQUVDLE9BQUYsQ0FBVUosUUFBVixDQUExQjtBQUNEOztBQUVELFNBQVNLLGFBQVQsQ0FBd0JDLE1BQXhCLEVBQWdDQyxTQUFTLEdBQUcsSUFBNUMsRUFBa0RDLElBQUksR0FBRyxJQUF6RCxFQUErRDtBQUM3RCxNQUFJLENBQUNELFNBQUQsSUFBYyxDQUFDQyxJQUFuQixFQUF5QjtBQUN2QixXQUFPLElBQVA7QUFDRDs7QUFDRCxNQUFJLENBQUNGLE1BQU0sQ0FBQ0csYUFBUCxFQUFMLEVBQTZCO0FBQzNCLFdBQU8sSUFBUDtBQUNEOztBQUVELE9BQUssSUFBSUMsWUFBWSxHQUFHLENBQXhCLEVBQTJCQSxZQUFZLEdBQUdKLE1BQU0sQ0FBQ0ssVUFBUCxDQUFrQkMsTUFBNUQsRUFBb0VGLFlBQVksRUFBaEYsRUFBb0Y7QUFDbEYsVUFBTUcsU0FBUyxHQUFHUCxNQUFNLENBQUNLLFVBQVAsQ0FBa0JELFlBQWxCLENBQWxCOztBQUNBLFFBQUlILFNBQVMsSUFBSSxDQUFDQyxJQUFkLElBQXNCRCxTQUFTLEtBQUtNLFNBQVMsQ0FBQ0MsU0FBbEQsRUFBNkQ7QUFDM0QsYUFBT0QsU0FBUDtBQUNEOztBQUNELFFBQUlMLElBQUosRUFBVTtBQUNSLFlBQU1PLFNBQVMsR0FBR0MsZUFBZSxDQUFDSCxTQUFELENBQWpDOztBQUNBLFVBQUksQ0FBQ0UsU0FBTCxFQUFnQjtBQUNkO0FBQ0Q7O0FBQ0QsVUFBSVIsU0FBUyxJQUFJQSxTQUFTLEtBQUtNLFNBQVMsQ0FBQ0MsU0FBckMsSUFBa0ROLElBQUksS0FBS08sU0FBL0QsRUFBMEU7QUFDeEUsZUFBT0YsU0FBUDtBQUNEOztBQUNELFVBQUksQ0FBQ04sU0FBRCxJQUFjQyxJQUFJLEtBQUtPLFNBQTNCLEVBQXNDO0FBQ3BDLGVBQU9GLFNBQVA7QUFDRDtBQUNGO0FBQ0Y7O0FBQ0QsU0FBTyxJQUFQO0FBQ0Q7O0FBRUQsU0FBU0csZUFBVCxDQUEwQkMsSUFBMUIsRUFBZ0M7QUFDOUIsU0FBUSxDQUFDQSxJQUFELElBQVMsQ0FBQ0EsSUFBSSxDQUFDQyxVQUFmLElBQTZCLENBQUNDLG9CQUFLQyxRQUFMLENBQWNILElBQUksQ0FBQ0MsVUFBTCxDQUFnQkcsU0FBOUIsQ0FBL0IsR0FDSCxJQURHLEdBRUhKLElBQUksQ0FBQ0MsVUFBTCxDQUFnQkcsU0FGcEI7QUFHRDs7QUFHRCxNQUFNQyx5QkFBTixDQUFnQztBQUM5QkMsRUFBQUEsV0FBVyxDQUFFQyxJQUFJLEdBQUcsRUFBVCxFQUFhO0FBQ3RCLFVBQU07QUFDSkMsTUFBQUEsZUFBZSxHQUFHLGdDQURkO0FBRUpDLE1BQUFBLE9BQU8sR0FBR2xEO0FBRk4sUUFHRmdELElBSEo7QUFJQSxTQUFLQyxlQUFMLEdBQXVCQSxlQUF2QjtBQUNBLFNBQUtDLE9BQUwsR0FBZUEsT0FBZjtBQUNBLFNBQUtDLE9BQUwsR0FBZSxFQUFmO0FBQ0Q7O0FBaUJEQyxFQUFBQSxVQUFVLENBQUVDLE9BQUYsRUFBVztBQUNuQixVQUFNOUMsTUFBTSxHQUFHLEVBQWY7QUFDQSxVQUFNK0MsWUFBWSxHQUFHLHNDQUFzQ0MsSUFBdEMsQ0FBMkNGLE9BQTNDLENBQXJCOztBQUNBLFFBQUlDLFlBQUosRUFBa0I7QUFDaEIvQyxNQUFBQSxNQUFNLENBQUNpRCxPQUFQLEdBQWlCRixZQUFZLENBQUMsQ0FBRCxDQUE3QjtBQUNEOztBQUNELFVBQU1HLHNCQUFzQixHQUFHLGtDQUFrQ0YsSUFBbEMsQ0FBdUNGLE9BQXZDLENBQS9COztBQUNBLFFBQUlJLHNCQUFKLEVBQTRCO0FBQzFCbEQsTUFBQUEsTUFBTSxDQUFDbUQsaUJBQVAsR0FBMkJELHNCQUFzQixDQUFDLENBQUQsQ0FBakQ7QUFDRDs7QUFDRCxXQUFPbEQsTUFBUDtBQUNEOztBQVlELFFBQU1vRCw0QkFBTixDQUFvQ0MsU0FBcEMsRUFBK0NDLFFBQS9DLEVBQXlEQyxRQUF6RCxFQUFtRTtBQUNqRSxVQUFNQyxRQUFRLEdBQUcsTUFBTSw2QkFBZTtBQUNwQ0MsTUFBQUEsR0FBRyxFQUFFSCxRQUQrQjtBQUVwQ0ksTUFBQUEsTUFBTSxFQUFFLEtBRjRCO0FBR3BDQyxNQUFBQSxPQUFPLEVBQUU7QUFDUCxzQkFBYyxRQURQO0FBRVBDLFFBQUFBLE1BQU0sRUFBRTtBQUZELE9BSDJCO0FBT3BDQyxNQUFBQSx1QkFBdUIsRUFBRSxJQVBXO0FBUXBDbEIsTUFBQUEsT0FBTyxFQUFFLEtBQUtBO0FBUnNCLEtBQWYsQ0FBdkI7QUFVQSxVQUFNO0FBQUVRLE1BQUFBO0FBQUYsUUFBd0IsS0FBS04sVUFBTCxDQUFnQlcsUUFBUSxDQUFDTSxJQUF6QixDQUE5Qjs7QUFDQSxRQUFJLENBQUNYLGlCQUFMLEVBQXdCO0FBQ3RCeEQsTUFBQUEsR0FBRyxDQUFDb0UsS0FBSixDQUFXLGVBQWNWLFNBQVUsNkNBQTRDQyxRQUFTLElBQTlFLEdBQ1AsYUFESDtBQUVBO0FBQ0Q7O0FBQ0RDLElBQUFBLFFBQVEsQ0FBQ0osaUJBQVQsR0FBNkJBLGlCQUE3QjtBQUNEOztBQVlELFFBQU1hLGVBQU4sQ0FBdUJDLEdBQXZCLEVBQTRCQyxnQkFBZ0IsR0FBRyxJQUEvQyxFQUFxRDtBQUNuRCxVQUFNQyxXQUFXLEdBQUdDLGVBQU1DLE1BQU4sQ0FBYywrQkFBZCxFQUE4Q0osR0FBOUMsQ0FBcEI7O0FBQ0F0RSxJQUFBQSxHQUFHLENBQUNvRSxLQUFKLENBQVcsVUFBU0ksV0FBVyxDQUFDdEMsTUFBTywyQkFBdkM7O0FBQ0EsUUFBSVQsZ0JBQUVrRCxPQUFGLENBQVVILFdBQVYsQ0FBSixFQUE0QjtBQUMxQjtBQUNEOztBQUVELFVBQU1JLFFBQVEsR0FBRyxFQUFqQjs7QUFDQSxTQUFLLE1BQU1DLFVBQVgsSUFBeUJMLFdBQXpCLEVBQXNDO0FBQ3BDLFlBQU1NLEdBQUcsR0FBR3hDLGVBQWUsQ0FBQ1gsYUFBYSxDQUFDa0QsVUFBRCxFQUFhLEtBQWIsQ0FBZCxDQUEzQjs7QUFDQSxVQUFJLENBQUNwRCxnQkFBRXNELFFBQUYsQ0FBV0QsR0FBWCxFQUFnQixnQkFBaEIsQ0FBTCxFQUF3QztBQUN0QztBQUNEOztBQUVEOUUsTUFBQUEsR0FBRyxDQUFDb0UsS0FBSixDQUFXLGtDQUFpQ1UsR0FBSSxHQUFoRDtBQUNBLFlBQU1FLElBQUksR0FBRzFDLGVBQWUsQ0FBQ1gsYUFBYSxDQUFDa0QsVUFBRCxFQUFhLE1BQWIsQ0FBZCxDQUE1Qjs7QUFDQSxVQUFJLENBQUNHLElBQUwsRUFBVztBQUNUaEYsUUFBQUEsR0FBRyxDQUFDb0UsS0FBSixDQUFXLGNBQWFVLEdBQUksOENBQTVCO0FBQ0E7QUFDRDs7QUFFRCxZQUFNRyxNQUFNLEdBQUc7QUFDYm5CLFFBQUFBLEdBQUcsRUFBRyxHQUFFakUsV0FBWSxJQUFHaUYsR0FBSSxFQURkO0FBRWJFLFFBQUFBLElBQUksRUFBRXZELGdCQUFFeUQsSUFBRixDQUFPRixJQUFQLEVBQWEsR0FBYixDQUZPO0FBR2IxQixRQUFBQSxPQUFPLEVBQUU3QixnQkFBRTBELEtBQUYsQ0FBUUwsR0FBRyxDQUFDTSxLQUFKLENBQVUsR0FBVixDQUFSO0FBSEksT0FBZjtBQUtBLFdBQUtuQyxPQUFMLENBQWE2QixHQUFiLElBQW9CRyxNQUFwQjtBQUVBLFlBQU1JLFNBQVMsR0FBSSxHQUFFSixNQUFNLENBQUMzQixPQUFRLFlBQXBDO0FBQ0EsWUFBTWdDLGNBQWMsR0FBRyxDQUFDLENBQUNkLFdBQVcsQ0FDakNlLE1BRHNCLENBQ2YsQ0FBQ0MsR0FBRCxFQUFNakQsSUFBTixLQUFlaUQsR0FBRyxJQUFJN0QsYUFBYSxDQUFDWSxJQUFELEVBQU8sS0FBUCxFQUFjOEMsU0FBZCxDQURwQixFQUM4QyxLQUQ5QyxDQUF6Qjs7QUFFQSxVQUFJLENBQUNDLGNBQUwsRUFBcUI7QUFDbkJMLFFBQUFBLE1BQU0sQ0FBQ3pCLGlCQUFQLEdBQTJCLElBQTNCOztBQUNBLFlBQUllLGdCQUFKLEVBQXNCO0FBQ3BCdkUsVUFBQUEsR0FBRyxDQUFDeUYsSUFBSixDQUFVLGNBQWFYLEdBQUksMkNBQTNCO0FBQ0Q7O0FBQ0Q7QUFDRCxPQU5ELE1BTU8sSUFBSSxDQUFDUCxnQkFBTCxFQUF1QjtBQUM1QjtBQUNEOztBQUVESyxNQUFBQSxRQUFRLENBQUNoRSxJQUFULENBQWMsS0FBSzZDLDRCQUFMLENBQWtDcUIsR0FBbEMsRUFBd0MsR0FBRWpGLFdBQVksSUFBR3dGLFNBQVUsRUFBbkUsRUFBc0VKLE1BQXRFLENBQWQ7O0FBQ0EsVUFBSUwsUUFBUSxDQUFDMUMsTUFBVCxHQUFrQm5DLHNCQUFsQixLQUE2QyxDQUFqRCxFQUFvRDtBQUNsRCxjQUFNMkYsa0JBQUVDLEdBQUYsQ0FBTWYsUUFBTixDQUFOO0FBQ0Q7QUFDRjs7QUFDRCxVQUFNYyxrQkFBRUMsR0FBRixDQUFNZixRQUFOLENBQU47QUFDQTVFLElBQUFBLEdBQUcsQ0FBQ3lGLElBQUosQ0FBVSw4Q0FBNkNoRSxnQkFBRW1FLElBQUYsQ0FBTyxLQUFLM0MsT0FBWixDQUFxQixFQUE1RTtBQUNEOztBQXlCRCxRQUFNNEMsZUFBTixDQUF1QnRCLGdCQUFnQixHQUFHLElBQTFDLEVBQWdEO0FBQzlDLFVBQU1WLFFBQVEsR0FBRyxNQUFNLDZCQUFlO0FBQ3BDQyxNQUFBQSxHQUFHLEVBQUVqRSxXQUQrQjtBQUVwQ2tFLE1BQUFBLE1BQU0sRUFBRSxLQUY0QjtBQUdwQ0MsTUFBQUEsT0FBTyxFQUFFO0FBQ1Asc0JBQWMsUUFEUDtBQUVQQyxRQUFBQSxNQUFNLEVBQUU7QUFGRCxPQUgyQjtBQU9wQ0MsTUFBQUEsdUJBQXVCLEVBQUUsSUFQVztBQVFwQ2xCLE1BQUFBLE9BQU8sRUFBRSxLQUFLQTtBQVJzQixLQUFmLENBQXZCO0FBVUEsVUFBTXNCLEdBQUcsR0FBRyxJQUFJd0IsaUJBQUosR0FBZ0JDLGVBQWhCLENBQWdDbEMsUUFBUSxDQUFDTSxJQUF6QyxDQUFaO0FBQ0EsVUFBTSxLQUFLRSxlQUFMLENBQXFCQyxHQUFyQixFQUEwQkMsZ0JBQTFCLENBQU47QUFDQSxXQUFPOUMsZ0JBQUV1RSxTQUFGLENBQVksS0FBSy9DLE9BQWpCLENBQVA7QUFDRDs7QUFTRCxRQUFNZ0QsV0FBTixDQUFtQjVFLEdBQW5CLEVBQXdCNkUsR0FBeEIsRUFBNkI7QUFDM0IsVUFBTUMsT0FBTyxHQUFHLE1BQU1DLHVCQUFRQyxPQUFSLEVBQXRCOztBQUNBLFFBQUk7QUFDRixZQUFNQyxtQkFBSUMsWUFBSixDQUFpQmxGLEdBQWpCLEVBQXNCOEUsT0FBdEIsQ0FBTjtBQUNBLFlBQU1LLGlCQUFpQixHQUFHLE1BQU1yRyxPQUFPLENBQUNnRyxPQUFELENBQXZDO0FBQ0EsWUFBTU0sZ0JBQWdCLEdBQUdELGlCQUFpQixDQUN2Q0UsSUFEc0IsQ0FDaEJDLENBQUQsSUFBT2pHLGNBQUtrRyxLQUFMLENBQVdELENBQVgsRUFBY3JHLElBQWQsS0FBdUIsY0FEYixDQUF6Qjs7QUFFQSxVQUFJLENBQUNtRyxnQkFBTCxFQUF1QjtBQUNyQixjQUFNLElBQUlJLEtBQUosQ0FBVSxzRkFBVixDQUFOO0FBQ0Q7O0FBQ0Q3RyxNQUFBQSxHQUFHLENBQUNvRSxLQUFKLENBQVcseUJBQXdCMUQsY0FBS29HLFFBQUwsQ0FBY0wsZ0JBQWQsQ0FBZ0MsU0FBUVAsR0FBSSxHQUEvRTtBQUNBLFlBQU0zRixrQkFBR3dHLEVBQUgsQ0FBTU4sZ0JBQU4sRUFBd0JQLEdBQXhCLEVBQTZCO0FBQ2pDYyxRQUFBQSxNQUFNLEVBQUU7QUFEeUIsT0FBN0IsQ0FBTjtBQUdELEtBWkQsU0FZVTtBQUNSLFlBQU16RyxrQkFBRzBHLE1BQUgsQ0FBVWQsT0FBVixDQUFOO0FBQ0Q7QUFDRjs7QUFvQkRlLEVBQUFBLHFCQUFxQixDQUFFQyxNQUFGLEVBQVVDLElBQUksR0FBRyxFQUFqQixFQUFxQjtBQUN4QyxVQUFNO0FBQ0o1RCxNQUFBQSxpQkFESTtBQUVKNkQsTUFBQUEsUUFBUSxHQUFHO0FBRlAsUUFHRkQsSUFISjs7QUFJQSxRQUFJRSxhQUFhLEdBQUc3RixnQkFBRThGLElBQUYsQ0FBTyxLQUFLdEUsT0FBWixDQUFwQjs7QUFFQSxRQUFJLENBQUN4QixnQkFBRWtELE9BQUYsQ0FBVTBDLFFBQVYsQ0FBTCxFQUEwQjtBQUV4QnJILE1BQUFBLEdBQUcsQ0FBQ29FLEtBQUosQ0FBVyxtREFBa0RpRCxRQUFTLEVBQXRFO0FBQ0FDLE1BQUFBLGFBQWEsR0FBR0EsYUFBYSxDQUMxQkUsTUFEYSxDQUNMQyxDQUFELElBQU9KLFFBQVEsQ0FBQ3RDLFFBQVQsQ0FBbUIsR0FBRSxLQUFLOUIsT0FBTCxDQUFhd0UsQ0FBYixFQUFnQm5FLE9BQVEsRUFBN0MsQ0FERCxDQUFoQjtBQUVBdEQsTUFBQUEsR0FBRyxDQUFDb0UsS0FBSixDQUFXLE9BQU1rRCxhQUFhLENBQUNwRixNQUFPLFFBQU9vRixhQUFhLENBQUNwRixNQUFkLEtBQXlCLENBQXpCLEdBQTZCLEVBQTdCLEdBQWtDLEdBQUksRUFBbkY7QUFDRDs7QUFFRCxRQUFJc0IsaUJBQUosRUFBdUI7QUFFckJ4RCxNQUFBQSxHQUFHLENBQUNvRSxLQUFKLENBQVcsOEVBQTZFWixpQkFBa0IsRUFBMUc7QUFDQThELE1BQUFBLGFBQWEsR0FBR0EsYUFBYSxDQUFDL0IsTUFBZCxDQUNkLENBQUNDLEdBQUQsRUFBTWlDLENBQU4sS0FBWSxLQUFLeEUsT0FBTCxDQUFhd0UsQ0FBYixFQUFnQmpFLGlCQUFoQixLQUF1QyxHQUFFQSxpQkFBa0IsRUFBM0QsR0FBK0QsQ0FBQyxHQUFHZ0MsR0FBSixFQUFTaUMsQ0FBVCxDQUEvRCxHQUE2RWpDLEdBRDNFLEVBQ2dGLEVBRGhGLENBQWhCO0FBRUF4RixNQUFBQSxHQUFHLENBQUNvRSxLQUFKLENBQVcsT0FBTWtELGFBQWEsQ0FBQ3BGLE1BQU8sUUFBT29GLGFBQWEsQ0FBQ3BGLE1BQWQsS0FBeUIsQ0FBekIsR0FBNkIsRUFBN0IsR0FBa0MsR0FBSSxFQUFuRjtBQUNEOztBQUdELFFBQUk7QUFBQzVCLE1BQUFBLElBQUQ7QUFBT2EsTUFBQUE7QUFBUCxRQUFlZ0csTUFBbkI7O0FBQ0EsUUFBSWhHLElBQUksS0FBSyxJQUFULElBQWlCLENBQUNtRyxhQUFhLENBQUNJLElBQWQsQ0FBb0JELENBQUQsSUFBT0EsQ0FBQyxDQUFDMUMsUUFBRixDQUFZLElBQUd6RSxJQUFLLElBQXBCLENBQTFCLENBQXRCLEVBQTJFO0FBRXpFYSxNQUFBQSxJQUFJLEdBQUcsSUFBUDtBQUNEOztBQUNEbkIsSUFBQUEsR0FBRyxDQUFDb0UsS0FBSixDQUFXLHFEQUFvRDlELElBQUssR0FBRWEsSUFBSyxFQUEzRTtBQUNBbUcsSUFBQUEsYUFBYSxHQUFHQSxhQUFhLENBQUNFLE1BQWQsQ0FBc0JDLENBQUQsSUFBT0EsQ0FBQyxDQUFDMUMsUUFBRixDQUFZLElBQUd6RSxJQUFLLEdBQUVhLElBQUssRUFBM0IsQ0FBNUIsQ0FBaEI7QUFDQW5CLElBQUFBLEdBQUcsQ0FBQ29FLEtBQUosQ0FBVyxPQUFNa0QsYUFBYSxDQUFDcEYsTUFBTyxRQUFPb0YsYUFBYSxDQUFDcEYsTUFBZCxLQUF5QixDQUF6QixHQUE2QixFQUE3QixHQUFrQyxHQUFJLEVBQW5GO0FBRUEsV0FBT29GLGFBQVA7QUFDRDs7QUFpQkQsUUFBTUssY0FBTixDQUFzQkMsS0FBdEIsRUFBNkJsRSxTQUE3QixFQUF3Q21FLFlBQXhDLEVBQXNEQyxRQUFRLEdBQUcsS0FBakUsRUFBd0U7QUFDdEUsVUFBTTtBQUFFaEUsTUFBQUEsR0FBRjtBQUFPa0IsTUFBQUEsSUFBUDtBQUFhMUIsTUFBQUE7QUFBYixRQUF5QixLQUFLTCxPQUFMLENBQWFTLFNBQWIsQ0FBL0I7O0FBQ0EsVUFBTXFFLFdBQVcsR0FBR3JILGNBQUtzSCxPQUFMLENBQWFILFlBQWIsRUFBNEIsR0FBRUQsS0FBTSxNQUFwQyxDQUFwQjs7QUFDQTVILElBQUFBLEdBQUcsQ0FBQ29FLEtBQUosQ0FBVyxlQUFjTixHQUFJLFNBQVFpRSxXQUFZLEdBQWpEOztBQUNBLFFBQUk7QUFDRixZQUFNLElBQUlyQyxpQkFBSixDQUFNLENBQUNzQyxPQUFELEVBQVVDLE1BQVYsS0FBcUI7QUFDL0IsOEJBQVFuRSxHQUFSLEVBQ0dvRSxFQURILENBQ00sT0FETixFQUNlRCxNQURmLEVBRUdDLEVBRkgsQ0FFTSxVQUZOLEVBRW1CQyxHQUFELElBQVM7QUFFdkIsY0FBSUEsR0FBRyxDQUFDQyxVQUFKLElBQWtCLEdBQXRCLEVBQTJCO0FBQ3pCLG1CQUFPSCxNQUFNLENBQUUscUNBQW9DbkUsR0FBSSxLQUFJcUUsR0FBRyxDQUFDQyxVQUFXLEVBQTdELENBQWI7QUFDRDtBQUNGLFNBUEgsRUFRR0MsSUFSSCxDQVFROUgsa0JBQUcrSCxpQkFBSCxDQUFxQlAsV0FBckIsQ0FSUixFQVNHRyxFQVRILENBU00sT0FUTixFQVNlRixPQVRmO0FBVUQsT0FYSyxDQUFOO0FBWUQsS0FiRCxDQWFFLE9BQU9PLENBQVAsRUFBVTtBQUNWLFlBQU1DLEdBQUcsR0FBSSx5REFBd0RELENBQUMsQ0FBQ0UsT0FBUSxFQUEvRTs7QUFDQSxVQUFJWCxRQUFKLEVBQWM7QUFDWixjQUFNLElBQUlqQixLQUFKLENBQVUyQixHQUFWLENBQU47QUFDRDs7QUFDRHhJLE1BQUFBLEdBQUcsQ0FBQzBJLEtBQUosQ0FBVUYsR0FBVjtBQUNBLGFBQU8sS0FBUDtBQUNEOztBQUNELFFBQUksRUFBQyxNQUFNcEgsT0FBTyxDQUFDMkcsV0FBRCxFQUFjL0MsSUFBZCxDQUFkLENBQUosRUFBdUM7QUFDckMsWUFBTXdELEdBQUcsR0FBSSxpREFBZ0Q5RSxTQUFVLGlCQUF2RTs7QUFDQSxVQUFJb0UsUUFBSixFQUFjO0FBQ1osY0FBTSxJQUFJakIsS0FBSixDQUFVMkIsR0FBVixDQUFOO0FBQ0Q7O0FBQ0R4SSxNQUFBQSxHQUFHLENBQUMwSSxLQUFKLENBQVVGLEdBQVY7QUFDQSxhQUFPLEtBQVA7QUFDRDs7QUFDRCxVQUFNRyxRQUFRLEdBQUksR0FBRWpJLGNBQUtrRyxLQUFMLENBQVc5QyxHQUFYLEVBQWdCeEQsSUFBSyxLQUFJZ0QsT0FBUSxFQUFwQyxJQUNkdEMsc0JBQU9DLFNBQVAsS0FBcUIsTUFBckIsR0FBOEIsRUFEaEIsQ0FBakI7O0FBRUEsVUFBTTJILFVBQVUsR0FBR2xJLGNBQUtzSCxPQUFMLENBQWEsS0FBS2pGLGVBQWxCLEVBQW1DNEYsUUFBbkMsQ0FBbkI7O0FBQ0EsUUFBSTtBQUNGLFlBQU0sS0FBSzFDLFdBQUwsQ0FBaUI4QixXQUFqQixFQUE4QmEsVUFBOUIsQ0FBTjtBQUNELEtBRkQsQ0FFRSxPQUFPTCxDQUFQLEVBQVU7QUFDVixVQUFJVCxRQUFKLEVBQWM7QUFDWixjQUFNUyxDQUFOO0FBQ0Q7O0FBQ0R2SSxNQUFBQSxHQUFHLENBQUMwSSxLQUFKLENBQVVILENBQUMsQ0FBQ0UsT0FBWjtBQUNBLGFBQU8sS0FBUDtBQUNEOztBQUNELFdBQU8sSUFBUDtBQUNEOztBQXFCRCxRQUFNSSxXQUFOLENBQW1CekIsSUFBSSxHQUFHLEVBQTFCLEVBQThCO0FBQzVCLFFBQUkzRixnQkFBRWtELE9BQUYsQ0FBVSxLQUFLMUIsT0FBZixDQUFKLEVBQTZCO0FBQzNCLFlBQU0sS0FBSzRDLGVBQUwsQ0FBcUIsQ0FBQyxDQUFDdUIsSUFBSSxDQUFDNUQsaUJBQTVCLENBQU47QUFDRDs7QUFDRCxRQUFJL0IsZ0JBQUVrRCxPQUFGLENBQVUsS0FBSzFCLE9BQWYsQ0FBSixFQUE2QjtBQUMzQixZQUFNLElBQUk0RCxLQUFKLENBQVUsMkRBQVYsQ0FBTjtBQUNEOztBQUVELFVBQU1TLGFBQWEsR0FBRyxLQUFLSixxQkFBTCxFQUEyQixNQUFNbkcsU0FBUyxFQUExQyxHQUE4Q3FHLElBQTlDLENBQXRCOztBQUNBLFFBQUkzRixnQkFBRWtELE9BQUYsQ0FBVTJDLGFBQVYsQ0FBSixFQUE4QjtBQUM1QnRILE1BQUFBLEdBQUcsQ0FBQ29FLEtBQUosQ0FBVyx1Q0FBWDtBQUNBLGFBQU8sRUFBUDtBQUNEOztBQUNEcEUsSUFBQUEsR0FBRyxDQUFDb0UsS0FBSixDQUFXLE9BQU1rRCxhQUFhLENBQUNwRixNQUFPLHVCQUFzQm9GLGFBQWMsRUFBMUU7QUFFQSxVQUFNd0IsbUJBQW1CLEdBQUcsRUFBNUI7QUFDQSxVQUFNbEUsUUFBUSxHQUFHLEVBQWpCO0FBQ0EsVUFBTWlELFlBQVksR0FBRyxNQUFNekIsdUJBQVFDLE9BQVIsRUFBM0I7O0FBQ0EsUUFBSTtBQUNGLFdBQUssTUFBTSxDQUFDMEMsR0FBRCxFQUFNckYsU0FBTixDQUFYLElBQStCNEQsYUFBYSxDQUFDMEIsT0FBZCxFQUEvQixFQUF3RDtBQUN0RHBFLFFBQUFBLFFBQVEsQ0FBQ2hFLElBQVQsQ0FBYyxDQUFDLFlBQVk7QUFDekIsY0FBSSxNQUFNLEtBQUsrRyxjQUFMLENBQW9Cb0IsR0FBcEIsRUFBeUJyRixTQUF6QixFQUFvQ21FLFlBQXBDLEVBQWtELENBQUNwRyxnQkFBRWtELE9BQUYsQ0FBVXlDLElBQVYsQ0FBbkQsQ0FBVixFQUErRTtBQUM3RTBCLFlBQUFBLG1CQUFtQixDQUFDbEksSUFBcEIsQ0FBeUI4QyxTQUF6QjtBQUNEO0FBQ0YsU0FKYSxHQUFkOztBQU1BLFlBQUlrQixRQUFRLENBQUMxQyxNQUFULEdBQWtCbkMsc0JBQWxCLEtBQTZDLENBQWpELEVBQW9EO0FBQ2xELGdCQUFNMkYsa0JBQUVDLEdBQUYsQ0FBTWYsUUFBTixDQUFOO0FBQ0Q7QUFDRjs7QUFDRCxZQUFNYyxrQkFBRUMsR0FBRixDQUFNZixRQUFOLENBQU47QUFDRCxLQWJELFNBYVU7QUFDUixZQUFNckUsa0JBQUcwRyxNQUFILENBQVVZLFlBQVYsQ0FBTjtBQUNEOztBQUNELFFBQUksQ0FBQ3BHLGdCQUFFa0QsT0FBRixDQUFVbUUsbUJBQVYsQ0FBTCxFQUFxQztBQUNuQzlJLE1BQUFBLEdBQUcsQ0FBQ3lGLElBQUosQ0FBVSw2QkFBNEJxRCxtQkFBbUIsQ0FBQzVHLE1BQU8sR0FBeEQsR0FDTixlQUFjNEcsbUJBQW1CLENBQUM1RyxNQUFwQixLQUErQixDQUEvQixHQUFtQyxFQUFuQyxHQUF3QyxHQUFJLEVBRDdEO0FBRUQsS0FIRCxNQUdPO0FBQ0xsQyxNQUFBQSxHQUFHLENBQUN5RixJQUFKLENBQVUsb0NBQVY7QUFDRDs7QUFDRCxXQUFPcUQsbUJBQVA7QUFDRDs7QUFuWDZCOztlQXNYakJsRyx5QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGdldENocm9tZWRyaXZlckRpciB9IGZyb20gJy4vdXRpbHMnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCByZXF1ZXN0UHJvbWlzZSBmcm9tICdyZXF1ZXN0LXByb21pc2UnO1xuaW1wb3J0IHJlcXVlc3QgZnJvbSAncmVxdWVzdCc7XG5pbXBvcnQgeHBhdGggZnJvbSAneHBhdGgnO1xuaW1wb3J0IHsgRE9NUGFyc2VyIH0gZnJvbSAneG1sZG9tJztcbmltcG9ydCBCIGZyb20gJ2JsdWViaXJkJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgc3lzdGVtLCBmcywgbG9nZ2VyLCB0ZW1wRGlyLCB6aXAsIHV0aWwgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5cblxuY29uc3QgU1RPUkFHRV9VUkwgPSAnaHR0cHM6Ly9jaHJvbWVkcml2ZXIuc3RvcmFnZS5nb29nbGVhcGlzLmNvbSc7XG5jb25zdCBUSU1FT1VUX01TID0gMTUwMDA7XG5jb25zdCBNQVhfUEFSQUxMRUxfRE9XTkxPQURTID0gNTtcblxuY29uc3QgbG9nID0gbG9nZ2VyLmdldExvZ2dlcignQ2hyb21lZHJpdmVyU3RvcmFnZUNsaWVudCcpO1xuXG5hc3luYyBmdW5jdGlvbiB3YWxrRGlyIChkaXIpIHtcbiAgY29uc3QgcmVzdWx0ID0gW107XG4gIGZvciAoY29uc3QgbmFtZSBvZiBhd2FpdCBmcy5yZWFkZGlyKGRpcikpIHtcbiAgICBjb25zdCBjdXJyZW50UGF0aCA9IHBhdGguam9pbihkaXIsIG5hbWUpO1xuICAgIHJlc3VsdC5wdXNoKGN1cnJlbnRQYXRoKTtcbiAgICBpZiAoKGF3YWl0IGZzLnN0YXQoY3VycmVudFBhdGgpKS5pc0RpcmVjdG9yeSgpKSB7XG4gICAgICByZXN1bHQucHVzaCguLi4oYXdhaXQgd2Fsa0RpcihjdXJyZW50UGF0aCkpKTtcbiAgICB9XG4gIH1cbiAgcmV0dXJuIHJlc3VsdDtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZ2V0T3NJbmZvICgpIHtcbiAgbGV0IG5hbWUgPSAnbGludXgnO1xuICBpZiAoc3lzdGVtLmlzV2luZG93cygpKSB7XG4gICAgbmFtZSA9ICd3aW4nO1xuICB9IGVsc2UgaWYgKHN5c3RlbS5pc01hYygpKSB7XG4gICAgbmFtZSA9ICdtYWMnO1xuICB9XG4gIHJldHVybiB7XG4gICAgbmFtZSxcbiAgICBhcmNoOiBhd2FpdCBzeXN0ZW0uYXJjaCgpLFxuICB9O1xufVxuXG5hc3luYyBmdW5jdGlvbiBpc0NyY09rIChzcmMsIGNoZWNrc3VtKSB7XG4gIGNvbnN0IG1kNSA9IGF3YWl0IGZzLmhhc2goc3JjLCAnbWQ1Jyk7XG4gIHJldHVybiBfLnRvTG93ZXIobWQ1KSA9PT0gXy50b0xvd2VyKGNoZWNrc3VtKTtcbn1cblxuZnVuY3Rpb24gZmluZENoaWxkTm9kZSAocGFyZW50LCBjaGlsZE5hbWUgPSBudWxsLCB0ZXh0ID0gbnVsbCkge1xuICBpZiAoIWNoaWxkTmFtZSAmJiAhdGV4dCkge1xuICAgIHJldHVybiBudWxsO1xuICB9XG4gIGlmICghcGFyZW50Lmhhc0NoaWxkTm9kZXMoKSkge1xuICAgIHJldHVybiBudWxsO1xuICB9XG5cbiAgZm9yIChsZXQgY2hpbGROb2RlSWR4ID0gMDsgY2hpbGROb2RlSWR4IDwgcGFyZW50LmNoaWxkTm9kZXMubGVuZ3RoOyBjaGlsZE5vZGVJZHgrKykge1xuICAgIGNvbnN0IGNoaWxkTm9kZSA9IHBhcmVudC5jaGlsZE5vZGVzW2NoaWxkTm9kZUlkeF07XG4gICAgaWYgKGNoaWxkTmFtZSAmJiAhdGV4dCAmJiBjaGlsZE5hbWUgPT09IGNoaWxkTm9kZS5sb2NhbE5hbWUpIHtcbiAgICAgIHJldHVybiBjaGlsZE5vZGU7XG4gICAgfVxuICAgIGlmICh0ZXh0KSB7XG4gICAgICBjb25zdCBjaGlsZFRleHQgPSBleHRyYWN0Tm9kZVRleHQoY2hpbGROb2RlKTtcbiAgICAgIGlmICghY2hpbGRUZXh0KSB7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuICAgICAgaWYgKGNoaWxkTmFtZSAmJiBjaGlsZE5hbWUgPT09IGNoaWxkTm9kZS5sb2NhbE5hbWUgJiYgdGV4dCA9PT0gY2hpbGRUZXh0KSB7XG4gICAgICAgIHJldHVybiBjaGlsZE5vZGU7XG4gICAgICB9XG4gICAgICBpZiAoIWNoaWxkTmFtZSAmJiB0ZXh0ID09PSBjaGlsZFRleHQpIHtcbiAgICAgICAgcmV0dXJuIGNoaWxkTm9kZTtcbiAgICAgIH1cbiAgICB9XG4gIH1cbiAgcmV0dXJuIG51bGw7XG59XG5cbmZ1bmN0aW9uIGV4dHJhY3ROb2RlVGV4dCAobm9kZSkge1xuICByZXR1cm4gKCFub2RlIHx8ICFub2RlLmZpcnN0Q2hpbGQgfHwgIXV0aWwuaGFzVmFsdWUobm9kZS5maXJzdENoaWxkLm5vZGVWYWx1ZSkpXG4gICAgPyBudWxsXG4gICAgOiBub2RlLmZpcnN0Q2hpbGQubm9kZVZhbHVlO1xufVxuXG5cbmNsYXNzIENocm9tZWRyaXZlclN0b3JhZ2VDbGllbnQge1xuICBjb25zdHJ1Y3RvciAoYXJncyA9IHt9KSB7XG4gICAgY29uc3Qge1xuICAgICAgY2hyb21lZHJpdmVyRGlyID0gZ2V0Q2hyb21lZHJpdmVyRGlyKCksXG4gICAgICB0aW1lb3V0ID0gVElNRU9VVF9NUyxcbiAgICB9ID0gYXJncztcbiAgICB0aGlzLmNocm9tZWRyaXZlckRpciA9IGNocm9tZWRyaXZlckRpcjtcbiAgICB0aGlzLnRpbWVvdXQgPSB0aW1lb3V0O1xuICAgIHRoaXMubWFwcGluZyA9IHt9O1xuICB9XG5cbiAgLyoqXG4gICAqIEB0eXBlZGVmIHtPYmplY3R9IEFkZGl0aW9uYWxEcml2ZXJEZXRhaWxzXG4gICAqIEBwcm9wZXJ0eSB7P3N0cmluZ30gdmVyc2lvbiAtIENocm9tZWRyaXZlciB2ZXJzaW9uXG4gICAqIG9yIGBudWxsYCBpZiBpdCBjYW5ub3QgYmUgZm91bmRcbiAgICogQHByb3BlcnR5IHs/c3RyaW5nfSBtaW5Ccm93c2VyVmVyc2lvbiAtIFRoZSBtaW5pbXVtIGJyb3dzZXIgdmVyc2lvblxuICAgKiBzdXBwb3J0ZWQgYnkgY2hyb21lZHJpdmVyIG9yIGBudWxsYCBpZiBpdCBjYW5ub3QgYmUgZm91bmRcbiAgICovXG5cbiAgLyoqXG4gICAqIEdldHMgYWRkaXRpb25hbCBjaHJvbWVkcml2ZXIgZGV0YWlscyBmcm9tIGNocm9tZWRyaXZlclxuICAgKiByZWxlYXNlIG5vdGVzXG4gICAqXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBjb250ZW50IC0gUmVsZWFzZSBub3RlcyBvZiB0aGUgY29ycmVzcG9uZGluZyBjaHJvbWVkcml2ZXJcbiAgICogQHJldHVybnMge0FkZGl0aW9uYWxEcml2ZXJEZXRhaWxzfVxuICAgKi9cbiAgcGFyc2VOb3RlcyAoY29udGVudCkge1xuICAgIGNvbnN0IHJlc3VsdCA9IHt9O1xuICAgIGNvbnN0IHZlcnNpb25NYXRjaCA9IC9eXFxzKlstXStDaHJvbWVEcml2ZXJbXFxEXSsoW1xcZC5dKykvaW0uZXhlYyhjb250ZW50KTtcbiAgICBpZiAodmVyc2lvbk1hdGNoKSB7XG4gICAgICByZXN1bHQudmVyc2lvbiA9IHZlcnNpb25NYXRjaFsxXTtcbiAgICB9XG4gICAgY29uc3QgbWluQnJvd3NlclZlcnNpb25NYXRjaCA9IC9eXFxzKlN1cHBvcnRzIENocm9tZVtcXERdKyhcXGQrKS9pbS5leGVjKGNvbnRlbnQpO1xuICAgIGlmIChtaW5Ccm93c2VyVmVyc2lvbk1hdGNoKSB7XG4gICAgICByZXN1bHQubWluQnJvd3NlclZlcnNpb24gPSBtaW5Ccm93c2VyVmVyc2lvbk1hdGNoWzFdO1xuICAgIH1cbiAgICByZXR1cm4gcmVzdWx0O1xuICB9XG5cbiAgLyoqXG4gICAqIERvd25sb2FkcyBjaHJvbWVkcml2ZXIgcmVsZWFzZSBub3RlcyBhbmQgcHV0cyB0aGVtXG4gICAqIGludG8gdGhlIGRpY3Rpb25hcnkgYXJndW1lbnRcbiAgICpcbiAgICogQHBhcmFtIHtzdHJpbmd9IGRyaXZlcktleSAtIERyaXZlciB2ZXJzaW9uIHBsdXMgYXJjaGl2ZSBuYW1lXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBub3Rlc1VybCAtIFRoZSBVUkwgb2YgY2hyb21lZHJpdmVyIG5vdGVzXG4gICAqIEBwYXJhbSB7T2JqZWN0fSBpbmZvRGljdCAtIFRoZSBkaWN0aW9uYXJ5IGNvbnRhaW5pbmcgZHJpdmVyIGluZm8uXG4gICAqIFRoZSBtZXRob2QgY2FsbCBtdXRhdGVzIGJ5IG1lcmdpbmcgYEFkZGl0aW9uYWxEcml2ZXJEZXRhaWxzYFxuICAgKiBAdGhyb3dzIHtFcnJvcn0gaWYgdGhlIHJlbGVhc2Ugbm90ZXMgY2Fubm90IGJlIGRvd25sb2FkZWRcbiAgICovXG4gIGFzeW5jIHJldHJpZXZlQWRkaXRpb25hbERyaXZlckluZm8gKGRyaXZlcktleSwgbm90ZXNVcmwsIGluZm9EaWN0KSB7XG4gICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCByZXF1ZXN0UHJvbWlzZSh7XG4gICAgICB1cmw6IG5vdGVzVXJsLFxuICAgICAgbWV0aG9kOiAnR0VUJyxcbiAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgJ3VzZXItYWdlbnQnOiAnYXBwaXVtJyxcbiAgICAgICAgYWNjZXB0OiAnKi8qJyxcbiAgICAgIH0sXG4gICAgICByZXNvbHZlV2l0aEZ1bGxSZXNwb25zZTogdHJ1ZSxcbiAgICAgIHRpbWVvdXQ6IHRoaXMudGltZW91dCxcbiAgICB9KTtcbiAgICBjb25zdCB7IG1pbkJyb3dzZXJWZXJzaW9uIH0gPSB0aGlzLnBhcnNlTm90ZXMocmVzcG9uc2UuYm9keSk7XG4gICAgaWYgKCFtaW5Ccm93c2VyVmVyc2lvbikge1xuICAgICAgbG9nLmRlYnVnKGBUaGUgZHJpdmVyICcke2RyaXZlcktleX0nIGRvZXMgbm90IGNvbnRhaW4gdmFsaWQgcmVsZWFzZSBub3RlcyBhdCAke25vdGVzVXJsfS4gYCArXG4gICAgICAgIGBTa2lwcGluZyBpdGApO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpbmZvRGljdC5taW5Ccm93c2VyVmVyc2lvbiA9IG1pbkJyb3dzZXJWZXJzaW9uO1xuICB9XG5cbiAgLyoqXG4gICAqIFBhcnNlcyBjaHJvbWVkcml2ZXIgc3RvcmFnZSBYTUwgYW5kIHN0b3Jlc1xuICAgKiB0aGUgcGFyc2VkIHJlc3VsdHMgaW50byBgdGhpcy5tYXBwaW5nYFxuICAgKlxuICAgKiBAcGFyYW0ge0RPTURvY3VtZW50fSBkb2MgLSBUaGUgRE9NIHJlcHJlc2VudGF0aW9uXG4gICAqIG9mIHRoZSBjaHJvbWVkcml2ZXIgc3RvcmFnZSBYTUxcbiAgICogQHBhcmFtIHtib29sZWFufSBzaG91bGRQYXJzZU5vdGVzIFt0cnVlXSAtIElmIHNldCB0byBgdHJ1ZWBcbiAgICogdGhlbiBhZGRpdGlvbmFsIGRyaXZlcnMgaW5mb3JtYXRpb24gaXMgZ29pbmcgdG8gYmUgcGFyc2VkXG4gICAqIGFuZCBhc3NpZ25lZCB0byBgdGhpcy5tYXBwaW5nYFxuICAgKi9cbiAgYXN5bmMgcGFyc2VTdG9yYWdlWG1sIChkb2MsIHNob3VsZFBhcnNlTm90ZXMgPSB0cnVlKSB7XG4gICAgY29uc3QgZHJpdmVyTm9kZXMgPSB4cGF0aC5zZWxlY3QoYC8vKltsb2NhbC1uYW1lKC4pPSdDb250ZW50cyddYCwgZG9jKTtcbiAgICBsb2cuZGVidWcoYFBhcnNlZCAke2RyaXZlck5vZGVzLmxlbmd0aH0gZW50cmllcyBmcm9tIHN0b3JhZ2UgWE1MYCk7XG4gICAgaWYgKF8uaXNFbXB0eShkcml2ZXJOb2RlcykpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCBwcm9taXNlcyA9IFtdO1xuICAgIGZvciAoY29uc3QgZHJpdmVyTm9kZSBvZiBkcml2ZXJOb2Rlcykge1xuICAgICAgY29uc3Qga2V5ID0gZXh0cmFjdE5vZGVUZXh0KGZpbmRDaGlsZE5vZGUoZHJpdmVyTm9kZSwgJ0tleScpKTtcbiAgICAgIGlmICghXy5pbmNsdWRlcyhrZXksICcvY2hyb21lZHJpdmVyXycpKSB7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuXG4gICAgICBsb2cuZGVidWcoYFByb2Nlc3NpbmcgY2hyb21lZHJpdmVyIGVudHJ5ICcke2tleX0nYCk7XG4gICAgICBjb25zdCBldGFnID0gZXh0cmFjdE5vZGVUZXh0KGZpbmRDaGlsZE5vZGUoZHJpdmVyTm9kZSwgJ0VUYWcnKSk7XG4gICAgICBpZiAoIWV0YWcpIHtcbiAgICAgICAgbG9nLmRlYnVnKGBUaGUgZW50cnkgJyR7a2V5fScgZG9lcyBub3QgY29udGFpbiB0aGUgY2hlY2tzdW0uIFNraXBwaW5nIGl0YCk7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBjZEluZm8gPSB7XG4gICAgICAgIHVybDogYCR7U1RPUkFHRV9VUkx9LyR7a2V5fWAsXG4gICAgICAgIGV0YWc6IF8udHJpbShldGFnLCAnXCInKSxcbiAgICAgICAgdmVyc2lvbjogXy5maXJzdChrZXkuc3BsaXQoJy8nKSksXG4gICAgICB9O1xuICAgICAgdGhpcy5tYXBwaW5nW2tleV0gPSBjZEluZm87XG5cbiAgICAgIGNvbnN0IG5vdGVzUGF0aCA9IGAke2NkSW5mby52ZXJzaW9ufS9ub3Rlcy50eHRgO1xuICAgICAgY29uc3QgaXNOb3Rlc1ByZXNlbnQgPSAhIWRyaXZlck5vZGVzXG4gICAgICAgIC5yZWR1Y2UoKGFjYywgbm9kZSkgPT4gYWNjIHx8IGZpbmRDaGlsZE5vZGUobm9kZSwgJ0tleScsIG5vdGVzUGF0aCksIGZhbHNlKTtcbiAgICAgIGlmICghaXNOb3Rlc1ByZXNlbnQpIHtcbiAgICAgICAgY2RJbmZvLm1pbkJyb3dzZXJWZXJzaW9uID0gbnVsbDtcbiAgICAgICAgaWYgKHNob3VsZFBhcnNlTm90ZXMpIHtcbiAgICAgICAgICBsb2cuaW5mbyhgVGhlIGVudHJ5ICcke2tleX0nIGRvZXMgbm90IGNvbnRhaW4gYW55IG5vdGVzLiBTa2lwcGluZyBpdGApO1xuICAgICAgICB9XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfSBlbHNlIGlmICghc2hvdWxkUGFyc2VOb3Rlcykge1xuICAgICAgICBjb250aW51ZTtcbiAgICAgIH1cblxuICAgICAgcHJvbWlzZXMucHVzaCh0aGlzLnJldHJpZXZlQWRkaXRpb25hbERyaXZlckluZm8oa2V5LCBgJHtTVE9SQUdFX1VSTH0vJHtub3Rlc1BhdGh9YCwgY2RJbmZvKSk7XG4gICAgICBpZiAocHJvbWlzZXMubGVuZ3RoICUgTUFYX1BBUkFMTEVMX0RPV05MT0FEUyA9PT0gMCkge1xuICAgICAgICBhd2FpdCBCLmFsbChwcm9taXNlcyk7XG4gICAgICB9XG4gICAgfVxuICAgIGF3YWl0IEIuYWxsKHByb21pc2VzKTtcbiAgICBsb2cuaW5mbyhgVGhlIHRvdGFsIGNvdW50IG9mIGVudHJpZXMgaW4gdGhlIG1hcHBpbmc6ICR7Xy5zaXplKHRoaXMubWFwcGluZyl9YCk7XG4gIH1cblxuICAvKipcbiAgICogQHR5cGVkZWYge09iamVjdH0gRHJpdmVyRGV0YWlsc1xuICAgKiBAcHJvcGVydHkge3N0cmluZ30gdXJsIC0gVGhlIGZ1bGwgdXJsIHRvIHRoZSBjb3JyZXNwb25kaW5nIGRyaXZlciBpblxuICAgKiB0aGUgcmVtb3RlIHN0b3JhZ2VcbiAgICogQHByb3BlcnR5IHtzdHJpbmd9IGV0YWcgLSBUaGUgQ1JDIG9mIHRoZSBkcml2ZXIgYXJjaGl2ZVxuICAgKiBAcHJvcGVydHkge3N0cmluZ30gdmVyc2lvbiAtIENocm9tZWRyaXZlciB2ZXJzaW9uXG4gICAqL1xuXG4gIC8qKlxuICAgKiBAdHlwZWRlZiB7T2JqZWN0fSBDaHJvbWVkcml2ZXJzTWFwcGluZ1xuICAgKiBAcHJvcGVydHkge0RyaXZlckRldGFpbHN9IC0gVGhlIGtleXMgYXJlIHVuaXF1ZSBkcml2ZXIgaWRlbnRpZmllcnNcbiAgICogKHZlcnNpb24vYXJjaGl2ZSBuYW1lKS4gVGhlIGNvcnJlc3BvbmRpbmcgdmFsdWVzIGhhdmUgYERyaXZlckRldGFpbHNgXG4gICAqIGNvbnRhaW5pbmcgY2hyb21lZHJpdmVyIGRldGFpbHNcbiAgICovXG5cbiAgLyoqXG4gICAqIFJldHJpZXZlcyBjaHJvbWVkcml2ZXIgbWFwcGluZyBmcm9tIHRoZSBzdG9yYWdlXG4gICAqXG4gICAqIEBwYXJhbSB7Ym9vbGVhbn0gc2hvdWxkUGFyc2VOb3RlcyBbdHJ1ZV0gLSBpZiBzZXQgdG8gYHRydWVgXG4gICAqIHRoZW4gYWRkaXRpb25hbCBjaHJvbWVkcml2ZXJzIGluZm8gaXMgZ29pbmcgdG8gYmUgcmV0cmlldmVkIGFuZFxuICAgKiBwYXJzZWQgZnJvbSByZWxlYXNlIG5vdGVzXG4gICAqIEByZXR1cm5zIHtDaHJvbWVkcml2ZXJzTWFwcGluZ31cbiAgICovXG4gIGFzeW5jIHJldHJpZXZlTWFwcGluZyAoc2hvdWxkUGFyc2VOb3RlcyA9IHRydWUpIHtcbiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHJlcXVlc3RQcm9taXNlKHtcbiAgICAgIHVybDogU1RPUkFHRV9VUkwsXG4gICAgICBtZXRob2Q6ICdHRVQnLFxuICAgICAgaGVhZGVyczoge1xuICAgICAgICAndXNlci1hZ2VudCc6ICdhcHBpdW0nLFxuICAgICAgICBhY2NlcHQ6ICdhcHBsaWNhdGlvbi94bWwsICovKicsXG4gICAgICB9LFxuICAgICAgcmVzb2x2ZVdpdGhGdWxsUmVzcG9uc2U6IHRydWUsXG4gICAgICB0aW1lb3V0OiB0aGlzLnRpbWVvdXQsXG4gICAgfSk7XG4gICAgY29uc3QgZG9jID0gbmV3IERPTVBhcnNlcigpLnBhcnNlRnJvbVN0cmluZyhyZXNwb25zZS5ib2R5KTtcbiAgICBhd2FpdCB0aGlzLnBhcnNlU3RvcmFnZVhtbChkb2MsIHNob3VsZFBhcnNlTm90ZXMpO1xuICAgIHJldHVybiBfLmNsb25lRGVlcCh0aGlzLm1hcHBpbmcpO1xuICB9XG5cbiAgLyoqXG4gICAqIEV4dHJhY3RzIGRvd25sb2FkZWQgY2hyb21lZHJpdmVyIGFyY2hpdmVcbiAgICogaW50byB0aGUgZ2l2ZW4gZGVzdGluYXRpb25cbiAgICpcbiAgICogQHBhcmFtIHtzdHJpbmd9IHNyYyAtIFRoZSBzb3VyY2UgYXJjaGl2ZSBwYXRoXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBkc3QgLSBUaGUgZGVzdGluYXRpb24gY2hyb21lZHJpdmVyIHBhdGhcbiAgICovXG4gIGFzeW5jIHVuemlwRHJpdmVyIChzcmMsIGRzdCkge1xuICAgIGNvbnN0IHRtcFJvb3QgPSBhd2FpdCB0ZW1wRGlyLm9wZW5EaXIoKTtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgemlwLmV4dHJhY3RBbGxUbyhzcmMsIHRtcFJvb3QpO1xuICAgICAgY29uc3QgYWxsRXh0cmFjdGVkSXRlbXMgPSBhd2FpdCB3YWxrRGlyKHRtcFJvb3QpO1xuICAgICAgY29uc3QgY2hyb21lZHJpdmVyUGF0aCA9IGFsbEV4dHJhY3RlZEl0ZW1zXG4gICAgICAgIC5maW5kKChwKSA9PiBwYXRoLnBhcnNlKHApLm5hbWUgPT09ICdjaHJvbWVkcml2ZXInKTtcbiAgICAgIGlmICghY2hyb21lZHJpdmVyUGF0aCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1RoZSBhcmNoaXZlIHdhcyB1bnppcHBlZCBwcm9wZXJseSwgYnV0IHdlIGNvdWxkIG5vdCBmaW5kIGFueSBjaHJvbWVkcml2ZXIgZXhlY3V0YWJsZScpO1xuICAgICAgfVxuICAgICAgbG9nLmRlYnVnKGBNb3ZpbmcgdGhlIGV4dHJhY3RlZCAnJHtwYXRoLmJhc2VuYW1lKGNocm9tZWRyaXZlclBhdGgpfScgdG8gJyR7ZHN0fSdgKTtcbiAgICAgIGF3YWl0IGZzLm12KGNocm9tZWRyaXZlclBhdGgsIGRzdCwge1xuICAgICAgICBta2RpcnA6IHRydWVcbiAgICAgIH0pO1xuICAgIH0gZmluYWxseSB7XG4gICAgICBhd2FpdCBmcy5yaW1yYWYodG1wUm9vdCk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEB0eXBlZGVmIHtPYmplY3R9IE9TSW5mb1xuICAgKiBAcHJvcGVydHkge3N0cmluZ30gbmFtZSAtIFRoZSBuYW1lIG9mIHRoZSBob3N0IE9TXG4gICAqIENhbiBiZSBlaXRoZXIgYG1hY2AsIGB3aW5kb3dzYCBvciBgbGludXhgXG4gICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBhcmNoIC0gVGhlIGFyY2hpdGVjdHVyZSBvZiB0aGUgaG9zdCBPRC5cbiAgICogQ2FuIGJlIGVpdGhlciBgMzJgIG9yIGA2NGBcbiAgICovXG5cbiAgLyoqXG4gICAqIEZpbHRlcnMgYHRoaXMubWFwcGluZ2AgdG8gb25seSBzZWxlY3QgbWF0Y2hpbmdcbiAgICogY2hyb21lZHJpdmVyIGVudHJpZXMgYnkgb3BlcmF0aW5nIHN5c3RlbSBpbmZvcm1hdGlvblxuICAgKiBhbmQvb3IgYWRkaXRpb25hbCBzeW5jaHJvbml6YXRpb24gb3B0aW9ucyAoaWYgcHJvdmlkZWQpXG4gICAqXG4gICAqIEBwYXJhbSB7T1NJbmZvfSBvc0luZm9cbiAgICogQHBhcmFtIHs/U3luY09wdGlvbnN9IG9wdHNcbiAgICogQHJldHVybnMge0FycmF5PFN0cmluZz59IFRoZSBsaXN0IG9mIGZpbHRlcmVkIGNocm9tZWRyaXZlclxuICAgKiBlbnRyeSBuYW1lcyAodmVyc2lvbi9hcmNoaXZlIG5hbWUpXG4gICAqL1xuICBzZWxlY3RNYXRjaGluZ0RyaXZlcnMgKG9zSW5mbywgb3B0cyA9IHt9KSB7XG4gICAgY29uc3Qge1xuICAgICAgbWluQnJvd3NlclZlcnNpb24sXG4gICAgICB2ZXJzaW9ucyA9IFtdLFxuICAgIH0gPSBvcHRzO1xuICAgIGxldCBkcml2ZXJzVG9TeW5jID0gXy5rZXlzKHRoaXMubWFwcGluZyk7XG5cbiAgICBpZiAoIV8uaXNFbXB0eSh2ZXJzaW9ucykpIHtcbiAgICAgIC8vIEhhbmRsZSBvbmx5IHNlbGVjdGVkIHZlcnNpb25zIGlmIHJlcXVlc3RlZFxuICAgICAgbG9nLmRlYnVnKGBTZWxlY3RpbmcgY2hyb21lZHJpdmVycyB3aG9zZSB2ZXJzaW9ucyBtYXRjaCB0byAke3ZlcnNpb25zfWApO1xuICAgICAgZHJpdmVyc1RvU3luYyA9IGRyaXZlcnNUb1N5bmNcbiAgICAgICAgLmZpbHRlcigoeCkgPT4gdmVyc2lvbnMuaW5jbHVkZXMoYCR7dGhpcy5tYXBwaW5nW3hdLnZlcnNpb259YCkpO1xuICAgICAgbG9nLmRlYnVnKGBHb3QgJHtkcml2ZXJzVG9TeW5jLmxlbmd0aH0gaXRlbSR7ZHJpdmVyc1RvU3luYy5sZW5ndGggPT09IDEgPyAnJyA6ICdzJ31gKTtcbiAgICB9XG5cbiAgICBpZiAobWluQnJvd3NlclZlcnNpb24pIHtcbiAgICAgIC8vIE9ubHkgc2VsZWN0IGRyaXZlcnMsIHdoZXJlIHRoZSBnaXZlbiBicm93c2VyIHZlcnNpb24gaXMgc2V0IGFzIHRoZSBtaW5pbWFsIG9uZVxuICAgICAgbG9nLmRlYnVnKGBTZWxlY3RpbmcgY2hyb21lZHJpdmVycyB3aG9zZSBtaW5pbXVtIHN1cHBvcnRlZCBicm93c2VyIHZlcnNpb24gbWF0Y2hlcyB0byAke21pbkJyb3dzZXJWZXJzaW9ufWApO1xuICAgICAgZHJpdmVyc1RvU3luYyA9IGRyaXZlcnNUb1N5bmMucmVkdWNlKFxuICAgICAgICAoYWNjLCB4KSA9PiB0aGlzLm1hcHBpbmdbeF0ubWluQnJvd3NlclZlcnNpb24gPT09IGAke21pbkJyb3dzZXJWZXJzaW9ufWAgPyBbLi4uYWNjLCB4XSA6IGFjYywgW10pO1xuICAgICAgbG9nLmRlYnVnKGBHb3QgJHtkcml2ZXJzVG9TeW5jLmxlbmd0aH0gaXRlbSR7ZHJpdmVyc1RvU3luYy5sZW5ndGggPT09IDEgPyAnJyA6ICdzJ31gKTtcbiAgICB9XG5cbiAgICAvLyBGaWx0ZXIgb3V0IGRyaXZlciBmb3IgdW5zdXBwb3J0ZWQgc3lzdGVtIGFyY2hpdGVjdHVyZXNcbiAgICBsZXQge25hbWUsIGFyY2h9ID0gb3NJbmZvO1xuICAgIGlmIChhcmNoID09PSAnNjQnICYmICFkcml2ZXJzVG9TeW5jLnNvbWUoKHgpID0+IHguaW5jbHVkZXMoYF8ke25hbWV9NjRgKSkpIHtcbiAgICAgIC8vIEZhbGwgYmFjayB0byB4ODYgYnVpbGQgaWYgeDY0IG9uZSBpcyBub3QgYXZhaWxhYmxlIGZvciB0aGUgZ2l2ZW4gT1NcbiAgICAgIGFyY2ggPSAnMzInO1xuICAgIH1cbiAgICBsb2cuZGVidWcoYFNlbGVjdGluZyBjaHJvbWVkcml2ZXJzIHdob3NlIHBsYXRmb3JtIG1hdGNoZXMgdG8gJHtuYW1lfSR7YXJjaH1gKTtcbiAgICBkcml2ZXJzVG9TeW5jID0gZHJpdmVyc1RvU3luYy5maWx0ZXIoKHgpID0+IHguaW5jbHVkZXMoYF8ke25hbWV9JHthcmNofWApKTtcbiAgICBsb2cuZGVidWcoYEdvdCAke2RyaXZlcnNUb1N5bmMubGVuZ3RofSBpdGVtJHtkcml2ZXJzVG9TeW5jLmxlbmd0aCA9PT0gMSA/ICcnIDogJ3MnfWApO1xuXG4gICAgcmV0dXJuIGRyaXZlcnNUb1N5bmM7XG4gIH1cblxuICAvKipcbiAgICogUmV0cmlldmVzIHRoZSBnaXZlbiBjaHJvbWVkcml2ZXIgZnJvbSB0aGUgc3RvcmFnZVxuICAgKiBhbmQgdW5wYWNrcyBpdCBpbnRvIGB0aGlzLmNocm9tZWRyaXZlckRpcmAgZm9sZGVyXG4gICAqXG4gICAqIEBwYXJhbSB7bnVtYmVyfSBpbmRleCAtIFRoZSB1bmlxdWUgZHJpdmVyIGluZGV4XG4gICAqIEBwYXJhbSB7c3RyaW5nfSBkcml2ZXJLZXkgLSBUaGUgZHJpdmVyIGtleSBpbiBgdGhpcy5tYXBwaW5nYFxuICAgKiBAcGFyYW0ge3N0cmluZ30gYXJjaGl2ZXNSb290IC0gVGhlIHRlbXBvcmFyeSBmb2xkZXIgcGF0aCB0byBleHRyYWN0XG4gICAqIGRvd25sb2FkZWQgYXJjaGl2ZXMgdG9cbiAgICogQHBhcmFtIHtib29sZWFufSBpc1N0cmljdCBbdHJ1ZV0gLSBXaGV0aGVyIHRvIHRocm93IGFuIGVycm9yIChgdHJ1ZWApXG4gICAqIG9yIHJldHVybiBhIGJvb2xlYW4gcmVzdWx0IGlmIHRoZSBkcml2ZXIgcmV0cmlldmFsIHByb2Nlc3MgZmFpbHNcbiAgICogQHRocm93cyB7RXJyb3J9IGlmIHRoZXJlIHdhcyBhIGZhaWx1cmUgd2hpbGUgcmV0cmlldmluZyB0aGUgZHJpdmVyXG4gICAqIGFuZCBgaXNTdHJpY3RgIGlzIHNldCB0byBgdHJ1ZWBcbiAgICogQHJldHVybnMge2Jvb2xlYW59IGlmIGB0cnVlYCB0aGVuIHRoZSBjaHJvbWVkcml2ZXIgaXMgc3VjY2Vzc2Z1bGx5XG4gICAqIGRvd25sb2FkZWQgYW5kIGV4dHJhY3RlZFxuICAgKi9cbiAgYXN5bmMgcmV0cmlldmVEcml2ZXIgKGluZGV4LCBkcml2ZXJLZXksIGFyY2hpdmVzUm9vdCwgaXNTdHJpY3QgPSBmYWxzZSkge1xuICAgIGNvbnN0IHsgdXJsLCBldGFnLCB2ZXJzaW9uIH0gPSB0aGlzLm1hcHBpbmdbZHJpdmVyS2V5XTtcbiAgICBjb25zdCBhcmNoaXZlUGF0aCA9IHBhdGgucmVzb2x2ZShhcmNoaXZlc1Jvb3QsIGAke2luZGV4fS56aXBgKTtcbiAgICBsb2cuZGVidWcoYFJldHJpZXZpbmcgJyR7dXJsfScgdG8gJyR7YXJjaGl2ZVBhdGh9J2ApO1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCBuZXcgQigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgIHJlcXVlc3QodXJsKVxuICAgICAgICAgIC5vbignZXJyb3InLCByZWplY3QpXG4gICAgICAgICAgLm9uKCdyZXNwb25zZScsIChyZXMpID0+IHtcbiAgICAgICAgICAgIC8vIGhhbmRsZSByZXNwb25zZXMgdGhhdCBmYWlsLCBsaWtlIDQwNHNcbiAgICAgICAgICAgIGlmIChyZXMuc3RhdHVzQ29kZSA+PSA0MDApIHtcbiAgICAgICAgICAgICAgcmV0dXJuIHJlamVjdChgRXJyb3IgZG93bmxvYWRpbmcgY2hyb21lZHJpdmVyIGF0ICR7dXJsfTogJHtyZXMuc3RhdHVzQ29kZX1gKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KVxuICAgICAgICAgIC5waXBlKGZzLmNyZWF0ZVdyaXRlU3RyZWFtKGFyY2hpdmVQYXRoKSlcbiAgICAgICAgICAub24oJ2Nsb3NlJywgcmVzb2x2ZSk7XG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBjb25zdCBtc2cgPSBgQ2Fubm90IGRvd25sb2FkIGNocm9tZWRyaXZlciBhcmNoaXZlLiBPcmlnaW5hbCBlcnJvcjogJHtlLm1lc3NhZ2V9YDtcbiAgICAgIGlmIChpc1N0cmljdCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IobXNnKTtcbiAgICAgIH1cbiAgICAgIGxvZy5lcnJvcihtc2cpO1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICBpZiAoIWF3YWl0IGlzQ3JjT2soYXJjaGl2ZVBhdGgsIGV0YWcpKSB7XG4gICAgICBjb25zdCBtc2cgPSBgVGhlIGNoZWNrc3VtIGZvciB0aGUgZG93bmxvYWRlZCBjaHJvbWVkcml2ZXIgJyR7ZHJpdmVyS2V5fScgZGlkIG5vdCBtYXRjaGA7XG4gICAgICBpZiAoaXNTdHJpY3QpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKG1zZyk7XG4gICAgICB9XG4gICAgICBsb2cuZXJyb3IobXNnKTtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gICAgY29uc3QgZmlsZU5hbWUgPSBgJHtwYXRoLnBhcnNlKHVybCkubmFtZX1fdiR7dmVyc2lvbn1gICtcbiAgICAgIChzeXN0ZW0uaXNXaW5kb3dzKCkgPyAnLmV4ZScgOiAnJyk7XG4gICAgY29uc3QgdGFyZ2V0UGF0aCA9IHBhdGgucmVzb2x2ZSh0aGlzLmNocm9tZWRyaXZlckRpciwgZmlsZU5hbWUpO1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0aGlzLnVuemlwRHJpdmVyKGFyY2hpdmVQYXRoLCB0YXJnZXRQYXRoKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBpZiAoaXNTdHJpY3QpIHtcbiAgICAgICAgdGhyb3cgZTtcbiAgICAgIH1cbiAgICAgIGxvZy5lcnJvcihlLm1lc3NhZ2UpO1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBAdHlwZWRlZiB7T2JqZWN0fSBTeW5jT3B0aW9uc1xuICAgKiBAcHJvcGVydHkge0FycmF5PFN0cmluZz59IHZlcnNpb25zIC0gVGhlIGxpc3Qgb2YgY2hyb21lZHJpdmVyXG4gICAqIHZlcnNpb25zIHRvIHN5bmMuIElmIGVtcHR5ICh0aGUgZGVmYXVsdCB2YWx1ZSkgdGhlbiBhbGwgYXZhaWxhYmxlXG4gICAqIGNocm9tZWRyaXZlcnMgYXJlIGdvaW5nIHRvIGJlIGRvd25sb2FkZWQgYW5kIGV4dHJhY3RlZFxuICAgKiBAcHJvcGVydHkge3N0cmluZ3xudW1iZXJ9IG1pbkJyb3dzZXJWZXJzaW9uIC0gVGhlIG1pbnVtdW0gc3VwcG9ydGVkXG4gICAqIENocm9tZSB2ZXJzaW9uIHRoYXQgZG93bmxvYWRlZCBjaHJvbWVkcml2ZXJzIHNob3VsZCBzdXBwb3J0LiBDYW4gbWF0Y2hcbiAgICogbXVsdGlwbGUgZHJpdmVycy5cbiAgICovXG5cbiAgLyoqXG4gICAqIFJldHJpZXZlcyBjaHJvbWVkcml2ZXJzIGZyb20gdGhlIHJlbW90ZSBzdG9yYWdlXG4gICAqIHRvIHRoZSBsb2NhbCBmaWxlIHN5c3RlbVxuICAgKlxuICAgKiBAcGFyYW0gez9TeW5jT3B0aW9uc30gb3B0c1xuICAgKiBAdGhyb3dzIHtFcnJvcn0gaWYgdGhlcmUgd2FzIGEgcHJvYmxlbSB3aGlsZSByZXRyaWV2aW5nXG4gICAqIHRoZSBkcml2ZXJzXG4gICAqIEByZXR1cm5zIHtBcnJheTxTdHJpbmd9IFRoZSBsaXN0IG9mIHN1Y2Nlc3NmdWxseSBzeW5jaHJvbml6ZWQgZHJpdmVyIGtleXNcbiAgICovXG4gIGFzeW5jIHN5bmNEcml2ZXJzIChvcHRzID0ge30pIHtcbiAgICBpZiAoXy5pc0VtcHR5KHRoaXMubWFwcGluZykpIHtcbiAgICAgIGF3YWl0IHRoaXMucmV0cmlldmVNYXBwaW5nKCEhb3B0cy5taW5Ccm93c2VyVmVyc2lvbik7XG4gICAgfVxuICAgIGlmIChfLmlzRW1wdHkodGhpcy5tYXBwaW5nKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdDYW5ub3QgcmV0cmlldmUgY2hyb21lZHJpdmVycyBtYXBwaW5nIGZyb20gR29vZ2xlIHN0b3JhZ2UnKTtcbiAgICB9XG5cbiAgICBjb25zdCBkcml2ZXJzVG9TeW5jID0gdGhpcy5zZWxlY3RNYXRjaGluZ0RyaXZlcnMoYXdhaXQgZ2V0T3NJbmZvKCksIG9wdHMpO1xuICAgIGlmIChfLmlzRW1wdHkoZHJpdmVyc1RvU3luYykpIHtcbiAgICAgIGxvZy5kZWJ1ZyhgVGhlcmUgYXJlIG5vIGRyaXZlcnMgdG8gc3luYy4gRXhpdGluZ2ApO1xuICAgICAgcmV0dXJuIFtdO1xuICAgIH1cbiAgICBsb2cuZGVidWcoYEdvdCAke2RyaXZlcnNUb1N5bmMubGVuZ3RofSBkcml2ZXIocykgdG8gc3luYzogJHtkcml2ZXJzVG9TeW5jfWApO1xuXG4gICAgY29uc3Qgc3luY2hyb25pemVkRHJpdmVycyA9IFtdO1xuICAgIGNvbnN0IHByb21pc2VzID0gW107XG4gICAgY29uc3QgYXJjaGl2ZXNSb290ID0gYXdhaXQgdGVtcERpci5vcGVuRGlyKCk7XG4gICAgdHJ5IHtcbiAgICAgIGZvciAoY29uc3QgW2lkeCwgZHJpdmVyS2V5XSBvZiBkcml2ZXJzVG9TeW5jLmVudHJpZXMoKSkge1xuICAgICAgICBwcm9taXNlcy5wdXNoKChhc3luYyAoKSA9PiB7XG4gICAgICAgICAgaWYgKGF3YWl0IHRoaXMucmV0cmlldmVEcml2ZXIoaWR4LCBkcml2ZXJLZXksIGFyY2hpdmVzUm9vdCwgIV8uaXNFbXB0eShvcHRzKSkpIHtcbiAgICAgICAgICAgIHN5bmNocm9uaXplZERyaXZlcnMucHVzaChkcml2ZXJLZXkpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSkoKSk7XG5cbiAgICAgICAgaWYgKHByb21pc2VzLmxlbmd0aCAlIE1BWF9QQVJBTExFTF9ET1dOTE9BRFMgPT09IDApIHtcbiAgICAgICAgICBhd2FpdCBCLmFsbChwcm9taXNlcyk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGF3YWl0IEIuYWxsKHByb21pc2VzKTtcbiAgICB9IGZpbmFsbHkge1xuICAgICAgYXdhaXQgZnMucmltcmFmKGFyY2hpdmVzUm9vdCk7XG4gICAgfVxuICAgIGlmICghXy5pc0VtcHR5KHN5bmNocm9uaXplZERyaXZlcnMpKSB7XG4gICAgICBsb2cuaW5mbyhgU3VjY2Vzc2Z1bGx5IHN5bmNocm9uaXplZCAke3N5bmNocm9uaXplZERyaXZlcnMubGVuZ3RofSBgICtcbiAgICAgICAgYGNocm9tZWRyaXZlciR7c3luY2hyb25pemVkRHJpdmVycy5sZW5ndGggPT09IDEgPyAnJyA6ICdzJ31gKTtcbiAgICB9IGVsc2Uge1xuICAgICAgbG9nLmluZm8oYE5vIGNocm9tZWRyaXZlcnMgd2VyZSBzeW5jaHJvbml6ZWRgKTtcbiAgICB9XG4gICAgcmV0dXJuIHN5bmNocm9uaXplZERyaXZlcnM7XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgQ2hyb21lZHJpdmVyU3RvcmFnZUNsaWVudDsiXSwiZmlsZSI6ImxpYi9zdG9yYWdlLWNsaWVudC5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLiJ9
