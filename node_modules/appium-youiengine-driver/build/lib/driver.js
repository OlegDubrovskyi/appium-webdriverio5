"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.YouiEngineDriver = void 0;

require("source-map-support/register");

var _appiumBaseDriver = require("appium-base-driver");

var _desiredCaps = require("./desired-caps");

var _logger = _interopRequireDefault(require("./logger"));

var _index = _interopRequireDefault(require("./commands/index"));

var _lodash = _interopRequireDefault(require("lodash"));

var _bluebird = _interopRequireDefault(require("bluebird"));

var _asyncbox = require("asyncbox");

var _appiumAndroidDriver = _interopRequireDefault(require("appium-android-driver"));

var _appiumIosDriver = _interopRequireDefault(require("appium-ios-driver"));

var _appiumXcuitestDriver = _interopRequireDefault(require("appium-xcuitest-driver"));

var _appiumMacDriver = _interopRequireDefault(require("appium-mac-driver"));

var _bluesky = _interopRequireDefault(require("./bluesky"));

var _tvos = _interopRequireDefault(require("./tvos"));

var _tvossimulator = _interopRequireDefault(require("./tvossimulator"));

var _yimac = _interopRequireDefault(require("./yimac"));

const TO_PROXY_COMMON = ['background', 'closeApp', 'getLog', 'getLogTypes', 'getOrientation', 'getStrings', 'installApp', 'launchApp', 'lock', 'removeApp', 'setOrientation'];
const TO_PROXY_IOS_ONLY = ['mobileShake'];
const TO_PROXY_ANDROID_ONLY = ['getNetworkConnection', 'isAppInstalled', 'isLocked', 'longPressKeyCode', 'pressKeyCode', 'setNetworkConnection', 'toggleLocationServices', 'unlock'];
const TO_PROXY_IOS = TO_PROXY_IOS_ONLY.concat(TO_PROXY_COMMON);
const TO_PROXY_ANDROID = TO_PROXY_ANDROID_ONLY.concat(TO_PROXY_COMMON);
const TO_PROXY_MAC = TO_PROXY_COMMON;
const MAX_RETRY_COUNT = 10;
const RETRY_BACKOFF = 3000;

class YouiEngineDriver extends _appiumBaseDriver.BaseDriver {
  resetYouiEngine() {
    this.ready = false;
    this.socket = null;
    this.locatorStrategies = ['id', 'name', 'class name', 'accessibility id'];
    this.proxydriver = null;
    this.proxyAllowList = '';
    this.device = null;
  }

  constructor(opts, shouldValidateCaps) {
    super(opts, shouldValidateCaps);
    this.desiredCapConstraints = _desiredCaps.desiredCapConstraints;
    this.settings = new _appiumBaseDriver.DeviceSettings({
      'TimeDilation': 1,
      'SourceTreeFilter': ''
    }, this.onSettingsUpdate.bind(this));
    this.resetYouiEngine();
  }

  validateLocatorStrategy(strategy) {
    super.validateLocatorStrategy(strategy, false);
  }

  async createSession(caps) {
    try {
      let [sessionId] = await super.createSession(caps);

      if (caps.platformName !== null) {
        let appPlatform = caps.platformName.toLowerCase();

        switch (appPlatform) {
          case "ios":
            await this.startIOSSession(caps);
            break;

          case "android":
            await this.startAndroidSession(caps);
            break;

          case "mac":
            await this.startMacSession(caps);
            break;

          case "yimac":
            this.device = new _yimac.default();
            await this.device.startSession(caps);
            break;

          case "bluesky":
            this.device = new _bluesky.default();
            await this.device.startSession(caps);
            break;

          case "yitvos":
            {
              let shell = require('shelljs');

              if (shell.exec(`instruments -s devices | grep '${caps.udid}'`).includes('(Simulator)')) {
                this.device = new _tvossimulator.default();
              } else {
                this.device = new _tvos.default();
              }

              await this.device.startSession(caps, this);
              break;
            }

          case "noproxy":
          case "connecttoapp":
            break;

          default:
            _logger.default.errorAndThrow(`Unsupported platformName: ${caps.platformName}`);

        }
      }

      await this.connectSocket();

      if (caps.fullSourceTree === true) {} else {
        await this.updateSettings({
          SourceTreeFilter: "[@isDisplayed='true']"
        });
      }

      return [sessionId, this.opts];
    } catch (e) {
      await this.deleteSession();
      throw e;
    }
  }

  async onSettingsUpdate(key, value) {
    if (key === "TimeDilation") {
      await this.setTimeDilation(value);
    } else if (key === "SourceTreeFilter") {
      await this.setSourceTreeFilter(value);
    }
  }

  async stop() {
    this.ready = false;
  }

  async deleteSession() {
    _logger.default.debug("Deleting YouiEngine session");

    if (this.caps.platformName !== null) {
      let appPlatform = this.caps.platformName.toLowerCase();

      if (["yimac", "yitvos", "bluesky"].includes(appPlatform)) {
        if (this.device) {
          this.device.endSession();
        }
      }
    }

    if (this.proxydriver !== null) {
      await this.proxydriver.deleteSession();
    }

    await super.deleteSession();
    await this.stop();
  }

  driverShouldDoProxyCmd(command) {
    if (!this.proxydriver) {
      return false;
    }

    for (let allowedCommand of this.proxyAllowList) {
      if (allowedCommand === command) {
        return true;
      }
    }

    return false;
  }

  async executeCommand(cmd, ...args) {
    if (cmd === 'receiveAsyncResponse') {
      _logger.default.debug(`Executing YouiEngineDriver response '${cmd}'`);

      return await this.receiveAsyncResponse(...args);
    } else if (this.ready) {
      if (this.driverShouldDoProxyCmd(cmd)) {
        _logger.default.debug(`Executing proxied WebDriver command '${cmd}'`);

        this.clearNewCommandTimeout();
        let result = this.proxydriver.executeCommand(cmd, ...args);
        this.startNewCommandTimeout(cmd);
        return result;
      } else {
        _logger.default.debug(`Executing YouiEngine WebDriver command '${cmd}'`);

        return super.executeCommand(cmd, ...args);
      }
    } else {
      _logger.default.debug(`Command Error '${cmd}'`);

      throw new _appiumBaseDriver.errors.NoSuchDriverError(`Driver is not ready, cannot execute ${cmd}.`);
    }
  }

  validateDesiredCaps(caps) {
    let res = super.validateDesiredCaps(caps);

    if (!res) {
      return res;
    }

    if (!caps.youiEngineAppAddress) {
      let msg = 'The desired capabilities must include youiEngineAppAddress';

      _logger.default.errorAndThrow(msg);
    }

    if (caps.platformName.toLowerCase() !== 'connecttoapp' && caps.platformName.toLowerCase() !== 'noproxy') {
      if (!caps.app) {
        let msg = 'The desired capabilities must include app';

        _logger.default.errorAndThrow(msg);
      }

      const fs = require('fs');

      const path = require('path');

      if (!fs.existsSync(caps.app)) {
        let absolutepath = path.resolve(caps.app);
        let msg = 'The app could not be found in following location: ' + absolutepath;

        _logger.default.errorAndThrow(msg);
      }

      if (caps.deviceName.toLowerCase() === 'android') {
        if (!caps.avd) {
          let msg = 'The desired capabilities must include avd';

          _logger.default.errorAndThrow(msg);
        }
      }
    }

    return true;
  }

  async setupNewIOSDriver(caps) {
    let iosArgs = {
      javascriptEnabled: true
    };
    let iosdriver = new _appiumXcuitestDriver.default(iosArgs);

    if (caps.platformVersion) {
      let majorVer = caps.platformVersion.toString().split(".")[0];

      if (parseInt(majorVer, 10) < 10) {
        iosdriver = new _appiumIosDriver.default(iosArgs);
      }
    }

    let capsCopy = _lodash.default.cloneDeep(caps);

    capsCopy.newCommandTimeout = 0;
    await iosdriver.createSession(capsCopy);
    return iosdriver;
  }

  async startIOSSession(caps) {
    _logger.default.info("Starting an IOS proxy session");

    this.proxyAllowList = TO_PROXY_IOS;
    this.proxydriver = await this.setupNewIOSDriver(caps);
  }

  async setupNewAndroidDriver(caps) {
    let androidArgs = {
      javascriptEnabled: true
    };
    let androiddriver = new _appiumAndroidDriver.default(androidArgs);

    let capsCopy = _lodash.default.cloneDeep(caps);

    capsCopy.newCommandTimeout = 0;
    await androiddriver.createSession(capsCopy);
    return androiddriver;
  }

  async startAndroidSession(caps) {
    _logger.default.info("Starting an Android proxy session");

    this.proxyAllowList = TO_PROXY_ANDROID;
    this.proxydriver = await this.setupNewAndroidDriver(caps);
  }

  async setupNewMacDriver(caps) {
    let macArgs = {
      javascriptEnabled: true
    };
    let macdriver = new _appiumMacDriver.default(macArgs);

    let capsCopy = _lodash.default.cloneDeep(caps);

    capsCopy.newCommandTimeout = 0;
    await macdriver.createSession(capsCopy);
    return macdriver;
  }

  async startMacSession(caps) {
    _logger.default.info("Starting a Mac proxy session");

    this.proxyAllowList = TO_PROXY_MAC;
    this.proxydriver = await this.setupNewMacDriver(caps);
  }

  async connectSocket() {
    let retryCount = 0;
    let connected = false;

    while (retryCount < MAX_RETRY_COUNT && !connected) {
      if (retryCount > 0) {
        _logger.default.info("Waiting " + RETRY_BACKOFF / 1000 + " seconds before trying...");

        await (0, _asyncbox.sleep)(RETRY_BACKOFF);
      }

      _logger.default.info("Attempt #" + (retryCount + 1));

      let connectedPromise = new _bluebird.default(resolve => {
        let net = require('net');

        let HOST = this.opts.youiEngineAppAddress;
        let PORT = 12345;

        _logger.default.info('Connecting to WebDriver: ' + HOST + ':' + PORT);

        this.socket = new net.Socket();
        this.socket.on('error', function (ex) {
          _logger.default.error(ex);

          _logger.default.error('Check that WebDriver is enabled in application, if a device ensure the proper IP address is used.');

          resolve(false);
        });
        this.socket.on('close', function () {
          _logger.default.info('Connection closed');
        });
        this.socket.on('timeout', function () {
          _logger.default.error('Connection timed out');

          resolve(false);
        });
        this.socket.connect(PORT, HOST, function () {
          _logger.default.info('Connected');

          resolve(true);
        });
      });
      retryCount++;
      connected = await connectedPromise;

      if (!connected && retryCount === MAX_RETRY_COUNT - 1) {
        _logger.default.errorAndThrow("Failed to connect " + MAX_RETRY_COUNT + " times. Aborting.");
      }
    }

    retryCount = 0;
    this.ready = connected;
  }

  async executeSocketCommand(cmd) {
    if (!this.socket.writable) {
      _logger.default.info("Socket is not writable. Trying to reconnect.");

      await this.connectSocket();
    }

    let cmdPromise = new _bluebird.default(resolve => {
      _logger.default.debug('COMMAND: ' + cmd);

      let totaldata = [];
      let endMarker = new Buffer("youiend");
      let socketClient = this.socket;

      let dataHandler = function (data) {
        if (data.length >= endMarker.length) {
          let dataend = new Buffer(endMarker.length);
          let startIndex = data.length - endMarker.length;
          data.copy(dataend, 0, startIndex, startIndex + endMarker.length);

          if (dataend.equals(endMarker)) {
            let lastData = data.slice(0, startIndex);
            totaldata.push(lastData);
            socketClient.removeListener('data', dataHandler);
            resolve(Buffer.concat(totaldata));
          } else {
            totaldata.push(data);
          }
        }
      };

      socketClient.write(cmd + "\n", "UTF8", () => {
        socketClient.on('data', dataHandler);
      });
    });
    return await cmdPromise;
  }

}

exports.YouiEngineDriver = YouiEngineDriver;

for (let [cmd, fn] of _lodash.default.toPairs(_index.default)) {
  YouiEngineDriver.prototype[cmd] = fn;
}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9kcml2ZXIuanMiXSwibmFtZXMiOlsiVE9fUFJPWFlfQ09NTU9OIiwiVE9fUFJPWFlfSU9TX09OTFkiLCJUT19QUk9YWV9BTkRST0lEX09OTFkiLCJUT19QUk9YWV9JT1MiLCJjb25jYXQiLCJUT19QUk9YWV9BTkRST0lEIiwiVE9fUFJPWFlfTUFDIiwiTUFYX1JFVFJZX0NPVU5UIiwiUkVUUllfQkFDS09GRiIsIllvdWlFbmdpbmVEcml2ZXIiLCJCYXNlRHJpdmVyIiwicmVzZXRZb3VpRW5naW5lIiwicmVhZHkiLCJzb2NrZXQiLCJsb2NhdG9yU3RyYXRlZ2llcyIsInByb3h5ZHJpdmVyIiwicHJveHlBbGxvd0xpc3QiLCJkZXZpY2UiLCJjb25zdHJ1Y3RvciIsIm9wdHMiLCJzaG91bGRWYWxpZGF0ZUNhcHMiLCJkZXNpcmVkQ2FwQ29uc3RyYWludHMiLCJzZXR0aW5ncyIsIkRldmljZVNldHRpbmdzIiwib25TZXR0aW5nc1VwZGF0ZSIsImJpbmQiLCJ2YWxpZGF0ZUxvY2F0b3JTdHJhdGVneSIsInN0cmF0ZWd5IiwiY3JlYXRlU2Vzc2lvbiIsImNhcHMiLCJzZXNzaW9uSWQiLCJwbGF0Zm9ybU5hbWUiLCJhcHBQbGF0Zm9ybSIsInRvTG93ZXJDYXNlIiwic3RhcnRJT1NTZXNzaW9uIiwic3RhcnRBbmRyb2lkU2Vzc2lvbiIsInN0YXJ0TWFjU2Vzc2lvbiIsIllpTWFjIiwic3RhcnRTZXNzaW9uIiwiQmx1ZVNreSIsInNoZWxsIiwicmVxdWlyZSIsImV4ZWMiLCJ1ZGlkIiwiaW5jbHVkZXMiLCJUdk9zU2ltdWxhdG9yIiwiVHZPcyIsImxvZ2dlciIsImVycm9yQW5kVGhyb3ciLCJjb25uZWN0U29ja2V0IiwiZnVsbFNvdXJjZVRyZWUiLCJ1cGRhdGVTZXR0aW5ncyIsIlNvdXJjZVRyZWVGaWx0ZXIiLCJlIiwiZGVsZXRlU2Vzc2lvbiIsImtleSIsInZhbHVlIiwic2V0VGltZURpbGF0aW9uIiwic2V0U291cmNlVHJlZUZpbHRlciIsInN0b3AiLCJkZWJ1ZyIsImVuZFNlc3Npb24iLCJkcml2ZXJTaG91bGREb1Byb3h5Q21kIiwiY29tbWFuZCIsImFsbG93ZWRDb21tYW5kIiwiZXhlY3V0ZUNvbW1hbmQiLCJjbWQiLCJhcmdzIiwicmVjZWl2ZUFzeW5jUmVzcG9uc2UiLCJjbGVhck5ld0NvbW1hbmRUaW1lb3V0IiwicmVzdWx0Iiwic3RhcnROZXdDb21tYW5kVGltZW91dCIsImVycm9ycyIsIk5vU3VjaERyaXZlckVycm9yIiwidmFsaWRhdGVEZXNpcmVkQ2FwcyIsInJlcyIsInlvdWlFbmdpbmVBcHBBZGRyZXNzIiwibXNnIiwiYXBwIiwiZnMiLCJwYXRoIiwiZXhpc3RzU3luYyIsImFic29sdXRlcGF0aCIsInJlc29sdmUiLCJkZXZpY2VOYW1lIiwiYXZkIiwic2V0dXBOZXdJT1NEcml2ZXIiLCJpb3NBcmdzIiwiamF2YXNjcmlwdEVuYWJsZWQiLCJpb3Nkcml2ZXIiLCJYQ1VJVGVzdERyaXZlciIsInBsYXRmb3JtVmVyc2lvbiIsIm1ham9yVmVyIiwidG9TdHJpbmciLCJzcGxpdCIsInBhcnNlSW50IiwiSU9TRHJpdmVyIiwiY2Fwc0NvcHkiLCJfIiwiY2xvbmVEZWVwIiwibmV3Q29tbWFuZFRpbWVvdXQiLCJpbmZvIiwic2V0dXBOZXdBbmRyb2lkRHJpdmVyIiwiYW5kcm9pZEFyZ3MiLCJhbmRyb2lkZHJpdmVyIiwiQW5kcm9pZERyaXZlciIsInNldHVwTmV3TWFjRHJpdmVyIiwibWFjQXJncyIsIm1hY2RyaXZlciIsIk1hY0RyaXZlciIsInJldHJ5Q291bnQiLCJjb25uZWN0ZWQiLCJjb25uZWN0ZWRQcm9taXNlIiwiQiIsIm5ldCIsIkhPU1QiLCJQT1JUIiwiU29ja2V0Iiwib24iLCJleCIsImVycm9yIiwiY29ubmVjdCIsImV4ZWN1dGVTb2NrZXRDb21tYW5kIiwid3JpdGFibGUiLCJjbWRQcm9taXNlIiwidG90YWxkYXRhIiwiZW5kTWFya2VyIiwiQnVmZmVyIiwic29ja2V0Q2xpZW50IiwiZGF0YUhhbmRsZXIiLCJkYXRhIiwibGVuZ3RoIiwiZGF0YWVuZCIsInN0YXJ0SW5kZXgiLCJjb3B5IiwiZXF1YWxzIiwibGFzdERhdGEiLCJzbGljZSIsInB1c2giLCJyZW1vdmVMaXN0ZW5lciIsIndyaXRlIiwiZm4iLCJ0b1BhaXJzIiwiY29tbWFuZHMiLCJwcm90b3R5cGUiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBR0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBTUEsTUFBTUEsZUFBZSxHQUFHLENBQ3RCLFlBRHNCLEVBRXRCLFVBRnNCLEVBR3RCLFFBSHNCLEVBSXRCLGFBSnNCLEVBS3RCLGdCQUxzQixFQU10QixZQU5zQixFQU90QixZQVBzQixFQVF0QixXQVJzQixFQVN0QixNQVRzQixFQVV0QixXQVZzQixFQVd0QixnQkFYc0IsQ0FBeEI7QUFjQSxNQUFNQyxpQkFBaUIsR0FBRyxDQUN4QixhQUR3QixDQUExQjtBQUlBLE1BQU1DLHFCQUFxQixHQUFHLENBQzVCLHNCQUQ0QixFQUU1QixnQkFGNEIsRUFHNUIsVUFINEIsRUFJNUIsa0JBSjRCLEVBSzVCLGNBTDRCLEVBTTVCLHNCQU40QixFQU81Qix3QkFQNEIsRUFRNUIsUUFSNEIsQ0FBOUI7QUFXQSxNQUFNQyxZQUFZLEdBQUdGLGlCQUFpQixDQUFDRyxNQUFsQixDQUF5QkosZUFBekIsQ0FBckI7QUFDQSxNQUFNSyxnQkFBZ0IsR0FBR0gscUJBQXFCLENBQUNFLE1BQXRCLENBQTZCSixlQUE3QixDQUF6QjtBQUNBLE1BQU1NLFlBQVksR0FBR04sZUFBckI7QUFFQSxNQUFNTyxlQUFlLEdBQUcsRUFBeEI7QUFDQSxNQUFNQyxhQUFhLEdBQUcsSUFBdEI7O0FBRUEsTUFBTUMsZ0JBQU4sU0FBK0JDLDRCQUEvQixDQUEwQztBQUN4Q0MsRUFBQUEsZUFBZSxHQUFJO0FBRWpCLFNBQUtDLEtBQUwsR0FBYSxLQUFiO0FBQ0EsU0FBS0MsTUFBTCxHQUFjLElBQWQ7QUFDQSxT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dCI6WyJpbXBvcnQgeyBCYXNlRHJpdmVyLCBEZXZpY2VTZXR0aW5ncywgZXJyb3JzIH0gZnJvbSAnYXBwaXVtLWJhc2UtZHJpdmVyJztcbmltcG9ydCB7IGRlc2lyZWRDYXBDb25zdHJhaW50cyB9IGZyb20gJy4vZGVzaXJlZC1jYXBzJztcbmltcG9ydCBsb2dnZXIgZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IGNvbW1hbmRzIGZyb20gJy4vY29tbWFuZHMvaW5kZXgnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBCIGZyb20gJ2JsdWViaXJkJztcbmltcG9ydCB7IHNsZWVwIH0gZnJvbSAnYXN5bmNib3gnO1xuXG4vLyBmb3IgcHJveGllc1xuaW1wb3J0IEFuZHJvaWREcml2ZXIgZnJvbSAnYXBwaXVtLWFuZHJvaWQtZHJpdmVyJztcbmltcG9ydCBJT1NEcml2ZXIgZnJvbSAnYXBwaXVtLWlvcy1kcml2ZXInO1xuaW1wb3J0IFhDVUlUZXN0RHJpdmVyIGZyb20gJ2FwcGl1bS14Y3VpdGVzdC1kcml2ZXInO1xuaW1wb3J0IE1hY0RyaXZlciBmcm9tICdhcHBpdW0tbWFjLWRyaXZlcic7XG5pbXBvcnQgQmx1ZVNreSBmcm9tICcuL2JsdWVza3knO1xuaW1wb3J0IFR2T3MgZnJvbSAnLi90dm9zJztcbmltcG9ydCBUdk9zU2ltdWxhdG9yIGZyb20gJy4vdHZvc3NpbXVsYXRvcic7XG5pbXBvcnQgWWlNYWMgZnJvbSAnLi95aW1hYyc7XG5cblxuLy8gQWRkIGNvbW1hbmRzIGZyb20gdGhlIGZvbGxvd2luZyBsb2NhdGlvbiB0aGF0IHNob3VsZCBiZSBtYXBwZWQgdG8gZXhpc3RpbmcgZHJpdmVyczpcbi8vIGh0dHBzOi8vZ2l0aHViLmNvbS9hcHBpdW0vYXBwaXVtLWJhc2UtZHJpdmVyL2Jsb2IvbWFzdGVyL2xpYi9tanNvbndwL3JvdXRlcy5qc1xuXG5jb25zdCBUT19QUk9YWV9DT01NT04gPSBbXG4gICdiYWNrZ3JvdW5kJyxcbiAgJ2Nsb3NlQXBwJyxcbiAgJ2dldExvZycsXG4gICdnZXRMb2dUeXBlcycsXG4gICdnZXRPcmllbnRhdGlvbicsXG4gICdnZXRTdHJpbmdzJyxcbiAgJ2luc3RhbGxBcHAnLFxuICAnbGF1bmNoQXBwJyxcbiAgJ2xvY2snLFxuICAncmVtb3ZlQXBwJyxcbiAgJ3NldE9yaWVudGF0aW9uJyxcbl07XG5cbmNvbnN0IFRPX1BST1hZX0lPU19PTkxZID0gW1xuICAnbW9iaWxlU2hha2UnLFxuXTtcblxuY29uc3QgVE9fUFJPWFlfQU5EUk9JRF9PTkxZID0gW1xuICAnZ2V0TmV0d29ya0Nvbm5lY3Rpb24nLFxuICAnaXNBcHBJbnN0YWxsZWQnLFxuICAnaXNMb2NrZWQnLFxuICAnbG9uZ1ByZXNzS2V5Q29kZScsXG4gICdwcmVzc0tleUNvZGUnLFxuICAnc2V0TmV0d29ya0Nvbm5lY3Rpb24nLFxuICAndG9nZ2xlTG9jYXRpb25TZXJ2aWNlcycsXG4gICd1bmxvY2snLFxuXTtcblxuY29uc3QgVE9fUFJPWFlfSU9TID0gVE9fUFJPWFlfSU9TX09OTFkuY29uY2F0KFRPX1BST1hZX0NPTU1PTik7XG5jb25zdCBUT19QUk9YWV9BTkRST0lEID0gVE9fUFJPWFlfQU5EUk9JRF9PTkxZLmNvbmNhdChUT19QUk9YWV9DT01NT04pO1xuY29uc3QgVE9fUFJPWFlfTUFDID0gVE9fUFJPWFlfQ09NTU9OO1xuXG5jb25zdCBNQVhfUkVUUllfQ09VTlQgPSAxMDtcbmNvbnN0IFJFVFJZX0JBQ0tPRkYgPSAzMDAwO1xuXG5jbGFzcyBZb3VpRW5naW5lRHJpdmVyIGV4dGVuZHMgQmFzZURyaXZlciB7XG4gIHJlc2V0WW91aUVuZ2luZSAoKSB7XG5cbiAgICB0aGlzLnJlYWR5ID0gZmFsc2U7XG4gICAgdGhpcy5zb2NrZXQgPSBudWxsO1xuICAgIHRoaXMubG9jYXRvclN0cmF0ZWdpZXMgPSBbJ2lkJywgJ25hbWUnLCAnY2xhc3MgbmFtZScsICdhY2Nlc3NpYmlsaXR5IGlkJ107XG4gICAgdGhpcy5wcm94eWRyaXZlciA9IG51bGw7XG4gICAgdGhpcy5wcm94eUFsbG93TGlzdCA9ICcnO1xuICAgIHRoaXMuZGV2aWNlID0gbnVsbDtcbiAgfVxuXG4gIGNvbnN0cnVjdG9yIChvcHRzLCBzaG91bGRWYWxpZGF0ZUNhcHMpIHtcbiAgICBzdXBlcihvcHRzLCBzaG91bGRWYWxpZGF0ZUNhcHMpO1xuXG4gICAgdGhpcy5kZXNpcmVkQ2FwQ29uc3RyYWludHMgPSBkZXNpcmVkQ2FwQ29uc3RyYWludHM7XG4gICAgdGhpcy5zZXR0aW5ncyA9IG5ldyBEZXZpY2VTZXR0aW5ncyh7J1RpbWVEaWxhdGlvbic6IDEsICdTb3VyY2VUcmVlRmlsdGVyJzogJyd9LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm9uU2V0dGluZ3NVcGRhdGUuYmluZCh0aGlzKSk7XG4gICAgdGhpcy5yZXNldFlvdWlFbmdpbmUoKTtcblxuICB9XG5cbiAgdmFsaWRhdGVMb2NhdG9yU3RyYXRlZ3kgKHN0cmF0ZWd5KSB7XG4gICAgc3VwZXIudmFsaWRhdGVMb2NhdG9yU3RyYXRlZ3koc3RyYXRlZ3ksIGZhbHNlKTtcbiAgfVxuXG4gIGFzeW5jIGNyZWF0ZVNlc3Npb24gKGNhcHMpIHtcbiAgICB0cnkge1xuICAgICAgbGV0IFtzZXNzaW9uSWRdID0gYXdhaXQgc3VwZXIuY3JlYXRlU2Vzc2lvbihjYXBzKTtcblxuICAgICAgLy8gc2V0dXAgcHJveGllcyAtIGlmIHBsYXRmb3JtTmFtZSBpcyBub3QgZW1wdHksIG1ha2UgaXQgbGVzcyBjYXNlIHNlbnNpdGl2ZVxuICAgICAgaWYgKGNhcHMucGxhdGZvcm1OYW1lICE9PSBudWxsKSB7XG4gICAgICAgIGxldCBhcHBQbGF0Zm9ybSA9IGNhcHMucGxhdGZvcm1OYW1lLnRvTG93ZXJDYXNlKCk7XG4gICAgICAgIHN3aXRjaCAoYXBwUGxhdGZvcm0pIHtcbiAgICAgICAgICBjYXNlIFwiaW9zXCI6XG4gICAgICAgICAgICBhd2FpdCB0aGlzLnN0YXJ0SU9TU2Vzc2lvbihjYXBzKTtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIGNhc2UgXCJhbmRyb2lkXCI6XG4gICAgICAgICAgICBhd2FpdCB0aGlzLnN0YXJ0QW5kcm9pZFNlc3Npb24oY2Fwcyk7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgICBjYXNlIFwibWFjXCI6XG4gICAgICAgICAgICBhd2FpdCB0aGlzLnN0YXJ0TWFjU2Vzc2lvbihjYXBzKTtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIGNhc2UgXCJ5aW1hY1wiOlxuICAgICAgICAgICAgdGhpcy5kZXZpY2UgPSBuZXcgWWlNYWMoKTtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuZGV2aWNlLnN0YXJ0U2Vzc2lvbihjYXBzKTtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIGNhc2UgXCJibHVlc2t5XCI6XG4gICAgICAgICAgICB0aGlzLmRldmljZSA9IG5ldyBCbHVlU2t5KCk7XG4gICAgICAgICAgICBhd2FpdCB0aGlzLmRldmljZS5zdGFydFNlc3Npb24oY2Fwcyk7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgICBjYXNlIFwieWl0dm9zXCI6IHtcbiAgICAgICAgICAgIGxldCBzaGVsbCA9IHJlcXVpcmUoJ3NoZWxsanMnKTtcbiAgICAgICAgICAgIGlmIChzaGVsbC5leGVjKGBpbnN0cnVtZW50cyAtcyBkZXZpY2VzIHwgZ3JlcCAnJHtjYXBzLnVkaWR9J2ApLmluY2x1ZGVzKCcoU2ltdWxhdG9yKScpKSB7XG4gICAgICAgICAgICAgIHRoaXMuZGV2aWNlID0gbmV3IFR2T3NTaW11bGF0b3IoKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIHRoaXMuZGV2aWNlID0gbmV3IFR2T3MoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGF3YWl0IHRoaXMuZGV2aWNlLnN0YXJ0U2Vzc2lvbihjYXBzLCB0aGlzKTtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIH1cbiAgICAgICAgICBjYXNlIFwibm9wcm94eVwiOlxuICAgICAgICAgIGNhc2UgXCJjb25uZWN0dG9hcHBcIjpcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICBsb2dnZXIuZXJyb3JBbmRUaHJvdyhgVW5zdXBwb3J0ZWQgcGxhdGZvcm1OYW1lOiAke2NhcHMucGxhdGZvcm1OYW1lfWApO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIGF3YWl0IHRoaXMuY29ubmVjdFNvY2tldCgpO1xuXG4gICAgICBpZiAoY2Fwcy5mdWxsU291cmNlVHJlZSA9PT0gdHJ1ZSkge1xuICAgICAgICAvL0RvIG5vdCBzZXQgZmlsdGVyXG4gICAgICB9IGVsc2Uge1xuICAgICAgICBhd2FpdCB0aGlzLnVwZGF0ZVNldHRpbmdzKHtTb3VyY2VUcmVlRmlsdGVyOiBcIltAaXNEaXNwbGF5ZWQ9J3RydWUnXVwifSk7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiBbc2Vzc2lvbklkLCB0aGlzLm9wdHNdO1xuXG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgYXdhaXQgdGhpcy5kZWxldGVTZXNzaW9uKCk7XG4gICAgICB0aHJvdyBlO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIG9uU2V0dGluZ3NVcGRhdGUgKGtleSwgdmFsdWUpIHtcbiAgICBpZiAoa2V5ID09PSBcIlRpbWVEaWxhdGlvblwiKSB7XG4gICAgICBhd2FpdCB0aGlzLnNldFRpbWVEaWxhdGlvbih2YWx1ZSk7XG4gICAgfSBlbHNlIGlmIChrZXkgPT09IFwiU291cmNlVHJlZUZpbHRlclwiKSB7XG4gICAgICBhd2FpdCB0aGlzLnNldFNvdXJjZVRyZWVGaWx0ZXIodmFsdWUpO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHN0b3AgKCkgeyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIHJlcXVpcmUtYXdhaXRcbiAgICB0aGlzLnJlYWR5ID0gZmFsc2U7XG4gIH1cblxuICBhc3luYyBkZWxldGVTZXNzaW9uICgpIHtcbiAgICBsb2dnZXIuZGVidWcoXCJEZWxldGluZyBZb3VpRW5naW5lIHNlc3Npb25cIik7XG5cbiAgICBpZiAodGhpcy5jYXBzLnBsYXRmb3JtTmFtZSAhPT0gbnVsbCkge1xuICAgICAgbGV0IGFwcFBsYXRmb3JtID0gdGhpcy5jYXBzLnBsYXRmb3JtTmFtZS50b0xvd2VyQ2FzZSgpO1xuXG4gICAgICBpZiAoW1wieWltYWNcIiwgXCJ5aXR2b3NcIiwgXCJibHVlc2t5XCJdLmluY2x1ZGVzKGFwcFBsYXRmb3JtKSkge1xuICAgICAgICBpZiAodGhpcy5kZXZpY2UpIHtcbiAgICAgICAgICB0aGlzLmRldmljZS5lbmRTZXNzaW9uKCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAodGhpcy5wcm94eWRyaXZlciAhPT0gbnVsbCkge1xuICAgICAgYXdhaXQgdGhpcy5wcm94eWRyaXZlci5kZWxldGVTZXNzaW9uKCk7XG4gICAgfVxuICAgIGF3YWl0IHN1cGVyLmRlbGV0ZVNlc3Npb24oKTtcbiAgICBhd2FpdCB0aGlzLnN0b3AoKTtcbiAgfVxuXG4gIGRyaXZlclNob3VsZERvUHJveHlDbWQgKGNvbW1hbmQpIHtcbiAgICBpZiAoIXRoaXMucHJveHlkcml2ZXIpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICAvLyBvbmx5IGFsbG93IHdoaXRlIGxpc3RlZCBjb21tYW5kc1xuICAgIGZvciAobGV0IGFsbG93ZWRDb21tYW5kIG9mIHRoaXMucHJveHlBbGxvd0xpc3QpIHtcbiAgICAgIGlmIChhbGxvd2VkQ29tbWFuZCA9PT0gY29tbWFuZCkge1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgYXN5bmMgZXhlY3V0ZUNvbW1hbmQgKGNtZCwgLi4uYXJncykge1xuICAgIGlmIChjbWQgPT09ICdyZWNlaXZlQXN5bmNSZXNwb25zZScpIHtcbiAgICAgIGxvZ2dlci5kZWJ1ZyhgRXhlY3V0aW5nIFlvdWlFbmdpbmVEcml2ZXIgcmVzcG9uc2UgJyR7Y21kfSdgKTtcbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLnJlY2VpdmVBc3luY1Jlc3BvbnNlKC4uLmFyZ3MpO1xuICAgIH0gZWxzZSBpZiAodGhpcy5yZWFkeSkge1xuXG4gICAgICBpZiAodGhpcy5kcml2ZXJTaG91bGREb1Byb3h5Q21kKGNtZCkpIHtcbiAgICAgICAgbG9nZ2VyLmRlYnVnKGBFeGVjdXRpbmcgcHJveGllZCBXZWJEcml2ZXIgY29tbWFuZCAnJHtjbWR9J2ApO1xuXG4gICAgICAgIC8vIFRoZXJlIGFyZSAyIENvbW1hbmRUaW1lb3V0IChZb3VpRW5naW5lRHJpdmVyIGFuZCBwcm94eSlcbiAgICAgICAgLy8gT25seSBZb3VpRW5naW5lRHJpdmVyIENvbW1hbmRUaW1lb3V0IGlzIHVzZWQ7IFByb3h5IGlzIGRpc2FibGVkXG4gICAgICAgIC8vIEFsbCBwcm94eSBjb21tYW5kcyBuZWVkcyB0byByZXNldCB0aGUgWW91aUVuZ2luZURyaXZlciBDb21tYW5kVGltZW91dFxuICAgICAgICAvLyBIZXJlIHdlIG1hbnVhbGx5IHJlc2V0IHRoZSBZb3VpRW5naW5lRHJpdmVyIENvbW1hbmRUaW1lb3V0IGZvciBjb21tYW5kcyB0aGF0IGdvZSB0byBwcm94eS5cbiAgICAgICAgdGhpcy5jbGVhck5ld0NvbW1hbmRUaW1lb3V0KCk7XG4gICAgICAgIGxldCByZXN1bHQgPSB0aGlzLnByb3h5ZHJpdmVyLmV4ZWN1dGVDb21tYW5kKGNtZCwgLi4uYXJncyk7XG4gICAgICAgIHRoaXMuc3RhcnROZXdDb21tYW5kVGltZW91dChjbWQpO1xuICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbG9nZ2VyLmRlYnVnKGBFeGVjdXRpbmcgWW91aUVuZ2luZSBXZWJEcml2ZXIgY29tbWFuZCAnJHtjbWR9J2ApO1xuICAgICAgICByZXR1cm4gc3VwZXIuZXhlY3V0ZUNvbW1hbmQoY21kLCAuLi5hcmdzKTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgbG9nZ2VyLmRlYnVnKGBDb21tYW5kIEVycm9yICcke2NtZH0nYCk7XG4gICAgICB0aHJvdyBuZXcgZXJyb3JzLk5vU3VjaERyaXZlckVycm9yKGBEcml2ZXIgaXMgbm90IHJlYWR5LCBjYW5ub3QgZXhlY3V0ZSAke2NtZH0uYCk7XG4gICAgfVxuICB9XG5cbiAgdmFsaWRhdGVEZXNpcmVkQ2FwcyAoY2Fwcykge1xuICAgIC8vIGNoZWNrIHdpdGggdGhlIGJhc2UgY2xhc3MsIGFuZCByZXR1cm4gaWYgaXQgZmFpbHNcbiAgICBsZXQgcmVzID0gc3VwZXIudmFsaWRhdGVEZXNpcmVkQ2FwcyhjYXBzKTtcbiAgICBpZiAoIXJlcykge1xuICAgICAgcmV0dXJuIHJlcztcbiAgICB9XG5cbiAgICAvLyBtYWtlIHN1cmUgdGhhdCB0aGUgY2FwYWJpbGl0aWVzIGhhcyB5b3VpRW5naW5lQXBwQWRkcmVzc1xuICAgIGlmICghY2Fwcy55b3VpRW5naW5lQXBwQWRkcmVzcykge1xuICAgICAgbGV0IG1zZyA9ICdUaGUgZGVzaXJlZCBjYXBhYmlsaXRpZXMgbXVzdCBpbmNsdWRlIHlvdWlFbmdpbmVBcHBBZGRyZXNzJztcbiAgICAgIGxvZ2dlci5lcnJvckFuZFRocm93KG1zZyk7XG4gICAgfVxuXG4gICAgLy8gQXBwIGlzIGJlaW5nIGxhdW5jaGVkXG4gICAgaWYgKGNhcHMucGxhdGZvcm1OYW1lLnRvTG93ZXJDYXNlKCkgIT09ICdjb25uZWN0dG9hcHAnICYmIGNhcHMucGxhdGZvcm1OYW1lLnRvTG93ZXJDYXNlKCkgIT09ICdub3Byb3h5Jykge1xuXG4gICAgICAvLyBtYWtlIHN1cmUgdGhhdCB0aGUgY2FwYWJpbGl0aWVzIGhhcyBhcHBcbiAgICAgIGlmICghY2Fwcy5hcHApIHtcbiAgICAgICAgbGV0IG1zZyA9ICdUaGUgZGVzaXJlZCBjYXBhYmlsaXRpZXMgbXVzdCBpbmNsdWRlIGFwcCc7XG4gICAgICAgIGxvZ2dlci5lcnJvckFuZFRocm93KG1zZyk7XG4gICAgICB9XG4gICAgICBjb25zdCBmcyA9IHJlcXVpcmUoJ2ZzJyk7XG4gICAgICBjb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xuICAgICAgaWYgKCFmcy5leGlzdHNTeW5jKGNhcHMuYXBwKSkge1xuICAgICAgICBsZXQgYWJzb2x1dGVwYXRoID0gcGF0aC5yZXNvbHZlKGNhcHMuYXBwKTtcbiAgICAgICAgbGV0IG1zZyA9ICdUaGUgYXBwIGNvdWxkIG5vdCBiZSBmb3VuZCBpbiBmb2xsb3dpbmcgbG9jYXRpb246ICcgKyBhYnNvbHV0ZXBhdGg7XG4gICAgICAgIGxvZ2dlci5lcnJvckFuZFRocm93KG1zZyk7XG4gICAgICB9XG5cbiAgICAgIC8vQW5kcm9pZCBlbXVsYXRvciB3aXRoIHByb3h5XG4gICAgICBpZiAoY2Fwcy5kZXZpY2VOYW1lLnRvTG93ZXJDYXNlKCkgPT09ICdhbmRyb2lkJykge1xuICAgICAgICBpZiAoIWNhcHMuYXZkKSB7XG4gICAgICAgICAgbGV0IG1zZyA9ICdUaGUgZGVzaXJlZCBjYXBhYmlsaXRpZXMgbXVzdCBpbmNsdWRlIGF2ZCc7XG4gICAgICAgICAgbG9nZ2VyLmVycm9yQW5kVGhyb3cobXNnKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIC8vIGZpbmFsbHksIHJldHVybiB0cnVlIHNpbmNlIHRoZSBzdXBlcmNsYXNzIGNoZWNrIHBhc3NlZCwgYXMgZGlkIHRoaXNcbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIGFzeW5jIHNldHVwTmV3SU9TRHJpdmVyIChjYXBzKSB7XG4gICAgbGV0IGlvc0FyZ3MgPSB7XG4gICAgICBqYXZhc2NyaXB0RW5hYmxlZDogdHJ1ZSxcbiAgICB9O1xuXG4gICAgbGV0IGlvc2RyaXZlciA9IG5ldyBYQ1VJVGVzdERyaXZlcihpb3NBcmdzKTtcbiAgICAvLyBJZiBpT1MgdmVyc2lvbiBpcyAxMCBvciBhYm92ZSB3ZSBuZWVkIHRvIHVzZSBYQ1VJVGVzdERyaXZlciAoYW5kIFhjb2RlIDgrKVxuICAgIGlmIChjYXBzLnBsYXRmb3JtVmVyc2lvbikge1xuICAgICAgbGV0IG1ham9yVmVyID0gY2Fwcy5wbGF0Zm9ybVZlcnNpb24udG9TdHJpbmcoKS5zcGxpdChcIi5cIilbMF07XG4gICAgICBpZiAocGFyc2VJbnQobWFqb3JWZXIsIDEwKSA8IDEwKSB7XG4gICAgICAgIGlvc2RyaXZlciA9IG5ldyBJT1NEcml2ZXIoaW9zQXJncyk7XG4gICAgICB9XG4gICAgfVxuICAgIGxldCBjYXBzQ29weSA9IF8uY2xvbmVEZWVwKGNhcHMpO1xuICAgIC8vIERpc2FibGluZyB0aGUgcHJveHkgQ29tbWFuZFRpbWVvdXQgaW4gdGhlIGlPUyBkcml2ZXIgc2luY2Ugd2UgYXJlIG5vdyBoYW5kbGluZyBpdCBpbiB0aGUgWW91aUVuZ2luZSBEcml2ZXJcbiAgICBjYXBzQ29weS5uZXdDb21tYW5kVGltZW91dCA9IDA7XG4gICAgYXdhaXQgaW9zZHJpdmVyLmNyZWF0ZVNlc3Npb24oY2Fwc0NvcHkpO1xuXG4gICAgcmV0dXJuIGlvc2RyaXZlcjtcbiAgfVxuXG4gIGFzeW5jIHN0YXJ0SU9TU2Vzc2lvbiAoY2Fwcykge1xuICAgIGxvZ2dlci5pbmZvKFwiU3RhcnRpbmcgYW4gSU9TIHByb3h5IHNlc3Npb25cIik7XG4gICAgdGhpcy5wcm94eUFsbG93TGlzdCA9IFRPX1BST1hZX0lPUztcblxuICAgIHRoaXMucHJveHlkcml2ZXIgPSBhd2FpdCB0aGlzLnNldHVwTmV3SU9TRHJpdmVyKGNhcHMpO1xuICB9XG5cbiAgYXN5bmMgc2V0dXBOZXdBbmRyb2lkRHJpdmVyIChjYXBzKSB7XG4gICAgbGV0IGFuZHJvaWRBcmdzID0ge1xuICAgICAgamF2YXNjcmlwdEVuYWJsZWQ6IHRydWVcbiAgICB9O1xuICAgIGxldCBhbmRyb2lkZHJpdmVyID0gbmV3IEFuZHJvaWREcml2ZXIoYW5kcm9pZEFyZ3MpO1xuICAgIGxldCBjYXBzQ29weSA9IF8uY2xvbmVEZWVwKGNhcHMpO1xuICAgIC8vIERpc2FibGluZyB0aGUgcHJveHkgQ29tbWFuZFRpbWVvdXQgaW4gdGhlIEFuZHJvaWQgZHJpdmVyIHNpbmNlIHdlIGFyZSBub3cgaGFuZGxpbmcgaXQgaW4gdGhlIFlvdWlFbmdpbmUgRHJpdmVyXG4gICAgY2Fwc0NvcHkubmV3Q29tbWFuZFRpbWVvdXQgPSAwO1xuXG4gICAgYXdhaXQgYW5kcm9pZGRyaXZlci5jcmVhdGVTZXNzaW9uKGNhcHNDb3B5KTtcblxuICAgIHJldHVybiBhbmRyb2lkZHJpdmVyO1xuICB9XG5cbiAgYXN5bmMgc3RhcnRBbmRyb2lkU2Vzc2lvbiAoY2Fwcykge1xuICAgIGxvZ2dlci5pbmZvKFwiU3RhcnRpbmcgYW4gQW5kcm9pZCBwcm94eSBzZXNzaW9uXCIpO1xuICAgIHRoaXMucHJveHlBbGxvd0xpc3QgPSBUT19QUk9YWV9BTkRST0lEO1xuXG4gICAgdGhpcy5wcm94eWRyaXZlciA9IGF3YWl0IHRoaXMuc2V0dXBOZXdBbmRyb2lkRHJpdmVyKGNhcHMpO1xuICB9XG5cbiAgYXN5bmMgc2V0dXBOZXdNYWNEcml2ZXIgKGNhcHMpIHtcbiAgICBsZXQgbWFjQXJncyA9IHtcbiAgICAgIGphdmFzY3JpcHRFbmFibGVkOiB0cnVlXG4gICAgfTtcbiAgICBsZXQgbWFjZHJpdmVyID0gbmV3IE1hY0RyaXZlcihtYWNBcmdzKTtcbiAgICBsZXQgY2Fwc0NvcHkgPSBfLmNsb25lRGVlcChjYXBzKTtcbiAgICAvLyBEaXNhYmxpbmcgdGhlIHByb3h5IENvbW1hbmRUaW1lb3V0IGluIHRoZSBwcm94aWVkIGRyaXZlciBzaW5jZSB3ZSBhcmUgbm93IGhhbmRsaW5nIGl0IGluIHRoZSBZb3VpRW5naW5lIERyaXZlclxuICAgIGNhcHNDb3B5Lm5ld0NvbW1hbmRUaW1lb3V0ID0gMDtcblxuICAgIGF3YWl0IG1hY2RyaXZlci5jcmVhdGVTZXNzaW9uKGNhcHNDb3B5KTtcblxuICAgIHJldHVybiBtYWNkcml2ZXI7XG4gIH1cblxuICBhc3luYyBzdGFydE1hY1Nlc3Npb24gKGNhcHMpIHtcbiAgICBsb2dnZXIuaW5mbyhcIlN0YXJ0aW5nIGEgTWFjIHByb3h5IHNlc3Npb25cIik7XG4gICAgdGhpcy5wcm94eUFsbG93TGlzdCA9IFRPX1BST1hZX01BQztcblxuICAgIHRoaXMucHJveHlkcml2ZXIgPSBhd2FpdCB0aGlzLnNldHVwTmV3TWFjRHJpdmVyKGNhcHMpO1xuICB9XG5cbiAgLy8gU09DS0VUU1xuICBhc3luYyBjb25uZWN0U29ja2V0ICgpIHtcbiAgICBsZXQgcmV0cnlDb3VudCA9IDA7XG4gICAgbGV0IGNvbm5lY3RlZCA9IGZhbHNlO1xuICAgIHdoaWxlIChyZXRyeUNvdW50IDwgTUFYX1JFVFJZX0NPVU5UICYmICFjb25uZWN0ZWQpIHtcbiAgICAgIGlmIChyZXRyeUNvdW50ID4gMCkge1xuICAgICAgICBsb2dnZXIuaW5mbyhcIldhaXRpbmcgXCIgKyAoUkVUUllfQkFDS09GRiAvIDEwMDApICsgXCIgc2Vjb25kcyBiZWZvcmUgdHJ5aW5nLi4uXCIpO1xuICAgICAgICBhd2FpdCBzbGVlcChSRVRSWV9CQUNLT0ZGKTtcbiAgICAgIH1cbiAgICAgIGxvZ2dlci5pbmZvKFwiQXR0ZW1wdCAjXCIgKyAocmV0cnlDb3VudCArIDEpKTtcblxuICAgICAgbGV0IGNvbm5lY3RlZFByb21pc2UgPSBuZXcgQigocmVzb2x2ZSkgPT4ge1xuICAgICAgICBsZXQgbmV0ID0gcmVxdWlyZSgnbmV0Jyk7XG5cbiAgICAgICAgbGV0IEhPU1QgPSB0aGlzLm9wdHMueW91aUVuZ2luZUFwcEFkZHJlc3M7XG4gICAgICAgIGxldCBQT1JUID0gMTIzNDU7XG5cbiAgICAgICAgbG9nZ2VyLmluZm8oJ0Nvbm5lY3RpbmcgdG8gV2ViRHJpdmVyOiAnICsgSE9TVCArICc6JyArIFBPUlQpO1xuXG4gICAgICAgIHRoaXMuc29ja2V0ID0gbmV3IG5ldC5Tb2NrZXQoKTtcblxuICAgICAgICAvLyBBZGQgYW4gJ2Vycm9yJyBldmVudCBoYW5kbGVyIGZvciB0aGUgY2xpZW50IHNvY2tldFxuICAgICAgICB0aGlzLnNvY2tldC5vbiAoJ2Vycm9yJywgZnVuY3Rpb24gKGV4KSB7XG4gICAgICAgICAgbG9nZ2VyLmVycm9yKGV4KTtcbiAgICAgICAgICBsb2dnZXIuZXJyb3IoJ0NoZWNrIHRoYXQgV2ViRHJpdmVyIGlzIGVuYWJsZWQgaW4gYXBwbGljYXRpb24sIGlmIGEgZGV2aWNlIGVuc3VyZSB0aGUgcHJvcGVyIElQIGFkZHJlc3MgaXMgdXNlZC4nKTtcbiAgICAgICAgICByZXNvbHZlKGZhbHNlKTtcbiAgICAgICAgfSk7XG4gICAgICAgIC8vIEFkZCBhICdjbG9zZScgZXZlbnQgaGFuZGxlciBmb3IgdGhlIGNsaWVudCBzb2NrZXRcbiAgICAgICAgdGhpcy5zb2NrZXQub24gKCdjbG9zZScsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICBsb2dnZXIuaW5mbygnQ29ubmVjdGlvbiBjbG9zZWQnKTtcbiAgICAgICAgfSk7XG4gICAgICAgIC8vIEFkZCBhICd0aW1lb3V0JyBldmVudCBoYW5kbGVyIGZvciB0aGUgY2xpZW50IHNvY2tldFxuICAgICAgICB0aGlzLnNvY2tldC5vbiAoJ3RpbWVvdXQnLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgbG9nZ2VyLmVycm9yKCdDb25uZWN0aW9uIHRpbWVkIG91dCcpO1xuICAgICAgICAgIHJlc29sdmUoZmFsc2UpO1xuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5zb2NrZXQuY29ubmVjdCAoUE9SVCwgSE9TVCwgZnVuY3Rpb24gKCkge1xuICAgICAgICAgIGxvZ2dlci5pbmZvKCdDb25uZWN0ZWQnKTtcbiAgICAgICAgICByZXNvbHZlKHRydWUpO1xuICAgICAgICB9KTtcbiAgICAgIH0pO1xuICAgICAgcmV0cnlDb3VudCsrO1xuICAgICAgY29ubmVjdGVkID0gYXdhaXQgY29ubmVjdGVkUHJvbWlzZTtcblxuICAgICAgaWYgKCFjb25uZWN0ZWQgJiYgcmV0cnlDb3VudCA9PT0gKE1BWF9SRVRSWV9DT1VOVCAtIDEpKSB7XG4gICAgICAgIGxvZ2dlci5lcnJvckFuZFRocm93KFwiRmFpbGVkIHRvIGNvbm5lY3QgXCIgKyBNQVhfUkVUUllfQ09VTlQgKyBcIiB0aW1lcy4gQWJvcnRpbmcuXCIpO1xuICAgICAgfVxuICAgIH1cbiAgICByZXRyeUNvdW50ID0gMDtcbiAgICB0aGlzLnJlYWR5ID0gY29ubmVjdGVkO1xuICB9XG5cbiAgLy8gcmVzcG9uc2VzIHRvIHRoZSBjb21tYW5kcyBhcmUgQklOQVJZXG4gIGFzeW5jIGV4ZWN1dGVTb2NrZXRDb21tYW5kIChjbWQpIHtcblxuICAgIGlmICghdGhpcy5zb2NrZXQud3JpdGFibGUpIHtcbiAgICAgIGxvZ2dlci5pbmZvKFwiU29ja2V0IGlzIG5vdCB3cml0YWJsZS4gVHJ5aW5nIHRvIHJlY29ubmVjdC5cIik7XG4gICAgICBhd2FpdCB0aGlzLmNvbm5lY3RTb2NrZXQoKTtcbiAgICB9XG5cbiAgICBsZXQgY21kUHJvbWlzZSA9IG5ldyBCKChyZXNvbHZlKSA9PiB7XG4gICAgICBsb2dnZXIuZGVidWcoJ0NPTU1BTkQ6ICcgKyBjbWQpO1xuXG4gICAgICBsZXQgdG90YWxkYXRhID0gW107XG4gICAgICBsZXQgZW5kTWFya2VyID0gbmV3IEJ1ZmZlcihcInlvdWllbmRcIik7XG4gICAgICBsZXQgc29ja2V0Q2xpZW50ID0gdGhpcy5zb2NrZXQ7XG5cblxuICAgICAgbGV0IGRhdGFIYW5kbGVyID0gZnVuY3Rpb24gKGRhdGEpIHtcblxuICAgICAgICAvLyBkZXRlcm1pbmUgaWYgdGhpcyBpbmNsdWRlcyBhbiBlbmQgcGFya2VyXG4gICAgICAgIC8vIGdldCBsYXN0IGZldyB2YWx1ZXMgb2YgYnVmZmVyXG4gICAgICAgIGlmIChkYXRhLmxlbmd0aCA+PSBlbmRNYXJrZXIubGVuZ3RoKSB7XG4gICAgICAgICAgbGV0IGRhdGFlbmQgPSBuZXcgQnVmZmVyKGVuZE1hcmtlci5sZW5ndGgpO1xuICAgICAgICAgIGxldCBzdGFydEluZGV4ID0gZGF0YS5sZW5ndGggLSBlbmRNYXJrZXIubGVuZ3RoO1xuICAgICAgICAgIGRhdGEuY29weShkYXRhZW5kLCAwLCBzdGFydEluZGV4LCBzdGFydEluZGV4ICsgZW5kTWFya2VyLmxlbmd0aCk7XG4gICAgICAgICAgLy9sb2dnZXIuZGVidWcoJ0RBVEFFTkQnICsgZGF0YWVuZC50b1N0cmluZygpKTtcbiAgICAgICAgICBpZiAoZGF0YWVuZC5lcXVhbHMoZW5kTWFya2VyKSkge1xuICAgICAgICAgICAgLy8gcmVtb3ZlIGRhdGEgZW5kXG4gICAgICAgICAgICBsZXQgbGFzdERhdGEgPSBkYXRhLnNsaWNlKDAsIHN0YXJ0SW5kZXgpO1xuICAgICAgICAgICAgLy9sb2dnZXIuZGVidWcoJ0xBU1QgREFUQTogJyArIGxhc3REYXRhLnRvU3RyaW5nKCkpO1xuICAgICAgICAgICAgdG90YWxkYXRhLnB1c2gobGFzdERhdGEpO1xuXG4gICAgICAgICAgICAvL3JlbW92ZSBoYW5kbGVyXG4gICAgICAgICAgICBzb2NrZXRDbGllbnQucmVtb3ZlTGlzdGVuZXIoJ2RhdGEnLCBkYXRhSGFuZGxlcik7XG5cbiAgICAgICAgICAgIC8vIHJlc29sdmVcbiAgICAgICAgICAgIHJlc29sdmUoQnVmZmVyLmNvbmNhdCh0b3RhbGRhdGEpKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdG90YWxkYXRhLnB1c2goZGF0YSk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9O1xuXG4gICAgICBzb2NrZXRDbGllbnQud3JpdGUoY21kICsgXCJcXG5cIiwgXCJVVEY4XCIsICgpID0+IHtcbiAgICAgICAgc29ja2V0Q2xpZW50Lm9uKCdkYXRhJywgZGF0YUhhbmRsZXIpO1xuICAgICAgfSk7XG4gICAgfSk7XG4gICAgcmV0dXJuIGF3YWl0IGNtZFByb21pc2U7XG4gIH1cbn1cblxuZm9yIChsZXQgW2NtZCwgZm5dIG9mIF8udG9QYWlycyhjb21tYW5kcykpIHtcbiAgWW91aUVuZ2luZURyaXZlci5wcm90b3R5cGVbY21kXSA9IGZuO1xufVxuZXhwb3J0IHsgWW91aUVuZ2luZURyaXZlciB9O1xuIl0sImZpbGUiOiJsaWIvZHJpdmVyLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uIn0=
