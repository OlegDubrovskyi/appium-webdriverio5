"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.createSim = createSim;
exports.getExistingSim = getExistingSim;
exports.runSimulatorReset = runSimulatorReset;
exports.installToSimulator = installToSimulator;
exports.shutdownSimulator = shutdownSimulator;
exports.shutdownOtherSimulators = shutdownOtherSimulators;

require("source-map-support/register");

var _path = _interopRequireDefault(require("path"));

var _appiumIosSimulator = require("appium-ios-simulator");

var _nodeSimctl = require("node-simctl");

var _utils = require("./utils");

var _lodash = _interopRequireDefault(require("lodash"));

var _logger = _interopRequireDefault(require("./logger"));

var _appiumSupport = require("appium-support");

var _uuidJs = _interopRequireDefault(require("uuid-js"));

var _desiredCaps = require("./desired-caps");

const INSTALL_DAEMON_CACHE = 'com.apple.mobile.installd.staging';

async function createSim(caps, platform = _desiredCaps.PLATFORM_NAME_IOS) {
  const appiumTestDeviceName = `appiumTest-${_uuidJs.default.create().toString().toUpperCase()}-${caps.deviceName}`;
  const udid = await (0, _nodeSimctl.createDevice)(appiumTestDeviceName, caps.deviceName, caps.platformVersion, {
    platform
  });
  return await (0, _appiumIosSimulator.getSimulator)(udid);
}

async function getExistingSim(opts) {
  const devices = await (0, _nodeSimctl.getDevices)(opts.platformVersion);
  const appiumTestDeviceName = `appiumTest-${opts.deviceName}`;
  let appiumTestDevice;

  for (const device of _lodash.default.values(devices)) {
    if (device.name === opts.deviceName) {
      return await (0, _appiumIosSimulator.getSimulator)(device.udid);
    }

    if (device.name === appiumTestDeviceName) {
      appiumTestDevice = device;
    }
  }

  if (appiumTestDevice) {
    _logger.default.warn(`Unable to find device '${opts.deviceName}'. Found '${appiumTestDevice.name}' (udid: '${appiumTestDevice.udid}') instead`);

    return await (0, _appiumIosSimulator.getSimulator)(appiumTestDevice.udid);
  }

  return null;
}

async function shutdownSimulator(device) {
  await (0, _utils.resetXCTestProcesses)(device.udid, true);
  await device.shutdown();
}

async function runSimulatorReset(device, opts) {
  if (opts.noReset && !opts.fullReset) {
    _logger.default.debug('Reset: noReset is on. Leaving simulator as is');

    return;
  }

  if (!device) {
    _logger.default.debug('Reset: no device available. Skipping');

    return;
  }

  if (opts.fullReset) {
    _logger.default.debug('Reset: fullReset is on. Cleaning simulator');

    await shutdownSimulator(device);
    let isKeychainsBackupSuccessful = false;

    if (opts.keychainsExcludePatterns || opts.keepKeyChains) {
      isKeychainsBackupSuccessful = await device.backupKeychains();
    }

    await device.clean();

    if (isKeychainsBackupSuccessful) {
      await device.restoreKeychains(opts.keychainsExcludePatterns || []);

      _logger.default.info(`Successfully restored keychains after full reset`);
    } else if (opts.keychainsExcludePatterns || opts.keepKeyChains) {
      _logger.default.warn('Cannot restore keychains after full reset, because ' + 'the backup operation did not succeed');
    }
  } else if (opts.bundleId) {
    if (await device.isRunning()) {
      if (opts.enforceSimulatorShutdown) {
        await shutdownSimulator(device);
      } else {
        try {
          await (0, _nodeSimctl.terminate)(device.udid, opts.bundleId);
        } catch (err) {
          _logger.default.warn(`Reset: failed to terminate Simulator application with id "${opts.bundleId}"`);
        }
      }
    }

    if (opts.app) {
      _logger.default.info('Not scrubbing third party app in anticipation of uninstall');

      return;
    }

    const isSafari = (opts.browserName || '').toLowerCase() === 'safari';

    try {
      if (isSafari) {
        await device.cleanSafari();
      } else {
        await device.scrubCustomApp('', opts.bundleId);
      }
    } catch (err) {
      _logger.default.warn(err.message);

      _logger.default.warn(`Reset: could not scrub ${isSafari ? 'Safari browser' : 'application with id "' + opts.bundleId + '"'}. Leaving as is.`);
    }
  }
}

async function installToSimulator(device, app, bundleId, noReset = true) {
  if (!app) {
    _logger.default.debug('No app path is given. Nothing to install.');

    return;
  }

  if (bundleId) {
    if (await device.isAppInstalled(bundleId)) {
      if (noReset) {
        _logger.default.debug(`App '${bundleId}' is already installed. No need to reinstall.`);

        return;
      }

      _logger.default.debug(`Reset requested. Removing app with id '${bundleId}' from the device`);

      await device.removeApp(bundleId);
    }
  }

  const installdCacheRoot = _path.default.resolve(device.getDir(), 'Library', 'Caches', INSTALL_DAEMON_CACHE);

  let tmpRoot = null;

  if (await _appiumSupport.fs.exists(installdCacheRoot)) {
    tmpRoot = await _appiumSupport.tempDir.openDir();

    _logger.default.debug('Cleaning installd cache to save the disk space');

    await _appiumSupport.fs.mv(installdCacheRoot, _path.default.resolve(tmpRoot, INSTALL_DAEMON_CACHE), {
      mkdirp: true
    });
    await (0, _appiumSupport.mkdirp)(installdCacheRoot);
  }

  _logger.default.debug(`Installing '${app}' on Simulator with UUID '${device.udid}'...`);

  try {
    try {
      await device.installApp(app);
    } catch (e) {
      _logger.default.info(`Got an error on '${app}' install: ${e.message}`);

      if (e.message.includes('MIInstallerErrorDomain') && tmpRoot) {
        _logger.default.info(`installd requires the cache to be available in order to install '${app}'. ` + `Restoring the cache`);

        await _appiumSupport.fs.rimraf(installdCacheRoot);
        await _appiumSupport.fs.mv(_path.default.resolve(tmpRoot, INSTALL_DAEMON_CACHE), installdCacheRoot, {
          mkdirp: true
        });
      }

      _logger.default.info('Retrying application install');

      await device.installApp(app);
    }

    _logger.default.debug('The app has been installed successfully.');
  } finally {
    if (tmpRoot && (await _appiumSupport.fs.exists(tmpRoot))) {
      await _appiumSupport.fs.rimraf(tmpRoot);
    }
  }
}

async function shutdownOtherSimulators(currentDevice) {
  const allDevices = _lodash.default.flatMap(_lodash.default.values((await (0, _nodeSimctl.getDevices)())));

  const otherBootedDevices = allDevices.filter(device => device.udid !== currentDevice.udid && device.state === 'Booted');

  if (_lodash.default.isEmpty(otherBootedDevices)) {
    _logger.default.info('No other running simulators have been detected');

    return;
  }

  _logger.default.info(`Detected ${otherBootedDevices.length} other running Simulator${otherBootedDevices.length === 1 ? '' : 's'}.` + `Shutting ${otherBootedDevices.length === 1 ? 'it' : 'them'} down...`);

  for (const {
    udid
  } of otherBootedDevices) {
    await (0, _utils.resetXCTestProcesses)(udid, true);
    await (0, _nodeSimctl.shutdown)(udid);
  }
}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9zaW11bGF0b3ItbWFuYWdlbWVudC5qcyJdLCJuYW1lcyI6WyJJTlNUQUxMX0RBRU1PTl9DQUNIRSIsImNyZWF0ZVNpbSIsImNhcHMiLCJwbGF0Zm9ybSIsIlBMQVRGT1JNX05BTUVfSU9TIiwiYXBwaXVtVGVzdERldmljZU5hbWUiLCJVVUlEIiwiY3JlYXRlIiwidG9TdHJpbmciLCJ0b1VwcGVyQ2FzZSIsImRldmljZU5hbWUiLCJ1ZGlkIiwicGxhdGZvcm1WZXJzaW9uIiwiZ2V0RXhpc3RpbmdTaW0iLCJvcHRzIiwiZGV2aWNlcyIsImFwcGl1bVRlc3REZXZpY2UiLCJkZXZpY2UiLCJfIiwidmFsdWVzIiwibmFtZSIsImxvZyIsIndhcm4iLCJzaHV0ZG93blNpbXVsYXRvciIsInNodXRkb3duIiwicnVuU2ltdWxhdG9yUmVzZXQiLCJub1Jlc2V0IiwiZnVsbFJlc2V0IiwiZGVidWciLCJpc0tleWNoYWluc0JhY2t1cFN1Y2Nlc3NmdWwiLCJrZXljaGFpbnNFeGNsdWRlUGF0dGVybnMiLCJrZWVwS2V5Q2hhaW5zIiwiYmFja3VwS2V5Y2hhaW5zIiwiY2xlYW4iLCJyZXN0b3JlS2V5Y2hhaW5zIiwiaW5mbyIsImJ1bmRsZUlkIiwiaXNSdW5uaW5nIiwiZW5mb3JjZVNpbXVsYXRvclNodXRkb3duIiwiZXJyIiwiYXBwIiwiaXNTYWZhcmkiLCJicm93c2VyTmFtZSIsInRvTG93ZXJDYXNlIiwiY2xlYW5TYWZhcmkiLCJzY3J1YkN1c3RvbUFwcCIsIm1lc3NhZ2UiLCJpbnN0YWxsVG9TaW11bGF0b3IiLCJpc0FwcEluc3RhbGxlZCIsInJlbW92ZUFwcCIsImluc3RhbGxkQ2FjaGVSb290IiwicGF0aCIsInJlc29sdmUiLCJnZXREaXIiLCJ0bXBSb290IiwiZnMiLCJleGlzdHMiLCJ0ZW1wRGlyIiwib3BlbkRpciIsIm12IiwibWtkaXJwIiwiaW5zdGFsbEFwcCIsImUiLCJpbmNsdWRlcyIsInJpbXJhZiIsInNodXRkb3duT3RoZXJTaW11bGF0b3JzIiwiY3VycmVudERldmljZSIsImFsbERldmljZXMiLCJmbGF0TWFwIiwib3RoZXJCb290ZWREZXZpY2VzIiwiZmlsdGVyIiwic3RhdGUiLCJpc0VtcHR5IiwibGVuZ3RoIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBR0EsTUFBTUEsb0JBQW9CLEdBQUcsbUNBQTdCOztBQWdCQSxlQUFlQyxTQUFmLENBQTBCQyxJQUExQixFQUFnQ0MsUUFBUSxHQUFHQyw4QkFBM0MsRUFBOEQ7QUFDNUQsUUFBTUMsb0JBQW9CLEdBQUksY0FBYUMsZ0JBQUtDLE1BQUwsR0FBY0MsUUFBZCxHQUF5QkMsV0FBekIsRUFBdUMsSUFBR1AsSUFBSSxDQUFDUSxVQUFXLEVBQXJHO0FBQ0EsUUFBTUMsSUFBSSxHQUFHLE1BQU0sOEJBQ2pCTixvQkFEaUIsRUFFakJILElBQUksQ0FBQ1EsVUFGWSxFQUdqQlIsSUFBSSxDQUFDVSxlQUhZLEVBSWpCO0FBQUVULElBQUFBO0FBQUYsR0FKaUIsQ0FBbkI7QUFNQSxTQUFPLE1BQU0sc0NBQWFRLElBQWIsQ0FBYjtBQUNEOztBQVVELGVBQWVFLGNBQWYsQ0FBK0JDLElBQS9CLEVBQXFDO0FBQ25DLFFBQU1DLE9BQU8sR0FBRyxNQUFNLDRCQUFXRCxJQUFJLENBQUNGLGVBQWhCLENBQXRCO0FBQ0EsUUFBTVAsb0JBQW9CLEdBQUksY0FBYVMsSUFBSSxDQUFDSixVQUFXLEVBQTNEO0FBRUEsTUFBSU0sZ0JBQUo7O0FBRUEsT0FBSyxNQUFNQyxNQUFYLElBQXFCQyxnQkFBRUMsTUFBRixDQUFTSixPQUFULENBQXJCLEVBQXdDO0FBQ3RDLFFBQUlFLE1BQU0sQ0FBQ0csSUFBUCxLQUFnQk4sSUFBSSxDQUFDSixVQUF6QixFQUFxQztBQUNuQyxhQUFPLE1BQU0sc0NBQWFPLE1BQU0sQ0FBQ04sSUFBcEIsQ0FBYjtBQUNEOztBQUVELFFBQUlNLE1BQU0sQ0FBQ0csSUFBUCxLQUFnQmYsb0JB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QVYsQ0FBTjtBQUNEO0FBQ0Y7QUFDRjs7QUFFRCxlQUFlVyx1QkFBZixDQUF3Q0MsYUFBeEMsRUFBdUQ7QUFDckQsUUFBTUMsVUFBVSxHQUFHakQsZ0JBQUVrRCxPQUFGLENBQVVsRCxnQkFBRUMsTUFBRixFQUFTLE1BQU0sNkJBQWYsRUFBVixDQUFuQjs7QUFDQSxRQUFNa0Qsa0JBQWtCLEdBQUdGLFVBQVUsQ0FBQ0csTUFBWCxDQUFtQnJELE1BQUQsSUFBWUEsTUFBTSxDQUFDTixJQUFQLEtBQWdCdUQsYUFBYSxDQUFDdkQsSUFBOUIsSUFBc0NNLE1BQU0sQ0FBQ3NELEtBQVAsS0FBaUIsUUFBckYsQ0FBM0I7O0FBQ0EsTUFBSXJELGdCQUFFc0QsT0FBRixDQUFVSCxrQkFBVixDQUFKLEVBQW1DO0FBQ2pDaEQsb0JBQUljLElBQUosQ0FBUyxnREFBVDs7QUFDQTtBQUNEOztBQUNEZCxrQkFBSWMsSUFBSixDQUFVLFlBQVdrQyxrQkFBa0IsQ0FBQ0ksTUFBTywyQkFBMEJKLGtCQUFrQixDQUFDSSxNQUFuQixLQUE4QixDQUE5QixHQUFrQyxFQUFsQyxHQUF1QyxHQUFJLEdBQTNHLEdBQ0MsWUFBV0osa0JBQWtCLENBQUNJLE1BQW5CLEtBQThCLENBQTlCLEdBQWtDLElBQWxDLEdBQXlDLE1BQU8sVUFEckU7O0FBRUEsT0FBSyxNQUFNO0FBQUM5RCxJQUFBQTtBQUFELEdBQVgsSUFBcUIwRCxrQkFBckIsRUFBeUM7QUFHdkMsVUFBTSxpQ0FBcUIxRCxJQUFyQixFQUEyQixJQUEzQixDQUFOO0FBQ0EsVUFBTSwwQkFBU0EsSUFBVCxDQUFOO0FBQ0Q7QUFDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgZ2V0U2ltdWxhdG9yIH0gZnJvbSAnYXBwaXVtLWlvcy1zaW11bGF0b3InO1xuaW1wb3J0IHsgY3JlYXRlRGV2aWNlLCBnZXREZXZpY2VzLCB0ZXJtaW5hdGUsIHNodXRkb3duIH0gZnJvbSAnbm9kZS1zaW1jdGwnO1xuaW1wb3J0IHsgcmVzZXRYQ1Rlc3RQcm9jZXNzZXMgfSBmcm9tICcuL3V0aWxzJztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgbG9nIGZyb20gJy4vbG9nZ2VyJztcbmltcG9ydCB7IHRlbXBEaXIsIGZzLCBta2RpcnAgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgVVVJRCBmcm9tICd1dWlkLWpzJztcbmltcG9ydCB7IFBMQVRGT1JNX05BTUVfSU9TIH0gZnJvbSAnLi9kZXNpcmVkLWNhcHMnO1xuXG5cbmNvbnN0IElOU1RBTExfREFFTU9OX0NBQ0hFID0gJ2NvbS5hcHBsZS5tb2JpbGUuaW5zdGFsbGQuc3RhZ2luZyc7XG5cblxuLyoqXG4gKiBDYXBhYmlsaXR5IHNldCBieSBhIHVzZXJcbiAqXG4gKiBAcHJvcGVydHkge3N0cmluZ30gZGV2aWNlTmFtZSAtIEEgbmFtZSBmb3IgdGhlIGRldmljZVxuICogQHByb3BlcnR5IHtzdHJpbmd9IHBsYXRmb3JtVmVyc2lvbiAtIFRoZSB2ZXJzaW9uIG9mIGlPUyB0byB1c2VcbiAqL1xuLyoqXG4gKiBDcmVhdGUgYSBuZXcgc2ltdWxhdG9yIHdpdGggYGFwcGl1bVRlc3QtYCBwcmVmaXggYW5kIHJldHVybiB0aGUgb2JqZWN0LlxuICpcbiAqIEBwYXJhbSB7b2JqZWN0fSBTaW1DcmVhdGlvbkNhcHMgLSBDYXBhYmlsaXR5IHNldCBieSBhIHVzZXIuIFRoZSBvcHRpb25zIGF2YWlsYWJsZSBhcmU6XG4gKiBAcHJvcGVydHkge3N0cmluZ30gcGxhdGZvcm0gW2lPU10gLSBQbGF0Zm9ybSBuYW1lIGluIG9yZGVyIHRvIHNwZWNpZnkgcnVudGltZSBzdWNoIGFzICdpT1MnLCAndHZPUycsICd3YXRjaE9TJ1xuICogQHJldHVybnMge29iamVjdH0gU2ltdWxhdG9yIG9iamVjdCBhc3NvY2lhdGVkIHdpdGggdGhlIHVkaWQgcGFzc2VkIGluLlxuICovXG5hc3luYyBmdW5jdGlvbiBjcmVhdGVTaW0gKGNhcHMsIHBsYXRmb3JtID0gUExBVEZPUk1fTkFNRV9JT1MpIHtcbiAgY29uc3QgYXBwaXVtVGVzdERldmljZU5hbWUgPSBgYXBwaXVtVGVzdC0ke1VVSUQuY3JlYXRlKCkudG9TdHJpbmcoKS50b1VwcGVyQ2FzZSgpfS0ke2NhcHMuZGV2aWNlTmFtZX1gO1xuICBjb25zdCB1ZGlkID0gYXdhaXQgY3JlYXRlRGV2aWNlKFxuICAgIGFwcGl1bVRlc3REZXZpY2VOYW1lLFxuICAgIGNhcHMuZGV2aWNlTmFtZSxcbiAgICBjYXBzLnBsYXRmb3JtVmVyc2lvbixcbiAgICB7IHBsYXRmb3JtIH1cbiAgKTtcbiAgcmV0dXJuIGF3YWl0IGdldFNpbXVsYXRvcih1ZGlkKTtcbn1cblxuLyoqXG4gKiBHZXQgYSBzaW11bGF0b3Igd2hpY2ggaXMgYWxyZWFkeSBydW5uaW5nLlxuICpcbiAqIEBwYXJhbSB7b2JqZWN0fSBvcHRzIC0gQ2FwYWJpbGl0eSBzZXQgYnkgYSB1c2VyLiBUaGUgb3B0aW9ucyBhdmFpbGFibGUgYXJlOlxuICogICAtIGBkZXZpY2VOYW1lYCAtIGEgbmFtZSBmb3IgdGhlIGRldmljZVxuICogICAtIGBwbGF0Zm9ybVZlcnNpb25gIC0gdGhlIHZlcnNpb24gb2YgaU9TIHRvIHVzZVxuICogQHJldHVybnMgez9vYmplY3R9IFNpbXVsYXRvciBvYmplY3QgYXNzb2NpYXRlZCB3aXRoIHRoZSB1ZGlkIHBhc3NlZCBpbi4gT3IgbnVsbCBpZiBubyBkZXZpY2UgaXMgcnVubmluZy5cbiAqL1xuYXN5bmMgZnVuY3Rpb24gZ2V0RXhpc3RpbmdTaW0gKG9wdHMpIHtcbiAgY29uc3QgZGV2aWNlcyA9IGF3YWl0IGdldERldmljZXMob3B0cy5wbGF0Zm9ybVZlcnNpb24pO1xuICBjb25zdCBhcHBpdW1UZXN0RGV2aWNlTmFtZSA9IGBhcHBpdW1UZXN0LSR7b3B0cy5kZXZpY2VOYW1lfWA7XG5cbiAgbGV0IGFwcGl1bVRlc3REZXZpY2U7XG5cbiAgZm9yIChjb25zdCBkZXZpY2Ugb2YgXy52YWx1ZXMoZGV2aWNlcykpIHtcbiAgICBpZiAoZGV2aWNlLm5hbWUgPT09IG9wdHMuZGV2aWNlTmFtZSkge1xuICAgICAgcmV0dXJuIGF3YWl0IGdldFNpbXVsYXRvcihkZXZpY2UudWRpZCk7XG4gICAgfVxuXG4gICAgaWYgKGRldmljZS5uYW1lID09PSBhcHBpdW1UZXN0RGV2aWNlTmFtZSkge1xuICAgICAgYXBwaXVtVGVzdERldmljZSA9IGRldmljZTtcbiAgICB9XG4gIH1cblxuICBpZiAoYXBwaXVtVGVzdERldmljZSkge1xuICAgIGxvZy53YXJuKGBVbmFibGUgdG8gZmluZCBkZXZpY2UgJyR7b3B0cy5kZXZpY2VOYW1lfScuIEZvdW5kICcke2FwcGl1bVRlc3REZXZpY2UubmFtZX0nICh1ZGlkOiAnJHthcHBpdW1UZXN0RGV2aWNlLnVkaWR9JykgaW5zdGVhZGApO1xuICAgIHJldHVybiBhd2FpdCBnZXRTaW11bGF0b3IoYXBwaXVtVGVzdERldmljZS51ZGlkKTtcbiAgfVxuICByZXR1cm4gbnVsbDtcbn1cblxuYXN5bmMgZnVuY3Rpb24gc2h1dGRvd25TaW11bGF0b3IgKGRldmljZSkge1xuICAvLyBzdG9wIFhDVGVzdCBwcm9jZXNzZXMgaWYgcnVubmluZyB0byBhdm9pZCB1bmV4cGVjdGVkIHNpZGUgZWZmZWN0c1xuICBhd2FpdCByZXNldFhDVGVzdFByb2Nlc3NlcyhkZXZpY2UudWRpZCwgdHJ1ZSk7XG4gIGF3YWl0IGRldmljZS5zaHV0ZG93bigpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBydW5TaW11bGF0b3JSZXNldCAoZGV2aWNlLCBvcHRzKSB7XG4gIGlmIChvcHRzLm5vUmVzZXQgJiYgIW9wdHMuZnVsbFJlc2V0KSB7XG4gICAgLy8gbm9SZXNldCA9PT0gdHJ1ZSAmJiBmdWxsUmVzZXQgPT09IGZhbHNlXG4gICAgbG9nLmRlYnVnKCdSZXNldDogbm9SZXNldCBpcyBvbi4gTGVhdmluZyBzaW11bGF0b3IgYXMgaXMnKTtcbiAgICByZXR1cm47XG4gIH1cblxuICBpZiAoIWRldmljZSkge1xuICAgIGxvZy5kZWJ1ZygnUmVzZXQ6IG5vIGRldmljZSBhdmFpbGFibGUuIFNraXBwaW5nJyk7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgaWYgKG9wdHMuZnVsbFJlc2V0KSB7XG4gICAgbG9nLmRlYnVnKCdSZXNldDogZnVsbFJlc2V0IGlzIG9uLiBDbGVhbmluZyBzaW11bGF0b3InKTtcbiAgICBhd2FpdCBzaHV0ZG93blNpbXVsYXRvcihkZXZpY2UpO1xuICAgIGxldCBpc0tleWNoYWluc0JhY2t1cFN1Y2Nlc3NmdWwgPSBmYWxzZTtcbiAgICBpZiAob3B0cy5rZXljaGFpbnNFeGNsdWRlUGF0dGVybnMgfHwgb3B0cy5rZWVwS2V5Q2hhaW5zKSB7XG4gICAgICBpc0tleWNoYWluc0JhY2t1cFN1Y2Nlc3NmdWwgPSBhd2FpdCBkZXZpY2UuYmFja3VwS2V5Y2hhaW5zKCk7XG4gICAgfVxuICAgIGF3YWl0IGRldmljZS5jbGVhbigpO1xuICAgIGlmIChpc0tleWNoYWluc0JhY2t1cFN1Y2Nlc3NmdWwpIHtcbiAgICAgIGF3YWl0IGRldmljZS5yZXN0b3JlS2V5Y2hhaW5zKG9wdHMua2V5Y2hhaW5zRXhjbHVkZVBhdHRlcm5zIHx8IFtdKTtcbiAgICAgIGxvZy5pbmZvKGBTdWNjZXNzZnVsbHkgcmVzdG9yZWQga2V5Y2hhaW5zIGFmdGVyIGZ1bGwgcmVzZXRgKTtcbiAgICB9IGVsc2UgaWYgKG9wdHMua2V5Y2hhaW5zRXhjbHVkZVBhdHRlcm5zIHx8IG9wdHMua2VlcEtleUNoYWlucykge1xuICAgICAgbG9nLndhcm4oJ0Nhbm5vdCByZXN0b3JlIGtleWNoYWlucyBhZnRlciBmdWxsIHJlc2V0LCBiZWNhdXNlICcgK1xuICAgICAgICAgICAgICAgJ3RoZSBiYWNrdXAgb3BlcmF0aW9uIGRpZCBub3Qgc3VjY2VlZCcpO1xuICAgIH1cbiAgfSBlbHNlIGlmIChvcHRzLmJ1bmRsZUlkKSB7XG4gICAgLy8gZmFzdFJlc2V0IG9yIG5vUmVzZXRcblxuICAgIC8vIFRlcm1pbmF0ZSB0aGUgYXBwIHVuZGVyIHRlc3QgaWYgaXQgaXMgc3RpbGwgcnVubmluZyBvbiBTaW11bGF0b3JcbiAgICAvLyBUZXJtaW5hdGlvbiBpcyBub3QgbmVlZGVkIGlmIFNpbXVsYXRvciBpcyBub3QgcnVubmluZ1xuICAgIGlmIChhd2FpdCBkZXZpY2UuaXNSdW5uaW5nKCkpIHtcbiAgICAgIGlmIChvcHRzLmVuZm9yY2VTaW11bGF0b3JTaHV0ZG93bikge1xuICAgICAgICBhd2FpdCBzaHV0ZG93blNpbXVsYXRvcihkZXZpY2UpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBhd2FpdCB0ZXJtaW5hdGUoZGV2aWNlLnVkaWQsIG9wdHMuYnVuZGxlSWQpO1xuICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICBsb2cud2FybihgUmVzZXQ6IGZhaWxlZCB0byB0ZXJtaW5hdGUgU2ltdWxhdG9yIGFwcGxpY2F0aW9uIHdpdGggaWQgXCIke29wdHMuYnVuZGxlSWR9XCJgKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICBpZiAob3B0cy5hcHApIHtcbiAgICAgIGxvZy5pbmZvKCdOb3Qgc2NydWJiaW5nIHRoaXJkIHBhcnR5IGFwcCBpbiBhbnRpY2lwYXRpb24gb2YgdW5pbnN0YWxsJyk7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGNvbnN0IGlzU2FmYXJpID0gKG9wdHMuYnJvd3Nlck5hbWUgfHwgJycpLnRvTG93ZXJDYXNlKCkgPT09ICdzYWZhcmknO1xuICAgIHRyeSB7XG4gICAgICBpZiAoaXNTYWZhcmkpIHtcbiAgICAgICAgYXdhaXQgZGV2aWNlLmNsZWFuU2FmYXJpKCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICAvLyBpT1MgOCsgZG9lcyBub3QgbmVlZCBiYXNlbmFtZVxuICAgICAgICBhd2FpdCBkZXZpY2Uuc2NydWJDdXN0b21BcHAoJycsIG9wdHMuYnVuZGxlSWQpO1xuICAgICAgfVxuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgbG9nLndhcm4oZXJyLm1lc3NhZ2UpO1xuICAgICAgbG9nLndhcm4oYFJlc2V0OiBjb3VsZCBub3Qgc2NydWIgJHtpc1NhZmFyaSA/ICdTYWZhcmkgYnJvd3NlcicgOiAnYXBwbGljYXRpb24gd2l0aCBpZCBcIicgKyBvcHRzLmJ1bmRsZUlkICsgJ1wiJ30uIExlYXZpbmcgYXMgaXMuYCk7XG4gICAgfVxuICB9XG59XG5cbi8qKlxuICogQHBhcmFtIHtvYmplY3R9IGRldmljZSBUaGUgc2ltdWxhdG9yIGRldmljZSBvYmplY3RcbiAqIEBwYXJhbSB7P3N0cmluZ30gYXBwIFRoZSBhcHAgdG8gdGhlIHBhdGhcbiAqIEBwYXJhbSB7c3RyaW5nfSBidW5kbGVJZCBUaGUgYnVuZGxlIGlkIHRvIGVuc3VyZVxuICogICAgICAgICAgICAgICAgICAgICAgICAgIGl0IGlzIGFscmVhZHkgaW5zdGFsbGVkIGFuZCB1bmluc3RhbGwgaXRcbiAqIEBwYXJhbSB7Ym9vbH0gbm9SZXNldCBXaGV0aGVyIG5vUmVzZXRcbiAqL1xuYXN5bmMgZnVuY3Rpb24gaW5zdGFsbFRvU2ltdWxhdG9yIChkZXZpY2UsIGFwcCwgYnVuZGxlSWQsIG5vUmVzZXQgPSB0cnVlKSB7XG4gIGlmICghYXBwKSB7XG4gICAgbG9nLmRlYnVnKCdObyBhcHAgcGF0aCBpcyBnaXZlbi4gTm90aGluZyB0byBpbnN0YWxsLicpO1xuICAgIHJldHVybjtcbiAgfVxuXG4gIGlmIChidW5kbGVJZCkge1xuICAgIGlmIChhd2FpdCBkZXZpY2UuaXNBcHBJbnN0YWxsZWQoYnVuZGxlSWQpKSB7XG4gICAgICBpZiAobm9SZXNldCkge1xuICAgICAgICBsb2cuZGVidWcoYEFwcCAnJHtidW5kbGVJZH0nIGlzIGFscmVhZHkgaW5zdGFsbGVkLiBObyBuZWVkIHRvIHJlaW5zdGFsbC5gKTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgICAgbG9nLmRlYnVnKGBSZXNldCByZXF1ZXN0ZWQuIFJlbW92aW5nIGFwcCB3aXRoIGlkICcke2J1bmRsZUlkfScgZnJvbSB0aGUgZGV2aWNlYCk7XG4gICAgICBhd2FpdCBkZXZpY2UucmVtb3ZlQXBwKGJ1bmRsZUlkKTtcbiAgICB9XG4gIH1cblxuICBjb25zdCBpbnN0YWxsZENhY2hlUm9vdCA9IHBhdGgucmVzb2x2ZShkZXZpY2UuZ2V0RGlyKCksICdMaWJyYXJ5JywgJ0NhY2hlcycsIElOU1RBTExfREFFTU9OX0NBQ0hFKTtcbiAgbGV0IHRtcFJvb3QgPSBudWxsO1xuICBpZiAoYXdhaXQgZnMuZXhpc3RzKGluc3RhbGxkQ2FjaGVSb290KSkge1xuICAgIC8vIENsZWFudXAgb2YgaW5zdGFsbGQgY2FjaGUgaGVscHMgdG8gc2F2ZSBkaXNrIHNwYWNlIHdoaWxlIHJ1bm5pbmcgbXVsdGlwbGUgdGVzdHNcbiAgICAvLyB3aXRob3V0IHJlc3RhcnRpbmcgdGhlIFNpbXVsYXRvcjogaHR0cHM6Ly9naXRodWIuY29tL2FwcGl1bS9hcHBpdW0vaXNzdWVzLzk0MTBcbiAgICB0bXBSb290ID0gYXdhaXQgdGVtcERpci5vcGVuRGlyKCk7XG4gICAgbG9nLmRlYnVnKCdDbGVhbmluZyBpbnN0YWxsZCBjYWNoZSB0byBzYXZlIHRoZSBkaXNrIHNwYWNlJyk7XG4gICAgYXdhaXQgZnMubXYoaW5zdGFsbGRDYWNoZVJvb3QsIHBhdGgucmVzb2x2ZSh0bXBSb290LCBJTlNUQUxMX0RBRU1PTl9DQUNIRSksIHtta2RpcnA6IHRydWV9KTtcbiAgICBhd2FpdCBta2RpcnAoaW5zdGFsbGRDYWNoZVJvb3QpO1xuICB9XG5cbiAgbG9nLmRlYnVnKGBJbnN0YWxsaW5nICcke2FwcH0nIG9uIFNpbXVsYXRvciB3aXRoIFVVSUQgJyR7ZGV2aWNlLnVkaWR9Jy4uLmApO1xuICB0cnkge1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCBkZXZpY2UuaW5zdGFsbEFwcChhcHApO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIC8vIGl0IHNvbWV0aW1lcyBmYWlscyBvbiBYY29kZSAxMCBiZWNhdXNlIG9mIGEgcmFjZSBjb25kaXRpb25cbiAgICAgIGxvZy5pbmZvKGBHb3QgYW4gZXJyb3Igb24gJyR7YXBwfScgaW5zdGFsbDogJHtlLm1lc3NhZ2V9YCk7XG4gICAgICAvLyBodHRwczovL2dpdGh1Yi5jb20vYXBwaXVtL2FwcGl1bS9pc3N1ZXMvMTEzNTBcbiAgICAgIGlmIChlLm1lc3NhZ2UuaW5jbHVkZXMoJ01JSW5zdGFsbGVyRXJyb3JEb21haW4nKSAmJiB0bXBSb290KSB7XG4gICAgICAgIGxvZy5pbmZvKGBpbnN0YWxsZCByZXF1aXJlcyB0aGUgY2FjaGUgdG8gYmUgYXZhaWxhYmxlIGluIG9yZGVyIHRvIGluc3RhbGwgJyR7YXBwfScuIGAgK1xuICAgICAgICAgIGBSZXN0b3JpbmcgdGhlIGNhY2hlYCk7XG4gICAgICAgIGF3YWl0IGZzLnJpbXJhZihpbnN0YWxsZENhY2hlUm9vdCk7XG4gICAgICAgIGF3YWl0IGZzLm12KHBhdGgucmVzb2x2ZSh0bXBSb290LCBJTlNUQUxMX0RBRU1PTl9DQUNIRSksIGluc3RhbGxkQ2FjaGVSb290LCB7XG4gICAgICAgICAgbWtkaXJwOiB0cnVlXG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgICAgbG9nLmluZm8oJ1JldHJ5aW5nIGFwcGxpY2F0aW9uIGluc3RhbGwnKTtcbiAgICAgIGF3YWl0IGRldmljZS5pbnN0YWxsQXBwKGFwcCk7XG4gICAgfVxuICAgIGxvZy5kZWJ1ZygnVGhlIGFwcCBoYXMgYmVlbiBpbnN0YWxsZWQgc3VjY2Vzc2Z1bGx5LicpO1xuICB9IGZpbmFsbHkge1xuICAgIGlmICh0bXBSb290ICYmIGF3YWl0IGZzLmV4aXN0cyh0bXBSb290KSkge1xuICAgICAgYXdhaXQgZnMucmltcmFmKHRtcFJvb3QpO1xuICAgIH1cbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBzaHV0ZG93bk90aGVyU2ltdWxhdG9ycyAoY3VycmVudERldmljZSkge1xuICBjb25zdCBhbGxEZXZpY2VzID0gXy5mbGF0TWFwKF8udmFsdWVzKGF3YWl0IGdldERldmljZXMoKSkpO1xuICBjb25zdCBvdGhlckJvb3RlZERldmljZXMgPSBhbGxEZXZpY2VzLmZpbHRlcigoZGV2aWNlKSA9PiBkZXZpY2UudWRpZCAhPT0gY3VycmVudERldmljZS51ZGlkICYmIGRldmljZS5zdGF0ZSA9PT0gJ0Jvb3RlZCcpO1xuICBpZiAoXy5pc0VtcHR5KG90aGVyQm9vdGVkRGV2aWNlcykpIHtcbiAgICBsb2cuaW5mbygnTm8gb3RoZXIgcnVubmluZyBzaW11bGF0b3JzIGhhdmUgYmVlbiBkZXRlY3RlZCcpO1xuICAgIHJldHVybjtcbiAgfVxuICBsb2cuaW5mbyhgRGV0ZWN0ZWQgJHtvdGhlckJvb3RlZERldmljZXMubGVuZ3RofSBvdGhlciBydW5uaW5nIFNpbXVsYXRvciR7b3RoZXJCb290ZWREZXZpY2VzLmxlbmd0aCA9PT0gMSA/ICcnIDogJ3MnfS5gICtcbiAgICAgICAgICAgYFNodXR0aW5nICR7b3RoZXJCb290ZWREZXZpY2VzLmxlbmd0aCA9PT0gMSA/ICdpdCcgOiAndGhlbSd9IGRvd24uLi5gKTtcbiAgZm9yIChjb25zdCB7dWRpZH0gb2Ygb3RoZXJCb290ZWREZXZpY2VzKSB7XG4gICAgLy8gSXQgaXMgbmVjZXNzYXJ5IHRvIHN0b3AgdGhlIGNvcnJlc3BvbmRpbmcgeGNvZGVidWlsZCBwcm9jZXNzIGJlZm9yZSBraWxsaW5nXG4gICAgLy8gdGhlIHNpbXVsYXRvciwgb3RoZXJ3aXNlIGl0IHdpbGwgYmUgYXV0b21hdGljYWxseSByZXN0YXJ0ZWRcbiAgICBhd2FpdCByZXNldFhDVGVzdFByb2Nlc3Nlcyh1ZGlkLCB0cnVlKTtcbiAgICBhd2FpdCBzaHV0ZG93bih1ZGlkKTtcbiAgfVxufVxuXG5leHBvcnQgeyBjcmVhdGVTaW0sIGdldEV4aXN0aW5nU2ltLCBydW5TaW11bGF0b3JSZXNldCwgaW5zdGFsbFRvU2ltdWxhdG9yLFxuICBzaHV0ZG93blNpbXVsYXRvciwgc2h1dGRvd25PdGhlclNpbXVsYXRvcnMgfTtcbiJdLCJmaWxlIjoibGliL3NpbXVsYXRvci1tYW5hZ2VtZW50LmpzIiwic291cmNlUm9vdCI6Ii4uLy4uIn0=
