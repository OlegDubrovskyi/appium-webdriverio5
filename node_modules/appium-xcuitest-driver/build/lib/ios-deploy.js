"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _appiumSupport = require("appium-support");

var _path = _interopRequireDefault(require("path"));

var _appiumIosDevice = require("appium-ios-device");

var _bluebird = _interopRequireDefault(require("bluebird"));

const APPLICATION_INSTALLED_NOTIFICATION = 'com.apple.mobile.application_installed';
const INSTALLATION_STAGING_DIR = 'PublicStaging';
const APPLICATION_PUSH_TIMEOUT = 60 * 1000;

class IOSDeploy {
  constructor(udid) {
    this.udid = udid;
  }

  async remove(bundleid) {
    const service = await _appiumIosDevice.services.startInstallationProxyService(this.udid);

    try {
      await service.uninstallApplication(bundleid);
    } finally {
      service.close();
    }
  }

  async removeApp(bundleId) {
    await this.remove(bundleId);
  }

  async install(app) {
    try {
      const bundlePathOnPhone = await this.pushAppBundle(app);
      await this.installApplcation(bundlePathOnPhone);
    } catch (err) {
      throw new Error(`Could not install app: '${err.message}'`);
    }
  }

  async installApplcation(bundlePathOnPhone) {
    const notificationService = await _appiumIosDevice.services.startNotificationProxyService(this.udid);
    const installationService = await _appiumIosDevice.services.startInstallationProxyService(this.udid);
    const appInstalledNotification = new _bluebird.default(resolve => {
      notificationService.observeNotification(APPLICATION_INSTALLED_NOTIFICATION, {
        notification: resolve
      });
    });

    try {
      await installationService.installApplication(bundlePathOnPhone, {
        PackageType: 'Developer'
      });
      await appInstalledNotification;
    } finally {
      installationService.close();
      notificationService.close();
    }
  }

  async pushAppBundle(app) {
    const afcService = await _appiumIosDevice.services.startAfcService(this.udid);

    try {
      const bundlePathOnPhone = await this.createAppPath(afcService, app);
      const promises = [];
      await this.walkDir(app, async (itemPath, isDir) => {
        const pathOnPhone = _path.default.join(bundlePathOnPhone, _path.default.relative(app, itemPath));

        if (isDir) {
          await afcService.createDirectory(pathOnPhone);
        } else {
          const readStream = _appiumSupport.fs.createReadStream(itemPath, {
            autoClose: true
          });

          const writeStream = await afcService.createWriteStream(pathOnPhone, {
            autoDestroy: true
          });
          promises.push(new _bluebird.default(resolve => writeStream.on('close', resolve)));
          readStream.pipe(writeStream);
        }
      });
      await _bluebird.default.all(promises).timeout(APPLICATION_PUSH_TIMEOUT);
      return bundlePathOnPhone;
    } finally {
      afcService.close();
    }
  }

  async createAppPath(afcService, localAppPath) {
    const basename = _path.default.basename(localAppPath);

    const relativePath = _path.default.join(INSTALLATION_STAGING_DIR, basename);

    try {
      await afcService.deleteDirectory(relativePath);
    } catch (ign) {}

    await afcService.createDirectory(relativePath);
    return relativePath;
  }

  async walkDir(dir, callback) {
    for (const file of await _appiumSupport.fs.readdir(dir, {
      withFileTypes: true
    })) {
      const itemPath = _path.default.join(dir, file.name);

      const isDirectory = file.isDirectory();
      await callback(itemPath, isDirectory);

      if (!isDirectory) {
        continue;
      }

      await this.walkDir(itemPath, callback);
    }
  }

  async installApp(app) {
    await this.install(app);
  }

  async isAppInstalled(bundleid) {
    const service = await _appiumIosDevice.services.startInstallationProxyService(this.udid);

    try {
      const applications = await service.lookupApplications({
        bundleIds: bundleid
      });
      return !!applications[bundleid];
    } finally {
      service.close();
    }
  }

}

var _default = IOSDeploy;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9pb3MtZGVwbG95LmpzIl0sIm5hbWVzIjpbIkFQUExJQ0FUSU9OX0lOU1RBTExFRF9OT1RJRklDQVRJT04iLCJJTlNUQUxMQVRJT05fU1RBR0lOR19ESVIiLCJBUFBMSUNBVElPTl9QVVNIX1RJTUVPVVQiLCJJT1NEZXBsb3kiLCJjb25zdHJ1Y3RvciIsInVkaWQiLCJyZW1vdmUiLCJidW5kbGVpZCIsInNlcnZpY2UiLCJzZXJ2aWNlcyIsInN0YXJ0SW5zdGFsbGF0aW9uUHJveHlTZXJ2aWNlIiwidW5pbnN0YWxsQXBwbGljYXRpb24iLCJjbG9zZSIsInJlbW92ZUFwcCIsImJ1bmRsZUlkIiwiaW5zdGFsbCIsImFwcCIsImJ1bmRsZVBhdGhPblBob25lIiwicHVzaEFwcEJ1bmRsZSIsImluc3RhbGxBcHBsY2F0aW9uIiwiZXJyIiwiRXJyb3IiLCJtZXNzYWdlIiwibm90aWZpY2F0aW9uU2VydmljZSIsInN0YXJ0Tm90aWZpY2F0aW9uUHJveHlTZXJ2aWNlIiwiaW5zdGFsbGF0aW9uU2VydmljZSIsImFwcEluc3RhbGxlZE5vdGlmaWNhdGlvbiIsIkIiLCJyZXNvbHZlIiwib2JzZXJ2ZU5vdGlmaWNhdGlvbiIsIm5vdGlmaWNhdGlvbiIsImluc3RhbGxBcHBsaWNhdGlvbiIsIlBhY2thZ2VUeXBlIiwiYWZjU2VydmljZSIsInN0YXJ0QWZjU2VydmljZSIsImNyZWF0ZUFwcFBhdGgiLCJwcm9taXNlcyIsIndhbGtEaXIiLCJpdGVtUGF0aCIsImlzRGlyIiwicGF0aE9uUGhvbmUiLCJwYXRoIiwiam9pbiIsInJlbGF0aXZlIiwiY3JlYXRlRGlyZWN0b3J5IiwicmVhZFN0cmVhbSIsImZzIiwiY3JlYXRlUmVhZFN0cmVhbSIsImF1dG9DbG9zZSIsIndyaXRlU3RyZWFtIiwiY3JlYXRlV3JpdGVTdHJlYW0iLCJhdXRvRGVzdHJveSIsInB1c2giLCJvbiIsInBpcGUiLCJhbGwiLCJ0aW1lb3V0IiwibG9jYWxBcHBQYXRoIiwiYmFzZW5hbWUiLCJyZWxhdGl2ZVBhdGgiLCJkZWxldGVEaXJlY3RvcnkiLCJpZ24iLCJkaXIiLCJjYWxsYmFjayIsImZpbGUiLCJyZWFkZGlyIiwid2l0aEZpbGVUeXBlcyIsIm5hbWUiLCJpc0RpcmVjdG9yeSIsImluc3RhbGxBcHAiLCJpc0FwcEluc3RhbGxlZCIsImFwcGxpY2F0aW9ucyIsImxvb2t1cEFwcGxpY2F0aW9ucyIsImJ1bmRsZUlkcyJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFFQSxNQUFNQSxrQ0FBa0MsR0FBRyx3Q0FBM0M7QUFDQSxNQUFNQyx3QkFBd0IsR0FBRyxlQUFqQztBQUNBLE1BQU1DLHdCQUF3QixHQUFHLEtBQUssSUFBdEM7O0FBRUEsTUFBTUMsU0FBTixDQUFnQjtBQUVkQyxFQUFBQSxXQUFXLENBQUVDLElBQUYsRUFBUTtBQUNqQixTQUFLQSxJQUFMLEdBQVlBLElBQVo7QUFDRDs7QUFFRCxRQUFNQyxNQUFOLENBQWNDLFFBQWQsRUFBd0I7QUFDdEIsVUFBTUMsT0FBTyxHQUFHLE1BQU1DLDBCQUFTQyw2QkFBVCxDQUF1QyxLQUFLTCxJQUE1QyxDQUF0Qjs7QUFDQSxRQUFJO0FBQ0YsWUFBTUcsT0FBTyxDQUFDRyxvQkFBUixDQUE2QkosUUFBN0IsQ0FBTjtBQUNELEtBRkQsU0FFVTtBQUNSQyxNQUFBQSxPQUFPLENBQUNJLEtBQVI7QUFDRDtBQUNGOztBQUVELFFBQU1DLFNBQU4sQ0FBaUJDLFFBQWpCLEVBQTJCO0FBQ3pCLFVBQU0sS0FBS1IsTUFBTCxDQUFZUSxRQUFaLENBQU47QUFDRDs7QUFFRCxRQUFNQyxPQUFOLENBQWVDLEdBQWYsRUFBb0I7QUFDbEIsUUFBSTtBQUNGLFlBQU1DLGlCQUFpQixHQUFHLE1BQU0sS0FBS0MsYUFBTCxDQUFtQkYsR0FBbkIsQ0FBaEM7QUFDQSxZQUFNLEtBQUtHLGlCQUFMLENBQXVCRixpQkFBdkIsQ0FBTjtBQUNELEtBSEQsQ0FHRSxPQUFPRyxHQUFQLEVBQVk7QUFDWixZQUFNLElBQUlDLEtBQUosQ0FBVywyQkFBMEJELEdBQUcsQ0FBQ0UsT0FBUSxHQUFqRCxDQUFOO0FBQ0Q7QUFDRjs7QUFFRCxRQUFNSCxpQkFBTixDQUF5QkYsaUJBQXpCLEVBQTRDO0FBQzFDLFVBQU1NLG1CQUFtQixHQUFHLE1BQU1kLDBCQUFTZSw2QkFBVCxDQUF1QyxLQUFLbkIsSUFBNUMsQ0FBbEM7QUFDQSxVQUFNb0IsbUJBQW1CLEdBQUcsTUFBTWhCLDBCQUFTQyw2QkFBVCxDQUF1QyxLQUFLTCxJQUE1QyxDQUFsQztBQUNBLFVBQU1xQix3QkFBd0IsR0FBRyxJQUFJQyxpQkFBSixDQUFPQyxPQUFELElBQWE7QUFDbERMLE1BQUFBLG1CQUFtQixDQUFDTSxtQkFBcEIsQ0FBd0M3QixrQ0FBeEMsRUFBNEU7QUFBRThCLFFBQUFBLFlBQVksRUFBRUY7QUFBaEIsT0FBNUU7QUFDRCxLQUZnQyxDQUFqQzs7QUFHQSxRQUFJO0FBQ0YsWUFBTUgsbUJBQW1CLENBQUNNLGtCQUFwQixDQUF1Q2QsaUJBQXZDLEVBQTBEO0FBQUVlLFFBQUFBLFdBQVcsRUFBRTtBQUFmLE9BQTFELENBQU47QUFDQSxZQUFNTix3QkFBTjtBQUNELEtBSEQsU0FHVTtBQUNSRCxNQUFBQSxtQkFBbUIsQ0FBQ2IsS0FBcEI7QUFDQVcsTUFBQUEsbUJBQW1CLENBQUNYLEtBQXBCO0FBQ0Q7QUFDRjs7QUFFRCxRQUFNTSxhQUFOLENBQXFCRixHQUFyQixFQUEwQjtBQUN4QixVQUFNaUIsVUFBVSxHQUFHLE1BQU14QiwwQkFBU3lCLGVBQVQsQ0FBeUIsS0FBSzdCLElBQTlCLENBQXpCOztBQUNBLFFBQUk7QUFDRixZQUFNWSxpQkFBaUIsR0FBRyxNQUFNLEtBQUtrQixhQUFMLENBQW1CRixVQUFuQixFQUErQmpCLEdBQS9CLENBQWhDO0FBQ0EsWUFBTW9CLFFBQVEsR0FBRyxFQUFqQjtBQUNBLFlBQU0sS0FBS0MsT0FBTCxDQUFhckIsR0FBYixFQUFrQixPQUFPc0IsUUFBUCxFQUFpQkMsS0FBakIsS0FBMkI7QUFDakQsY0FBTUMsV0FBVyxHQUFHQyxjQUFLQyxJQUFMLENBQVV6QixpQkFBVixFQUE2QndCLGNBQUtFLFFBQUwsQ0FBYzNCLEdBQWQsRUFBbUJzQixRQUFuQixDQUE3QixDQUFwQjs7QUFDQSxZQUFJQyxLQUFKLEVBQVc7QUFDVCxnQkFBTU4sVUFBVSxDQUFDVyxlQUFYLENBQTJCSixXQUEzQixDQUFOO0FBQ0QsU0FGRCxNQUVPO0FBQ0wsZ0JBQU1LLFVBQVUsR0FBR0Msa0JBQUdDLGdCQUFILENBQW9CVCxRQUFwQixFQUE4QjtBQUFDVSxZQUFBQSxTQUFTLEVBQUU7QUFBWixXQUE5QixDQUFuQjs7QUFDQSxnQkFBTUMsV0FBVyxHQUFHLE1BQU1oQixVQUFVLENBQUNpQixpQkFBWCxDQUE2QlYsV0FBN0IsRUFBMEM7QUFBQ1csWUFBQUEsV0FBVyxFQUFFO0FBQWQsV0FBMUMsQ0FBMUI7QUFDQWYsVUFBQUEsUUFBUSxDQUFDZ0IsSUFBVCxDQUFjLElBQUl6QixpQkFBSixDQUFPQyxPQUFELElBQWFxQixXQUFXLENBQUNJLEVBQVosQ0FBZSxPQUFmLEVBQXdCekIsT0FBeEIsQ0FBbkIsQ0FBZDtBQUNBaUIsVUFBQUEsVUFBVSxDQUFDUyxJQUFYLENBQWdCTCxXQUFoQjtBQUNEO0FBQ0YsT0FWSyxDQUFOO0FBV0EsWUFBTXRCLGtCQUFFNEIsR0FBRixDQUFNbkIsUUFBTixFQUFnQm9CLE9BQWhCLENBQXdCdEQsd0JBQXhCLENBQU47QUFDQSxhQUFPZSxpQkFBUDtBQUNELEtBaEJELFNBZ0JVO0FBQ1JnQixNQUFBQSxVQUFVLENBQUNyQixLQUFYO0FBQ0Q7QUFDRjs7QUFFRCxRQUFNdUIsYUFBTixDQUFxQkYsVUFBckIsRUFBaUN3QixZQUFqQyxFQUErQztBQUM3QyxVQUFNQyxRQUFRLEdBQUdqQixjQUFLaUIsUUFBTCxDQUFjRCxZQUFkLENBQWpCOztBQUNBLFVBQU1FLFlBQVksR0FBR2xCLGNBQUtDLElBQUwsQ0FBVXpDLHdCQUFWLEVBQW9DeUQsUUFBcEMsQ0FBckI7O0FBQ0EsUUFBSTtBQUNGLFlBQU16QixVQUFVLENBQUMyQixlQUFYLENBQTJCRCxZQUEzQixDQUFOO0FBQ0QsS0FGRCxDQUVFLE9BQU9FLEdBQVAsRUFBWSxDQUFFOztBQUNoQixVQUFNNUIsVUFBVSxDQUFDVyxlQUFYLENBQTJCZSxZQUEzQixDQUFOO0FBQ0EsV0FBT0EsWUFBUDtBQUNEOztBQUVELFFBQU10QixPQUFOLENBQWV5QixHQUFmLEVBQW9CQyxRQUFwQixFQUE4QjtBQUM1QixTQUFLLE1BQU1DLElBQVgsSUFBbUIsTUFBTWxCLGtCQUFHbUIsT0FBSCxDQUFXSCxHQUFYLEVBQWdCO0FBQUVJLE1BQUFBLGFBQWEsRUFBRTtBQUFqQixLQUFoQixDQUF6QixFQUFtRTtBQUNqRSxZQUFNNUIsUUFBUSxHQUFHRyxjQUFLQyxJQUFMLENBQVVvQixHQUFWLEVBQWVFLElBQUksQ0FBQ0csSUFBcEIsQ0FBakI7O0FBQ0EsWUFBTUMsV0FBVyxHQUFHSixJQUFJLENBQUNJLFdBQUwsRUFBcEI7QUFDQSxZQUFNTCxRQUFRLENBQUN6QixRQUFELEVBQVc4QixXQUFYLENBQWQ7O0FBQ0EsVUFBSSxDQUFDQSxXQUFMLEVBQWtCO0FBQ2hCO0FBQ0Q7O0FBQ0QsWUFBTSxLQUFLL0IsT0FBTCxDQUFhQyxRQUFiLEVBQXVCeUIsUUFBdkIsQ0FBTjtBQUNEO0FBQ0Y7O0FBRUQsUUFBTU0sVUFBTixDQUFrQnJELEdBQWxCLEVBQXVCO0FBQ3JCLFVBQU0sS0FBS0QsT0FBTCxDQUFhQyxHQUFiLENBQU47QUFDRDs7QUFjRCxRQUFNc0QsY0FBTixDQUFzQi9ELFFBQXRCLEVBQWdDO0FBQzlCLFVBQU1DLE9BQU8sR0FBRyxNQUFNQywwQkFBU0MsNkJBQVQsQ0FBdUMsS0FBS0wsSUFBNUMsQ0FBdEI7O0FBQ0EsUUFBSTtBQUNGLFlBQU1rRSxZQUFZLEdBQUcsTUFBTS9ELE9BQU8sQ0FBQ2dFLGtCQUFSLENBQTJCO0FBQUVDLFFBQUFBLFNBQVMsRUFBRWxFO0FBQWIsT0FBM0IsQ0FBM0I7QUFDQSxhQUFPLENBQUMsQ0FBQ2dFLFlBQVksQ0FBQ2hFLFFBQUQsQ0FBckI7QUFDRCxLQUhELFNBR1U7QUFDUkMsTUFBQUEsT0FBTyxDQUFDSSxLQUFSO0FBQ0Q7QUFDRjs7QUFoSGE7O2VBbUhEVCxTIiwic291cmNlc0NvbnRlbnQiOlsiLyogZXNsaW50LWRpc2FibGUgcHJvbWlzZS9wcmVmZXItYXdhaXQtdG8tY2FsbGJhY2tzICovXG5pbXBvcnQgeyBmcyB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgc2VydmljZXMgfSBmcm9tICdhcHBpdW0taW9zLWRldmljZSc7XG5pbXBvcnQgQiBmcm9tICdibHVlYmlyZCc7XG5cbmNvbnN0IEFQUExJQ0FUSU9OX0lOU1RBTExFRF9OT1RJRklDQVRJT04gPSAnY29tLmFwcGxlLm1vYmlsZS5hcHBsaWNhdGlvbl9pbnN0YWxsZWQnO1xuY29uc3QgSU5TVEFMTEFUSU9OX1NUQUdJTkdfRElSID0gJ1B1YmxpY1N0YWdpbmcnO1xuY29uc3QgQVBQTElDQVRJT05fUFVTSF9USU1FT1VUID0gNjAgKiAxMDAwO1xuXG5jbGFzcyBJT1NEZXBsb3kge1xuXG4gIGNvbnN0cnVjdG9yICh1ZGlkKSB7XG4gICAgdGhpcy51ZGlkID0gdWRpZDtcbiAgfVxuXG4gIGFzeW5jIHJlbW92ZSAoYnVuZGxlaWQpIHtcbiAgICBjb25zdCBzZXJ2aWNlID0gYXdhaXQgc2VydmljZXMuc3RhcnRJbnN0YWxsYXRpb25Qcm94eVNlcnZpY2UodGhpcy51ZGlkKTtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgc2VydmljZS51bmluc3RhbGxBcHBsaWNhdGlvbihidW5kbGVpZCk7XG4gICAgfSBmaW5hbGx5IHtcbiAgICAgIHNlcnZpY2UuY2xvc2UoKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyByZW1vdmVBcHAgKGJ1bmRsZUlkKSB7XG4gICAgYXdhaXQgdGhpcy5yZW1vdmUoYnVuZGxlSWQpO1xuICB9XG5cbiAgYXN5bmMgaW5zdGFsbCAoYXBwKSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGJ1bmRsZVBhdGhPblBob25lID0gYXdhaXQgdGhpcy5wdXNoQXBwQnVuZGxlKGFwcCk7XG4gICAgICBhd2FpdCB0aGlzLmluc3RhbGxBcHBsY2F0aW9uKGJ1bmRsZVBhdGhPblBob25lKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgQ291bGQgbm90IGluc3RhbGwgYXBwOiAnJHtlcnIubWVzc2FnZX0nYCk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgaW5zdGFsbEFwcGxjYXRpb24gKGJ1bmRsZVBhdGhPblBob25lKSB7XG4gICAgY29uc3Qgbm90aWZpY2F0aW9uU2VydmljZSA9IGF3YWl0IHNlcnZpY2VzLnN0YXJ0Tm90aWZpY2F0aW9uUHJveHlTZXJ2aWNlKHRoaXMudWRpZCk7XG4gICAgY29uc3QgaW5zdGFsbGF0aW9uU2VydmljZSA9IGF3YWl0IHNlcnZpY2VzLnN0YXJ0SW5zdGFsbGF0aW9uUHJveHlTZXJ2aWNlKHRoaXMudWRpZCk7XG4gICAgY29uc3QgYXBwSW5zdGFsbGVkTm90aWZpY2F0aW9uID0gbmV3IEIoKHJlc29sdmUpID0+IHtcbiAgICAgIG5vdGlmaWNhdGlvblNlcnZpY2Uub2JzZXJ2ZU5vdGlmaWNhdGlvbihBUFBMSUNBVElPTl9JTlNUQUxMRURfTk9USUZJQ0FUSU9OLCB7IG5vdGlmaWNhdGlvbjogcmVzb2x2ZSB9KTtcbiAgICB9KTtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgaW5zdGFsbGF0aW9uU2VydmljZS5pbnN0YWxsQXBwbGljYXRpb24oYnVuZGxlUGF0aE9uUGhvbmUsIHsgUGFja2FnZVR5cGU6ICdEZXZlbG9wZXInfSk7XG4gICAgICBhd2FpdCBhcHBJbnN0YWxsZWROb3RpZmljYXRpb247XG4gICAgfSBmaW5hbGx5IHtcbiAgICAgIGluc3RhbGxhdGlvblNlcnZpY2UuY2xvc2UoKTtcbiAgICAgIG5vdGlmaWNhdGlvblNlcnZpY2UuY2xvc2UoKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBwdXNoQXBwQnVuZGxlIChhcHApIHtcbiAgICBjb25zdCBhZmNTZXJ2aWNlID0gYXdhaXQgc2VydmljZXMuc3RhcnRBZmNTZXJ2aWNlKHRoaXMudWRpZCk7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGJ1bmRsZVBhdGhPblBob25lID0gYXdhaXQgdGhpcy5jcmVhdGVBcHBQYXRoKGFmY1NlcnZpY2UsIGFwcCk7XG4gICAgICBjb25zdCBwcm9taXNlcyA9IFtdO1xuICAgICAgYXdhaXQgdGhpcy53YWxrRGlyKGFwcCwgYXN5bmMgKGl0ZW1QYXRoLCBpc0RpcikgPT4ge1xuICAgICAgICBjb25zdCBwYXRoT25QaG9uZSA9IHBhdGguam9pbihidW5kbGVQYXRoT25QaG9uZSwgcGF0aC5yZWxhdGl2ZShhcHAsIGl0ZW1QYXRoKSk7XG4gICAgICAgIGlmIChpc0Rpcikge1xuICAgICAgICAgIGF3YWl0IGFmY1NlcnZpY2UuY3JlYXRlRGlyZWN0b3J5KHBhdGhPblBob25lKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBjb25zdCByZWFkU3RyZWFtID0gZnMuY3JlYXRlUmVhZFN0cmVhbShpdGVtUGF0aCwge2F1dG9DbG9zZTogdHJ1ZX0pO1xuICAgICAgICAgIGNvbnN0IHdyaXRlU3RyZWFtID0gYXdhaXQgYWZjU2VydmljZS5jcmVhdGVXcml0ZVN0cmVhbShwYXRoT25QaG9uZSwge2F1dG9EZXN0cm95OiB0cnVlIH0pO1xuICAgICAgICAgIHByb21pc2VzLnB1c2gobmV3IEIoKHJlc29sdmUpID0+IHdyaXRlU3RyZWFtLm9uKCdjbG9zZScsIHJlc29sdmUpKSk7XG4gICAgICAgICAgcmVhZFN0cmVhbS5waXBlKHdyaXRlU3RyZWFtKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgICBhd2FpdCBCLmFsbChwcm9taXNlcykudGltZW91dChBUFBMSUNBVElPTl9QVVNIX1RJTUVPVVQpO1xuICAgICAgcmV0dXJuIGJ1bmRsZVBhdGhPblBob25lO1xuICAgIH0gZmluYWxseSB7XG4gICAgICBhZmNTZXJ2aWNlLmNsb3NlKCk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgY3JlYXRlQXBwUGF0aCAoYWZjU2VydmljZSwgbG9jYWxBcHBQYXRoKSB7XG4gICAgY29uc3QgYmFzZW5hbWUgPSBwYXRoLmJhc2VuYW1lKGxvY2FsQXBwUGF0aCk7XG4gICAgY29uc3QgcmVsYXRpdmVQYXRoID0gcGF0aC5qb2luKElOU1RBTExBVElPTl9TVEFHSU5HX0RJUiwgYmFzZW5hbWUpO1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCBhZmNTZXJ2aWNlLmRlbGV0ZURpcmVjdG9yeShyZWxhdGl2ZVBhdGgpO1xuICAgIH0gY2F0Y2ggKGlnbikge31cbiAgICBhd2FpdCBhZmNTZXJ2aWNlLmNyZWF0ZURpcmVjdG9yeShyZWxhdGl2ZVBhdGgpO1xuICAgIHJldHVybiByZWxhdGl2ZVBhdGg7XG4gIH1cblxuICBhc3luYyB3YWxrRGlyIChkaXIsIGNhbGxiYWNrKSB7XG4gICAgZm9yIChjb25zdCBmaWxlIG9mIGF3YWl0IGZzLnJlYWRkaXIoZGlyLCB7IHdpdGhGaWxlVHlwZXM6IHRydWUgfSkpIHtcbiAgICAgIGNvbnN0IGl0ZW1QYXRoID0gcGF0aC5qb2luKGRpciwgZmlsZS5uYW1lKTtcbiAgICAgIGNvbnN0IGlzRGlyZWN0b3J5ID0gZmlsZS5pc0RpcmVjdG9yeSgpO1xuICAgICAgYXdhaXQgY2FsbGJhY2soaXRlbVBhdGgsIGlzRGlyZWN0b3J5KTtcbiAgICAgIGlmICghaXNEaXJlY3RvcnkpIHtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG4gICAgICBhd2FpdCB0aGlzLndhbGtEaXIoaXRlbVBhdGgsIGNhbGxiYWNrKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBpbnN0YWxsQXBwIChhcHApIHtcbiAgICBhd2FpdCB0aGlzLmluc3RhbGwoYXBwKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm4gYW4gYXBwbGljYXRpb24gb2JqZWN0IGlmIHRlc3QgYXBwIGhhcyAnYnVuZGxlaWQnLlxuICAgKiBUaGUgdGFyZ2V0IGJ1bmRsZWlkIGNhbiBiZSBVc2VyIGFuZCBTeXN0ZW0gYXBwcy5cbiAgICogQHBhcmFtIHtzdHJpbmd9IGJ1bmRsZWlkIFRoZSBidW5kbGVJZCB0byBlbnN1cmUgaXQgaXMgaW5zdGFsbGVkXG4gICAqIEByZXR1cm4ge2Jvb2xlYW59IFJldHVybnMgVHJ1ZSBpZiB0aGUgYnVuZGxlaWQgZXhpc3RzIGluIHRoZSByZXN1bHQgb2YgJ2xpc3RBcHBsaWNhdGlvbnMnIGxpa2U6XG4gICAqIHsgXCJjb20uYXBwbGUuUHJlZmVyZW5jZXNcIjp7XG4gICAqICAgXCJVSVJlcXVpcmVkRGV2aWNlQ2FwYWJpbGl0aWVzXCI6W1wiYXJtNjRcIl0sXG4gICAqICAgXCJVSVJlcXVpcmVzRnVsbFNjcmVlblwiOnRydWUsXG4gICAqICAgXCJDRkJ1bmRsZUluZm9EaWN0aW9uYXJ5VmVyc2lvblwiOlwiNi4wXCIsXG4gICAqICAgXCJFbnRpdGxlbWVudHNcIjpcbiAgICogICAgIHtcImNvbS5hcHBsZS5mcm9udGJvYXJkLmRlbGV0ZS1hcHBsaWNhdGlvbi1zbmFwc2hvdHNcIjp0cnVlLC4uXG4gICAqL1xuICBhc3luYyBpc0FwcEluc3RhbGxlZCAoYnVuZGxlaWQpIHtcbiAgICBjb25zdCBzZXJ2aWNlID0gYXdhaXQgc2VydmljZXMuc3RhcnRJbnN0YWxsYXRpb25Qcm94eVNlcnZpY2UodGhpcy51ZGlkKTtcbiAgICB0cnkge1xuICAgICAgY29uc3QgYXBwbGljYXRpb25zID0gYXdhaXQgc2VydmljZS5sb29rdXBBcHBsaWNhdGlvbnMoeyBidW5kbGVJZHM6IGJ1bmRsZWlkIH0pO1xuICAgICAgcmV0dXJuICEhYXBwbGljYXRpb25zW2J1bmRsZWlkXTtcbiAgICB9IGZpbmFsbHkge1xuICAgICAgc2VydmljZS5jbG9zZSgpO1xuICAgIH1cbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBJT1NEZXBsb3k7XG4iXSwiZmlsZSI6ImxpYi9pb3MtZGVwbG95LmpzIiwic291cmNlUm9vdCI6Ii4uLy4uIn0=
