"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.IOSCrashLog = void 0;

require("source-map-support/register");

var _appiumIosDriver = require("appium-ios-driver");

var _appiumSupport = require("appium-support");

var _bluebird = _interopRequireDefault(require("bluebird"));

var _logger = _interopRequireDefault(require("../logger"));

var _appiumIosDevice = require("appium-ios-device");

var _path = _interopRequireDefault(require("path"));

class IOSCrashLog extends _appiumIosDriver.IOSCrashLog {
  constructor(opts = {}) {
    super(opts.udid ? _path.default.resolve(process.env.HOME, 'Library', 'Logs', 'CrashReporter', 'MobileDevice') : _path.default.resolve(process.env.HOME, 'Library', 'Logs', 'DiagnosticReports'));
    this.udid = opts.udid;
    this.phoneName = null;
    this.sim = opts.sim;
  }

  async getCrashes() {
    let crashLogsRoot = this.logDir;

    if (this.udid) {
      this.phoneName = this.phoneName || (await _appiumIosDevice.utilities.getDeviceName(this.udid));
      crashLogsRoot = _path.default.resolve(crashLogsRoot, this.phoneName);
    }

    if (!(await _appiumSupport.fs.exists(crashLogsRoot))) {
      _logger.default.debug(`Crash reports root '${crashLogsRoot}' does not exist. Got nothing to gather.`);

      return [];
    }

    const foundFiles = await _appiumSupport.fs.glob(`${crashLogsRoot}/**/*.crash`);

    if (this.udid) {
      return foundFiles;
    }

    return await _bluebird.default.filter(foundFiles, async x => {
      try {
        const content = await _appiumSupport.fs.readFile(x, 'utf8');
        return content.toUpperCase().includes(this.sim.udid.toUpperCase());
      } catch (err) {
        return false;
      }
    });
  }

  async filesToJSON(paths) {
    return await _bluebird.default.map(paths, async fullPath => {
      const stat = await _appiumSupport.fs.stat(fullPath);
      return {
        timestamp: stat.ctime.getTime(),
        level: 'ALL',
        message: await _appiumSupport.fs.readFile(fullPath, 'utf8')
      };
    });
  }

}

exports.IOSCrashLog = IOSCrashLog;
var _default = IOSCrashLog;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9kZXZpY2UtbG9nL2lvcy1jcmFzaC1sb2cuanMiXSwibmFtZXMiOlsiSU9TQ3Jhc2hMb2ciLCJJT1NEcml2ZXJJT1NDcmFzaExvZyIsImNvbnN0cnVjdG9yIiwib3B0cyIsInVkaWQiLCJwYXRoIiwicmVzb2x2ZSIsInByb2Nlc3MiLCJlbnYiLCJIT01FIiwicGhvbmVOYW1lIiwic2ltIiwiZ2V0Q3Jhc2hlcyIsImNyYXNoTG9nc1Jvb3QiLCJsb2dEaXIiLCJ1dGlsaXRpZXMiLCJnZXREZXZpY2VOYW1lIiwiZnMiLCJleGlzdHMiLCJsb2ciLCJkZWJ1ZyIsImZvdW5kRmlsZXMiLCJnbG9iIiwiQiIsImZpbHRlciIsIngiLCJjb250ZW50IiwicmVhZEZpbGUiLCJ0b1VwcGVyQ2FzZSIsImluY2x1ZGVzIiwiZXJyIiwiZmlsZXNUb0pTT04iLCJwYXRocyIsIm1hcCIsImZ1bGxQYXRoIiwic3RhdCIsInRpbWVzdGFtcCIsImN0aW1lIiwiZ2V0VGltZSIsImxldmVsIiwibWVzc2FnZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFFQSxNQUFNQSxXQUFOLFNBQTBCQyw0QkFBMUIsQ0FBK0M7QUFDN0NDLEVBQUFBLFdBQVcsQ0FBRUMsSUFBSSxHQUFHLEVBQVQsRUFBYTtBQUN0QixVQUFNQSxJQUFJLENBQUNDLElBQUwsR0FDSkMsY0FBS0MsT0FBTCxDQUFhQyxPQUFPLENBQUNDLEdBQVIsQ0FBWUMsSUFBekIsRUFBK0IsU0FBL0IsRUFBMEMsTUFBMUMsRUFBa0QsZUFBbEQsRUFBbUUsY0FBbkUsQ0FESSxHQUVKSixjQUFLQyxPQUFMLENBQWFDLE9BQU8sQ0FBQ0MsR0FBUixDQUFZQyxJQUF6QixFQUErQixTQUEvQixFQUEwQyxNQUExQyxFQUFrRCxtQkFBbEQsQ0FGRjtBQUdBLFNBQUtMLElBQUwsR0FBWUQsSUFBSSxDQUFDQyxJQUFqQjtBQUNBLFNBQUtNLFNBQUwsR0FBaUIsSUFBakI7QUFDQSxTQUFLQyxHQUFMLEdBQVdSLElBQUksQ0FBQ1EsR0FBaEI7QUFDRDs7QUFFRCxRQUFNQyxVQUFOLEdBQW9CO0FBQ2xCLFFBQUlDLGFBQWEsR0FBRyxLQUFLQyxNQUF6Qjs7QUFDQSxRQUFJLEtBQUtWLElBQVQsRUFBZTtBQUNiLFdBQUtNLFNBQUwsR0FBaUIsS0FBS0EsU0FBTCxLQUFrQixNQUFNSywyQkFBVUMsYUFBVixDQUF3QixLQUFLWixJQUE3QixDQUF4QixDQUFqQjtBQUNBUyxNQUFBQSxhQUFhLEdBQUdSLGNBQUtDLE9BQUwsQ0FBYU8sYUFBYixFQUE0QixLQUFLSCxTQUFqQyxDQUFoQjtBQUNEOztBQUNELFFBQUksRUFBQyxNQUFNTyxrQkFBR0MsTUFBSCxDQUFVTCxhQUFWLENBQVAsQ0FBSixFQUFxQztBQUNuQ00sc0JBQUlDLEtBQUosQ0FBVyx1QkFBc0JQLGFBQWMsMENBQS9DOztBQUNBLGFBQU8sRUFBUDtBQUNEOztBQUNELFVBQU1RLFVBQVUsR0FBRyxNQUFNSixrQkFBR0ssSUFBSCxDQUFTLEdBQUVULGFBQWMsYUFBekIsQ0FBekI7O0FBQ0EsUUFBSSxLQUFLVCxJQUFULEVBQWU7QUFDYixhQUFPaUIsVUFBUDtBQUNEOztBQUVELFdBQU8sTUFBTUUsa0JBQUVDLE1BQUYsQ0FBU0gsVUFBVCxFQUFxQixNQUFPSSxDQUFQLElBQWE7QUFDN0MsVUFBSTtBQUNGLGNBQU1DLE9BQU8sR0FBRyxNQUFNVCxrQkFBR1UsUUFBSCxDQUFZRixDQUFaLEVBQWUsTUFBZixDQUF0QjtBQUNBLGVBQU9DLE9BQU8sQ0FBQ0UsV0FBUixHQUFzQkMsUUFBdEIsQ0FBK0IsS0FBS2xCLEdBQUwsQ0FBU1AsSUFBVCxDQUFjd0IsV0FBZCxFQUEvQixDQUFQO0FBQ0QsT0FIRCxDQUdFLE9BQU9FLEdBQVAsRUFBWTtBQUNaLGVBQU8sS0FBUDtBQUNEO0FBQ0YsS0FQWSxDQUFiO0FBUUQ7O0FBRUQsUUFBTUMsV0FBTixDQUFtQkMsS0FBbkIsRUFBMEI7QUFDeEIsV0FBTyxNQUFNVCxrQkFBRVUsR0FBRixDQUFNRCxLQUFOLEVBQWEsTUFBT0UsUUFBUCxJQUFvQjtBQUM1QyxZQUFNQyxJQUFJLEdBQUcsTUFBTWxCLGtCQUFHa0IsSUFBSCxDQUFRRCxRQUFSLENBQW5CO0FBQ0EsYUFBTztBQUNMRSxRQUFBQSxTQUFTLEVBQUVELElBQUksQ0FBQ0UsS0FBTCxDQUFXQyxPQUFYLEVBRE47QUFFTEMsUUFBQUEsS0FBSyxFQUFFLEtBRkY7QUFHTEMsUUFBQUEsT0FBTyxFQUFFLE1BQU12QixrQkFBR1UsUUFBSCxDQUFZTyxRQUFaLEVBQXNCLE1BQXRCO0FBSFYsT0FBUDtBQUtELEtBUFksQ0FBYjtBQVFEOztBQTVDNEM7OztlQWdEaENsQyxXIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSU9TQ3Jhc2hMb2cgYXMgSU9TRHJpdmVySU9TQ3Jhc2hMb2cgfSBmcm9tICdhcHBpdW0taW9zLWRyaXZlcic7XG5pbXBvcnQgeyBmcyB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCBCIGZyb20gJ2JsdWViaXJkJztcbmltcG9ydCBsb2cgZnJvbSAnLi4vbG9nZ2VyJztcbmltcG9ydCB7IHV0aWxpdGllcyB9IGZyb20gJ2FwcGl1bS1pb3MtZGV2aWNlJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuXG5jbGFzcyBJT1NDcmFzaExvZyBleHRlbmRzIElPU0RyaXZlcklPU0NyYXNoTG9nIHtcbiAgY29uc3RydWN0b3IgKG9wdHMgPSB7fSkge1xuICAgIHN1cGVyKG9wdHMudWRpZCA/XG4gICAgICBwYXRoLnJlc29sdmUocHJvY2Vzcy5lbnYuSE9NRSwgJ0xpYnJhcnknLCAnTG9ncycsICdDcmFzaFJlcG9ydGVyJywgJ01vYmlsZURldmljZScpIDpcbiAgICAgIHBhdGgucmVzb2x2ZShwcm9jZXNzLmVudi5IT01FLCAnTGlicmFyeScsICdMb2dzJywgJ0RpYWdub3N0aWNSZXBvcnRzJykpO1xuICAgIHRoaXMudWRpZCA9IG9wdHMudWRpZDtcbiAgICB0aGlzLnBob25lTmFtZSA9IG51bGw7XG4gICAgdGhpcy5zaW0gPSBvcHRzLnNpbTtcbiAgfVxuXG4gIGFzeW5jIGdldENyYXNoZXMgKCkge1xuICAgIGxldCBjcmFzaExvZ3NSb290ID0gdGhpcy5sb2dEaXI7XG4gICAgaWYgKHRoaXMudWRpZCkge1xuICAgICAgdGhpcy5waG9uZU5hbWUgPSB0aGlzLnBob25lTmFtZSB8fCBhd2FpdCB1dGlsaXRpZXMuZ2V0RGV2aWNlTmFtZSh0aGlzLnVkaWQpO1xuICAgICAgY3Jhc2hMb2dzUm9vdCA9IHBhdGgucmVzb2x2ZShjcmFzaExvZ3NSb290LCB0aGlzLnBob25lTmFtZSk7XG4gICAgfVxuICAgIGlmICghYXdhaXQgZnMuZXhpc3RzKGNyYXNoTG9nc1Jvb3QpKSB7XG4gICAgICBsb2cuZGVidWcoYENyYXNoIHJlcG9ydHMgcm9vdCAnJHtjcmFzaExvZ3NSb290fScgZG9lcyBub3QgZXhpc3QuIEdvdCBub3RoaW5nIHRvIGdhdGhlci5gKTtcbiAgICAgIHJldHVybiBbXTtcbiAgICB9XG4gICAgY29uc3QgZm91bmRGaWxlcyA9IGF3YWl0IGZzLmdsb2IoYCR7Y3Jhc2hMb2dzUm9vdH0vKiovKi5jcmFzaGApO1xuICAgIGlmICh0aGlzLnVkaWQpIHtcbiAgICAgIHJldHVybiBmb3VuZEZpbGVzO1xuICAgIH1cbiAgICAvLyBGb3IgU2ltdWxhdG9yIG9ubHkgaW5jbHVkZSBmaWxlcywgdGhhdCBjb250YWluIGN1cnJlbnQgVURJRFxuICAgIHJldHVybiBhd2FpdCBCLmZpbHRlcihmb3VuZEZpbGVzLCBhc3luYyAoeCkgPT4ge1xuICAgICAgdHJ5IHtcbiAgICAgICAgY29uc3QgY29udGVudCA9IGF3YWl0IGZzLnJlYWRGaWxlKHgsICd1dGY4Jyk7XG4gICAgICAgIHJldHVybiBjb250ZW50LnRvVXBwZXJDYXNlKCkuaW5jbHVkZXModGhpcy5zaW0udWRpZC50b1VwcGVyQ2FzZSgpKTtcbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBhc3luYyBmaWxlc1RvSlNPTiAocGF0aHMpIHtcbiAgICByZXR1cm4gYXdhaXQgQi5tYXAocGF0aHMsIGFzeW5jIChmdWxsUGF0aCkgPT4ge1xuICAgICAgY29uc3Qgc3RhdCA9IGF3YWl0IGZzLnN0YXQoZnVsbFBhdGgpO1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgdGltZXN0YW1wOiBzdGF0LmN0aW1lLmdldFRpbWUoKSxcbiAgICAgICAgbGV2ZWw6ICdBTEwnLFxuICAgICAgICBtZXNzYWdlOiBhd2FpdCBmcy5yZWFkRmlsZShmdWxsUGF0aCwgJ3V0ZjgnKVxuICAgICAgfTtcbiAgICB9KTtcbiAgfVxufVxuXG5leHBvcnQgeyBJT1NDcmFzaExvZyB9O1xuZXhwb3J0IGRlZmF1bHQgSU9TQ3Jhc2hMb2c7XG4iXSwiZmlsZSI6ImxpYi9kZXZpY2UtbG9nL2lvcy1jcmFzaC1sb2cuanMiLCJzb3VyY2VSb290IjoiLi4vLi4vLi4ifQ==
