"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.IOSSimulatorLog = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _iosLog = require("./ios-log");

var _appiumSupport = require("appium-support");

var _teen_process = require("teen_process");

const log = _appiumSupport.logger.getLogger('IOSSimulatorLog');

const START_TIMEOUT = 10000;

class IOSSimulatorLog extends _iosLog.IOSLog {
  constructor(opts) {
    super();
    this.sim = opts.sim;
    this.showLogs = !!opts.showLogs;
    this.xcodeVersion = opts.xcodeVersion;
    this.proc = null;
  }

  async startCapture() {
    if (_lodash.default.isUndefined(this.sim.udid)) {
      throw new Error(`Log capture requires a sim udid`);
    }

    if (!(await this.sim.isRunning())) {
      throw new Error(`iOS Simulator with udid ${this.sim.udid} is not running`);
    }

    const tool = 'xcrun';
    const args = ['simctl', 'spawn', this.sim.udid, 'log', 'stream', '--style', 'compact'];
    log.debug(`Starting log capture for iOS Simulator with udid '${this.sim.udid}', ` + `using '${tool} ${args.join(' ')}'`);

    try {
      await (0, _teen_process.exec)('pkill', ['-xf', [tool, ...args].join(' ')]);
    } catch (ign) {}

    try {
      this.proc = new _teen_process.SubProcess(tool, args);
      await this.finishStartingLogCapture();
    } catch (e) {
      throw new Error(`Simulator log capture failed. Original error: ${e.message}`);
    }
  }

  async finishStartingLogCapture() {
    if (!this.proc) {
      log.errorAndThrow('Could not capture simulator log');
    }

    let firstLine = true;
    let logRow = '';
    this.proc.on('output', (stdout, stderr) => {
      if (stdout) {
        if (firstLine) {
          if (stdout.endsWith('\n')) {
            firstLine = false;
          }
        } else {
          logRow += stdout;

          if (stdout.endsWith('\n')) {
            this.onOutput(logRow);
            logRow = '';
          }
        }
      }

      if (stderr) {
        this.onOutput(logRow, 'STDERR');
      }
    });

    let sd = (stdout, stderr) => {
      if (/execvp\(\)/.test(stderr)) {
        throw new Error('iOS log capture process failed to start');
      }

      return stdout || stderr;
    };

    await this.proc.start(sd, START_TIMEOUT);
  }

  async stopCapture() {
    if (!this.proc) {
      return;
    }

    await this.killLogSubProcess();
    this.proc = null;
  }

  async killLogSubProcess() {
    if (!this.proc.isRunning) {
      return;
    }

    log.debug('Stopping iOS log capture');

    try {
      await this.proc.stop('SIGTERM', 1000);
    } catch (e) {
      if (!this.proc.isRunning) {
        return;
      }

      _appiumSupport.logger.warn('Cannot stop log capture process. Sending SIGKILL...');

      await this.proc.stop('SIGKILL');
    }
  }

  get isCapturing() {
    return this.proc && this.proc.isRunning;
  }

  onOutput(logRow, prefix = '') {
    const logs = _lodash.default.cloneDeep(logRow.split('\n'));

    for (const logLine of logs) {
      if (!logLine) continue;
      this.broadcast(logLine);

      if (this.showLogs) {
        const space = prefix.length > 0 ? ' ' : '';
        log.info(`[IOS_SYSLOG_ROW${space}${prefix}] ${logLine}`);
      }
    }
  }

}

exports.IOSSimulatorLog = IOSSimulatorLog;
var _default = IOSSimulatorLog;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9kZXZpY2UtbG9nL2lvcy1zaW11bGF0b3ItbG9nLmpzIl0sIm5hbWVzIjpbImxvZyIsImxvZ2dlciIsImdldExvZ2dlciIsIlNUQVJUX1RJTUVPVVQiLCJJT1NTaW11bGF0b3JMb2ciLCJJT1NMb2ciLCJjb25zdHJ1Y3RvciIsIm9wdHMiLCJzaW0iLCJzaG93TG9ncyIsInhjb2RlVmVyc2lvbiIsInByb2MiLCJzdGFydENhcHR1cmUiLCJfIiwiaXNVbmRlZmluZWQiLCJ1ZGlkIiwiRXJyb3IiLCJpc1J1bm5pbmciLCJ0b29sIiwiYXJncyIsImRlYnVnIiwiam9pbiIsImlnbiIsIlN1YlByb2Nlc3MiLCJmaW5pc2hTdGFydGluZ0xvZ0NhcHR1cmUiLCJlIiwibWVzc2FnZSIsImVycm9yQW5kVGhyb3ciLCJmaXJzdExpbmUiLCJsb2dSb3ciLCJvbiIsInN0ZG91dCIsInN0ZGVyciIsImVuZHNXaXRoIiwib25PdXRwdXQiLCJzZCIsInRlc3QiLCJzdGFydCIsInN0b3BDYXB0dXJlIiwia2lsbExvZ1N1YlByb2Nlc3MiLCJzdG9wIiwid2FybiIsImlzQ2FwdHVyaW5nIiwicHJlZml4IiwibG9ncyIsImNsb25lRGVlcCIsInNwbGl0IiwibG9nTGluZSIsImJyb2FkY2FzdCIsInNwYWNlIiwibGVuZ3RoIiwiaW5mbyJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFFQSxNQUFNQSxHQUFHLEdBQUdDLHNCQUFPQyxTQUFQLENBQWlCLGlCQUFqQixDQUFaOztBQUVBLE1BQU1DLGFBQWEsR0FBRyxLQUF0Qjs7QUFFQSxNQUFNQyxlQUFOLFNBQThCQyxjQUE5QixDQUFxQztBQUNuQ0MsRUFBQUEsV0FBVyxDQUFFQyxJQUFGLEVBQVE7QUFDakI7QUFDQSxTQUFLQyxHQUFMLEdBQVdELElBQUksQ0FBQ0MsR0FBaEI7QUFDQSxTQUFLQyxRQUFMLEdBQWdCLENBQUMsQ0FBQ0YsSUFBSSxDQUFDRSxRQUF2QjtBQUNBLFNBQUtD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aEIsR0FBb0IsR0FBcEIsR0FBMEIsRUFBeEM7QUFDQWxELFFBQUFBLEdBQUcsQ0FBQ21ELElBQUosQ0FBVSxrQkFBaUJGLEtBQU0sR0FBRU4sTUFBTyxLQUFJSSxPQUFRLEVBQXREO0FBQ0Q7QUFDRjtBQUNGOztBQTFHa0M7OztlQThHdEIzQyxlIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IElPU0xvZyB9IGZyb20gJy4vaW9zLWxvZyc7XG5pbXBvcnQgeyBsb2dnZXIgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgeyBTdWJQcm9jZXNzLCBleGVjIH0gZnJvbSAndGVlbl9wcm9jZXNzJztcblxuY29uc3QgbG9nID0gbG9nZ2VyLmdldExvZ2dlcignSU9TU2ltdWxhdG9yTG9nJyk7XG5cbmNvbnN0IFNUQVJUX1RJTUVPVVQgPSAxMDAwMDtcblxuY2xhc3MgSU9TU2ltdWxhdG9yTG9nIGV4dGVuZHMgSU9TTG9nIHtcbiAgY29uc3RydWN0b3IgKG9wdHMpIHtcbiAgICBzdXBlcigpO1xuICAgIHRoaXMuc2ltID0gb3B0cy5zaW07XG4gICAgdGhpcy5zaG93TG9ncyA9ICEhb3B0cy5zaG93TG9ncztcbiAgICB0aGlzLnhjb2RlVmVyc2lvbiA9IG9wdHMueGNvZGVWZXJzaW9uO1xuICAgIHRoaXMucHJvYyA9IG51bGw7XG4gIH1cblxuICBhc3luYyBzdGFydENhcHR1cmUgKCkge1xuICAgIGlmIChfLmlzVW5kZWZpbmVkKHRoaXMuc2ltLnVkaWQpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYExvZyBjYXB0dXJlIHJlcXVpcmVzIGEgc2ltIHVkaWRgKTtcbiAgICB9XG5cbiAgICBpZiAoIWF3YWl0IHRoaXMuc2ltLmlzUnVubmluZygpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYGlPUyBTaW11bGF0b3Igd2l0aCB1ZGlkICR7dGhpcy5zaW0udWRpZH0gaXMgbm90IHJ1bm5pbmdgKTtcbiAgICB9XG4gICAgY29uc3QgdG9vbCA9ICd4Y3J1bic7XG4gICAgY29uc3QgYXJncyA9IFsnc2ltY3RsJywgJ3NwYXduJywgdGhpcy5zaW0udWRpZCwgJ2xvZycsICdzdHJlYW0nLCAnLS1zdHlsZScsICdjb21wYWN0J107XG4gICAgbG9nLmRlYnVnKGBTdGFydGluZyBsb2cgY2FwdHVyZSBmb3IgaU9TIFNpbXVsYXRvciB3aXRoIHVkaWQgJyR7dGhpcy5zaW0udWRpZH0nLCBgICtcbiAgICAgICAgICAgICAgICBgdXNpbmcgJyR7dG9vbH0gJHthcmdzLmpvaW4oJyAnKX0nYCk7XG4gICAgdHJ5IHtcbiAgICAgIC8vIGNsZWFudXAgZXhpc3RpbmcgbGlzdGVuZXJzIGlmIHRoZSBwcmV2aW91cyBzZXNzaW9uIGhhcyBub3QgYmVlbiB0ZXJtaW5hdGVkIHByb3Blcmx5XG4gICAgICBhd2FpdCBleGVjKCdwa2lsbCcsIFsnLXhmJywgW3Rvb2wsIC4uLmFyZ3NdLmpvaW4oJyAnKV0pO1xuICAgIH0gY2F0Y2ggKGlnbikge31cbiAgICB0cnkge1xuICAgICAgdGhpcy5wcm9jID0gbmV3IFN1YlByb2Nlc3ModG9vbCwgYXJncyk7XG4gICAgICBhd2FpdCB0aGlzLmZpbmlzaFN0YXJ0aW5nTG9nQ2FwdHVyZSgpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgU2ltdWxhdG9yIGxvZyBjYXB0dXJlIGZhaWxlZC4gT3JpZ2luYWwgZXJyb3I6ICR7ZS5tZXNzYWdlfWApO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGZpbmlzaFN0YXJ0aW5nTG9nQ2FwdHVyZSAoKSB7XG4gICAgaWYgKCF0aGlzLnByb2MpIHtcbiAgICAgIGxvZy5lcnJvckFuZFRocm93KCdDb3VsZCBub3QgY2FwdHVyZSBzaW11bGF0b3IgbG9nJyk7XG4gICAgfVxuICAgIGxldCBmaXJzdExpbmUgPSB0cnVlO1xuICAgIGxldCBsb2dSb3cgPSAnJztcbiAgICB0aGlzLnByb2Mub24oJ291dHB1dCcsIChzdGRvdXQsIHN0ZGVycikgPT4ge1xuICAgICAgaWYgKHN0ZG91dCkge1xuICAgICAgICBpZiAoZmlyc3RMaW5lKSB7XG4gICAgICAgICAgaWYgKHN0ZG91dC5lbmRzV2l0aCgnXFxuJykpIHtcbiAgICAgICAgICAgIC8vIGRvbid0IHN0b3JlIHRoZSBmaXJzdCBsaW5lIG9mIHRoZSBsb2cgYmVjYXVzZSBpdCBjYW1lIGJlZm9yZSB0aGUgc2ltIHdhcyBsYXVuY2hlZFxuICAgICAgICAgICAgZmlyc3RMaW5lID0gZmFsc2U7XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGxvZ1JvdyArPSBzdGRvdXQ7XG4gICAgICAgICAgaWYgKHN0ZG91dC5lbmRzV2l0aCgnXFxuJykpIHtcbiAgICAgICAgICAgIHRoaXMub25PdXRwdXQobG9nUm93KTtcbiAgICAgICAgICAgIGxvZ1JvdyA9ICcnO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgaWYgKHN0ZGVycikge1xuICAgICAgICB0aGlzLm9uT3V0cHV0KGxvZ1JvdywgJ1NUREVSUicpO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgbGV0IHNkID0gKHN0ZG91dCwgc3RkZXJyKSA9PiB7XG4gICAgICBpZiAoL2V4ZWN2cFxcKFxcKS8udGVzdChzdGRlcnIpKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignaU9TIGxvZyBjYXB0dXJlIHByb2Nlc3MgZmFpbGVkIHRvIHN0YXJ0Jyk7XG4gICAgICB9XG4gICAgICByZXR1cm4gc3Rkb3V0IHx8IHN0ZGVycjtcbiAgICB9O1xuICAgIGF3YWl0IHRoaXMucHJvYy5zdGFydChzZCwgU1RBUlRfVElNRU9VVCk7XG4gIH1cblxuICBhc3luYyBzdG9wQ2FwdHVyZSAoKSB7XG4gICAgaWYgKCF0aGlzLnByb2MpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgYXdhaXQgdGhpcy5raWxsTG9nU3ViUHJvY2VzcygpO1xuICAgIHRoaXMucHJvYyA9IG51bGw7XG4gIH1cblxuICBhc3luYyBraWxsTG9nU3ViUHJvY2VzcyAoKSB7XG4gICAgaWYgKCF0aGlzLnByb2MuaXNSdW5uaW5nKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGxvZy5kZWJ1ZygnU3RvcHBpbmcgaU9TIGxvZyBjYXB0dXJlJyk7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHRoaXMucHJvYy5zdG9wKCdTSUdURVJNJywgMTAwMCk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgaWYgKCF0aGlzLnByb2MuaXNSdW5uaW5nKSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICAgIGxvZ2dlci53YXJuKCdDYW5ub3Qgc3RvcCBsb2cgY2FwdHVyZSBwcm9jZXNzLiBTZW5kaW5nIFNJR0tJTEwuLi4nKTtcbiAgICAgIGF3YWl0IHRoaXMucHJvYy5zdG9wKCdTSUdLSUxMJyk7XG4gICAgfVxuICB9XG5cbiAgZ2V0IGlzQ2FwdHVyaW5nICgpIHtcbiAgICByZXR1cm4gdGhpcy5wcm9jICYmIHRoaXMucHJvYy5pc1J1bm5pbmc7XG4gIH1cblxuICBvbk91dHB1dCAobG9nUm93LCBwcmVmaXggPSAnJykge1xuICAgIGNvbnN0IGxvZ3MgPSBfLmNsb25lRGVlcChsb2dSb3cuc3BsaXQoJ1xcbicpKTtcbiAgICBmb3IgKGNvbnN0IGxvZ0xpbmUgb2YgbG9ncykge1xuICAgICAgaWYgKCFsb2dMaW5lKSBjb250aW51ZTsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBjdXJseVxuICAgICAgdGhpcy5icm9hZGNhc3QobG9nTGluZSk7XG4gICAgICBpZiAodGhpcy5zaG93TG9ncykge1xuICAgICAgICBjb25zdCBzcGFjZSA9IHByZWZpeC5sZW5ndGggPiAwID8gJyAnIDogJyc7XG4gICAgICAgIGxvZy5pbmZvKGBbSU9TX1NZU0xPR19ST1cke3NwYWNlfSR7cHJlZml4fV0gJHtsb2dMaW5lfWApO1xuICAgICAgfVxuICAgIH1cbiAgfVxufVxuXG5leHBvcnQgeyBJT1NTaW11bGF0b3JMb2cgfTtcbmV4cG9ydCBkZWZhdWx0IElPU1NpbXVsYXRvckxvZzsiXSwiZmlsZSI6ImxpYi9kZXZpY2UtbG9nL2lvcy1zaW11bGF0b3ItbG9nLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
