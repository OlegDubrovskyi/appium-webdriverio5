"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.commands = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _path = _interopRequireDefault(require("path"));

var _appiumSupport = require("appium-support");

var _teen_process = require("teen_process");

var _logger = _interopRequireDefault(require("../logger"));

var _utils = require("../utils");

var _asyncbox = require("asyncbox");

let commands = {};
exports.commands = commands;
const PERF_RECORD_FEAT_NAME = 'perf_record';
const PERF_RECORD_SECURITY_MESSAGE = 'Performance measurement requires relaxing security for simulator. ' + `Please set '--relaxed-security' or '--allow-insecure' with '${PERF_RECORD_FEAT_NAME}' ` + 'referencing https://github.com/appium/appium/blob/master/docs/en/writing-running-appium/security.md for more details.';
const RECORDERS_CACHE = {};
const DEFAULT_TIMEOUT_MS = 5 * 60 * 1000;
const STOP_TIMEOUT_MS = 3 * 60 * 1000;
const START_TIMEOUT_MS = 15 * 1000;
const DEFAULT_PROFILE_NAME = 'Activity Monitor';
const DEFAULT_EXT = '.trace';

async function finishPerfRecord(proc, stopGracefully = true) {
  if (!proc.isRunning) {
    return;
  }

  if (stopGracefully) {
    _logger.default.debug(`Sending SIGINT to the running instruments process`);

    return await proc.stop('SIGINT', STOP_TIMEOUT_MS);
  }

  _logger.default.debug(`Sending SIGTERM to the running instruments process`);

  await proc.stop();
}

async function uploadTrace(localFile, remotePath = null, uploadOptions = {}) {
  try {
    return await (0, _utils.encodeBase64OrUpload)(localFile, remotePath, uploadOptions);
  } finally {
    await _appiumSupport.fs.rimraf(localFile);
  }
}

commands.mobileStartPerfRecord = async function mobileStartPerfRecord(opts = {}) {
  if (!this.isFeatureEnabled(PERF_RECORD_FEAT_NAME) && !this.isRealDevice()) {
    _logger.default.errorAndThrow(PERF_RECORD_SECURITY_MESSAGE);
  }

  const {
    timeout = DEFAULT_TIMEOUT_MS,
    profileName = DEFAULT_PROFILE_NAME,
    pid
  } = opts;
  const runningRecorders = RECORDERS_CACHE[profileName];

  if (_lodash.default.isPlainObject(runningRecorders) && runningRecorders[this.opts.device.udid]) {
    const {
      proc,
      localPath
    } = runningRecorders[this.opts.device.udid];
    await finishPerfRecord(proc, false);

    if (await _appiumSupport.fs.exists(localPath)) {
      await _appiumSupport.fs.rimraf(localPath);
    }

    delete runningRecorders[this.opts.device.udid];
  }

  if (!(await _appiumSupport.fs.which('instruments'))) {
    _logger.default.errorAndThrow(`Cannot start performance recording, because 'instruments' ` + `tool cannot be found in PATH. Are Xcode development tools installed?`);
  }

  const localPath = await _appiumSupport.tempDir.path({
    prefix: `appium_perf_${profileName}_${Date.now()}`.replace(/\W/g, '_'),
    suffix: DEFAULT_EXT
  });
  const args = ['-w', this.opts.device.udid, '-t', profileName, '-D', localPath, '-l', timeout];

  if (pid) {
    if (`${pid}`.toLowerCase() === 'current') {
      const appInfo = await this.proxyCommand('/wda/activeAppInfo', 'GET');
      args.push('-p', appInfo.pid);
    } else {
      args.push('-p', pid);
    }
  }

  const proc = new _teen_process.SubProcess('instruments', args);

  _logger.default.info(`Starting 'instruments' with arguments: ${args.join(' ')}`);

  proc.on('exit', code => {
    const msg = `instruments exited with code '${code}'`;

    if (code) {
      _logger.default.warn(msg);
    } else {
      _logger.default.debug(msg);
    }
  });
  proc.on('output', (stdout, stderr) => {
    (stdout || stderr).split('\n').filter(x => x.length).map(x => _logger.default.debug(`[instruments] ${x}`));
  });
  await proc.start(0);

  try {
    await (0, _asyncbox.waitForCondition)(async () => await _appiumSupport.fs.exists(localPath), {
      waitMs: START_TIMEOUT_MS,
      intervalMs: 500
    });
  } catch (err) {
    try {
      await proc.stop('SIGKILL');
    } catch (ign) {}

    _logger.default.errorAndThrow(`Cannot start performance monitoring for '${profileName}' profile in ${START_TIMEOUT_MS}ms. ` + `Make sure you can execute it manually.`);
  }

  RECORDERS_CACHE[profileName] = Object.assign({}, RECORDERS_CACHE[profileName] || {}, {
    [this.opts.device.udid]: {
      proc,
      localPath
    }
  });
};

commands.mobileStopPerfRecord = async function mobileStopPerfRecord(opts = {}) {
  if (!this.isFeatureEnabled(PERF_RECORD_FEAT_NAME) && !this.isRealDevice()) {
    _logger.default.errorAndThrow(PERF_RECORD_SECURITY_MESSAGE);
  }

  const {
    remotePath,
    user,
    pass,
    method,
    profileName = DEFAULT_PROFILE_NAME
  } = opts;
  const runningRecorders = RECORDERS_CACHE[profileName];

  if (!_lodash.default.isPlainObject(runningRecorders) || !runningRecorders[this.opts.device.udid]) {
    _logger.default.errorAndThrow(`There are no records for performance profile '${profileName}' ` + `and device ${this.opts.device.udid}. ` + `Have you started the profiling before?`);
  }

  const {
    proc,
    localPath
  } = runningRecorders[this.opts.device.udid];
  await finishPerfRecord(proc, true);

  if (!(await _appiumSupport.fs.exists(localPath))) {
    _logger.default.errorAndThrow(`There is no .trace file found for performance profile '${profileName}' ` + `and device ${this.opts.device.udid}. ` + `Make sure the profile is supported on this device. ` + `You can use 'instruments -s' command to see the list of all available profiles.`);
  }

  const zipPath = `${localPath}.zip`;
  const zipArgs = ['-9', '-r', zipPath, _path.default.basename(localPath)];

  _logger.default.info(`Found perf trace record '${localPath}'. Compressing it with 'zip ${zipArgs.join(' ')}'`);

  try {
    await (0, _teen_process.exec)('zip', zipArgs, {
      cwd: _path.default.dirname(localPath)
    });
    return await uploadTrace(zipPath, remotePath, {
      user,
      pass,
      method
    });
  } finally {
    delete runningRecorders[this.opts.device.udid];

    if (await _appiumSupport.fs.exists(localPath)) {
      await _appiumSupport.fs.rimraf(localPath);
    }
  }
};

var _default = commands;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9wZXJmb3JtYW5jZS5qcyJdLCJuYW1lcyI6WyJjb21tYW5kcyIsIlBFUkZfUkVDT1JEX0ZFQVRfTkFNRSIsIlBFUkZfUkVDT1JEX1NFQ1VSSVRZX01FU1NBR0UiLCJSRUNPUkRFUlNfQ0FDSEUiLCJERUZBVUxUX1RJTUVPVVRfTVMiLCJTVE9QX1RJTUVPVVRfTVMiLCJTVEFSVF9USU1FT1VUX01TIiwiREVGQVVMVF9QUk9GSUxFX05BTUUiLCJERUZBVUxUX0VYVCIsImZpbmlzaFBlcmZSZWNvcmQiLCJwcm9jIiwic3RvcEdyYWNlZnVsbHkiLCJpc1J1bm5pbmciLCJsb2ciLCJkZWJ1ZyIsInN0b3AiLCJ1cGxvYWRUcmFjZSIsImxvY2FsRmlsZSIsInJlbW90ZVBhdGgiLCJ1cGxvYWRPcHRpb25zIiwiZnMiLCJyaW1yYWYiLCJtb2JpbGVTdGFydFBlcmZSZWNvcmQiLCJvcHRzIiwiaXNGZWF0dXJlRW5hYmxlZCIsImlzUmVhbERldmljZSIsImVycm9yQW5kVGhyb3ciLCJ0aW1lb3V0IiwicHJvZmlsZU5hbWUiLCJwaWQiLCJydW5uaW5nUmVjb3JkZXJzIiwiXyIsImlzUGxhaW5PYmplY3QiLCJkZXZpY2UiLCJ1ZGlkIiwibG9jYWxQYXRoIiwiZXhpc3RzIiwid2hpY2giLCJ0ZW1wRGlyIiwicGF0aCIsInByZWZpeCIsIkRhdGUiLCJub3ciLCJyZXBsYWNlIiwic3VmZml4IiwiYXJncyIsInRvTG93ZXJDYXNlIiwiYXBwSW5mbyIsInByb3h5Q29tbWFuZCIsInB1c2giLCJTdWJQcm9jZXNzIiwiaW5mbyIsImpvaW4iLCJvbiIsImNvZGUiLCJtc2ciLCJ3YXJuIiwic3Rkb3V0Iiwic3RkZXJyIiwic3BsaXQiLCJmaWx0ZXIiLCJ4IiwibGVuZ3RoIiwibWFwIiwic3RhcnQiLCJ3YWl0TXMiLCJpbnRlcnZhbE1zIiwiZXJyIiwiaWduIiwiT2JqZWN0IiwiYXNzaWduIiwibW9iaWxlU3RvcFBlcmZSZWNvcmQiLCJ1c2VyIiwicGFzcyIsIm1l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aUM7QUFDL0J0QixvQkFBSWEsYUFBSixDQUFtQiwwREFBeURFLFdBQVksSUFBdEUsR0FDQyxjQUFhLEtBQUtMLElBQUwsQ0FBVVUsTUFBVixDQUFpQkMsSUFBSyxJQURwQyxHQUVDLHFEQUZELEdBR0MsaUZBSG5CO0FBSUQ7O0FBRUQsUUFBTXlDLE9BQU8sR0FBSSxHQUFFeEMsU0FBVSxNQUE3QjtBQUNBLFFBQU15QyxPQUFPLEdBQUcsQ0FDZCxJQURjLEVBQ1IsSUFEUSxFQUNGRCxPQURFLEVBRWRwQyxjQUFLc0MsUUFBTCxDQUFjMUMsU0FBZCxDQUZjLENBQWhCOztBQUlBdEIsa0JBQUlzQyxJQUFKLENBQVUsNEJBQTJCaEIsU0FBVSwrQkFBOEJ5QyxPQUFPLENBQUN4QixJQUFSLENBQWEsR0FBYixDQUFrQixHQUEvRjs7QUFDQSxNQUFJO0FBQ0YsVUFBTSx3QkFBSyxLQUFMLEVBQVl3QixPQUFaLEVBQXFCO0FBQ3pCRSxNQUFBQSxHQUFHLEVBQUV2QyxjQUFLd0MsT0FBTCxDQUFhNUMsU0FBYjtBQURvQixLQUFyQixDQUFOO0FBR0EsV0FBTyxNQUFNbkIsV0FBVyxDQUFDMkQsT0FBRCxFQUFVekQsVUFBVixFQUFzQjtBQUFDc0QsTUFBQUEsSUFBRDtBQUFPQyxNQUFBQSxJQUFQO0FBQWFDLE1BQUFBO0FBQWIsS0FBdEIsQ0FBeEI7QUFDRCxHQUxELFNBS1U7QUFDUixXQUFPNUMsZ0JBQWdCLENBQUMsS0FBS1AsSUFBTCxDQUFVVSxNQUFWLENBQWlCQyxJQUFsQixDQUF2Qjs7QUFDQSxRQUFJLE1BQU1kLGtCQUFHZ0IsTUFBSCxDQUFVRCxTQUFWLENBQVYsRUFBZ0M7QUFDOUIsWUFBTWYsa0JBQUdDLE1BQUgsQ0FBVWMsU0FBVixDQUFOO0FBQ0Q7QUFDRjtBQUNGLENBN0NEOztlQWlEZW5DLFEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBmcywgdGVtcERpciB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCB7IFN1YlByb2Nlc3MsIGV4ZWMgfSBmcm9tICd0ZWVuX3Byb2Nlc3MnO1xuaW1wb3J0IGxvZyBmcm9tICcuLi9sb2dnZXInO1xuaW1wb3J0IHsgZW5jb2RlQmFzZTY0T3JVcGxvYWQgfSBmcm9tICcuLi91dGlscyc7XG5pbXBvcnQgeyB3YWl0Rm9yQ29uZGl0aW9uIH0gZnJvbSAnYXN5bmNib3gnO1xuXG5cbmxldCBjb21tYW5kcyA9IHt9O1xuXG5jb25zdCBQRVJGX1JFQ09SRF9GRUFUX05BTUUgPSAncGVyZl9yZWNvcmQnO1xuY29uc3QgUEVSRl9SRUNPUkRfU0VDVVJJVFlfTUVTU0FHRSA9ICdQZXJmb3JtYW5jZSBtZWFzdXJlbWVudCByZXF1aXJlcyByZWxheGluZyBzZWN1cml0eSBmb3Igc2ltdWxhdG9yLiAnICtcbiAgYFBsZWFzZSBzZXQgJy0tcmVsYXhlZC1zZWN1cml0eScgb3IgJy0tYWxsb3ctaW5zZWN1cmUnIHdpdGggJyR7UEVSRl9SRUNPUkRfRkVBVF9OQU1FfScgYCArXG4gICdyZWZlcmVuY2luZyBodHRwczovL2dpdGh1Yi5jb20vYXBwaXVtL2FwcGl1bS9ibG9iL21hc3Rlci9kb2NzL2VuL3dyaXRpbmctcnVubmluZy1hcHBpdW0vc2VjdXJpdHkubWQgZm9yIG1vcmUgZGV0YWlscy4nO1xuY29uc3QgUkVDT1JERVJTX0NBQ0hFID0ge307XG5jb25zdCBERUZBVUxUX1RJTUVPVVRfTVMgPSA1ICogNjAgKiAxMDAwO1xuY29uc3QgU1RPUF9USU1FT1VUX01TID0gMyAqIDYwICogMTAwMDtcbmNvbnN0IFNUQVJUX1RJTUVPVVRfTVMgPSAxNSAqIDEwMDA7XG5jb25zdCBERUZBVUxUX1BST0ZJTEVfTkFNRSA9ICdBY3Rpdml0eSBNb25pdG9yJztcbmNvbnN0IERFRkFVTFRfRVhUID0gJy50cmFjZSc7XG5cblxuYXN5bmMgZnVuY3Rpb24gZmluaXNoUGVyZlJlY29yZCAocHJvYywgc3RvcEdyYWNlZnVsbHkgPSB0cnVlKSB7XG4gIGlmICghcHJvYy5pc1J1bm5pbmcpIHtcbiAgICByZXR1cm47XG4gIH1cbiAgaWYgKHN0b3BHcmFjZWZ1bGx5KSB7XG4gICAgbG9nLmRlYnVnKGBTZW5kaW5nIFNJR0lOVCB0byB0aGUgcnVubmluZyBpbnN0cnVtZW50cyBwcm9jZXNzYCk7XG4gICAgcmV0dXJuIGF3YWl0IHByb2Muc3RvcCgnU0lHSU5UJywgU1RPUF9USU1FT1VUX01TKTtcbiAgfVxuICBsb2cuZGVidWcoYFNlbmRpbmcgU0lHVEVSTSB0byB0aGUgcnVubmluZyBpbnN0cnVtZW50cyBwcm9jZXNzYCk7XG4gIGF3YWl0IHByb2Muc3RvcCgpO1xufVxuXG5hc3luYyBmdW5jdGlvbiB1cGxvYWRUcmFjZSAobG9jYWxGaWxlLCByZW1vdGVQYXRoID0gbnVsbCwgdXBsb2FkT3B0aW9ucyA9IHt9KSB7XG4gIHRyeSB7XG4gICAgcmV0dXJuIGF3YWl0IGVuY29kZUJhc2U2NE9yVXBsb2FkKGxvY2FsRmlsZSwgcmVtb3RlUGF0aCwgdXBsb2FkT3B0aW9ucyk7XG4gIH0gZmluYWxseSB7XG4gICAgYXdhaXQgZnMucmltcmFmKGxvY2FsRmlsZSk7XG4gIH1cbn1cblxuXG4vKipcbiAqIEB0eXBlZGVmIHtPYmplY3R9IFN0YXJ0UGVyZlJlY29yZE9wdGlvbnNcbiAqXG4gKiBAcHJvcGVydHkgez9udW1iZXJ8c3RyaW5nfSB0aW1lb3V0IFszMDAwMDBdIC0gVGhlIG1heGltdW0gY291bnQgb2YgbWlsbGlzZWNvbmRzIHRvIHJlY29yZCB0aGUgcHJvZmlsaW5nIGluZm9ybWF0aW9uLlxuICogQHByb3BlcnR5IHs/c3RyaW5nfSBwcm9maWxlTmFtZSBbQWN0aXZpdHkgTW9uaXRvcl0gLSBUaGUgbmFtZSBvZiBleGlzdGluZyBwZXJmb3JtYW5jZSBwcm9maWxlIHRvIGFwcGx5LlxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBFeGVjdXRlIGBpbnN0cnVtZW50cyAtc2AgdG8gc2hvdyB0aGUgbGlzdCBvZiBhdmFpbGFibGUgcHJvZmlsZXMuXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIE5vdGUsIHRoYXQgbm90IGFsbCBwcm9maWxlcyBhcmUgc3VwcG9ydGVkIG9uIG1vYmlsZSBkZXZpY2VzLlxuICogQHByb3BlcnR5IHs/c3RyaW5nfG51bWJlcn0gcGlkIC0gVGhlIElEIG9mIHRoZSBwcm9jZXNzIHRvIG1lYXN1cmUgdGhlIHBlcmZvcm1hbmNlIGZvci5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFNldCBpdCB0byBgY3VycmVudGAgaW4gb3JkZXIgdG8gbWVhc3VyZSB0aGUgcGVyZm9ybWFuY2Ugb2ZcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoZSBwcm9jZXNzLCB3aGljaCBiZWxvbmdzIHRvIHRoZSBjdXJyZW50bHkgYWN0aXZlIGFwcGxpY2F0aW9uLlxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgQWxsIHByb2Nlc3NlcyBydW5uaW5nIG9uIHRoZSBkZXZpY2UgYXJlIG1lYXN1cmVkIGlmXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwaWQgaXMgdW5zZXQgKHRoZSBkZWZhdWx0IHNldHRpbmcpLlxuICovXG5cbi8qKlxuICogU3RhcnRzIHBlcmZvcm1hbmNlIHByb2ZpbGluZyBmb3IgdGhlIGRldmljZSB1bmRlciB0ZXN0LlxuICogUmVsYXhpbmcgc2VjdXJpdHkgaXMgbWFuZGF0b3J5IGZvciBzaW11bGF0b3JzLiBJdCBjYW4gYWx3YXlzIHdvcmsgZm9yIHJlYWwgZGV2aWNlcy5cbiAqXG4gKiBUaGUgYGluc3RydW1lbnRzYCBkZXZlbG9wZXIgdXRpbGl0eSBpcyB1c2VkIGZvciB0aGlzIHB1cnBvc2UgdW5kZXIgdGhlIGhvb2QuXG4gKiBJdCBpcyBwb3NzaWJsZSB0byByZWNvcmQgbXVsdGlwbGUgcHJvZmlsZXMgYXQgdGhlIHNhbWUgdGltZS5cbiAqIFJlYWQgaHR0cHM6Ly9kZXZlbG9wZXIuYXBwbGUuY29tL2xpYnJhcnkvY29udGVudC9kb2N1bWVudGF0aW9uL0RldmVsb3BlclRvb2xzL0NvbmNlcHR1YWwvSW5zdHJ1bWVudHNVc2VyR3VpZGUvUmVjb3JkaW5nLFBhdXNpbmcsYW5kU3RvcHBpbmdUcmFjZXMuaHRtbFxuICogZm9yIG1vcmUgZGV0YWlscy5cbiAqXG4gKiBAcGFyYW0gez9TdGFydFBlcmZSZWNvcmRPcHRpb25zfSBvcHRzIC0gVGhlIHNldCBvZiBwb3NzaWJsZSBzdGFydCByZWNvcmQgb3B0aW9uc1xuICovXG5jb21tYW5kcy5tb2JpbGVTdGFydFBlcmZSZWNvcmQgPSBhc3luYyBmdW5jdGlvbiBtb2JpbGVTdGFydFBlcmZSZWNvcmQgKG9wdHMgPSB7fSkge1xuICBpZiAoIXRoaXMuaXNGZWF0dXJlRW5hYmxlZChQRVJGX1JFQ09SRF9GRUFUX05BTUUpICYmICF0aGlzLmlzUmVhbERldmljZSgpKSB7XG4gICAgbG9nLmVycm9yQW5kVGhyb3coUEVSRl9SRUNPUkRfU0VDVVJJVFlfTUVTU0FHRSk7XG4gIH1cblxuICBjb25zdCB7XG4gICAgdGltZW91dCA9IERFRkFVTFRfVElNRU9VVF9NUyxcbiAgICBwcm9maWxlTmFtZSA9IERFRkFVTFRfUFJPRklMRV9OQU1FLFxuICAgIHBpZCxcbiAgfSA9IG9wdHM7XG5cbiAgLy8gQ2xlYW51cCB0aGUgcHJvY2VzcyBpZiBpdCBpcyBhbHJlYWR5IHJ1bm5pbmdcbiAgY29uc3QgcnVubmluZ1JlY29yZGVycyA9IFJFQ09SREVSU19DQUNIRVtwcm9maWxlTmFtZV07XG4gIGlmIChfLmlzUGxhaW5PYmplY3QocnVubmluZ1JlY29yZGVycykgJiYgcnVubmluZ1JlY29yZGVyc1t0aGlzLm9wdHMuZGV2aWNlLnVkaWRdKSB7XG4gICAgY29uc3Qge3Byb2MsIGxvY2FsUGF0aH0gPSBydW5uaW5nUmVjb3JkZXJzW3RoaXMub3B0cy5kZXZpY2UudWRpZF07XG4gICAgYXdhaXQgZmluaXNoUGVyZlJlY29yZChwcm9jLCBmYWxzZSk7XG4gICAgaWYgKGF3YWl0IGZzLmV4aXN0cyhsb2NhbFBhdGgpKSB7XG4gICAgICBhd2FpdCBmcy5yaW1yYWYobG9jYWxQYXRoKTtcbiAgICB9XG4gICAgZGVsZXRlIHJ1bm5pbmdSZWNvcmRlcnNbdGhpcy5vcHRzLmRldmljZS51ZGlkXTtcbiAgfVxuXG4gIGlmICghYXdhaXQgZnMud2hpY2goJ2luc3RydW1lbnRzJykpIHtcbiAgICBsb2cuZXJyb3JBbmRUaHJvdyhgQ2Fubm90IHN0YXJ0IHBlcmZvcm1hbmNlIHJlY29yZGluZywgYmVjYXVzZSAnaW5zdHJ1bWVudHMnIGAgK1xuICAgICAgICAgICAgICAgICAgICAgIGB0b29sIGNhbm5vdCBiZSBmb3VuZCBpbiBQQVRILiBBcmUgWGNvZGUgZGV2ZWxvcG1lbnQgdG9vbHMgaW5zdGFsbGVkP2ApO1xuICB9XG5cbiAgY29uc3QgbG9jYWxQYXRoID0gYXdhaXQgdGVtcERpci5wYXRoKHtcbiAgICBwcmVmaXg6IGBhcHBpdW1fcGVyZl8ke3Byb2ZpbGVOYW1lfV8ke0RhdGUubm93KCl9YC5yZXBsYWNlKC9cXFcvZywgJ18nKSxcbiAgICBzdWZmaXg6IERFRkFVTFRfRVhULFxuICB9KTtcbiAgY29uc3QgYXJncyA9IFtcbiAgICAnLXcnLCB0aGlzLm9wdHMuZGV2aWNlLnVkaWQsXG4gICAgJy10JywgcHJvZmlsZU5hbWUsXG4gICAgJy1EJywgbG9jYWxQYXRoLFxuICAgICctbCcsIHRpbWVvdXQsXG4gIF07XG4gIGlmIChwaWQpIHtcbiAgICBpZiAoYCR7cGlkfWAudG9Mb3dlckNhc2UoKSA9PT0gJ2N1cnJlbnQnKSB7XG4gICAgICBjb25zdCBhcHBJbmZvID0gYXdhaXQgdGhpcy5wcm94eUNvbW1hbmQoJy93ZGEvYWN0aXZlQXBwSW5mbycsICdHRVQnKTtcbiAgICAgIGFyZ3MucHVzaCgnLXAnLCBhcHBJbmZvLnBpZCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGFyZ3MucHVzaCgnLXAnLCBwaWQpO1xuICAgIH1cbiAgfVxuICBjb25zdCBwcm9jID0gbmV3IFN1YlByb2Nlc3MoJ2luc3RydW1lbnRzJywgYXJncyk7XG4gIGxvZy5pbmZvKGBTdGFydGluZyAnaW5zdHJ1bWVudHMnIHdpdGggYXJndW1lbnRzOiAke2FyZ3Muam9pbignICcpfWApO1xuICBwcm9jLm9uKCdleGl0JywgKGNvZGUpID0+IHtcbiAgICBjb25zdCBtc2cgPSBgaW5zdHJ1bWVudHMgZXhpdGVkIHdpdGggY29kZSAnJHtjb2RlfSdgO1xuICAgIGlmIChjb2RlKSB7XG4gICAgICBsb2cud2Fybihtc2cpO1xuICAgIH0gZWxzZSB7XG4gICAgICBsb2cuZGVidWcobXNnKTtcbiAgICB9XG4gIH0pO1xuICBwcm9jLm9uKCdvdXRwdXQnLCAoc3Rkb3V0LCBzdGRlcnIpID0+IHtcbiAgICAoc3Rkb3V0IHx8IHN0ZGVycikuc3BsaXQoJ1xcbicpXG4gICAgICAuZmlsdGVyKHggPT4geC5sZW5ndGgpXG4gICAgICAubWFwKHggPT4gbG9nLmRlYnVnKGBbaW5zdHJ1bWVudHNdICR7eH1gKSk7XG4gIH0pO1xuXG4gIGF3YWl0IHByb2Muc3RhcnQoMCk7XG4gIHRyeSB7XG4gICAgYXdhaXQgd2FpdEZvckNvbmRpdGlvbihhc3luYyAoKSA9PiBhd2FpdCBmcy5leGlzdHMobG9jYWxQYXRoKSwge1xuICAgICAgd2FpdE1zOiBTVEFSVF9USU1FT1VUX01TLFxuICAgICAgaW50ZXJ2YWxNczogNTAwLFxuICAgIH0pO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgcHJvYy5zdG9wKCdTSUdLSUxMJyk7XG4gICAgfSBjYXRjaCAoaWduKSB7fVxuICAgIGxvZy5lcnJvckFuZFRocm93KGBDYW5ub3Qgc3RhcnQgcGVyZm9ybWFuY2UgbW9uaXRvcmluZyBmb3IgJyR7cHJvZmlsZU5hbWV9JyBwcm9maWxlIGluICR7U1RBUlRfVElNRU9VVF9NU31tcy4gYCArXG4gICAgICAgICAgICAgICAgICAgICAgYE1ha2Ugc3VyZSB5b3UgY2FuIGV4ZWN1dGUgaXQgbWFudWFsbHkuYCk7XG4gIH1cbiAgUkVDT1JERVJTX0NBQ0hFW3Byb2ZpbGVOYW1lXSA9IE9iamVjdC5hc3NpZ24oe30sIChSRUNPUkRFUlNfQ0FDSEVbcHJvZmlsZU5hbWVdIHx8IHt9KSwge1xuICAgIFt0aGlzLm9wdHMuZGV2aWNlLnVkaWRdOiB7cHJvYywgbG9jYWxQYXRofSxcbiAgfSk7XG59O1xuXG4vKipcbiAqIEB0eXBlZGVmIHtPYmplY3R9IFN0b3BSZWNvcmRpbmdPcHRpb25zXG4gKlxuICogQHByb3BlcnR5IHs/c3RyaW5nfSByZW1vdGVQYXRoIC0gVGhlIHBhdGggdG8gdGhlIHJlbW90ZSBsb2NhdGlvbiwgd2hlcmUgdGhlIHJlc3VsdGluZyB6aXBwZWQgLnRyYWNlIGZpbGUgc2hvdWxkIGJlIHVwbG9hZGVkLlxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgVGhlIGZvbGxvd2luZyBwcm90b2NvbHMgYXJlIHN1cHBvcnRlZDogaHR0cC9odHRwcywgZnRwLlxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgTnVsbCBvciBlbXB0eSBzdHJpbmcgdmFsdWUgKHRoZSBkZWZhdWx0IHNldHRpbmcpIG1lYW5zIHRoZSBjb250ZW50IG9mIHJlc3VsdGluZ1xuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlsZSBzaG91bGQgYmUgemlwcGVkLCBlbmNvZGVkIGFzIEJhc2U2NCBhbmQgcGFzc2VkIGFzIHRoZSBlbmRwb2ludCByZXNwb25zZSB2YWx1ZS5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIEFuIGV4Y2VwdGlvbiB3aWxsIGJlIHRocm93biBpZiB0aGUgZ2VuZXJhdGVkIGZpbGUgaXMgdG9vIGJpZyB0b1xuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZml0IGludG8gdGhlIGF2YWlsYWJsZSBwcm9jZXNzIG1lbW9yeS5cbiAqIEBwcm9wZXJ0eSB7P3N0cmluZ30gdXNlciAtIFRoZSBuYW1lIG9mIHRoZSB1c2VyIGZvciB0aGUgcmVtb3RlIGF1dGhlbnRpY2F0aW9uLiBPbmx5IHdvcmtzIGlmIGByZW1vdGVQYXRoYCBpcyBwcm92aWRlZC5cbiAqIEBwcm9wZXJ0eSB7P3N0cmluZ30gcGFzcyAtIFRoZSBwYXNzd29yZCBmb3IgdGhlIHJlbW90ZSBhdXRoZW50aWNhdGlvbi4gT25seSB3b3JrcyBpZiBgcmVtb3RlUGF0aGAgaXMgcHJvdmlkZWQuXG4gKiBAcHJvcGVydHkgez9zdHJpbmd9IG1ldGhvZCBbUFVUXSAtIFRoZSBodHRwIG11bHRpcGFydCB1cGxvYWQgbWV0aG9kIG5hbWUuIE9ubHkgd29ya3MgaWYgYHJlbW90ZVBhdGhgIGlzIHByb3ZpZGVkLlxuICogQHByb3BlcnR5IHs/c3RyaW5nfSBwcm9maWxlTmFtZSBbQWN0aXZpdHkgTW9uaXRvcl0gLSBUaGUgbmFtZSBvZiBhbiBleGlzdGluZyBwZXJmb3JtYW5jZSBwcm9maWxlIGZvciB3aGljaCB0aGUgcmVjb3JkaW5nIGhhcyBiZWVuIG1hZGUuXG4gKi9cblxuLyoqXG4gKiBTdG9wcyBwZXJmb3JtYW5jZSBwcm9maWxpbmcgZm9yIHRoZSBkZXZpY2UgdW5kZXIgdGVzdC5cbiAqIFRoZSByZXN1bHRpbmcgZmlsZSBpbiAudHJhY2UgZm9ybWF0IGNhbiBiZSBlaXRoZXIgcmV0dXJuZWRcbiAqIGRpcmVjdGx5IGFzIGJhc2U2NC1lbmNvZGVkIHppcCBhcmNoaXZlIG9yIHVwbG9hZGVkIHRvIGEgcmVtb3RlIGxvY2F0aW9uXG4gKiAoc3VjaCBmaWxlcyBjYW4gYmUgcHJldHR5IGxhcmdlKS4gQWZ0ZXJ3YXJkcyBpdCBpcyBwb3NzaWJsZSB0byB1bmFyY2hpdmUgYW5kXG4gKiBvcGVuIHN1Y2ggZmlsZSB3aXRoIFhjb2RlIERldiBUb29scy5cbiAqXG4gKiBAcGFyYW0gez9TdG9wUmVjb3JkaW5nT3B0aW9uc30gb3B0cyAtIFRoZSBzZXQgb2YgcG9zc2libGUgc3RvcCByZWNvcmQgb3B0aW9uc1xuICogQHJldHVybiB7c3RyaW5nfSBFaXRoZXIgYW4gZW1wdHkgc3RyaW5nIGlmIHRoZSB1cGxvYWQgd2FzIHN1Y2Nlc3NmdWwgb3IgYmFzZS02NCBlbmNvZGVkXG4gKiBjb250ZW50IG9mIHppcHBlZCAudHJhY2UgZmlsZS5cbiAqIEB0aHJvd3Mge0Vycm9yfSBJZiBubyBwZXJmb3JtYW5jZSByZWNvcmRpbmcgd2l0aCBnaXZlbiBwcm9maWxlIG5hbWUvZGV2aWNlIHVkaWQgY29tYmluYXRpb25cbiAqIGhhcyBiZWVuIHN0YXJ0ZWQgYmVmb3JlIG9yIHRoZSByZXN1bHRpbmcgLnRyYWNlIGZpbGUgaGFzIG5vdCBiZWVuIGdlbmVyYXRlZCBwcm9wZXJseS5cbiAqL1xuY29tbWFuZHMubW9iaWxlU3RvcFBlcmZSZWNvcmQgPSBhc3luYyBmdW5jdGlvbiBtb2JpbGVTdG9wUGVyZlJlY29yZCAob3B0cyA9IHt9KSB7XG4gIGlmICghdGhpcy5pc0ZlYXR1cmVFbmFibGVkKFBFUkZfUkVDT1JEX0ZFQVRfTkFNRSkgJiYgIXRoaXMuaXNSZWFsRGV2aWNlKCkpIHtcbiAgICBsb2cuZXJyb3JBbmRUaHJvdyhQRVJGX1JFQ09SRF9TRUNVUklUWV9NRVNTQUdFKTtcbiAgfVxuXG4gIGNvbnN0IHtcbiAgICByZW1vdGVQYXRoLFxuICAgIHVzZXIsXG4gICAgcGFzcyxcbiAgICBtZXRob2QsXG4gICAgcHJvZmlsZU5hbWUgPSBERUZBVUxUX1BST0ZJTEVfTkFNRSxcbiAgfSA9IG9wdHM7XG4gIGNvbnN0IHJ1bm5pbmdSZWNvcmRlcnMgPSBSRUNPUkRFUlNfQ0FDSEVbcHJvZmlsZU5hbWVdO1xuICBpZiAoIV8uaXNQbGFpbk9iamVjdChydW5uaW5nUmVjb3JkZXJzKSB8fCAhcnVubmluZ1JlY29yZGVyc1t0aGlzLm9wdHMuZGV2aWNlLnVkaWRdKSB7XG4gICAgbG9nLmVycm9yQW5kVGhyb3coYFRoZXJlIGFyZSBubyByZWNvcmRzIGZvciBwZXJmb3JtYW5jZSBwcm9maWxlICcke3Byb2ZpbGVOYW1lfScgYCArXG4gICAgICAgICAgICAgICAgICAgICAgYGFuZCBkZXZpY2UgJHt0aGlzLm9wdHMuZGV2aWNlLnVkaWR9LiBgICtcbiAgICAgICAgICAgICAgICAgICAgICBgSGF2ZSB5b3Ugc3RhcnRlZCB0aGUgcHJvZmlsaW5nIGJlZm9yZT9gKTtcbiAgfVxuXG4gIGNvbnN0IHtwcm9jLCBsb2NhbFBhdGh9ID0gcnVubmluZ1JlY29yZGVyc1t0aGlzLm9wdHMuZGV2aWNlLnVkaWRdO1xuICBhd2FpdCBmaW5pc2hQZXJmUmVjb3JkKHByb2MsIHRydWUpO1xuICBpZiAoIWF3YWl0IGZzLmV4aXN0cyhsb2NhbFBhdGgpKSB7XG4gICAgbG9nLmVycm9yQW5kVGhyb3coYFRoZXJlIGlzIG5vIC50cmFjZSBmaWxlIGZvdW5kIGZvciBwZXJmb3JtYW5jZSBwcm9maWxlICcke3Byb2ZpbGVOYW1lfScgYCArXG4gICAgICAgICAgICAgICAgICAgICAgYGFuZCBkZXZpY2UgJHt0aGlzLm9wdHMuZGV2aWNlLnVkaWR9LiBgICtcbiAgICAgICAgICAgICAgICAgICAgICBgTWFrZSBzdXJlIHRoZSBwcm9maWxlIGlzIHN1cHBvcnRlZCBvbiB0aGlzIGRldmljZS4gYCArXG4gICAgICAgICAgICAgICAgICAgICAgYFlvdSBjYW4gdXNlICdpbnN0cnVtZW50cyAtcycgY29tbWFuZCB0byBzZWUgdGhlIGxpc3Qgb2YgYWxsIGF2YWlsYWJsZSBwcm9maWxlcy5gKTtcbiAgfVxuXG4gIGNvbnN0IHppcFBhdGggPSBgJHtsb2NhbFBhdGh9LnppcGA7XG4gIGNvbnN0IHppcEFyZ3MgPSBbXG4gICAgJy05JywgJy1yJywgemlwUGF0aCxcbiAgICBwYXRoLmJhc2VuYW1lKGxvY2FsUGF0aCksXG4gIF07XG4gIGxvZy5pbmZvKGBGb3VuZCBwZXJmIHRyYWNlIHJlY29yZCAnJHtsb2NhbFBhdGh9Jy4gQ29tcHJlc3NpbmcgaXQgd2l0aCAnemlwICR7emlwQXJncy5qb2luKCcgJyl9J2ApO1xuICB0cnkge1xuICAgIGF3YWl0IGV4ZWMoJ3ppcCcsIHppcEFyZ3MsIHtcbiAgICAgIGN3ZDogcGF0aC5kaXJuYW1lKGxvY2FsUGF0aCksXG4gICAgfSk7XG4gICAgcmV0dXJuIGF3YWl0IHVwbG9hZFRyYWNlKHppcFBhdGgsIHJlbW90ZVBhdGgsIHt1c2VyLCBwYXNzLCBtZXRob2R9KTtcbiAgfSBmaW5hbGx5IHtcbiAgICBkZWxldGUgcnVubmluZ1JlY29yZGVyc1t0aGlzLm9wdHMuZGV2aWNlLnVkaWRdO1xuICAgIGlmIChhd2FpdCBmcy5leGlzdHMobG9jYWxQYXRoKSkge1xuICAgICAgYXdhaXQgZnMucmltcmFmKGxvY2FsUGF0aCk7XG4gICAgfVxuICB9XG59O1xuXG5cbmV4cG9ydCB7IGNvbW1hbmRzIH07XG5leHBvcnQgZGVmYXVsdCBjb21tYW5kcztcbiJdLCJmaWxlIjoibGliL2NvbW1hbmRzL3BlcmZvcm1hbmNlLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
