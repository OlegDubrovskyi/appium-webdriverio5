"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _appiumBaseDriver = require("appium-base-driver");

var _appiumIosDriver = require("appium-ios-driver");

var _iosCrashLog = require("../device-log/ios-crash-log");

var _iosSimulatorLog = require("../device-log/ios-simulator-log");

var _iosDeviceLog = require("../device-log/ios-device-log");

var _logger = _interopRequireDefault(require("../logger"));

var _ws = _interopRequireDefault(require("ws"));

var _safariConsoleLog = _interopRequireDefault(require("../device-log/safari-console-log"));

var _safariNetworkLog = _interopRequireDefault(require("../device-log/safari-network-log"));

let extensions = {};

const WEBSOCKET_ENDPOINT = sessionId => `${_appiumBaseDriver.DEFAULT_WS_PATHNAME_PREFIX}/session/${sessionId}/appium/device/syslog`;

Object.assign(extensions, _appiumIosDriver.iosCommands.logging);
extensions.supportedLogTypes.safariConsole = {
  description: 'Safari Console Logs - data written to the JS console in Safari',
  getter: async self => await self.extractLogs('safariConsole', self.logs)
};
extensions.supportedLogTypes.safariNetwork = {
  description: 'Safari Network Logs - information about network operations undertaken by Safari',
  getter: async self => await self.extractLogs('safariNetwork', self.logs)
};

extensions.startLogCapture = async function startLogCapture() {
  this.logs = this.logs || {};

  if (!_lodash.default.isUndefined(this.logs.syslog) && this.logs.syslog.isCapturing) {
    _logger.default.warn('Trying to start iOS log capture but it has already started!');

    return true;
  }

  if (_lodash.default.isUndefined(this.logs.syslog)) {
    this.logs.crashlog = new _iosCrashLog.IOSCrashLog({
      sim: this.opts.device,
      udid: this.isRealDevice() ? this.opts.udid : undefined
    });

    if (this.isRealDevice()) {
      this.logs.syslog = new _iosDeviceLog.IOSDeviceLog({
        udid: this.opts.udid,
        showLogs: this.opts.showIOSLog
      });
    } else {
      this.logs.syslog = new _iosSimulatorLog.IOSSimulatorLog({
        sim: this.opts.device,
        showLogs: this.opts.showIOSLog,
        xcodeVersion: this.xcodeVersion
      });
    }

    this.logs.safariConsole = new _safariConsoleLog.default(!!this.opts.showSafariConsoleLog);
    this.logs.safariNetwork = new _safariNetworkLog.default(!!this.opts.showSafariNetworkLog);
  }

  try {
    await this.logs.syslog.startCapture();
  } catch (err) {
    _logger.default.warn(`Continuing without capturing device logs: ${err.message}`);

    return false;
  }

  await this.logs.crashlog.startCapture();
  await this.logs.safariConsole.startCapture();
  await this.logs.safariNetwork.startCapture();
  return true;
};

extensions.mobileStartLogsBroadcast = async function mobileStartLogsBroadcast() {
  const pathname = WEBSOCKET_ENDPOINT(this.sessionId);

  if (!_lodash.default.isEmpty((await this.server.getWebSocketHandlers(pathname)))) {
    _logger.default.debug(`The system logs broadcasting web socket server is already listening at ${pathname}`);

    return;
  }

  _logger.default.info(`Assigning system logs broadcasting web socket server to ${pathname}`);

  const wss = new _ws.default.Server({
    noServer: true
  });
  wss.on('connection', (ws, req) => {
    if (req) {
      const remoteIp = _lodash.default.isEmpty(req.headers['x-forwarded-for']) ? req.connection.remoteAddress : req.headers['x-forwarded-for'];

      _logger.default.debug(`Established a new system logs listener web socket connection from ${remoteIp}`);
    } else {
      _logger.default.debug('Established a new system logs listener web socket connection');
    }

    if (_lodash.default.isEmpty(this._syslogWebsocketListener)) {
      this._syslogWebsocketListener = logRecord => {
        if (ws && ws.readyState === _ws.default.OPEN) {
          ws.send(logRecord.message);
        }
      };
    }

    this.logs.syslog.on('output', this._syslogWebsocketListener);
    ws.on('close', (code, reason) => {
      if (!_lodash.default.isEmpty(this._syslogWebsocketListener)) {
        this.logs.syslog.removeListener('output', this._syslogWebsocketListener);
        this._syslogWebsocketListener = null;
      }

      let closeMsg = 'System logs listener web socket is closed.';

      if (!_lodash.default.isEmpty(code)) {
        closeMsg += ` Code: ${code}.`;
      }

      if (!_lodash.default.isEmpty(reason)) {
        closeMsg += ` Reason: ${reason}.`;
      }

      _logger.default.debug(closeMsg);
    });
  });
  await this.server.addWebSocketHandler(pathname, wss);
};

extensions.mobileStopLogsBroadcast = async function mobileStopLogsBroadcast() {
  const pathname = WEBSOCKET_ENDPOINT(this.sessionId);

  if (_lodash.default.isEmpty((await this.server.getWebSocketHandlers(pathname)))) {
    return;
  }

  _logger.default.debug('Stopping the system logs broadcasting web socket server');

  await this.server.removeWebSocketHandler(pathname);
};

var _default = extensions;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9sb2cuanMiXSwibmFtZXMiOlsiZXh0ZW5zaW9ucyIsIldFQlNPQ0tFVF9FTkRQT0lOVCIsInNlc3Npb25JZCIsIkRFRkFVTFRfV1NfUEFUSE5BTUVfUFJFRklYIiwiT2JqZWN0IiwiYXNzaWduIiwiaW9zQ29tbWFuZHMiLCJsb2dnaW5nIiwic3VwcG9ydGVkTG9nVHlwZXMiLCJzYWZhcmlDb25zb2xlIiwiZGVzY3JpcHRpb24iLCJnZXR0ZXIiLCJzZWxmIiwiZXh0cmFjdExvZ3MiLCJsb2dzIiwic2FmYXJpTmV0d29yayIsInN0YXJ0TG9nQ2FwdHVyZSIsIl8iLCJpc1VuZGVmaW5lZCIsInN5c2xvZyIsImlzQ2FwdHVyaW5nIiwibG9nIiwid2FybiIsImNyYXNobG9nIiwiSU9TQ3Jhc2hMb2ciLCJzaW0iLCJvcHRzIiwiZGV2aWNlIiwidWRpZCIsImlzUmVhbERldmljZSIsInVuZGVmaW5lZCIsIklPU0RldmljZUxvZyIsInNob3dMb2dzIiwic2hvd0lPU0xvZyIsIklPU1NpbXVsYXRvckxvZyIsInhjb2RlVmVyc2lvbiIsIlNhZmFyaUNvbnNvbGVMb2ciLCJzaG93U2FmYXJpQ29uc29sZUxvZyIsIlNhZmFyaU5ldHdvcmtMb2ciLCJzaG93U2FmYXJpTmV0d29ya0xvZyIsInN0YXJ0Q2FwdHVyZSIsImVyciIsIm1lc3NhZ2UiLCJtb2JpbGVTdGFydExvZ3NCcm9hZGNhc3QiLCJwYXRobmFtZSIsImlzRW1wdHkiLCJzZXJ2ZXIiLCJnZXRXZWJTb2NrZXRIYW5kbGVycyIsImRlYnVnIiwiaW5mbyIsIndzcyIsIldlYlNvY2tldCIsIlNlcnZlciIsIm5vU2VydmVyIiwib24iLCJ3cyIsInJlcSIsInJlbW90ZUlwIiwiaGVhZGVycyIsImNvbm5lY3Rpb24iLCJyZW1vdGVBZGRyZXNzIiwiX3N5c2xvZ1dlYnNvY2tldExpc3RlbmVyIiwibG9nUmVjb3JkIiwicmVhZHlTdGF0ZSIsIk9QRU4iLCJzZW5kIiwiY29kZSIsInJlYXNvbiIsInJlbW92ZUxpc3RlbmVyIiwiY2xvc2VNc2ciLCJhZGRXZWJTb2NrZXRIYW5kbGVyIiwibW9iaWxlU3RvcExvZ3NCcm9hZGNhc3QiLCJyZW1vdmVXZWJTb2NrZXRIYW5kbGVyIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUdBLElBQUlBLFVBQVUsR0FBRyxFQUFqQjs7QUFFQSxNQUFNQyxrQkFBa0IsR0FBSUMsU0FBRCxJQUFnQixHQUFFQyw0Q0FBMkIsWUFBV0QsU0FBVSx1QkFBN0Y7O0FBRUFFLE1BQU0sQ0FBQ0MsTUFBUCxDQUFjTCxVQUFkLEVBQTBCTSw2QkFBWUMsT0FBdEM7QUFFQVAsVUFBVSxDQUFDUSxpQkFBWCxDQUE2QkMsYUFBN0IsR0FBNkM7QUFDM0NDLEVBQUFBLFdBQVcsRUFBRSxnRUFEOEI7QUFFM0NDLEVBQUFBLE1BQU0sRUFBRSxNQUFPQyxJQUFQLElBQWdCLE1BQU1BLElBQUksQ0FBQ0MsV0FBTCxDQUFpQixlQUFqQixFQUFrQ0QsSUFBSSxDQUFDRSxJQUF2QztBQUZhLENBQTdDO0FBS0FkLFVBQVUsQ0FBQ1EsaUJBQVgsQ0FBNkJPLGFBQTdCLEdBQTZDO0FBQzNDTCxFQUFBQSxXQUFXLEVBQUUsaUZBRDhCO0FBRTNDQyxFQUFBQSxNQUFNLEVBQUUsTUFBT0MsSUFBUCxJQUFnQixNQUFNQSxJQUFJLENBQUNDLFdBQUwsQ0FBaUIsZUFBakIsRUFBa0NELElBQUksQ0FBQ0UsSUFBdkM7QUFGYSxDQUE3Qzs7QUFLQWQsVUFBVSxDQUFDZ0IsZUFBWCxHQUE2QixlQUFlQSxlQUFmLEdBQWtDO0FBQzdELE9BQUtGLElBQUwsR0FBWSxLQUFLQSxJQUFMLElBQWEsRUFBekI7O0FBQ0EsTUFBSSxDQUFDRyxnQkFBRUMsV0FBRixDQUFjLEtBQUtKLElBQUwsQ0FBVUssTUFBeEIsQ0FBRCxJQUFvQyxLQUFLTCxJQUFMLENBQVVLLE1BQVYsQ0FBaUJDLFdBQXpELEVBQXNFO0FBQ3BFQyxv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RixNQUFPLEdBQS9CO0FBQ0Q7O0FBQ0Q5QyxzQkFBSTJCLEtBQUosQ0FBVXFCLFFBQVY7QUFDRCxLQWREO0FBZUQsR0FsQ0Q7QUFtQ0EsUUFBTSxLQUFLdkIsTUFBTCxDQUFZd0IsbUJBQVosQ0FBZ0MxQixRQUFoQyxFQUEwQ00sR0FBMUMsQ0FBTjtBQUNELENBaEREOztBQXNEQWxELFVBQVUsQ0FBQ3VFLHVCQUFYLEdBQXFDLGVBQWVBLHVCQUFmLEdBQTBDO0FBQzdFLFFBQU0zQixRQUFRLEdBQUczQyxrQkFBa0IsQ0FBQyxLQUFLQyxTQUFOLENBQW5DOztBQUNBLE1BQUllLGdCQUFFNEIsT0FBRixFQUFVLE1BQU0sS0FBS0MsTUFBTCxDQUFZQyxvQkFBWixDQUFpQ0gsUUFBakMsQ0FBaEIsRUFBSixFQUFpRTtBQUMvRDtBQUNEOztBQUVEdkIsa0JBQUkyQixLQUFKLENBQVUseURBQVY7O0FBQ0EsUUFBTSxLQUFLRixNQUFMLENBQVkwQixzQkFBWixDQUFtQzVCLFFBQW5DLENBQU47QUFDRCxDQVJEOztlQVdlNUMsVSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyBERUZBVUxUX1dTX1BBVEhOQU1FX1BSRUZJWCB9IGZyb20gJ2FwcGl1bS1iYXNlLWRyaXZlcic7XG5pbXBvcnQgeyBpb3NDb21tYW5kcyB9IGZyb20gJ2FwcGl1bS1pb3MtZHJpdmVyJztcbmltcG9ydCB7IElPU0NyYXNoTG9nIH0gZnJvbSAnLi4vZGV2aWNlLWxvZy9pb3MtY3Jhc2gtbG9nJztcbmltcG9ydCB7IElPU1NpbXVsYXRvckxvZyB9IGZyb20gJy4uL2RldmljZS1sb2cvaW9zLXNpbXVsYXRvci1sb2cnO1xuaW1wb3J0IHsgSU9TRGV2aWNlTG9nIH0gZnJvbSAnLi4vZGV2aWNlLWxvZy9pb3MtZGV2aWNlLWxvZyc7XG5pbXBvcnQgbG9nIGZyb20gJy4uL2xvZ2dlcic7XG5pbXBvcnQgV2ViU29ja2V0IGZyb20gJ3dzJztcbmltcG9ydCBTYWZhcmlDb25zb2xlTG9nIGZyb20gJy4uL2RldmljZS1sb2cvc2FmYXJpLWNvbnNvbGUtbG9nJztcbmltcG9ydCBTYWZhcmlOZXR3b3JrTG9nIGZyb20gJy4uL2RldmljZS1sb2cvc2FmYXJpLW5ldHdvcmstbG9nJztcblxuXG5sZXQgZXh0ZW5zaW9ucyA9IHt9O1xuXG5jb25zdCBXRUJTT0NLRVRfRU5EUE9JTlQgPSAoc2Vzc2lvbklkKSA9PiBgJHtERUZBVUxUX1dTX1BBVEhOQU1FX1BSRUZJWH0vc2Vzc2lvbi8ke3Nlc3Npb25JZH0vYXBwaXVtL2RldmljZS9zeXNsb2dgO1xuXG5PYmplY3QuYXNzaWduKGV4dGVuc2lvbnMsIGlvc0NvbW1hbmRzLmxvZ2dpbmcpO1xuXG5leHRlbnNpb25zLnN1cHBvcnRlZExvZ1R5cGVzLnNhZmFyaUNvbnNvbGUgPSB7XG4gIGRlc2NyaXB0aW9uOiAnU2FmYXJpIENvbnNvbGUgTG9ncyAtIGRhdGEgd3JpdHRlbiB0byB0aGUgSlMgY29uc29sZSBpbiBTYWZhcmknLFxuICBnZXR0ZXI6IGFzeW5jIChzZWxmKSA9PiBhd2FpdCBzZWxmLmV4dHJhY3RMb2dzKCdzYWZhcmlDb25zb2xlJywgc2VsZi5sb2dzKSxcbn07XG5cbmV4dGVuc2lvbnMuc3VwcG9ydGVkTG9nVHlwZXMuc2FmYXJpTmV0d29yayA9IHtcbiAgZGVzY3JpcHRpb246ICdTYWZhcmkgTmV0d29yayBMb2dzIC0gaW5mb3JtYXRpb24gYWJvdXQgbmV0d29yayBvcGVyYXRpb25zIHVuZGVydGFrZW4gYnkgU2FmYXJpJyxcbiAgZ2V0dGVyOiBhc3luYyAoc2VsZikgPT4gYXdhaXQgc2VsZi5leHRyYWN0TG9ncygnc2FmYXJpTmV0d29yaycsIHNlbGYubG9ncyksXG59O1xuXG5leHRlbnNpb25zLnN0YXJ0TG9nQ2FwdHVyZSA9IGFzeW5jIGZ1bmN0aW9uIHN0YXJ0TG9nQ2FwdHVyZSAoKSB7XG4gIHRoaXMubG9ncyA9IHRoaXMubG9ncyB8fCB7fTtcbiAgaWYgKCFfLmlzVW5kZWZpbmVkKHRoaXMubG9ncy5zeXNsb2cpICYmIHRoaXMubG9ncy5zeXNsb2cuaXNDYXB0dXJpbmcpIHtcbiAgICBsb2cud2FybignVHJ5aW5nIHRvIHN0YXJ0IGlPUyBsb2cgY2FwdHVyZSBidXQgaXQgaGFzIGFscmVhZHkgc3RhcnRlZCEnKTtcbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuICBpZiAoXy5pc1VuZGVmaW5lZCh0aGlzLmxvZ3Muc3lzbG9nKSkge1xuICAgIHRoaXMubG9ncy5jcmFzaGxvZyA9IG5ldyBJT1NDcmFzaExvZyh7XG4gICAgICBzaW06IHRoaXMub3B0cy5kZXZpY2UsXG4gICAgICB1ZGlkOiB0aGlzLmlzUmVhbERldmljZSgpID8gdGhpcy5vcHRzLnVkaWQgOiB1bmRlZmluZWQsXG4gICAgfSk7XG5cbiAgICBpZiAodGhpcy5pc1JlYWxEZXZpY2UoKSkge1xuICAgICAgdGhpcy5sb2dzLnN5c2xvZyA9IG5ldyBJT1NEZXZpY2VMb2coe1xuICAgICAgICB1ZGlkOiB0aGlzLm9wdHMudWRpZCxcbiAgICAgICAgc2hvd0xvZ3M6IHRoaXMub3B0cy5zaG93SU9TTG9nLFxuICAgICAgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMubG9ncy5zeXNsb2cgPSBuZXcgSU9TU2ltdWxhdG9yTG9nKHtcbiAgICAgICAgc2ltOiB0aGlzLm9wdHMuZGV2aWNlLFxuICAgICAgICBzaG93TG9nczogdGhpcy5vcHRzLnNob3dJT1NMb2csXG4gICAgICAgIHhjb2RlVmVyc2lvbjogdGhpcy54Y29kZVZlcnNpb24sXG4gICAgICB9KTtcbiAgICB9XG4gICAgdGhpcy5sb2dzLnNhZmFyaUNvbnNvbGUgPSBuZXcgU2FmYXJpQ29uc29sZUxvZyghIXRoaXMub3B0cy5zaG93U2FmYXJpQ29uc29sZUxvZyk7XG4gICAgdGhpcy5sb2dzLnNhZmFyaU5ldHdvcmsgPSBuZXcgU2FmYXJpTmV0d29ya0xvZyghIXRoaXMub3B0cy5zaG93U2FmYXJpTmV0d29ya0xvZyk7XG4gIH1cbiAgdHJ5IHtcbiAgICBhd2FpdCB0aGlzLmxvZ3Muc3lzbG9nLnN0YXJ0Q2FwdHVyZSgpO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBsb2cud2FybihgQ29udGludWluZyB3aXRob3V0IGNhcHR1cmluZyBkZXZpY2UgbG9nczogJHtlcnIubWVzc2FnZX1gKTtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cbiAgYXdhaXQgdGhpcy5sb2dzLmNyYXNobG9nLnN0YXJ0Q2FwdHVyZSgpO1xuICBhd2FpdCB0aGlzLmxvZ3Muc2FmYXJpQ29uc29sZS5zdGFydENhcHR1cmUoKTtcbiAgYXdhaXQgdGhpcy5sb2dzLnNhZmFyaU5ldHdvcmsuc3RhcnRDYXB0dXJlKCk7XG5cbiAgcmV0dXJuIHRydWU7XG59O1xuXG4vKipcbiAqIFN0YXJ0cyBpT1Mgc3lzdGVtIGxvZ3MgYnJvYWRjYXN0IHdlYnNvY2tldCBvbiB0aGUgc2FtZSBob3N0IGFuZCBwb3J0XG4gKiB3aGVyZSBBcHBpdW0gc2VydmVyIGlzIHJ1bm5pbmcgYXQgYC93cy9zZXNzaW9uLzpzZXNzaW9uSWQ6L2FwcGl1bS9zeXNsb2dgIGVuZHBvaW50LiBUaGUgbWV0aG9kXG4gKiB3aWxsIHJldHVybiBpbW1lZGlhdGVseSBpZiB0aGUgd2ViIHNvY2tldCBpcyBhbHJlYWR5IGxpc3RlbmluZy5cbiAqXG4gKiBFYWNoIGNvbm5lY3RlZCB3ZWJjb2tldCBsaXN0ZW5lciB3aWxsIHJlY2VpdmUgc3lzbG9nIGxpbmVzXG4gKiBhcyBzb29uIGFzIHRoZXkgYXJlIHZpc2libGUgdG8gQXBwaXVtLlxuICovXG5leHRlbnNpb25zLm1vYmlsZVN0YXJ0TG9nc0Jyb2FkY2FzdCA9IGFzeW5jIGZ1bmN0aW9uIG1vYmlsZVN0YXJ0TG9nc0Jyb2FkY2FzdCAoKSB7XG4gIGNvbnN0IHBhdGhuYW1lID0gV0VCU09DS0VUX0VORFBPSU5UKHRoaXMuc2Vzc2lvbklkKTtcbiAgaWYgKCFfLmlzRW1wdHkoYXdhaXQgdGhpcy5zZXJ2ZXIuZ2V0V2ViU29ja2V0SGFuZGxlcnMocGF0aG5hbWUpKSkge1xuICAgIGxvZy5kZWJ1ZyhgVGhlIHN5c3RlbSBsb2dzIGJyb2FkY2FzdGluZyB3ZWIgc29ja2V0IHNlcnZlciBpcyBhbHJlYWR5IGxpc3RlbmluZyBhdCAke3BhdGhuYW1lfWApO1xuICAgIHJldHVybjtcbiAgfVxuXG4gIGxvZy5pbmZvKGBBc3NpZ25pbmcgc3lzdGVtIGxvZ3MgYnJvYWRjYXN0aW5nIHdlYiBzb2NrZXQgc2VydmVyIHRvICR7cGF0aG5hbWV9YCk7XG4gIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS93ZWJzb2NrZXRzL3dzL2Jsb2IvbWFzdGVyL2RvYy93cy5tZFxuICBjb25zdCB3c3MgPSBuZXcgV2ViU29ja2V0LlNlcnZlcih7XG4gICAgbm9TZXJ2ZXI6IHRydWUsXG4gIH0pO1xuICB3c3Mub24oJ2Nvbm5lY3Rpb24nLCAod3MsIHJlcSkgPT4ge1xuICAgIGlmIChyZXEpIHtcbiAgICAgIGNvbnN0IHJlbW90ZUlwID0gXy5pc0VtcHR5KHJlcS5oZWFkZXJzWyd4LWZvcndhcmRlZC1mb3InXSlcbiAgICAgICAgPyByZXEuY29ubmVjdGlvbi5yZW1vdGVBZGRyZXNzXG4gICAgICAgIDogcmVxLmhlYWRlcnNbJ3gtZm9yd2FyZGVkLWZvciddO1xuICAgICAgbG9nLmRlYnVnKGBFc3RhYmxpc2hlZCBhIG5ldyBzeXN0ZW0gbG9ncyBsaXN0ZW5lciB3ZWIgc29ja2V0IGNvbm5lY3Rpb24gZnJvbSAke3JlbW90ZUlwfWApO1xuICAgIH0gZWxzZSB7XG4gICAgICBsb2cuZGVidWcoJ0VzdGFibGlzaGVkIGEgbmV3IHN5c3RlbSBsb2dzIGxpc3RlbmVyIHdlYiBzb2NrZXQgY29ubmVjdGlvbicpO1xuICAgIH1cblxuICAgIGlmIChfLmlzRW1wdHkodGhpcy5fc3lzbG9nV2Vic29ja2V0TGlzdGVuZXIpKSB7XG4gICAgICB0aGlzLl9zeXNsb2dXZWJzb2NrZXRMaXN0ZW5lciA9IChsb2dSZWNvcmQpID0+IHtcbiAgICAgICAgaWYgKHdzICYmIHdzLnJlYWR5U3RhdGUgPT09IFdlYlNvY2tldC5PUEVOKSB7XG4gICAgICAgICAgd3Muc2VuZChsb2dSZWNvcmQubWVzc2FnZSk7XG4gICAgICAgIH1cbiAgICAgIH07XG4gICAgfVxuICAgIHRoaXMubG9ncy5zeXNsb2cub24oJ291dHB1dCcsIHRoaXMuX3N5c2xvZ1dlYnNvY2tldExpc3RlbmVyKTtcblxuICAgIHdzLm9uKCdjbG9zZScsIChjb2RlLCByZWFzb24pID0+IHtcbiAgICAgIGlmICghXy5pc0VtcHR5KHRoaXMuX3N5c2xvZ1dlYnNvY2tldExpc3RlbmVyKSkge1xuICAgICAgICB0aGlzLmxvZ3Muc3lzbG9nLnJlbW92ZUxpc3RlbmVyKCdvdXRwdXQnLCB0aGlzLl9zeXNsb2dXZWJzb2NrZXRMaXN0ZW5lcik7XG4gICAgICAgIHRoaXMuX3N5c2xvZ1dlYnNvY2tldExpc3RlbmVyID0gbnVsbDtcbiAgICAgIH1cblxuICAgICAgbGV0IGNsb3NlTXNnID0gJ1N5c3RlbSBsb2dzIGxpc3RlbmVyIHdlYiBzb2NrZXQgaXMgY2xvc2VkLic7XG4gICAgICBpZiAoIV8uaXNFbXB0eShjb2RlKSkge1xuICAgICAgICBjbG9zZU1zZyArPSBgIENvZGU6ICR7Y29kZX0uYDtcbiAgICAgIH1cbiAgICAgIGlmICghXy5pc0VtcHR5KHJlYXNvbikpIHtcbiAgICAgICAgY2xvc2VNc2cgKz0gYCBSZWFzb246ICR7cmVhc29ufS5gO1xuICAgICAgfVxuICAgICAgbG9nLmRlYnVnKGNsb3NlTXNnKTtcbiAgICB9KTtcbiAgfSk7XG4gIGF3YWl0IHRoaXMuc2VydmVyLmFkZFdlYlNvY2tldEhhbmRsZXIocGF0aG5hbWUsIHdzcyk7XG59O1xuXG4vKipcbiAqIFN0b3BzIHRoZSBwcmV2aW91c2x5IHN0YXJ0ZWQgc3lzbG9nIGJyb2FkY2FzdGluZyB3ZXNvY2tldCBzZXJ2ZXIuXG4gKiBUaGlzIG1ldGhvZCB3aWxsIHJldHVybiBpbW1lZGlhdGVseSBpZiBubyBzZXJ2ZXIgaXMgcnVubmluZy5cbiAqL1xuZXh0ZW5zaW9ucy5tb2JpbGVTdG9wTG9nc0Jyb2FkY2FzdCA9IGFzeW5jIGZ1bmN0aW9uIG1vYmlsZVN0b3BMb2dzQnJvYWRjYXN0ICgpIHtcbiAgY29uc3QgcGF0aG5hbWUgPSBXRUJTT0NLRVRfRU5EUE9JTlQodGhpcy5zZXNzaW9uSWQpO1xuICBpZiAoXy5pc0VtcHR5KGF3YWl0IHRoaXMuc2VydmVyLmdldFdlYlNvY2tldEhhbmRsZXJzKHBhdGhuYW1lKSkpIHtcbiAgICByZXR1cm47XG4gIH1cblxuICBsb2cuZGVidWcoJ1N0b3BwaW5nIHRoZSBzeXN0ZW0gbG9ncyBicm9hZGNhc3Rpbmcgd2ViIHNvY2tldCBzZXJ2ZXInKTtcbiAgYXdhaXQgdGhpcy5zZXJ2ZXIucmVtb3ZlV2ViU29ja2V0SGFuZGxlcihwYXRobmFtZSk7XG59O1xuXG5cbmV4cG9ydCBkZWZhdWx0IGV4dGVuc2lvbnM7XG4iXSwiZmlsZSI6ImxpYi9jb21tYW5kcy9sb2cuanMiLCJzb3VyY2VSb290IjoiLi4vLi4vLi4ifQ==
