"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.commands = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _appiumSupport = require("appium-support");

var _teen_process = require("teen_process");

var _logger = _interopRequireDefault(require("../logger"));

var _utils = require("../utils");

var _iproxy = _interopRequireDefault(require("../wda/iproxy"));

var _webdriveragent = require("../wda/webdriveragent");

var _asyncbox = require("asyncbox");

var _url = _interopRequireDefault(require("url"));

let commands = {};
exports.commands = commands;
const MAX_RECORDING_TIME_SEC = 60 * 30;
const DEFAULT_RECORDING_TIME_SEC = 60 * 3;
const DEFAULT_MJPEG_SERVER_PORT = 9100;
const DEFAULT_FPS = 10;
const DEFAULT_QUALITY = 'medium';
const DEFAULT_VCODEC = 'mjpeg';
const MP4_EXT = '.mp4';
const FFMPEG_BINARY = 'ffmpeg';

const ffmpegLogger = _appiumSupport.logger.getLogger(FFMPEG_BINARY);

const QUALITY_MAPPING = {
  low: 10,
  medium: 25,
  high: 75,
  photo: 100
};

class ScreenRecorder {
  constructor(udid, videoPath, opts = {}) {
    this.videoPath = videoPath;
    this.opts = opts;
    this.udid = udid;
    this.mainProcess = null;
    this.iproxy = null;
    this.timeoutHandler = null;
  }

  async start(timeoutMs) {
    try {
      await _appiumSupport.fs.which(FFMPEG_BINARY);
    } catch (err) {
      throw new Error(`'${FFMPEG_BINARY}' binary is not found in PATH. Install it using 'brew install ffmpeg'. ` + `Check https://www.ffmpeg.org/download.html for more details.`);
    }

    const {
      remotePort,
      remoteUrl,
      usePortForwarding,
      videoFps,
      videoType,
      videoScale,
      videoFilters,
      pixelFormat
    } = this.opts;

    if (usePortForwarding) {
      this.startIproxy(remotePort);
    }

    const args = ['-f', 'mjpeg'];

    if (videoFps && videoType === 'libx264') {
      args.push('-r', videoFps);
    }

    const {
      protocol,
      hostname
    } = _url.default.parse(remoteUrl);

    args.push('-i', `${protocol}//${hostname}:${remotePort}`);

    if (videoFilters || videoScale) {
      args.push('-vf', videoFilters || `scale=${videoScale}`);
    }

    if (pixelFormat) {
      args.push('-pix_fmt', pixelFormat);
    }

    args.push('-vcodec', videoType, '-y', this.videoPath);
    this.mainProcess = new _teen_process.SubProcess(FFMPEG_BINARY, args);
    let isCaptureStarted = false;
    this.mainProcess.on('output', (stdout, stderr) => {
      if (stderr) {
        if (stderr.trim().startsWith('frame=')) {
          if (!isCaptureStarted) {
            isCaptureStarted = true;
          }
        } else {
          ffmpegLogger.info(`${stderr}`);
        }
      }
    });
    await this.mainProcess.start(0);
    const startupTimeout = 5000;

    try {
      await (0, _asyncbox.waitForCondition)(() => isCaptureStarted, {
        waitMs: startupTimeout,
        intervalMs: 300
      });
    } catch (e) {
      _logger.default.warn(`Screen capture process did not start within ${startupTimeout}ms. Continuing anyway`);
    }

    if (!this.mainProcess.isRunning) {
      throw new Error(`The screen capture process '${FFMPEG_BINARY}' died unexpectedly. ` + `Check server logs for more details`);
    }

    _logger.default.info(`Starting screen capture on the device '${this.udid}' with command: '${FFMPEG_BINARY} ${args.join(' ')}'. ` + `Will timeout in ${timeoutMs}ms`);

    this.timeoutHandler = setTimeout(async () => {
      if (!(await this.interrupt())) {
        _logger.default.warn(`Cannot finish the active screen recording on the device '${this.udid}' after ${timeoutMs}ms timeout`);
      }
    }, timeoutMs);
  }

  startIproxy(localPort) {
    this.iproxy = new _iproxy.default(this.udid, localPort, this.opts.remotePort);

    try {
      this.iproxy.start();
    } catch (err) {
      _logger.default.warn(`Cannot start iproxy. Assuming it is already forwarding the remote port ${this.opts.remotePort} to ${localPort} ` + `for the device ${this.udid}. Set the custom value to 'mjpegServerPort' capability if this is an undesired behavior. ` + `Original error: ${err.message}`);

      this.iproxy = null;
    }
  }

  stopIproxy() {
    if (!this.iproxy) {
      return;
    }

    this.iproxy.quit();
    this.iproxy = null;
  }

  async interrupt(force = false) {
    let result = true;

    if (this.timeoutHandler) {
      clearTimeout(this.timeoutHandler);
      this.timeoutHandler = null;
    }

    if (this.mainProcess && this.mainProcess.isRunning) {
      const interruptPromise = this.mainProcess.stop(force ? 'SIGTERM' : 'SIGINT');
      this.mainProcess = null;

      try {
        await interruptPromise;
      } catch (e) {
        _logger.default.warn(`Cannot ${force ? 'terminate' : 'interrupt'} ${FFMPEG_BINARY}. ` + `Original error: ${e.message}`);

        result = false;
      }
    }

    if (this.opts.usePortForwarding) {
      this.stopIproxy();
    }

    return result;
  }

  async finish() {
    await this.interrupt();
    return this.videoPath;
  }

  async cleanup() {
    if (await _appiumSupport.fs.exists(this.videoPath)) {
      await _appiumSupport.fs.rimraf(this.videoPath);
    }
  }

}

commands.startRecordingScreen = async function startRecordingScreen(options = {}) {
  const {
    videoType = DEFAULT_VCODEC,
    timeLimit = DEFAULT_RECORDING_TIME_SEC,
    videoQuality = DEFAULT_QUALITY,
    videoFps = DEFAULT_FPS,
    videoFilters,
    videoScale,
    forceRestart
  } = options;
  let result = '';

  if (!forceRestart) {
    _logger.default.info(`Checking if there is/was a previous screen recording. ` + `Set 'forceRestart' option to 'true' if you'd like to skip this step.`);

    result = await this.stopRecordingScreen(options);
  }

  const videoPath = await _appiumSupport.tempDir.path({
    prefix: `appium_${Math.random().toString(16).substring(2, 8)}`,
    suffix: MP4_EXT
  });
  const wdaBaseUrl = this.opts.wdaBaseUrl || _webdriveragent.WDA_BASE_URL;
  const screenRecorder = new ScreenRecorder(this.opts.device.udid, videoPath, {
    remotePort: this.opts.mjpegServerPort || DEFAULT_MJPEG_SERVER_PORT,
    remoteUrl: wdaBaseUrl,
    usePortForwarding: this.isRealDevice() && (0, _utils.isLocalHost)(wdaBaseUrl),
    videoType,
    videoFilters,
    videoScale,
    videoFps
  });

  if (!(await screenRecorder.interrupt(true))) {
    _logger.default.errorAndThrow('Unable to stop screen recording process');
  }

  if (this._recentScreenRecorder) {
    await this._recentScreenRecorder.cleanup();
    this._recentScreenRecorder = null;
  }

  const timeoutSeconds = parseFloat(timeLimit);

  if (isNaN(timeoutSeconds) || timeoutSeconds > MAX_RECORDING_TIME_SEC || timeoutSeconds <= 0) {
    _logger.default.errorAndThrow(`The timeLimit value must be in range [1, ${MAX_RECORDING_TIME_SEC}] seconds. ` + `The value of '${timeLimit}' has been passed instead.`);
  }

  let {
    mjpegServerScreenshotQuality,
    mjpegServerFramerate
  } = await this.proxyCommand('/appium/settings', 'GET');

  if (videoQuality) {
    const quality = _lodash.default.isInteger(videoQuality) ? videoQuality : QUALITY_MAPPING[_lodash.default.toLower(videoQuality)];

    if (!quality) {
      throw new Error(`videoQuality value should be one of ${JSON.stringify(_lodash.default.keys(QUALITY_MAPPING))} or a number in range 1..100. ` + `'${videoQuality}' is given instead`);
    }

    mjpegServerScreenshotQuality = mjpegServerScreenshotQuality !== quality ? quality : undefined;
  } else {
    mjpegServerScreenshotQuality = undefined;
  }

  if (videoFps) {
    const fps = parseInt(videoFps, 10);

    if (isNaN(fps)) {
      throw new Error(`videoFps value should be a valid number in range 1..60. ` + `'${videoFps}' is given instead`);
    }

    mjpegServerFramerate = mjpegServerFramerate !== fps ? fps : undefined;
  } else {
    mjpegServerFramerate = undefined;
  }

  if (_appiumSupport.util.hasValue(mjpegServerScreenshotQuality) || _appiumSupport.util.hasValue(mjpegServerFramerate)) {
    await this.proxyCommand('/appium/settings', 'POST', {
      settings: {
        mjpegServerScreenshotQuality,
        mjpegServerFramerate
      }
    });
  }

  try {
    await screenRecorder.start(timeoutSeconds * 1000);
  } catch (e) {
    await screenRecorder.interrupt(true);
    await screenRecorder.cleanup();
    throw e;
  }

  this._recentScreenRecorder = screenRecorder;
  return result;
};

commands.stopRecordingScreen = async function stopRecordingScreen(options = {}) {
  const {
    remotePath,
    user,
    pass,
    method
  } = options;

  if (!this._recentScreenRecorder) {
    _logger.default.info('Screen recording is not running. There is nothing to stop.');

    return '';
  }

  try {
    const videoPath = await this._recentScreenRecorder.finish();

    if (!(await _appiumSupport.fs.exists(videoPath))) {
      _logger.default.errorAndThrow(`The screen recorder utility has failed ` + `to store the actual screen recording at '${videoPath}'`);
    }

    return await (0, _utils.encodeBase64OrUpload)(videoPath, remotePath, {
      user,
      pass,
      method
    });
  } finally {
    await this._recentScreenRecorder.interrupt(true);
    await this._recentScreenRecorder.cleanup();
    this._recentScreenRecorder = null;
  }
};

var _default = commands;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9yZWNvcmRzY3JlZW4uanMiXSwibmFtZXMiOlsiY29tbWFuZHMiLCJNQVhfUkVDT1JESU5HX1RJTUVfU0VDIiwiREVGQVVMVF9SRUNPUkRJTkdfVElNRV9TRUMiLCJERUZBVUxUX01KUEVHX1NFUlZFUl9QT1JUIiwiREVGQVVMVF9GUFMiLCJERUZBVUxUX1FVQUxJVFkiLCJERUZBVUxUX1ZDT0RFQyIsIk1QNF9FWFQiLCJGRk1QRUdfQklOQVJZIiwiZmZtcGVnTG9nZ2VyIiwibG9nZ2VyIiwiZ2V0TG9nZ2VyIiwiUVVBTElUWV9NQVBQSU5HIiwibG93IiwibWVkaXVtIiwiaGlnaCIsInBob3RvIiwiU2NyZWVuUmVjb3JkZXIiLCJjb25zdHJ1Y3RvciIsInVkaWQiLCJ2aWRlb1BhdGgiLCJvcHRzIiwibWFpblByb2Nlc3MiLCJpcHJveHkiLCJ0aW1lb3V0SGFuZGxlciIsInN0YXJ0IiwidGltZW91dE1zIiwiZnMiLCJ3aGljaCIsImVyciIsIkVycm9yIiwicmVtb3RlUG9ydCIsInJlbW90ZVVybCIsInVzZVBvcnRGb3J3YXJkaW5nIiwidmlkZW9GcHMiLCJ2aWRlb1R5cGUiLCJ2aWRlb1NjYWxlIiwidmlkZW9GaWx0ZXJzIiwicGl4ZWxGb3JtYXQiLCJzdGFydElwcm94eSIsImFyZ3MiLCJwdXNoIiwicHJvdG9jb2wiLCJob3N0bmFtZSIsInVybCIsInBhcnNlIiwiU3ViUHJvY2VzcyIsImlzQ2FwdHVyZVN0YXJ0ZWQiLCJvbiIsInN0ZG91dCIsInN0ZGVyciIsInRyaW0iLCJzdGFydHNXaXRoIiwiaW5mbyIsInN0YXJ0dXBUaW1lb3V0Iiwid2FpdE1zIiwiaW50ZXJ2YWxNcyIsImUiLCJsb2ciLCJ3YXJuIiwiaXNSdW5uaW5nIiwiam9pbiIsInNldFRpbWVvdXQiLCJpbnRlcnJ1cHQiLCJsb2NhbFBvcnQiLCJpUHJveHkiLCJtZXNzYWdlIiwic3RvcElwcm94eSIsInF1aXQiLCJmb3JjZSIsInJlc3VsdCIsImNsZWFyVGltZW91dCIsImludGVycnVwdFByb21pc2UiLCJzdG9wIiwiZmluaXNoIiwiY2xlYW51cCIsImV4aXN0cyIsInJpbXJhZiIsInN0YXJ0UmVjb3JkaW5nU2NyZWVuIiwib3B0aW9ucyIsInRpbWVMaW1pdCIsInZpZGVvUXVhbGl0eSIsImZvcmNlUmVzdGFydCIsInN0b3BSZWNvcmRpbmdTY3JlZW4iLCJ0ZW1wRGlyIiwicGF0aCIsInByZWZpeCIsIk1hdGgiLCJyYW5kb20iLCJ0b1N0cmluZyIsInN1YnN0cmluZyIsInN1ZmZpeCIsIndkYUJhc2VVcmwiLCJXREFfQkFTRV9VUkwiLCJzY3JlZW5SZWNvcmRlciIsImRldmljZSIsIm1qcGVnU2VydmVyUG9ydCIsImlzUmVhbERldmljZSIsImVycm9yQW5kVGhyb3ciLCJfcmVjZW50U2NyZWVuUmVjb3JkZXIiLCJ0aW1lb3V0U2Vjb25kcyIsInBhcnNlRmxvYXQiLCJpc05hTiIsIm1qcGVnU2VydmVyU2NyZWVuc2hvdFF1YWxpdHkiLCJtanBlZ1NlcnZlckZyYW1lcmF0ZSIsInByb3h5Q29tbWFuZCIsInF1YWxpdHkiLCJfIiwiaXNJbnRlZ2VyIiwidG9Mb3dlciIsIkpTT04iLCJzdHJpbmdpZnkiLCJrZXlzIiwidW5kZWZpbmVkIiwiZnBzIiwicGFyc2VJbnQiLCJ1dGlsIiwiaGFzVmFsdWUiLCJzZXR0aW5ncyIsInJlbW90ZVBhdGgiLCJ1c2VyIiwicGFzcyIsIm1ldGhvZCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFFQSxJQUFJQSxRQUFRLEdBQUcsRUFBZjs7QUFFQSxNQUFNQyxzQkFBc0IsR0FBRyxLQUFLLEVBQXBDO0FBQ0EsTUFBTUMsMEJBQTBCLEdBQUcsS0FBSyxDQUF4QztBQUNBLE1BQU1DLHlCQUF5QixHQUFHLElBQWxDO0FBQ0EsTUFBTUMsV0FBVyxHQUFHLEVBQXBCO0FBQ0EsTUFBTUMsZUFBZSxHQUFHLFFBQXhCO0FBQ0EsTUFBTUMsY0FBYyxHQUFH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Ziw0Q0FBMkM5RSxTQUFVLEdBRHhEO0FBRUQ7O0FBQ0QsV0FBTyxNQUFNLGlDQUFxQkEsU0FBckIsRUFBZ0NtRyxVQUFoQyxFQUE0QztBQUN2REMsTUFBQUEsSUFEdUQ7QUFFdkRDLE1BQUFBLElBRnVEO0FBR3ZEQyxNQUFBQTtBQUh1RCxLQUE1QyxDQUFiO0FBS0QsR0FYRCxTQVdVO0FBQ1IsVUFBTSxLQUFLdkIscUJBQUwsQ0FBMkJwQyxTQUEzQixDQUFxQyxJQUFyQyxDQUFOO0FBQ0EsVUFBTSxLQUFLb0MscUJBQUwsQ0FBMkJ4QixPQUEzQixFQUFOO0FBQ0EsU0FBS3dCLHFCQUFMLEdBQTZCLElBQTdCO0FBQ0Q7QUFDRixDQTdCRDs7ZUFpQ2VuRyxRIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IGZzLCB0ZW1wRGlyLCBsb2dnZXIsIHV0aWwgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgeyBTdWJQcm9jZXNzIH0gZnJvbSAndGVlbl9wcm9jZXNzJztcbmltcG9ydCBsb2cgZnJvbSAnLi4vbG9nZ2VyJztcbmltcG9ydCB7IGVuY29kZUJhc2U2NE9yVXBsb2FkLCBpc0xvY2FsSG9zdCB9IGZyb20gJy4uL3V0aWxzJztcbmltcG9ydCBpUHJveHkgZnJvbSAnLi4vd2RhL2lwcm94eSc7XG5pbXBvcnQgeyBXREFfQkFTRV9VUkwgfSBmcm9tICcuLi93ZGEvd2ViZHJpdmVyYWdlbnQnO1xuaW1wb3J0IHsgd2FpdEZvckNvbmRpdGlvbiB9IGZyb20gJ2FzeW5jYm94JztcbmltcG9ydCB1cmwgZnJvbSAndXJsJztcblxubGV0IGNvbW1hbmRzID0ge307XG5cbmNvbnN0IE1BWF9SRUNPUkRJTkdfVElNRV9TRUMgPSA2MCAqIDMwO1xuY29uc3QgREVGQVVMVF9SRUNPUkRJTkdfVElNRV9TRUMgPSA2MCAqIDM7XG5jb25zdCBERUZBVUxUX01KUEVHX1NFUlZFUl9QT1JUID0gOTEwMDtcbmNvbnN0IERFRkFVTFRfRlBTID0gMTA7XG5jb25zdCBERUZBVUxUX1FVQUxJVFkgPSAnbWVkaXVtJztcbmNvbnN0IERFRkFVTFRfVkNPREVDID0gJ21qcGVnJztcbmNvbnN0IE1QNF9FWFQgPSAnLm1wNCc7XG5jb25zdCBGRk1QRUdfQklOQVJZID0gJ2ZmbXBlZyc7XG5jb25zdCBmZm1wZWdMb2dnZXIgPSBsb2dnZXIuZ2V0TG9nZ2VyKEZGTVBFR19CSU5BUlkpO1xuY29uc3QgUVVBTElUWV9NQVBQSU5HID0ge1xuICBsb3c6IDEwLFxuICBtZWRpdW06IDI1LFxuICBoaWdoOiA3NSxcbiAgcGhvdG86IDEwMCxcbn07XG5cblxuY2xhc3MgU2NyZWVuUmVjb3JkZXIge1xuICBjb25zdHJ1Y3RvciAodWRpZCwgdmlkZW9QYXRoLCBvcHRzID0ge30pIHtcbiAgICB0aGlzLnZpZGVvUGF0aCA9IHZpZGVvUGF0aDtcbiAgICB0aGlzLm9wdHMgPSBvcHRzO1xuICAgIHRoaXMudWRpZCA9IHVkaWQ7XG4gICAgdGhpcy5tYWluUHJvY2VzcyA9IG51bGw7XG4gICAgdGhpcy5pcHJveHkgPSBudWxsO1xuICAgIHRoaXMudGltZW91dEhhbmRsZXIgPSBudWxsO1xuICB9XG5cbiAgYXN5bmMgc3RhcnQgKHRpbWVvdXRNcykge1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCBmcy53aGljaChGRk1QRUdfQklOQVJZKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgJyR7RkZNUEVHX0JJTkFSWX0nIGJpbmFyeSBpcyBub3QgZm91bmQgaW4gUEFUSC4gSW5zdGFsbCBpdCB1c2luZyAnYnJldyBpbnN0YWxsIGZmbXBlZycuIGAgK1xuICAgICAgICBgQ2hlY2sgaHR0cHM6Ly93d3cuZmZtcGVnLm9yZy9kb3dubG9hZC5odG1sIGZvciBtb3JlIGRldGFpbHMuYCk7XG4gICAgfVxuXG4gICAgY29uc3Qge1xuICAgICAgcmVtb3RlUG9ydCxcbiAgICAgIHJlbW90ZVVybCxcbiAgICAgIHVzZVBvcnRGb3J3YXJkaW5nLFxuICAgICAgdmlkZW9GcHMsXG4gICAgICB2aWRlb1R5cGUsXG4gICAgICB2aWRlb1NjYWxlLFxuICAgICAgdmlkZW9GaWx0ZXJzLFxuICAgICAgcGl4ZWxGb3JtYXQsXG4gICAgfSA9IHRoaXMub3B0cztcblxuICAgIGlmICh1c2VQb3J0Rm9yd2FyZGluZykge1xuICAgICAgdGhpcy5zdGFydElwcm94eShyZW1vdGVQb3J0KTtcbiAgICB9XG5cbiAgICBjb25zdCBhcmdzID0gW1xuICAgICAgJy1mJywgJ21qcGVnJyxcbiAgICBdO1xuICAgIC8vUGFyYW1ldGVyIGAtcmAgaXMgb3B0aW9uYWwuIFNlZSBkZXRhaWxzOiBodHRwczovL2dpdGh1Yi5jb20vYXBwaXVtL2FwcGl1bS9pc3N1ZXMvMTIwNjdcbiAgICBpZiAodmlkZW9GcHMgJiYgdmlkZW9UeXBlID09PSAnbGlieDI2NCcpIHtcbiAgICAgIGFyZ3MucHVzaCgnLXInLCB2aWRlb0Zwcyk7XG4gICAgfVxuICAgIGNvbnN0IHtwcm90b2NvbCwgaG9zdG5hbWV9ID0gdXJsLnBhcnNlKHJlbW90ZVVybCk7XG4gICAgYXJncy5wdXNoKCctaScsIGAke3Byb3RvY29sfS8vJHtob3N0bmFtZX06JHtyZW1vdGVQb3J0fWApO1xuICAgIGlmICh2aWRlb0ZpbHRlcnMgfHwgdmlkZW9TY2FsZSkge1xuICAgICAgYXJncy5wdXNoKCctdmYnLCB2aWRlb0ZpbHRlcnMgfHwgYHNjYWxlPSR7dmlkZW9TY2FsZX1gKTtcbiAgICB9XG4gICAgLy8gUXVpY2t0aW1lIGNvbXBhdGliaWxpdHkgdmlhIHBpeGVsRm9ybWF0OiAneXV2NDIwcCdcbiAgICBpZiAocGl4ZWxGb3JtYXQpIHtcbiAgICAgIGFyZ3MucHVzaCgnLXBpeF9mbXQnLCBwaXhlbEZvcm1hdCk7XG4gICAgfVxuICAgIGFyZ3MucHVzaChcbiAgICAgICctdmNvZGVjJywgdmlkZW9UeXBlLFxuICAgICAgJy15JywgdGhpcy52aWRlb1BhdGhcbiAgICApO1xuXG4gICAgdGhpcy5tYWluUHJvY2VzcyA9IG5ldyBTdWJQcm9jZXNzKEZGTVBFR19CSU5BUlksIGFyZ3MpO1xuICAgIGxldCBpc0NhcHR1cmVTdGFydGVkID0gZmFsc2U7XG4gICAgdGhpcy5tYWluUHJvY2Vzcy5vbignb3V0cHV0JywgKHN0ZG91dCwgc3RkZXJyKSA9PiB7XG4gICAgICBpZiAoc3RkZXJyKSB7XG4gICAgICAgIGlmIChzdGRlcnIudHJpbSgpLnN0YXJ0c1dpdGgoJ2ZyYW1lPScpKSB7XG4gICAgICAgICAgaWYgKCFpc0NhcHR1cmVTdGFydGVkKSB7XG4gICAgICAgICAgICBpc0NhcHR1cmVTdGFydGVkID0gdHJ1ZTtcbiAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgZmZtcGVnTG9nZ2VyLmluZm8oYCR7c3RkZXJyfWApO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSk7XG4gICAgYXdhaXQgdGhpcy5tYWluUHJvY2Vzcy5zdGFydCgwKTtcbiAgICBjb25zdCBzdGFydHVwVGltZW91dCA9IDUwMDA7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHdhaXRGb3JDb25kaXRpb24oKCkgPT4gaXNDYXB0dXJlU3RhcnRlZCwge1xuICAgICAgICB3YWl0TXM6IHN0YXJ0dXBUaW1lb3V0LFxuICAgICAgICBpbnRlcnZhbE1zOiAzMDAsXG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBsb2cud2FybihgU2NyZWVuIGNhcHR1cmUgcHJvY2VzcyBkaWQgbm90IHN0YXJ0IHdpdGhpbiAke3N0YXJ0dXBUaW1lb3V0fW1zLiBDb250aW51aW5nIGFueXdheWApO1xuICAgIH1cbiAgICBpZiAoIXRoaXMubWFpblByb2Nlc3MuaXNSdW5uaW5nKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFRoZSBzY3JlZW4gY2FwdHVyZSBwcm9jZXNzICcke0ZGTVBFR19CSU5BUll9JyBkaWVkIHVuZXhwZWN0ZWRseS4gYCArXG4gICAgICAgIGBDaGVjayBzZXJ2ZXIgbG9ncyBmb3IgbW9yZSBkZXRhaWxzYCk7XG4gICAgfVxuICAgIGxvZy5pbmZvKGBTdGFydGluZyBzY3JlZW4gY2FwdHVyZSBvbiB0aGUgZGV2aWNlICcke3RoaXMudWRpZH0nIHdpdGggY29tbWFuZDogJyR7RkZNUEVHX0JJTkFSWX0gJHthcmdzLmpvaW4oJyAnKX0nLiBgICtcbiAgICAgIGBXaWxsIHRpbWVvdXQgaW4gJHt0aW1lb3V0TXN9bXNgKTtcblxuICAgIHRoaXMudGltZW91dEhhbmRsZXIgPSBzZXRUaW1lb3V0KGFzeW5jICgpID0+IHtcbiAgICAgIGlmICghYXdhaXQgdGhpcy5pbnRlcnJ1cHQoKSkge1xuICAgICAgICBsb2cud2FybihgQ2Fubm90IGZpbmlzaCB0aGUgYWN0aXZlIHNjcmVlbiByZWNvcmRpbmcgb24gdGhlIGRldmljZSAnJHt0aGlzLnVkaWR9JyBhZnRlciAke3RpbWVvdXRNc31tcyB0aW1lb3V0YCk7XG4gICAgICB9XG4gICAgfSwgdGltZW91dE1zKTtcbiAgfVxuXG4gIHN0YXJ0SXByb3h5IChsb2NhbFBvcnQpIHtcbiAgICB0aGlzLmlwcm94eSA9IG5ldyBpUHJveHkodGhpcy51ZGlkLCBsb2NhbFBvcnQsIHRoaXMub3B0cy5yZW1vdGVQb3J0KTtcbiAgICB0cnkge1xuICAgICAgdGhpcy5pcHJveHkuc3RhcnQoKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGxvZy53YXJuKGBDYW5ub3Qgc3RhcnQgaXByb3h5LiBBc3N1bWluZyBpdCBpcyBhbHJlYWR5IGZvcndhcmRpbmcgdGhlIHJlbW90ZSBwb3J0ICR7dGhpcy5vcHRzLnJlbW90ZVBvcnR9IHRvICR7bG9jYWxQb3J0fSBgICtcbiAgICAgICAgYGZvciB0aGUgZGV2aWNlICR7dGhpcy51ZGlkfS4gU2V0IHRoZSBjdXN0b20gdmFsdWUgdG8gJ21qcGVnU2VydmVyUG9ydCcgY2FwYWJpbGl0eSBpZiB0aGlzIGlzIGFuIHVuZGVzaXJlZCBiZWhhdmlvci4gYCArXG4gICAgICAgIGBPcmlnaW5hbCBlcnJvcjogJHtlcnIubWVzc2FnZX1gKTtcbiAgICAgIHRoaXMuaXByb3h5ID0gbnVsbDtcbiAgICB9XG4gIH1cblxuICBzdG9wSXByb3h5ICgpIHtcbiAgICBpZiAoIXRoaXMuaXByb3h5KSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdGhpcy5pcHJveHkucXVpdCgpO1xuICAgIHRoaXMuaXByb3h5ID0gbnVsbDtcbiAgfVxuXG4gIGFzeW5jIGludGVycnVwdCAoZm9yY2UgPSBmYWxzZSkge1xuICAgIGxldCByZXN1bHQgPSB0cnVlO1xuXG4gICAgaWYgKHRoaXMudGltZW91dEhhbmRsZXIpIHtcbiAgICAgIGNsZWFyVGltZW91dCh0aGlzLnRpbWVvdXRIYW5kbGVyKTtcbiAgICAgIHRoaXMudGltZW91dEhhbmRsZXIgPSBudWxsO1xuICAgIH1cblxuICAgIGlmICh0aGlzLm1haW5Qcm9jZXNzICYmIHRoaXMubWFpblByb2Nlc3MuaXNSdW5uaW5nKSB7XG4gICAgICBjb25zdCBpbnRlcnJ1cHRQcm9taXNlID0gdGhpcy5tYWluUHJvY2Vzcy5zdG9wKGZvcmNlID8gJ1NJR1RFUk0nIDogJ1NJR0lOVCcpO1xuICAgICAgdGhpcy5tYWluUHJvY2VzcyA9IG51bGw7XG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCBpbnRlcnJ1cHRQcm9taXNlO1xuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBsb2cud2FybihgQ2Fubm90ICR7Zm9yY2UgPyAndGVybWluYXRlJyA6ICdpbnRlcnJ1cHQnfSAke0ZGTVBFR19CSU5BUll9LiBgICtcbiAgICAgICAgICBgT3JpZ2luYWwgZXJyb3I6ICR7ZS5tZXNzYWdlfWApO1xuICAgICAgICByZXN1bHQgPSBmYWxzZTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAodGhpcy5vcHRzLnVzZVBvcnRGb3J3YXJkaW5nKSB7XG4gICAgICB0aGlzLnN0b3BJcHJveHkoKTtcbiAgICB9XG5cbiAgICByZXR1cm4gcmVzdWx0O1xuICB9XG5cbiAgYXN5bmMgZmluaXNoICgpIHtcbiAgICBhd2FpdCB0aGlzLmludGVycnVwdCgpO1xuICAgIHJldHVybiB0aGlzLnZpZGVvUGF0aDtcbiAgfVxuXG4gIGFzeW5jIGNsZWFudXAgKCkge1xuICAgIGlmIChhd2FpdCBmcy5leGlzdHModGhpcy52aWRlb1BhdGgpKSB7XG4gICAgICBhd2FpdCBmcy5yaW1yYWYodGhpcy52aWRlb1BhdGgpO1xuICAgIH1cbiAgfVxufVxuXG5cbi8qKlxuICogQHR5cGVkZWYge09iamVjdH0gU3RhcnRSZWNvcmRpbmdPcHRpb25zXG4gKlxuICogQHByb3BlcnR5IHs/c3RyaW5nfSByZW1vdGVQYXRoIC0gVGhlIHBhdGggdG8gdGhlIHJlbW90ZSBsb2NhdGlvbiwgd2hlcmUgdGhlIHJlc3VsdGluZyB2aWRlbyBzaG91bGQgYmUgdXBsb2FkZWQuXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBUaGUgZm9sbG93aW5nIHByb3RvY29scyBhcmUgc3VwcG9ydGVkOiBodHRwL2h0dHBzLCBmdHAuXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBOdWxsIG9yIGVtcHR5IHN0cmluZyB2YWx1ZSAodGhlIGRlZmF1bHQgc2V0dGluZykgbWVhbnMgdGhlIGNvbnRlbnQgb2YgcmVzdWx0aW5nXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWxlIHNob3VsZCBiZSBlbmNvZGVkIGFzIEJhc2U2NCBhbmQgcGFzc2VkIGFzIHRoZSBlbmRwb2ludCByZXNwb25zZSB2YWx1ZS5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIEFuIGV4Y2VwdGlvbiB3aWxsIGJlIHRocm93biBpZiB0aGUgZ2VuZXJhdGVkIG1lZGlhIGZpbGUgaXMgdG9vIGJpZyB0b1xuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZml0IGludG8gdGhlIGF2YWlsYWJsZSBwcm9jZXNzIG1lbW9yeS5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFRoaXMgb3B0aW9uIG9ubHkgaGFzIGFuIGVmZmVjdCBpZiB0aGVyZSBpcyBzY3JlZW4gcmVjb3JkaW5nIHByb2Nlc3MgaW4gcHJvZ3Jlc3NcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFuZCBgZm9yY2VSZXN0YXJ0YCBwYXJhbWV0ZXIgaXMgbm90IHNldCB0byBgdHJ1ZWAuXG4gKiBAcHJvcGVydHkgez9zdHJpbmd9IHVzZXIgLSBUaGUgbmFtZSBvZiB0aGUgdXNlciBmb3IgdGhlIHJlbW90ZSBhdXRoZW50aWNhdGlvbi4gT25seSB3b3JrcyBpZiBgcmVtb3RlUGF0aGAgaXMgcHJvdmlkZWQuXG4gKiBAcHJvcGVydHkgez9zdHJpbmd9IHBhc3MgLSBUaGUgcGFzc3dvcmQgZm9yIHRoZSByZW1vdGUgYXV0aGVudGljYXRpb24uIE9ubHkgd29ya3MgaWYgYHJlbW90ZVBhdGhgIGlzIHByb3ZpZGVkLlxuICogQHByb3BlcnR5IHs/c3RyaW5nfSBtZXRob2QgLSBUaGUgaHR0cCBtdWx0aXBhcnQgdXBsb2FkIG1ldGhvZCBuYW1lLiBUaGUgJ1BVVCcgb25lIGlzIHVzZWQgYnkgZGVmYXVsdC5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgT25seSB3b3JrcyBpZiBgcmVtb3RlUGF0aGAgaXMgcHJvdmlkZWQuXG4gKiBAcHJvcGVydHkgez9zdHJpbmd9IHZpZGVvVHlwZSAtIFRoZSB2aWRlbyBjb2RlYyB0eXBlIHVzZWQgZm9yIGVuY29kaW5nIG9mIHRoZSBiZSByZWNvcmRlZCBzY3JlZW4gY2FwdHVyZS5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgRXhlY3V0ZSBgZmZtcGVnIC1jb2RlY3NgIGluIHRoZSB0ZXJtaW5hbCB0byBzZWUgdGhlIGxpc3Qgb2Ygc3VwcG9ydGVkIHZpZGVvIGNvZGVjcy5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ21qcGVnJyBieSBkZWZhdWx0LlxuICogQHByb3BlcnR5IHs/c3RyaW5nfG51bWJlcn0gdmlkZW9RdWFsaXR5IC0gVGhlIHZpZGVvIGVuY29kaW5nIHF1YWxpdHkgKGxvdywgbWVkaXVtLCBoaWdoLCBwaG90byAtIGRlZmF1bHRzIHRvIG1lZGl1bSkuXG4gKiBAcHJvcGVydHkgez9zdHJpbmd8bnVtYmVyfSB2aWRlb0ZwcyAtIFRoZSBGcmFtZXMgUGVyIFNlY29uZCByYXRlIG9mIHRoZSByZWNvcmRlZCB2aWRlby4gQ2hhbmdlIHRoaXMgdmFsdWUgaWYgdGhlIHJlc3VsdGluZyB2aWRlb1xuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlzIHRvbyBzbG93IG9yIHRvbyBmYXN0LiBEZWZhdWx0cyB0byAxMC5cbiAqIEBwcm9wZXJ0eSB7P3N0cmluZ30gdmlkZW9GaWx0ZXJzIC0gVGhlIEZGTVBFRyB2aWRlbyBmaWx0ZXJzIHRvIGFwcGx5LiBUaGVzZSBmaWx0ZXJzIGFsbG93IHRvIHNjYWxlLCBmbGlwLCByb3RhdGUgYW5kIGRvIG1hbnlcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3RoZXIgdXNlZnVsIHRyYW5zZm9ybWF0aW9ucyBvbiB0aGUgc291cmNlIHZpZGVvIHN0cmVhbS4gVGhlIGZvcm1hdCBvZiB0aGUgcHJvcGVydHlcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbXVzdCBjb21wbHkgd2l0aCBodHRwczovL2ZmbXBlZy5vcmcvZmZtcGVnLWZpbHRlcnMuaHRtbFxuICogQHByb3BlcnR5IHs/c3RyaW5nfSB2aWRlb1NjYWxlIC0gVGhlIHNjYWxpbmcgdmFsdWUgdG8gYXBwbHkuIFJlYWQgaHR0cHM6Ly90cmFjLmZmbXBlZy5vcmcvd2lraS9TY2FsaW5nIGZvciBwb3NzaWJsZSB2YWx1ZXMuXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBObyBzY2FsZSBpcyBhcHBsaWVkIGJ5IGRlZmF1bHQuIElmIGJvdGggYHZpZGVvRmlsdGVyc2AgYW5kIGB2aWRlb1NjYWxlYCBhcmUgc2V0IHRoZW5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9ubHkgYHZpZGVvRmlsdGVyc2AgdmFsdWUgd2lsbCBiZSByZXNwZWN0ZWQuXG4gKiBAcHJvcGVydHkgez9zdHJpbmd9IHBpeGVsRm9ybWF0IC0gT3V0cHV0IHBpeGVsIGZvcm1hdC4gUnVuIGBmZm1wZWcgLXBpeF9mbXRzYCB0byBsaXN0IHBvc3NpYmxlIHZhbHVlcy5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBGb3IgUXVpY2t0aW1lIGNvbXBhdGliaWxpdHksIHNldCB0byBcInl1djQyMHBcIiBhbG9uZyB3aXRoIHZpZGVvVHlwZTogXCJsaWJ4MjY0XCIuXG4gKiBAcHJvcGVydHkgez9ib29sZWFufSBmb3JjZVJlc3RhcnQgLSBXaGV0aGVyIHRvIHRyeSB0byBjYXRjaCBhbmQgdXBsb2FkL3JldHVybiB0aGUgY3VycmVudGx5IHJ1bm5pbmcgc2NyZWVuIHJlY29yZGluZ1xuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKGBmYWxzZWAsIHRoZSBkZWZhdWx0IHNldHRpbmcpIG9yIGlnbm9yZSB0aGUgcmVzdWx0IG9mIGl0IGFuZCBzdGFydCBhIG5ldyByZWNvcmRpbmdcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGltbWVkaWF0ZWx5LlxuICogQHByb3BlcnR5IHs/c3RyaW5nfG51bWJlcn0gdGltZUxpbWl0IC0gVGhlIG1heGltdW0gcmVjb3JkaW5nIHRpbWUsIGluIHNlY29uZHMuXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBUaGUgZGVmYXVsdCB2YWx1ZSBpcyAxODAsIHRoZSBtYXhpbXVtIHZhbHVlIGlzIDYwMCAoMTAgbWludXRlcykuXG4gKi9cblxuLyoqXG4gKiBSZWNvcmQgdGhlIGRpc3BsYXkgb2YgZGV2aWNlcyBydW5uaW5nIGlPUyBTaW11bGF0b3Igc2luY2UgWGNvZGUgOSBvciByZWFsIGRldmljZXMgc2luY2UgaU9TIDExXG4gKiAoZmZtcGVnIHV0aWxpdHkgaXMgcmVxdWlyZWQ6ICdicmV3IGluc3RhbGwgZmZtcGVnJykuXG4gKiBJdCByZWNvcmRzIHNjcmVlbiBhY3Rpdml0eSB0byBhIE1QRUctNCBmaWxlLiBBdWRpbyBpcyBub3QgcmVjb3JkZWQgd2l0aCB0aGUgdmlkZW8gZmlsZS5cbiAqIElmIHNjcmVlbiByZWNvcmRpbmcgaGFzIGJlZW4gYWxyZWFkeSBzdGFydGVkIHRoZW4gdGhlIGNvbW1hbmQgd2lsbCBzdG9wIGl0IGZvcmNlZnVsbHkgYW5kIHN0YXJ0IGEgbmV3IG9uZS5cbiAqIFRoZSBwcmV2aW91c2x5IHJlY29yZGVkIHZpZGVvIGZpbGUgd2lsbCBiZSBkZWxldGVkLlxuICpcbiAqIEBwYXJhbSB7P1N0YXJ0UmVjb3JkaW5nT3B0aW9uc30gb3B0aW9ucyAtIFRoZSBhdmFpbGFibGUgb3B0aW9ucy5cbiAqIEByZXR1cm5zIHtzdHJpbmd9IEJhc2U2NC1lbmNvZGVkIGNvbnRlbnQgb2YgdGhlIHJlY29yZGVkIG1lZGlhIGZpbGUgaWZcbiAqICAgICAgICAgICAgICAgICAgIGFueSBzY3JlZW4gcmVjb3JkaW5nIGlzIGN1cnJlbnRseSBydW5uaW5nIG9yIGFuIGVtcHR5IHN0cmluZy5cbiAqIEB0aHJvd3Mge0Vycm9yfSBJZiBzY3JlZW4gcmVjb3JkaW5nIGhhcyBmYWlsZWQgdG8gc3RhcnQuXG4gKi9cbmNvbW1hbmRzLnN0YXJ0UmVjb3JkaW5nU2NyZWVuID0gYXN5bmMgZnVuY3Rpb24gc3RhcnRSZWNvcmRpbmdTY3JlZW4gKG9wdGlvbnMgPSB7fSkge1xuICBjb25zdCB7XG4gICAgdmlkZW9UeXBlID0gREVGQVVMVF9WQ09ERUMsXG4gICAgdGltZUxpbWl0ID0gREVGQVVMVF9SRUNPUkRJTkdfVElNRV9TRUMsXG4gICAgdmlkZW9RdWFsaXR5ID0gREVGQVVMVF9RVUFMSVRZLFxuICAgIHZpZGVvRnBzID0gREVGQVVMVF9GUFMsXG4gICAgdmlkZW9GaWx0ZXJzLFxuICAgIHZpZGVvU2NhbGUsXG4gICAgZm9yY2VSZXN0YXJ0LFxuICB9ID0gb3B0aW9ucztcblxuICBsZXQgcmVzdWx0ID0gJyc7XG4gIGlmICghZm9yY2VSZXN0YXJ0KSB7XG4gICAgbG9nLmluZm8oYENoZWNraW5nIGlmIHRoZXJlIGlzL3dhcyBhIHByZXZpb3VzIHNjcmVlbiByZWNvcmRpbmcuIGAgK1xuICAgICAgYFNldCAnZm9yY2VSZXN0YXJ0JyBvcHRpb24gdG8gJ3RydWUnIGlmIHlvdSdkIGxpa2UgdG8gc2tpcCB0aGlzIHN0ZXAuYCk7XG4gICAgcmVzdWx0ID0gYXdhaXQgdGhpcy5zdG9wUmVjb3JkaW5nU2NyZWVuKG9wdGlvbnMpO1xuICB9XG5cbiAgY29uc3QgdmlkZW9QYXRoID0gYXdhaXQgdGVtcERpci5wYXRoKHtcbiAgICBwcmVmaXg6IGBhcHBpdW1fJHtNYXRoLnJhbmRvbSgpLnRvU3RyaW5nKDE2KS5zdWJzdHJpbmcoMiwgOCl9YCxcbiAgICBzdWZmaXg6IE1QNF9FWFQsXG4gIH0pO1xuXG4gIGNvbnN0IHdkYUJhc2VVcmwgPSB0aGlzLm9wdHMud2RhQmFzZVVybCB8fCBXREFfQkFTRV9VUkw7XG4gIGNvbnN0IHNjcmVlblJlY29yZGVyID0gbmV3IFNjcmVlblJlY29yZGVyKHRoaXMub3B0cy5kZXZpY2UudWRpZCwgdmlkZW9QYXRoLCB7XG4gICAgcmVtb3RlUG9ydDogdGhpcy5vcHRzLm1qcGVnU2VydmVyUG9ydCB8fCBERUZBVUxUX01KUEVHX1NFUlZFUl9QT1JULFxuICAgIHJlbW90ZVVybDogd2RhQmFzZVVybCxcbiAgICB1c2VQb3J0Rm9yd2FyZGluZzogdGhpcy5pc1JlYWxEZXZpY2UoKSAmJiBpc0xvY2FsSG9zdCh3ZGFCYXNlVXJsKSxcbiAgICB2aWRlb1R5cGUsXG4gICAgdmlkZW9GaWx0ZXJzLFxuICAgIHZpZGVvU2NhbGUsXG4gICAgdmlkZW9GcHMsXG4gIH0pO1xuICBpZiAoIWF3YWl0IHNjcmVlblJlY29yZGVyLmludGVycnVwdCh0cnVlKSkge1xuICAgIGxvZy5lcnJvckFuZFRocm93KCdVbmFibGUgdG8gc3RvcCBzY3JlZW4gcmVjb3JkaW5nIHByb2Nlc3MnKTtcbiAgfVxuICBpZiAodGhpcy5fcmVjZW50U2NyZWVuUmVjb3JkZXIpIHtcbiAgICBhd2FpdCB0aGlzLl9yZWNlbnRTY3JlZW5SZWNvcmRlci5jbGVhbnVwKCk7XG4gICAgdGhpcy5fcmVjZW50U2NyZWVuUmVjb3JkZXIgPSBudWxsO1xuICB9XG5cbiAgY29uc3QgdGltZW91dFNlY29uZHMgPSBwYXJzZUZsb2F0KHRpbWVMaW1pdCk7XG4gIGlmIChpc05hTih0aW1lb3V0U2Vjb25kcykgfHwgdGltZW91dFNlY29uZHMgPiBNQVhfUkVDT1JESU5HX1RJTUVfU0VDIHx8IHRpbWVvdXRTZWNvbmRzIDw9IDApIHtcbiAgICBsb2cuZXJyb3JBbmRUaHJvdyhgVGhlIHRpbWVMaW1pdCB2YWx1ZSBtdXN0IGJlIGluIHJhbmdlIFsxLCAke01BWF9SRUNPUkRJTkdfVElNRV9TRUN9XSBzZWNvbmRzLiBgICtcbiAgICAgIGBUaGUgdmFsdWUgb2YgJyR7dGltZUxpbWl0fScgaGFzIGJlZW4gcGFzc2VkIGluc3RlYWQuYCk7XG4gIH1cblxuICBsZXQge1xuICAgIG1qcGVnU2VydmVyU2NyZWVuc2hvdFF1YWxpdHksXG4gICAgbWpwZWdTZXJ2ZXJGcmFtZXJhdGUsXG4gIH0gPSBhd2FpdCB0aGlzLnByb3h5Q29tbWFuZCgnL2FwcGl1bS9zZXR0aW5ncycsICdHRVQnKTtcbiAgaWYgKHZpZGVvUXVhbGl0eSkge1xuICAgIGNvbnN0IHF1YWxpdHkgPSBfLmlzSW50ZWdlcih2aWRlb1F1YWxpdHkpID8gdmlkZW9RdWFsaXR5IDogUVVBTElUWV9NQVBQSU5HW18udG9Mb3dlcih2aWRlb1F1YWxpdHkpXTtcbiAgICBpZiAoIXF1YWxpdHkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgdmlkZW9RdWFsaXR5IHZhbHVlIHNob3VsZCBiZSBvbmUgb2YgJHtKU09OLnN0cmluZ2lmeShfLmtleXMoUVVBTElUWV9NQVBQSU5HKSl9IG9yIGEgbnVtYmVyIGluIHJhbmdlIDEuLjEwMC4gYCArXG4gICAgICAgIGAnJHt2aWRlb1F1YWxpdHl9JyBpcyBnaXZlbiBpbnN0ZWFkYCk7XG4gICAgfVxuICAgIG1qcGVnU2VydmVyU2NyZWVuc2hvdFF1YWxpdHkgPSBtanBlZ1NlcnZlclNjcmVlbnNob3RRdWFsaXR5ICE9PSBxdWFsaXR5ID8gcXVhbGl0eSA6IHVuZGVmaW5lZDtcbiAgfSBlbHNlIHtcbiAgICBtanBlZ1NlcnZlclNjcmVlbnNob3RRdWFsaXR5ID0gdW5kZWZpbmVkO1xuICB9XG4gIGlmICh2aWRlb0Zwcykge1xuICAgIGNvbnN0IGZwcyA9IHBhcnNlSW50KHZpZGVvRnBzLCAxMCk7XG4gICAgaWYgKGlzTmFOKGZwcykpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgdmlkZW9GcHMgdmFsdWUgc2hvdWxkIGJlIGEgdmFsaWQgbnVtYmVyIGluIHJhbmdlIDEuLjYwLiBgICtcbiAgICAgICAgYCcke3ZpZGVvRnBzfScgaXMgZ2l2ZW4gaW5zdGVhZGApO1xuICAgIH1cbiAgICBtanBlZ1NlcnZlckZyYW1lcmF0ZSA9IG1qcGVnU2VydmVyRnJhbWVyYXRlICE9PSBmcHMgPyBmcHMgOiB1bmRlZmluZWQ7XG4gIH0gZWxzZSB7XG4gICAgbWpwZWdTZXJ2ZXJGcmFtZXJhdGUgPSB1bmRlZmluZWQ7XG4gIH1cbiAgaWYgKHV0aWwuaGFzVmFsdWUobWpwZWdTZXJ2ZXJTY3JlZW5zaG90UXVhbGl0eSkgfHwgdXRpbC5oYXNWYWx1ZShtanBlZ1NlcnZlckZyYW1lcmF0ZSkpIHtcbiAgICBhd2FpdCB0aGlzLnByb3h5Q29tbWFuZCgnL2FwcGl1bS9zZXR0aW5ncycsICdQT1NUJywge1xuICAgICAgc2V0dGluZ3M6IHtcbiAgICAgICAgbWpwZWdTZXJ2ZXJTY3JlZW5zaG90UXVhbGl0eSxcbiAgICAgICAgbWpwZWdTZXJ2ZXJGcmFtZXJhdGUsXG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICB0cnkge1xuICAgIGF3YWl0IHNjcmVlblJlY29yZGVyLnN0YXJ0KHRpbWVvdXRTZWNvbmRzICogMTAwMCk7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBhd2FpdCBzY3JlZW5SZWNvcmRlci5pbnRlcnJ1cHQodHJ1ZSk7XG4gICAgYXdhaXQgc2NyZWVuUmVjb3JkZXIuY2xlYW51cCgpO1xuICAgIHRocm93IGU7XG4gIH1cbiAgdGhpcy5fcmVjZW50U2NyZWVuUmVjb3JkZXIgPSBzY3JlZW5SZWNvcmRlcjtcblxuICByZXR1cm4gcmVzdWx0O1xufTtcblxuLyoqXG4gKiBAdHlwZWRlZiB7T2JqZWN0fSBTdG9wUmVjb3JkaW5nT3B0aW9uc1xuICpcbiAqIEBwcm9wZXJ0eSB7P3N0cmluZ30gcmVtb3RlUGF0aCAtIFRoZSBwYXRoIHRvIHRoZSByZW1vdGUgbG9jYXRpb24sIHdoZXJlIHRoZSByZXN1bHRpbmcgdmlkZW8gc2hvdWxkIGJlIHVwbG9hZGVkLlxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgVGhlIGZvbGxvd2luZyBwcm90b2NvbHMgYXJlIHN1cHBvcnRlZDogaHR0cC9odHRwcywgZnRwLlxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgTnVsbCBvciBlbXB0eSBzdHJpbmcgdmFsdWUgKHRoZSBkZWZhdWx0IHNldHRpbmcpIG1lYW5zIHRoZSBjb250ZW50IG9mIHJlc3VsdGluZ1xuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlsZSBzaG91bGQgYmUgZW5jb2RlZCBhcyBCYXNlNjQgYW5kIHBhc3NlZCBhcyB0aGUgZW5kcG9pbnQgcmVzcG9uc2UgdmFsdWUuXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBBbiBleGNlcHRpb24gd2lsbCBiZSB0aHJvd24gaWYgdGhlIGdlbmVyYXRlZCBtZWRpYSBmaWxlIGlzIHRvbyBiaWcgdG9cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpdCBpbnRvIHRoZSBhdmFpbGFibGUgcHJvY2VzcyBtZW1vcnkuXG4gKiBAcHJvcGVydHkgez9zdHJpbmd9IHVzZXIgLSBUaGUgbmFtZSBvZiB0aGUgdXNlciBmb3IgdGhlIHJlbW90ZSBhdXRoZW50aWNhdGlvbi4gT25seSB3b3JrcyBpZiBgcmVtb3RlUGF0aGAgaXMgcHJvdmlkZWQuXG4gKiBAcHJvcGVydHkgez9zdHJpbmd9IHBhc3MgLSBUaGUgcGFzc3dvcmQgZm9yIHRoZSByZW1vdGUgYXV0aGVudGljYXRpb24uIE9ubHkgd29ya3MgaWYgYHJlbW90ZVBhdGhgIGlzIHByb3ZpZGVkLlxuICogQHByb3BlcnR5IHs/c3RyaW5nfSBtZXRob2QgLSBUaGUgaHR0cCBtdWx0aXBhcnQgdXBsb2FkIG1ldGhvZCBuYW1lLiBUaGUgJ1BVVCcgb25lIGlzIHVzZWQgYnkgZGVmYXVsdC5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgT25seSB3b3JrcyBpZiBgcmVtb3RlUGF0aGAgaXMgcHJvdmlkZWQuXG4gKi9cblxuLyoqXG4gKiBTdG9wIHJlY29yZGluZyB0aGUgc2NyZWVuLiBJZiBubyBzY3JlZW4gcmVjb3JkaW5nIHByb2Nlc3MgaXMgcnVubmluZyB0aGVuXG4gKiB0aGUgZW5kcG9pbnQgd2lsbCB0cnkgdG8gZ2V0IHRoZSByZWNlbnRseSByZWNvcmRlZCBmaWxlLlxuICogSWYgbm8gcHJldmlvdXNseSByZWNvcmRlZCBmaWxlIGlzIGZvdW5kIGFuZCBubyBhY3RpdmUgc2NyZWVuIHJlY29yZGluZ1xuICogcHJvY2Vzc2VzIGFyZSBydW5uaW5nIHRoZW4gdGhlIG1ldGhvZCByZXR1cm5zIGFuIGVtcHR5IHN0cmluZy5cbiAqXG4gKiBAcGFyYW0gez9TdG9wUmVjb3JkaW5nT3B0aW9uc30gb3B0aW9ucyAtIFRoZSBhdmFpbGFibGUgb3B0aW9ucy5cbiAqIEByZXR1cm5zIHtzdHJpbmd9IEJhc2U2NC1lbmNvZGVkIGNvbnRlbnQgb2YgdGhlIHJlY29yZGVkIG1lZGlhIGZpbGUgaWYgJ3JlbW90ZVBhdGgnXG4gKiAgICAgICAgICAgICAgICAgICBwYXJhbWV0ZXIgaXMgZW1wdHkgb3IgbnVsbCBvciBhbiBlbXB0eSBzdHJpbmcuXG4gKiBAdGhyb3dzIHtFcnJvcn0gSWYgdGhlcmUgd2FzIGFuIGVycm9yIHdoaWxlIGdldHRpbmcgdGhlIG5hbWUgb2YgYSBtZWRpYSBmaWxlXG4gKiAgICAgICAgICAgICAgICAgb3IgdGhlIGZpbGUgY29udGVudCBjYW5ub3QgYmUgdXBsb2FkZWQgdG8gdGhlIHJlbW90ZSBsb2NhdGlvbi5cbiAqL1xuY29tbWFuZHMuc3RvcFJlY29yZGluZ1NjcmVlbiA9IGFzeW5jIGZ1bmN0aW9uIHN0b3BSZWNvcmRpbmdTY3JlZW4gKG9wdGlvbnMgPSB7fSkge1xuICBjb25zdCB7XG4gICAgcmVtb3RlUGF0aCxcbiAgICB1c2VyLFxuICAgIHBhc3MsXG4gICAgbWV0aG9kLFxuICB9ID0gb3B0aW9ucztcblxuICBpZiAoIXRoaXMuX3JlY2VudFNjcmVlblJlY29yZGVyKSB7XG4gICAgbG9nLmluZm8oJ1NjcmVlbiByZWNvcmRpbmcgaXMgbm90IHJ1bm5pbmcuIFRoZXJlIGlzIG5vdGhpbmcgdG8gc3RvcC4nKTtcbiAgICByZXR1cm4gJyc7XG4gIH1cblxuICB0cnkge1xuICAgIGNvbnN0IHZpZGVvUGF0aCA9IGF3YWl0IHRoaXMuX3JlY2VudFNjcmVlblJlY29yZGVyLmZpbmlzaCgpO1xuICAgIGlmICghYXdhaXQgZnMuZXhpc3RzKHZpZGVvUGF0aCkpIHtcbiAgICAgIGxvZy5lcnJvckFuZFRocm93KGBUaGUgc2NyZWVuIHJlY29yZGVyIHV0aWxpdHkgaGFzIGZhaWxlZCBgICtcbiAgICAgICAgYHRvIHN0b3JlIHRoZSBhY3R1YWwgc2NyZWVuIHJlY29yZGluZyBhdCAnJHt2aWRlb1BhdGh9J2ApO1xuICAgIH1cbiAgICByZXR1cm4gYXdhaXQgZW5jb2RlQmFzZTY0T3JVcGxvYWQodmlkZW9QYXRoLCByZW1vdGVQYXRoLCB7XG4gICAgICB1c2VyLFxuICAgICAgcGFzcyxcbiAgICAgIG1ldGhvZFxuICAgIH0pO1xuICB9IGZpbmFsbHkge1xuICAgIGF3YWl0IHRoaXMuX3JlY2VudFNjcmVlblJlY29yZGVyLmludGVycnVwdCh0cnVlKTtcbiAgICBhd2FpdCB0aGlzLl9yZWNlbnRTY3JlZW5SZWNvcmRlci5jbGVhbnVwKCk7XG4gICAgdGhpcy5fcmVjZW50U2NyZWVuUmVjb3JkZXIgPSBudWxsO1xuICB9XG59O1xuXG5cbmV4cG9ydCB7IGNvbW1hbmRzIH07XG5leHBvcnQgZGVmYXVsdCBjb21tYW5kcztcbiJdLCJmaWxlIjoibGliL2NvbW1hbmRzL3JlY29yZHNjcmVlbi5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9
