"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _asyncbox = require("asyncbox");

var _lodash = _interopRequireDefault(require("lodash"));

var _nodeSimctl = require("node-simctl");

var _teen_process = require("teen_process");

var _logger = _interopRequireDefault(require("../logger"));

var _appiumSupport = require("appium-support");

var _jimp = _interopRequireDefault(require("jimp"));

let commands = {};

async function getScreenshotWithIdevicelib(udid, isLandscape) {
  const pathToResultPng = await _appiumSupport.tempDir.path({
    prefix: `screenshot-${udid}`,
    suffix: '.png'
  });
  await _appiumSupport.fs.rimraf(pathToResultPng);

  try {
    try {
      await (0, _teen_process.exec)('idevicescreenshot', ['-u', udid, pathToResultPng]);
    } catch (e) {
      throw new Error(`Cannot take a screenshot from the device '${udid}' using ` + `idevicescreenshot. Original error: ${e.message}`);
    }

    const data = await _appiumSupport.fs.readFile(pathToResultPng);

    if (!isLandscape) {
      return data.toString('base64');
    }

    const image = await _jimp.default.read(data);
    const buffer = await image.rotate(90).getBufferAsync(_jimp.default.MIME_PNG);
    return buffer.toString('base64');
  } finally {
    await _appiumSupport.fs.rimraf(pathToResultPng);
  }
}

async function verifyIdeviceScreenshotAvailable() {
  try {
    await _appiumSupport.fs.which('idevicescreenshot');
  } catch (err) {
    throw new Error(`No 'idevicescreenshot' program found. To use, install ` + `using 'brew install --HEAD libimobiledevice'`);
  }
}

commands.getScreenshot = async function getScreenshot() {
  const getScreenshotFromIDS = async () => {
    _logger.default.debug(`Taking screenshot with 'idevicescreenshot'`);

    await verifyIdeviceScreenshotAvailable();
    const orientation = await this.proxyCommand('/orientation', 'GET');
    return await getScreenshotWithIdevicelib(this.opts.udid, orientation === 'LANDSCAPE');
  };

  const getScreenshotFromWDA = async () => {
    _logger.default.debug(`Taking screenshot with WDA`);

    const data = await this.proxyCommand('/screenshot', 'GET');

    if (!_lodash.default.isString(data)) {
      throw new Error(`Unable to take screenshot. WDA returned '${JSON.stringify(data)}'`);
    }

    return data;
  };

  if (this.opts.realDeviceScreenshotter && this.mjpegStream) {
    _logger.default.warn("You've specified screenshot retrieval via both MJpeg server " + 'and a real device screenshot utility. Please use one or the ' + 'other! Choosing MJPEG server');
  }

  if (this.mjpegStrem) {
    const data = await this.mjpegStream.lastChunkPNGBase64();

    if (data) {
      return data;
    }

    _logger.default.warn('Tried to get screenshot from active MJPEG stream, but there ' + 'was no data yet. Falling back to regular screenshot methods.');
  }

  const useIdeviceScreenshot = _lodash.default.lowerCase(this.opts.realDeviceScreenshotter) === 'idevicescreenshot';

  if (useIdeviceScreenshot) {
    return await getScreenshotFromIDS();
  }

  try {
    return await getScreenshotFromWDA();
  } catch (err) {
    _logger.default.warn(`Error getting screenshot: ${err.message}`);
  }

  if (this.isSimulator()) {
    _logger.default.info(`Falling back to 'simctl io screenshot' API`);

    return await (0, _nodeSimctl.getScreenshot)(this.opts.udid);
  }

  try {
    return await getScreenshotFromIDS();
  } catch (err) {
    _logger.default.warn(`Error getting screenshot through 'idevicescreenshot': ${err.message}`);
  }

  return await (0, _asyncbox.retryInterval)(2, 1000, getScreenshotFromWDA);
};

commands.getElementScreenshot = async function getElementScreenshot(el) {
  el = _appiumSupport.util.unwrapElement(el);

  if (this.isWebContext()) {
    const atomsElement = this.useAtomsElement(el);
    return await this.executeAtom('getElementScreenshot', [atomsElement]);
  }

  const data = await this.proxyCommand(`/element/${el}/screenshot`, 'GET');

  if (!_lodash.default.isString(data)) {
    _logger.default.errorAndThrow(`Unable to take a screenshot of the element ${el}. WDA returned '${JSON.stringify(data)}'`);
  }

  return data;
};

commands.getViewportScreenshot = async function getViewportScreenshot() {
  let statusBarHeight = await this.getStatusBarHeight();
  const screenshot = await this.getScreenshot();

  if (statusBarHeight === 0) {
    return screenshot;
  }

  const scale = await this.getDevicePixelRatio();
  statusBarHeight = Math.round(statusBarHeight * scale);
  const windowSize = await this.getWindowSize();
  let rect = {
    left: 0,
    top: statusBarHeight,
    width: windowSize.width * scale,
    height: windowSize.height * scale - statusBarHeight
  };
  let newScreenshot = await _appiumSupport.imageUtil.cropBase64Image(screenshot, rect);
  return newScreenshot;
};

var _default = commands;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9zY3JlZW5zaG90cy5qcyJdLCJuYW1lcyI6WyJjb21tYW5kcyIsImdldFNjcmVlbnNob3RXaXRoSWRldmljZWxpYiIsInVkaWQiLCJpc0xhbmRzY2FwZSIsInBhdGhUb1Jlc3VsdFBuZyIsInRlbXBEaXIiLCJwYXRoIiwicHJlZml4Iiwic3VmZml4IiwiZnMiLCJyaW1yYWYiLCJlIiwiRXJyb3IiLCJtZXNzYWdlIiwiZGF0YSIsInJlYWRGaWxlIiwidG9TdHJpbmciLCJpbWFnZSIsImppbXAiLCJyZWFkIiwiYnVmZmVyIiwicm90YXRlIiwiZ2V0QnVmZmVyQXN5bmMiLCJNSU1FX1BORyIsInZlcmlmeUlkZXZpY2VTY3JlZW5zaG90QXZhaWxhYmxlIiwid2hpY2giLCJlcnIiLCJnZXRTY3JlZW5zaG90IiwiZ2V0U2NyZWVuc2hvdEZyb21JRFMiLCJsb2ciLCJkZWJ1ZyIsIm9yaWVudGF0aW9uIiwicHJveHlDb21tYW5kIiwib3B0cyIsImdldFNjcmVlbnNob3RGcm9tV0RBIiwiXyIsImlzU3RyaW5nIiwiSlNPTiIsInN0cmluZ2lmeSIsInJlYWxEZXZpY2VTY3JlZW5zaG90dGVyIiwibWpwZWdTdHJlYW0iLCJ3YXJuIiwibWpwZWdTdHJlbSIsImxhc3RDaHVua1BOR0Jhc2U2NCIsInVzZUlkZXZpY2VTY3JlZW5zaG90IiwibG93ZXJDYXNlIiwiaXNTaW11bGF0b3IiLCJpbmZvIiwiZ2V0RWxlbWVudFNjcmVlbnNob3QiLCJlbCIsInV0aWwiLCJ1bndyYXBFbGVtZW50IiwiaXNXZWJDb250ZXh0IiwiYXRvbXNFbGVtZW50IiwidXNlQXRvbXNFbGVtZW50IiwiZXhlY3V0ZUF0b20iLCJlcnJvckFuZFRocm93IiwiZ2V0Vmlld3BvcnRTY3JlZW5zaG90Iiwic3RhdHVzQmFySGVpZ2h0IiwiZ2V0U3RhdHVzQmFySGVpZ2h0Iiwic2NyZWVuc2hvdCIsInNjYWxlIiwiZ2V0RGV2aWNlUGl4ZWxSYXRpbyIsIk1hdGgiLCJyb3VuZCIsIndpbmRvd1NpemUiLCJnZXRXaW5kb3dTaXplIiwicmVjdCIsImxlZnQiLCJ0b3AiLCJ3aWR0aCIsImhlaWdodCIsIm5ld1NjcmVlbnNob3QiLCJpbWFnZVV0aWwiLCJjcm9wQmFzZTY0SW1hZ2UiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUEsSUFBSUEsUUFBUSxHQUFHLEVBQWY7O0FBRUEsZUFBZUMsMkJBQWYsQ0FBNENDLElBQTVDLEVBQWtEQyxXQUFsRCxFQUErRDtBQUM3RCxRQUFNQyxlQUFlLEdBQUcsTUFBTUMsdUJBQVFDLElBQVIsQ0FBYTtBQUFDQyxJQUFBQSxNQUFNLEVBQUcsY0FBYUwsSUFBSyxFQUE1QjtBQUErQk0sSUFBQUEsTUFBTSxFQUFFO0FBQXZDLEdBQWIsQ0FBOUI7QUFDQSxRQUFNQyxrQkFBR0MsTUFBSCxDQUFVTixlQUFWLENBQU47O0FBQ0EsTUFBSTtBQUNGLFFBQUk7QUFDRixZQUFNLHdCQUFLLG1CQUFMLEVBQTBCLENBQUMsSUFBRCxFQUFPRixJQUFQLEVBQWFFLGVBQWIsQ0FBMUIsQ0FBTjtBQUNELEtBRkQsQ0FFRSxPQUFPTyxDQUFQLEVBQVU7QUFDVixZQUFNLElBQUlDLEtBQUosQ0FBVyw2Q0FBNENWLElBQUssVUFBbEQsR0FDYixzQ0FBcUNTLENBQUMsQ0FBQ0UsT0FBUSxFQUQ1QyxDQUFOO0FBRUQ7O0FBQ0QsVUFBTUMsSUFBSSxHQUFHLE1BQU1MLGtCQUFHTSxRQUFILENBQVlYLGVBQVosQ0FBbkI7O0FBQ0EsUUFBSSxDQUFDRCxXQUFMLEVBQWtCO0FBQ2hCLGFBQU9XLElBQUksQ0FBQ0UsUUFBTCxDQUFjLFFBQWQsQ0FBUDtBQUNEOztBQUNELFVBQU1DLEtBQUssR0FBRyxNQUFNQyxjQUFLQyxJQUFMLENBQVVMLElBQVYsQ0FBcEI7QUFDQSxVQUFNTSxNQUFNLEdBQUcsTUFBTUgsS0FBSyxDQUFDSSxNQUFOLENBQWEsRUFBYixFQUFpQkMsY0FBakIsQ0FBZ0NKLGNBQUtLLFFBQXJDLENB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QUFBLEtBQUssRUFBRUwsVUFBVSxDQUFDSyxLQUFYLEdBQW1CVCxLQUhqQjtBQUlUVSxJQUFBQSxNQUFNLEVBQUlOLFVBQVUsQ0FBQ00sTUFBWCxHQUFvQlYsS0FBckIsR0FBOEJIO0FBSjlCLEdBQVg7QUFNQSxNQUFJYyxhQUFhLEdBQUcsTUFBTUMseUJBQVVDLGVBQVYsQ0FBMEJkLFVBQTFCLEVBQXNDTyxJQUF0QyxDQUExQjtBQUNBLFNBQU9LLGFBQVA7QUFDRCxDQXRCRDs7ZUF3QmV4RSxRIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgcmV0cnlJbnRlcnZhbCB9IGZyb20gJ2FzeW5jYm94JztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyBnZXRTY3JlZW5zaG90IGFzIHNpbWN0bEdldFNjcmVlbnNob3QgfSBmcm9tICdub2RlLXNpbWN0bCc7XG5pbXBvcnQgeyBleGVjIH0gZnJvbSAndGVlbl9wcm9jZXNzJztcbmltcG9ydCBsb2cgZnJvbSAnLi4vbG9nZ2VyJztcbmltcG9ydCB7IGZzLCB0ZW1wRGlyLCB1dGlsLCBpbWFnZVV0aWwgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgamltcCBmcm9tICdqaW1wJztcblxubGV0IGNvbW1hbmRzID0ge307XG5cbmFzeW5jIGZ1bmN0aW9uIGdldFNjcmVlbnNob3RXaXRoSWRldmljZWxpYiAodWRpZCwgaXNMYW5kc2NhcGUpIHtcbiAgY29uc3QgcGF0aFRvUmVzdWx0UG5nID0gYXdhaXQgdGVtcERpci5wYXRoKHtwcmVmaXg6IGBzY3JlZW5zaG90LSR7dWRpZH1gLCBzdWZmaXg6ICcucG5nJ30pO1xuICBhd2FpdCBmcy5yaW1yYWYocGF0aFRvUmVzdWx0UG5nKTtcbiAgdHJ5IHtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgZXhlYygnaWRldmljZXNjcmVlbnNob3QnLCBbJy11JywgdWRpZCwgcGF0aFRvUmVzdWx0UG5nXSk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBDYW5ub3QgdGFrZSBhIHNjcmVlbnNob3QgZnJvbSB0aGUgZGV2aWNlICcke3VkaWR9JyB1c2luZyBgICtcbiAgICAgICAgYGlkZXZpY2VzY3JlZW5zaG90LiBPcmlnaW5hbCBlcnJvcjogJHtlLm1lc3NhZ2V9YCk7XG4gICAgfVxuICAgIGNvbnN0IGRhdGEgPSBhd2FpdCBmcy5yZWFkRmlsZShwYXRoVG9SZXN1bHRQbmcpO1xuICAgIGlmICghaXNMYW5kc2NhcGUpIHtcbiAgICAgIHJldHVybiBkYXRhLnRvU3RyaW5nKCdiYXNlNjQnKTtcbiAgICB9XG4gICAgY29uc3QgaW1hZ2UgPSBhd2FpdCBqaW1wLnJlYWQoZGF0YSk7XG4gICAgY29uc3QgYnVmZmVyID0gYXdhaXQgaW1hZ2Uucm90YXRlKDkwKS5nZXRCdWZmZXJBc3luYyhqaW1wLk1JTUVfUE5HKTtcbiAgICByZXR1cm4gYnVmZmVyLnRvU3RyaW5nKCdiYXNlNjQnKTtcbiAgfSBmaW5hbGx5IHtcbiAgICBhd2FpdCBmcy5yaW1yYWYocGF0aFRvUmVzdWx0UG5nKTtcbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiB2ZXJpZnlJZGV2aWNlU2NyZWVuc2hvdEF2YWlsYWJsZSAoKSB7XG4gIHRyeSB7XG4gICAgYXdhaXQgZnMud2hpY2goJ2lkZXZpY2VzY3JlZW5zaG90Jyk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIHRocm93IG5ldyBFcnJvcihgTm8gJ2lkZXZpY2VzY3JlZW5zaG90JyBwcm9ncmFtIGZvdW5kLiBUbyB1c2UsIGluc3RhbGwgYCArXG4gICAgICAgICAgICAgICAgICAgIGB1c2luZyAnYnJldyBpbnN0YWxsIC0tSEVBRCBsaWJpbW9iaWxlZGV2aWNlJ2ApO1xuICB9XG59XG5cbmNvbW1hbmRzLmdldFNjcmVlbnNob3QgPSBhc3luYyBmdW5jdGlvbiBnZXRTY3JlZW5zaG90ICgpIHtcbiAgY29uc3QgZ2V0U2NyZWVuc2hvdEZyb21JRFMgPSBhc3luYyAoKSA9PiB7XG4gICAgbG9nLmRlYnVnKGBUYWtpbmcgc2NyZWVuc2hvdCB3aXRoICdpZGV2aWNlc2NyZWVuc2hvdCdgKTtcbiAgICBhd2FpdCB2ZXJpZnlJZGV2aWNlU2NyZWVuc2hvdEF2YWlsYWJsZSgpO1xuICAgIGNvbnN0IG9yaWVudGF0aW9uID0gYXdhaXQgdGhpcy5wcm94eUNvbW1hbmQoJy9vcmllbnRhdGlvbicsICdHRVQnKTtcbiAgICByZXR1cm4gYXdhaXQgZ2V0U2NyZWVuc2hvdFdpdGhJZGV2aWNlbGliKHRoaXMub3B0cy51ZGlkLCBvcmllbnRhdGlvbiA9PT0gJ0xBTkRTQ0FQRScpO1xuICB9O1xuXG4gIGNvbnN0IGdldFNjcmVlbnNob3RGcm9tV0RBID0gYXN5bmMgKCkgPT4ge1xuICAgIGxvZy5kZWJ1ZyhgVGFraW5nIHNjcmVlbnNob3Qgd2l0aCBXREFgKTtcbiAgICBjb25zdCBkYXRhID0gYXdhaXQgdGhpcy5wcm94eUNvbW1hbmQoJy9zY3JlZW5zaG90JywgJ0dFVCcpO1xuICAgIGlmICghXy5pc1N0cmluZyhkYXRhKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbmFibGUgdG8gdGFrZSBzY3JlZW5zaG90LiBXREEgcmV0dXJuZWQgJyR7SlNPTi5zdHJpbmdpZnkoZGF0YSl9J2ApO1xuICAgIH1cbiAgICByZXR1cm4gZGF0YTtcbiAgfTtcblxuICAvLyBlbnN1cmUgdGhlIHVzZXIgZG9lc24ndCB0cnkgdG8gdXNlIDIgc3BlY2lhbHR5IHNjcmVlbnNob3QgY2Fwc1xuICBpZiAodGhpcy5vcHRzLnJlYWxEZXZpY2VTY3JlZW5zaG90dGVyICYmIHRoaXMubWpwZWdTdHJlYW0pIHtcbiAgICBsb2cud2FybihcIllvdSd2ZSBzcGVjaWZpZWQgc2NyZWVuc2hvdCByZXRyaWV2YWwgdmlhIGJvdGggTUpwZWcgc2VydmVyIFwiICtcbiAgICAgICAgICAgICAnYW5kIGEgcmVhbCBkZXZpY2Ugc2NyZWVuc2hvdCB1dGlsaXR5LiBQbGVhc2UgdXNlIG9uZSBvciB0aGUgJyArXG4gICAgICAgICAgICAgJ290aGVyISBDaG9vc2luZyBNSlBFRyBzZXJ2ZXInKTtcbiAgfVxuXG4gIC8vIGlmIHdlJ3ZlIHNwZWNpZmllZCBhbiBtanBlZyBzZXJ2ZXIsIHVzZSB0aGF0XG4gIGlmICh0aGlzLm1qcGVnU3RyZW0pIHtcbiAgICBjb25zdCBkYXRhID0gYXdhaXQgdGhpcy5tanBlZ1N0cmVhbS5sYXN0Q2h1bmtQTkdCYXNlNjQoKTtcbiAgICBpZiAoZGF0YSkge1xuICAgICAgcmV0dXJuIGRhdGE7XG4gICAgfVxuICAgIGxvZy53YXJuKCdUcmllZCB0byBnZXQgc2NyZWVuc2hvdCBmcm9tIGFjdGl2ZSBNSlBFRyBzdHJlYW0sIGJ1dCB0aGVyZSAnICtcbiAgICAgICAgICAgICAnd2FzIG5vIGRhdGEgeWV0LiBGYWxsaW5nIGJhY2sgdG8gcmVndWxhciBzY3JlZW5zaG90IG1ldGhvZHMuJyk7XG4gIH1cblxuICAvLyBvdGhlcndpc2UgdXNlIHRoZSByZWFsIGRldmljZSBzY3JlZW5zaG90dGVyIGFzIHNwZWNpZmllZFxuICBjb25zdCB1c2VJZGV2aWNlU2NyZWVuc2hvdCA9IF8ubG93ZXJDYXNlKHRoaXMub3B0cy5yZWFsRGV2aWNlU2NyZWVuc2hvdHRlcikgPT09ICdpZGV2aWNlc2NyZWVuc2hvdCc7XG4gIGlmICh1c2VJZGV2aWNlU2NyZWVuc2hvdCkge1xuICAgIHJldHVybiBhd2FpdCBnZXRTY3JlZW5zaG90RnJvbUlEUygpO1xuICB9XG5cbiAgdHJ5IHtcbiAgICByZXR1cm4gYXdhaXQgZ2V0U2NyZWVuc2hvdEZyb21XREEoKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgbG9nLndhcm4oYEVycm9yIGdldHRpbmcgc2NyZWVuc2hvdDogJHtlcnIubWVzc2FnZX1gKTtcbiAgfVxuXG4gIC8vIHNpbXVsYXRvciBhdHRlbXB0XG4gIGlmICh0aGlzLmlzU2ltdWxhdG9yKCkpIHtcbiAgICBsb2cuaW5mbyhgRmFsbGluZyBiYWNrIHRvICdzaW1jdGwgaW8gc2NyZWVuc2hvdCcgQVBJYCk7XG4gICAgcmV0dXJuIGF3YWl0IHNpbWN0bEdldFNjcmVlbnNob3QodGhpcy5vcHRzLnVkaWQpO1xuICB9XG5cbiAgLy8gYWxsIHNpbXVsYXRvciBzY2VuYXJpb3MgYXJlIGZpbmlzaGVkXG4gIC8vIHJlYWwgZGV2aWNlLCBzbyB0cnkgaWRldmljZXNjcmVlbnNob3QgaWYgcG9zc2libGVcbiAgdHJ5IHtcbiAgICByZXR1cm4gYXdhaXQgZ2V0U2NyZWVuc2hvdEZyb21JRFMoKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgbG9nLndhcm4oYEVycm9yIGdldHRpbmcgc2NyZWVuc2hvdCB0aHJvdWdoICdpZGV2aWNlc2NyZWVuc2hvdCc6ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gIH1cblxuICAvLyBSZXRyeSBmb3IgcmVhbCBkZXZpY2VzIG9ubHkuIEZhaWwgZmFzdCBvbiBTaW11bGF0b3IgaWYgc2ltY3RsIGRvZXMgbm90IHdvcmsgYXMgZXhwZWN0ZWRcbiAgcmV0dXJuIGF3YWl0IHJldHJ5SW50ZXJ2YWwoMiwgMTAwMCwgZ2V0U2NyZWVuc2hvdEZyb21XREEpO1xufTtcblxuY29tbWFuZHMuZ2V0RWxlbWVudFNjcmVlbnNob3QgPSBhc3luYyBmdW5jdGlvbiBnZXRFbGVtZW50U2NyZWVuc2hvdCAoZWwpIHtcbiAgZWwgPSB1dGlsLnVud3JhcEVsZW1lbnQoZWwpO1xuICBpZiAodGhpcy5pc1dlYkNvbnRleHQoKSkge1xuICAgIGNvbnN0IGF0b21zRWxlbWVudCA9IHRoaXMudXNlQXRvbXNFbGVtZW50KGVsKTtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5leGVjdXRlQXRvbSgnZ2V0RWxlbWVudFNjcmVlbnNob3QnLCBbYXRvbXNFbGVtZW50XSk7XG4gIH1cblxuICBjb25zdCBkYXRhID0gYXdhaXQgdGhpcy5wcm94eUNvbW1hbmQoYC9lbGVtZW50LyR7ZWx9L3NjcmVlbnNob3RgLCAnR0VUJyk7XG4gIGlmICghXy5pc1N0cmluZyhkYXRhKSkge1xuICAgIGxvZy5lcnJvckFuZFRocm93KGBVbmFibGUgdG8gdGFrZSBhIHNjcmVlbnNob3Qgb2YgdGhlIGVsZW1lbnQgJHtlbH0uIFdEQSByZXR1cm5lZCAnJHtKU09OLnN0cmluZ2lmeShkYXRhKX0nYCk7XG4gIH1cbiAgcmV0dXJuIGRhdGE7XG59O1xuXG5jb21tYW5kcy5nZXRWaWV3cG9ydFNjcmVlbnNob3QgPSBhc3luYyBmdW5jdGlvbiBnZXRWaWV3cG9ydFNjcmVlbnNob3QgKCkge1xuICBsZXQgc3RhdHVzQmFySGVpZ2h0ID0gYXdhaXQgdGhpcy5nZXRTdGF0dXNCYXJIZWlnaHQoKTtcbiAgY29uc3Qgc2NyZWVuc2hvdCA9IGF3YWl0IHRoaXMuZ2V0U2NyZWVuc2hvdCgpO1xuXG4gIC8vIGlmIHdlIGRvbid0IGhhdmUgYSBzdGF0dXMgYmFyLCB0aGVyZSdzIG5vdGhpbmcgdG8gY3JvcCwgc28gd2UgY2FuIGF2b2lkXG4gIC8vIGV4dHJhIGNhbGxzIGFuZCByZXR1cm4gc3RyYWlnaHRhd2F5XG4gIGlmIChzdGF0dXNCYXJIZWlnaHQgPT09IDApIHtcbiAgICByZXR1cm4gc2NyZWVuc2hvdDtcbiAgfVxuXG4gIGNvbnN0IHNjYWxlID0gYXdhaXQgdGhpcy5nZXREZXZpY2VQaXhlbFJhdGlvKCk7XG4gIC8vIHN0YXR1cyBiYXIgaGVpZ2h0IGNvbWVzIGluIHVuc2NhbGVkLCBzbyBzY2FsZSBpdFxuICBzdGF0dXNCYXJIZWlnaHQgPSBNYXRoLnJvdW5kKHN0YXR1c0JhckhlaWdodCAqIHNjYWxlKTtcbiAgY29uc3Qgd2luZG93U2l6ZSA9IGF3YWl0IHRoaXMuZ2V0V2luZG93U2l6ZSgpO1xuICBsZXQgcmVjdCA9IHtcbiAgICBsZWZ0OiAwLFxuICAgIHRvcDogc3RhdHVzQmFySGVpZ2h0LFxuICAgIHdpZHRoOiB3aW5kb3dTaXplLndpZHRoICogc2NhbGUsXG4gICAgaGVpZ2h0OiAoKHdpbmRvd1NpemUuaGVpZ2h0ICogc2NhbGUpIC0gc3RhdHVzQmFySGVpZ2h0KVxuICB9O1xuICBsZXQgbmV3U2NyZWVuc2hvdCA9IGF3YWl0IGltYWdlVXRpbC5jcm9wQmFzZTY0SW1hZ2Uoc2NyZWVuc2hvdCwgcmVjdCk7XG4gIHJldHVybiBuZXdTY3JlZW5zaG90O1xufTtcblxuZXhwb3J0IGRlZmF1bHQgY29tbWFuZHM7XG4iXSwiZmlsZSI6ImxpYi9jb21tYW5kcy9zY3JlZW5zaG90cy5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9
